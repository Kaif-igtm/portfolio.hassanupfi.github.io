/******************************************************************************************************
 *                                             EDITOR HELPER
 *                          This class attached to the Spime engine on edit mode only
 *                          handles the communication with the editor and adds the resize handlers
 ******************************************************************************************************/

var EditorHelper = {};


EditorHelper.defaultElementValues = {};
EditorHelper.shortcodesJson = {};
EditorHelper.pagesDetails = {};
EditorHelper.errorReloadInterval = null;
EditorHelper.userSitesList = null;
EditorHelper.errorReloadCounter = 0;
EditorHelper.MAX_RELOAD_TIMES = 5;
EditorHelper.StyleSettings = {};
EditorHelper.ColorResetObj = {};
EditorHelper.FontResetObj = {};
EditorHelper.AllResetObj = {};
EditorHelper.ShortcodeStyles = {};
EditorHelper.StyleForSwitchers = {};
EditorHelper.ShortcodeConfig = {};
EditorHelper.SiteConfig = {};
EditorHelper.offers = [];
EditorHelper.offersDetails = {};
EditorHelper.saveTimers = {};
EditorHelper.realTimeStyle = {};
EditorHelper.PAGE_WIDTH = "1000";
EditorHelper.draggableImageTimeout; 
EditorHelper.draggablePanelFirstTime = true;
EditorHelper.mouseMoveTimeout = 0;
EditorHelper.paymentBinded = false;
EditorHelper.lastVisibleSection;
EditorHelper.imagesToPreload = ["add_stripe","margin_left","margin_right","sure","pagination_dot","pagination_dot_selected","items_ico","promo_ico","features_ico","slideshows_ico","galleries_ico","blog_ico","widget_ico",
                                "title_ico","pic_ico","subtitle_ico","video_ico","body_ico","quote_ico","link_ico","icon_ico","map_ico","delete_on","delete_off","tooltip_circle","tooltip_top_left","tooltip_top_right",
                                "tooltip_bottom_left","tooltip_bottom_right"];
EditorHelper.mode = "guest";
EditorHelper.presetIndex = 0;
EditorHelper.presetNumber = 10;
EditorHelper.viewerMode = "filmStrip";
EditorHelper.loadedLicense = {};
EditorHelper.mediaCenterExtraParams = "";


/******************************************************************************************************
 *                                             INIT
 *                          The following function is called once by the spime engine
 ******************************************************************************************************/

EditorHelper.bindHelperActions = function(){
	EditorCore.init();
	EditorHelper.disableRightClickMenu();
	EditorHelper.updateEditMode();
	SpimeEngine.getAllHolders().each(function(){
		var currentHolder = $(this);
		EditorHelper.addResizeHandlers(currentHolder);
		EditorHelper.addHoverControls(currentHolder);
		EditorHelper.overrideLinks(currentHolder);
		
	});
	//Init the add items menu
	XPRSHelper.imagePreloader(EditorHelper.imagesToPreload,"/images/ui_icons","png");
	//Load relevant json settings
	EditorHelper.LoadSettingsJson(function(){
		EditorHelper.initPresetMenu();
		SpimeEngine.getAllHolders().not(".element-box").each(function(){
			var currentHolder = $(this);
			EditorHelper.initStripeLeftClick(currentHolder);
		});
	});
	
	EditorHelper.initWebsiteLeftClick();
	if (document.cookie.indexOf("blockfreeurl") != -1){
		$("body").removeClass("blockfreeurl");
	}
	//Add the preview tab 
	EditorHelper.reloadErredStripes();
	EditorHelper.getPagesJson();
	EditorHelper.getSiteConfig();
	EditorHelper.createFloatingTooltip();
	EditorHelper.initPublishModule();
	setTimeout(function(){
		EditorHelper.initQuickStyleMenu();
		//checking for a popup stripe to update the control panel
		if ($(".page_stripe_popup_app").length > 0) {
			XPRSHelper.updateParent({"deliver_to":"parent","action":"app-dismiss-control-panel"});
		} else {
			XPRSHelper.updateParent({"deliver_to":"parent","action":"remove-app-dismiss-control-panel"});
		}
		EditorHelper.updateParent({"deliver_to":"parent","action":"finished-loading"});
    }, 500);
	
	$(document).keypress(function(e) {
		//ctrl + q
		if (e.keyCode == 17 && e.ctrlKey){
				var pageId = EditorHelper.getPageId();
				$(".master.item-box").not(".injected").not(".element-box").each(function(){
					var controlsHolder = $(this);
					XPRSHelper.GET("/snap_stripe", {"page_id":pageId,"stripe_id":controlsHolder.attr("id"),"stripe_height":parseInt(controlsHolder.outerHeight(true))}, function(){
						console.log("stripe " + controlsHolder.attr("id"));	
					});
				});
				alert("sent All " + $(".master.item-box").not(".injected").not(".element-box").length);	
			}
		
	});
	EditorHelper.updateAddToMenuBtn();
	EditorHelper.initImosDashboard();
	if (typeof XPRSUndo != "undefined"){
		XPRSUndo.BindUndo();
	}
	EditorHelper.initFloatingPlus();
};

EditorHelper.updateFloatingPlusText = function(floatingPlus){
	var popupVerb = "Add";
	if ($(".page_stripe_popup_app").length > 0) {
		popupVerb = "Edit"
	}
	floatingPlus.find("#edit_popup").text(XPRSTranslator.translateText(popupVerb + " Popup"));
	var menuVerb = "Add";
	var menuId = EditorHelper.checkIfMenuExists();
	var menuLayout = EditorHelper.getMenuLayout(menuId);
	if (menuLayout != "unknown" && menuLayout != "no_menu"){
		menuVerb = "Edit";
	}
	floatingPlus.find("#edit_menu").text(XPRSTranslator.translateText(menuVerb + " Menu"));
}
	

EditorHelper.initFloatingPlus = function(){
	$(".floating-plus").click(function(e){
		e.stopPropagation();
		EditorHelper.updateFloatingPlusText($(this));
		$(".plus-mark").removeClass("plus-mark");
		$(this).toggleClass("open");
		if ($(this).is(".open")){
			XPRSHelper.trackEvent('opened_fab',"General",XPRSHelper.getXprsCookie("xprs-initial-template"));
		}else{
			XPRSHelper.trackEvent('closed_fab',"General",XPRSHelper.getXprsCookie("xprs-initial-template"));
		}
	});


	$(".floating-plus li").click(function(e){
		e.stopPropagation();
		var option = $(this).attr("id");
		switch(option){
			case "edit_menu":
			XPRSHelper.trackEvent('clicked_fab_edit_menu',"General",XPRSHelper.getXprsCookie("xprs-initial-template"));
			EditorHelper.showManageMenu();
				break;
			case "edit_popup":
				XPRSHelper.trackEvent('clicked_fab_edit_popup',"General",XPRSHelper.getXprsCookie("xprs-initial-template"));
				EditorHelper.showPopupApp();
				break;
			case "add_page":
				XPRSHelper.trackEvent('clicked_fab_add_page',"General",XPRSHelper.getXprsCookie("xprs-initial-template"));
				if (typeof VueEditor != "undefined"){
					VueEditor._router.push("/website/add_page");
				}else{
				EditorHelper.showAddPageMenu("add-page",{});
				}
				break;
			case "add_section":
				XPRSHelper.trackEvent('clicked_fab_add_section',"General",XPRSHelper.getXprsCookie("xprs-initial-template"));
				var res = EditorHelper.lastVisibleSection.next(".control-handle").find("#add-stripe").click();
				if (res.length == 0){
					res = $(".control-handle:eq(1) #add-stripe").click();
				}
				EditorHelper.scrollToItem({vbid:"empty-stripe","top_padding":30});
				break;
		}
		$(".floating-plus").removeClass("open")
	});
	$(".floating-plus li#add_section").hover(function(){
		EditorHelper.lastVisibleSection = EditorHelper.getLastVisibleSection();
		EditorHelper.lastVisibleSection.addClass("plus-mark");
	},function(){
		$(".plus-mark").removeClass("plus-mark");
	});
	
};


EditorHelper.getLastVisibleSection = function(){
	var last =  $(".visible-section").last();
	if (last.prev().prev().is(".header-box")){
		return last;
	}else{
		return last.prev().prev();
	}
};

EditorHelper.adjustUI = function(){
	if($("#empty-stripe").length > 0){
		if ($("#children").first().width() < 1070){
			$("#empty-stripe").addClass("no-place");
		}else{
			$("#empty-stripe").removeClass("no-place");
		}
	}
	if (typeof XPRSIMOS != "undefined"){
		XPRSIMOS.arrange();
	}
};




EditorHelper.initStripePlus = function(){
	var addStripeBtn = $("<div />").addClass("main-add-stripe-btn clickable space-layer shadowed");
	var addStripImg = $("<img />").attr("src","/images/ui_icons/add_site.png");
	addStripeBtn.append(addStripImg);
	$("#xprs").append(addStripeBtn);
	addStripeBtn.unbind("click").bind("click",function(e){
		e.stopPropagation();
		if ($(this).find("img").is(".rotated-45")){
			$(this).find("img").removeClass("rotated-45");
			EditorHelper.stopAnchorSelectionMode();
			EditorHelper.closeAddStripeMenu();
		}else{
		   //close opened collection
			var openedCollection = $("[opened=yes]");
			if (openedCollection.length > 0){
				openedCollection.attr("opened","no");
				$("#empty-stripe").removeClass("opened")
				EditorHelper.closeAddStripeMenu();
			}
			$(".master.item-box").addClass("is-blocked").find(".add-stripe-selection-blocker").remove();
			var blocker = $("<div class='add-stripe-selection-blocker active' />");
			blocker.unbind("click").bind("click",function(e){
				e.stopPropagation();
			});
			$(this).find("img").addClass("rotated-45");
			$("#xprs").addClass("anchor-selection adding-stripes-mode");
			//scroll to the right position
			$('body').animate({scrollTop:$(this).offset().top/5},2000,'easeOutQuart');
			$("#xprs").one("click",function(e){
				EditorHelper.stopAnchorSelectionMode();
			});	
			$(".master.item-box").append(blocker)
		}
	});
};


EditorHelper.disableRightClickMenu = function(){
	document.oncontextmenu = function() {return false;};
};

EditorHelper.updateEditMode = function(){
	var currentUser = EditorHelper.getCurrentUser();
	if (currentUser == "admin"){
		EditorHelper.mode = "admin";	
	}
};


EditorHelper.createFloatingTooltip = function(){
	var floatingTooltip = $("<div />").attr("id","floating-tooltip").text("").css("z-index","9999999999");
	$("body").append(floatingTooltip);
	$("body").bind("mousemove",function(e){
		
		 clearTimeout(EditorHelper.mouseMoveTimeout);
		 floatingTooltip.removeClass("shown");
			setTimeout(function(){
				floatingTooltip.css("opacity","");
			},0);
		 var hoveredElement = $(e.target);
		 EditorHelper.mouseMoveTimeout = setTimeout(function() {
			 	
				var name = hoveredElement.attr("data-menu-name" );
				var color = "#333";
				if(typeof name != "undefined"){
					var presetName = name.replace("PREVIEW_","").replace("BLOCKS_","");
					name = presetName.toLowerCase().replace("_"," ");
					if (presetName.replace("IMAGE","PIC") in XPRSHelper.presetTypes){
						color = XPRSHelper.presetTypes[presetName.replace("IMAGE","PIC")]["COLOR"];
						name += " - ";
					}else{
						name = "";
					}
				}else{
					name = "";
				}
				var title = $(e.target).attr("data-title");
				if(typeof title == "undefined"){
					if (name.length > 0){
						title = "click to edit";
					}else{
						title = "";
					}
				}
				
				if (name.length > 0 || title.length > 0){
					title = XPRSTranslator.translateText(title);
					name = XPRSTranslator.translateText(name);
					floatingTooltip.html("<b>"+name + "</b> <span>" + title + "</span>" );
					if (!floatingTooltip.is(".shown")){
						floatingTooltip.addClass("shown").css("background-color",color);
						floatingTooltip.css("opacity",1);
					}
				}else{
					floatingTooltip.removeClass("shown");
					setTimeout(function(){
						floatingTooltip.css("opacity","");
					},0);
				}
				
				var offsetX = 20;
				var offsetY = 30;
				if (e.pageX + floatingTooltip.width() + offsetX > $(window).width()){
					offsetX = -1 * (floatingTooltip.width() + offsetX);
				}
				
				floatingTooltip.css({
				       left:  e.pageX + offsetX,
				       top:   e.pageY + offsetY
				 });
				
				if (hoveredElement.is(".edit-on")){
					floatingTooltip.removeClass("shown");
					setTimeout(function(){
						floatingTooltip.css("opacity","");
					},0);
				}
		 }, 700);
	});
	$("#xprs").bind("mouseout",function(e){
		floatingTooltip.removeClass("shown");
		setTimeout(function(){
			floatingTooltip.css("opacity","");
		},0);
	});
	$("#xprs").bind("mouseenter",function(e){
		floatingTooltip.addClass("shown");
		setTimeout(function(){
			floatingTooltip.css("opacity",1);
		},0);
	});
};


EditorHelper.showStripeSettings = function(stripeOrItem){
	var stripe = stripeOrItem.closest(".master.item-box");
	var tabConfig = (stripeOrItem.hasClass("sub")) ? {"selected-tab":"layout-switching"} : undefined;
	if(XPRSHelper.inPresetGroup(stripe.attr("data-preset-type-id"), "GALLERIES")){
		EditorHelper.showDraggableTabbedPanel("gallery-edit", stripe, tabConfig);
	}else if (XPRSHelper.inPresetGroup(stripe.attr("data-preset-type-id"), "FEATURES")){
		EditorHelper.showDraggableTabbedPanel("features-edit", stripe, tabConfig);
	}else if (XPRSHelper.inPresetGroup(stripe.attr("data-preset-type-id"), "SLIDESHOWS")){
		EditorHelper.showDraggableTabbedPanel("slideshow-edit", stripe, tabConfig);
	}else if (XPRSHelper.inPresetGroup(stripe.attr("data-preset-type-id"), "MENUS")){
		EditorHelper.showDraggableTabbedPanel("menu-edit", stripe);
	}else if (stripe.attr("data-preset-type-id") == "ARTICLE"){
		EditorHelper.showDraggableTabbedPanel("article-edit", stripe);
	}else if(XPRSHelper.inPresetGroup(stripe.attr("data-preset-type-id"), "ITEMS")){
		if (stripe.find(".sub.item-box").length > 0){
			EditorHelper.showDraggableTabbedPanel("items-edit", stripe, tabConfig);
		}else{
			EditorHelper.showDraggableTabbedPanel("item-edit", stripe, tabConfig);
		}
	}else if (XPRSHelper.inPresetGroup(stripe.attr("data-preset-type-id"), "FOOTERS")){
		EditorHelper.showDraggableTabbedPanel("footer-edit", stripe);
	}
};

EditorHelper.initWebsiteLeftClick = function(){
	$("#content").unbind("click").bind("click",function(e){
		if ($(".dragged").length == 0 && EditorHelper.allowLeftClickMenu($("#content"),e.target) ){
			EditorHelper.closeLeftClickMenu();
			var leftClickMenuHolder = EditorHelper.creatLeftMenuHolder();
			var leftClickMenuUL = $("<ul />");
			var leftClickOptionChangeColor = EditorHelper.createMiniMenuRowBtn($("body"), "stripe-row", "Website Background", "#555", "/images/ui_icons/color_selector_ico.png");
			var colorPicker = $("<div />").addClass("stripe-quick-color-btn sp-menu");
			leftClickOptionChangeColor.append(colorPicker);
			leftClickMenuUL.append(leftClickOptionChangeColor);
			leftClickMenuHolder.append(leftClickMenuUL);
			var relevantStyleId = $(".master.container").attr("data-preview-style");
			leftClickOptionChangeColor.unbind("click").bind("click", function(){
				EditorHelper.initQuickColorMenu(colorPicker,$("body"),relevantStyleId,"","WEBSITE_PAGE",{"allow_image":true,"background_class":"body"});
			})
			if ($("body").css("background-image") != "none"){
				colorPicker.find(".more.color-picker").css("display","block");
				var currentBodyClass = $("body").attr("class"); 
				var bgTypes = ["pattern","cover","full-width","contain","fixed"];
				for (t in bgTypes){
					var bgTypeOp = $("<li />").addClass("clickable sp-menu t-t half-size").text(bgTypes[t]).attr("id" ,bgTypes[t] + "-bg");
					if (currentBodyClass.indexOf(bgTypes[t]) != -1){
						bgTypeOp.addClass("selected");
					}
					bgTypeOp.unbind("click").bind("click",function(e){
						e.stopPropagation();
						$(this).siblings(".half-size").removeClass("selected");
						$(this).addClass("selected");
						$("body").attr("class",$(this).attr("id"));
						XPRSHelper.SAFEPOST("/update_css_class", {"vbid":EditorHelper.getRootId(),"updated_key":"BACKGROUND_CLASS","updated_value":$(this).attr("id")}, EditorHelper.getRootId(), "CSS_CLASS");
					});
					
					bgTypeOp.hover(function(){$("#xprs").addClass("animated-opacity").css("opacity",0.6)},function(){$("#xprs").css("opacity",1).removeClass("animated-opacity")});
					colorPicker.find("ul").append(bgTypeOp);
				}
			}
			EditorHelper.positionLeftClickMenu(e,leftClickMenuHolder);
		}
	});

	
	$(".menus-wrapper + .preview-item-links").unbind("click").bind("click",function(e){
		e.stopPropagation();
		var linksHolder = $(this);
		var currentHolder = linksHolder.closest(".master.item-box");
		if ($(".dragged").length == 0 && EditorHelper.allowLeftClickMenu($(".master.container"),e.target) ){
			EditorHelper.closeLeftClickMenu();
			var leftClickMenuHolder = EditorHelper.creatLeftMenuHolder();
			var leftClickMenuUL = $("<ul />");
			leftClickMenuHolder.append(leftClickMenuUL);
			var leftClickOptionStripeSettings  = EditorHelper.createMiniMenuRowBtn(currentHolder, "stripe-row", "Menu Settings", "#555", "/images/ui_icons/menu_section_ico.png");
			leftClickMenuUL.append(leftClickOptionStripeSettings);
			leftClickOptionStripeSettings.unbind("click").bind("click",function(e){
				linksHolder.removeClass("mark-area");
				EditorHelper.draggablePanelFirstTime = false;
				EditorHelper.showStripeSettings(currentHolder);
				$(".left-click-menu-holder").remove();
			});
			
			if (linksHolder.is(".allow-bg-color")){
				var leftClickOptionChangeColor = EditorHelper.createMiniMenuRowBtn(currentHolder, "stripe-row", "Background Color", "#555", "/images/ui_icons/color_selector_ico.png");
				var colorPicker = $("<div />").addClass("stripe-quick-color-btn sp-menu");
				leftClickOptionChangeColor.append(colorPicker);
				leftClickMenuUL.append(leftClickOptionChangeColor);
				var relevantStyleId = currentHolder.attr("data-preview-styleid");
				colorPicker.hover(function(){
					if (linksHolder.css("background-image") == "none"){
						linksHolder.addClass("mark-area");
					}
					},
					function(){
						linksHolder.removeClass("mark-area");
					});
				EditorHelper.initQuickColorMenu(colorPicker,linksHolder,relevantStyleId,"","MENUFIED_PREVIEW_LINKS_HOLDER",{"allow_image":true,"background_class":".preview-item-links","include_effects":false,"use_style_effects":true,"show_opacity":false,"effects_module":"BACKGROUND_IMAGE","include_bg_type":true});
				if (linksHolder.css("background-image") != "none"){
					colorPicker.find(".more.color-picker").css("display","block");
					var currentBodyClass = linksHolder.attr("class"); 
					var bgTypes = "pattern cover full-width contain fixed";
					var bgTypeArray = bgTypes.split(" ")
					for (t in bgTypeArray){
						var bgTypeOp = $("<li />").addClass("clickable sp-menu t-t half-size").text(bgTypeArray[t]).attr("id" ,bgTypeArray[t] + "-bg");
						if (currentBodyClass.indexOf(bgTypeArray[t]) != -1){
							bgTypeOp.addClass("selected");
						}
						bgTypeOp.unbind("click").bind("click",function(e){
							e.stopPropagation();
							$(this).siblings(".half-size").removeClass("selected");
							$(this).addClass("selected");
							linksHolder.removeClass("pattern-bg cover-bg full-width-bg contain-bg fixed-bg");
							linksHolder.addClass($(this).attr("id"));
							XPRSHelper.SAFEPOST("/update_css_class", {"vbid":linksHolder.closest(".master.item-box").attr("id"),"updated_key":"MENUFIED_LINKS_BG_CLASS","updated_value":$(this).attr("id"),"stripe_id":linksHolder.closest(".master.item-box").attr("id")}, linksHolder.closest(".master.item-box").attr("id"), "CSS_CLASS");
						});
						colorPicker.find("ul").append(bgTypeOp);
					}
				}
			}
			EditorHelper.positionLeftClickMenu(e,leftClickMenuHolder);
			setTimeout(function(){
				leftClickMenuHolder.addClass("shown");
			},10);
		}
	});	
};

EditorHelper.initStripeLeftClick = function(currentHolder){
	EditorHelper.initBackgroundColorSelector(currentHolder);
	currentHolder.not(".element-box").unbind("click").bind("click",function(e){
		e.stopPropagation();
		if ($(".dragged").length == 0 && EditorHelper.allowLeftClickMenu(currentHolder,e.target)){
			var openLeftClickMenus = $(".left-click-menu-holder");
			EditorHelper.closeLeftClickMenu();
			var wasOpen = menu_layout.closeOpenedSubmenus();
			if (wasOpen){
				return;
			}
			if (openLeftClickMenus.attr("data-initiator") == currentHolder.attr("id")){
				return;
			}
			
			var leftClickMenuHolder = EditorHelper.creatLeftMenuHolder();
			leftClickMenuHolder.attr("data-initiator",currentHolder.attr("id"));
			var leftClickMenuUL = $("<ul />");
			
			var leftClickOptionManageParent = EditorHelper.createStripeRow(currentHolder);
			leftClickMenuUL.append(leftClickOptionManageParent);
			//Stripe color
			var buttonText = "Section Color";
			if (currentHolder.find(".stripe-background").attr("id") != "no-image"){
				buttonText = "Section Background Settings";
			}
			var leftClickOptionChangeColor = EditorHelper.createMiniMenuRowBtn(currentHolder, "stripe-row", buttonText, "#555", "/images/ui_icons/color_selector_ico.png");
			leftClickMenuUL.append(leftClickOptionChangeColor);
			var colorPicker = $("<div />").addClass("stripe-quick-color-btn sp-menu");
			leftClickOptionChangeColor.append(colorPicker);
			leftClickOptionChangeColor.hover(function(){
				currentHolder.addClass("mark-area");
				$(".master.container").removeClass("mark-area");
			},function(){
				currentHolder.removeClass("mark-area");
			})

			if (currentHolder.find(".stripe-background").attr("id") != "no-image"){
				leftClickOptionChangeColor.unbind("click touch").bind("click",function(e){
					e.stopPropagation();
						EditorHelper.showDraggableTabbedPanel("bg-image-panel", currentHolder.find(".stripe-background"));
				});
			}else{
			var relevantStyleId = currentHolder.attr("data-preview-styleid");
			var relevantModule = "PREVIEW_ITEM_STRIPE";
			var allowImage = true;
			if (currentHolder.attr("data-preset-type-id") == "MENUS"){
				allowImage = false;
			}
			var colorMenuParams = {"allow_image":allowImage,"background_class":".stripe-background","include_effects":true,"use_style_effects":true,"include_bg_type":true,"show_opacity":true,"effects_module":"STRIPE_BACKGROUND","open_on_click":true}
			if (currentHolder.closest(".master.item-box").attr("data-preset-type-id") == "MENUS"){
				colorMenuParams["simple_colors"] = true;
			}
			EditorHelper.initQuickColorMenu(colorPicker,currentHolder,relevantStyleId,"",relevantModule,colorMenuParams);
		}
			leftClickMenuHolder.append(leftClickMenuUL);
			XPRSTranslator.translateDom(leftClickMenuHolder);
			EditorHelper.positionLeftClickMenu(e,leftClickMenuHolder);
		}
	});
};


EditorHelper.closeLeftClickMenu = function(){
	$(".marked-ecommerce").removeClass("marked-ecommerce");
	$(".marked-delete").removeClass("marked-delete");
	$(".mark-area").removeClass("mark-area");
	$(".marked").find(".marker").remove();
	$(".marked").removeClass("marked");
	$(".color-picker").spectrum("hide");
	$(".left-click-menu-holder").remove();
	$(".resizing-dragging").removeClass("resizing-dragging");
};

EditorHelper.isTransparentColor = function(color){
	if (color === undefined){
		return false;
	}
	var isTransparent = color == "rgba(0, 0, 0, 0)" || color == "transparent";
	if (color.indexOf("rgba") != -1 && color.indexOf(", 0)") != -1){
		isTransparent = true;
	}
	return isTransparent
};


EditorHelper.initBackgroundColorSelector = function(currentHolder){
	var items = currentHolder.find(".item-content").not(".blocks_layout");
	items.unbind("click").bind("click",function(e){
		if ($(".resizing-dragging").length > 0){
			e.stopPropagation();
		}
		if (EditorHelper.allowLeftClickMenu(currentHolder,e.target)){
			var currentItem = $(this);
			var currentColor = currentItem.css("background-color");
			var isTransparent = EditorHelper.isTransparentColor(currentColor);
			if ((currentItem.closest(".master.item-box").attr("data-preset-type-id") == "MENUS" || currentItem.closest(".master.item-box").attr("data-preset-type-id") == "FOOTERS") && isTransparent || currentItem.find(".helper-div.middle-center").length > 0){
				if (currentItem.find(".helper-div.middle-center").length > 0) {
					return false
				}
			}else{
				e.stopPropagation();
				currentItem.addClass("mark-area");
				EditorHelper.closeLeftClickMenu()
				var leftClickMenuHolder = EditorHelper.creatLeftMenuHolder();
				var leftClickMenuUL = $("<ul />");
				var leftClickOptionChangeColor = EditorHelper.createMiniMenuRowBtn(currentHolder, "stripe-row", "Background Color", "#555", "/images/ui_icons/color_selector_ico.png");
				var colorPicker = $("<div />").addClass("stripe-quick-color-btn sp-menu");
				leftClickOptionChangeColor.append(colorPicker);
				leftClickMenuUL.append(leftClickOptionChangeColor);
				leftClickMenuHolder.append(leftClickMenuUL);
				var relevantStyleId = currentItem.attr("data-preview-style");
				EditorHelper.initQuickColorMenu(colorPicker,currentItem,relevantStyleId,".item-content","ITEM_PREVIEW",{"allow_image":true,"background_class":".background-image-div.image-source","include_effects":true,"use_style_effects":true,"show_opacity":true,"effects_module":"BACKGROUND_IMAGE"});
				EditorHelper.positionLeftClickMenu(e,leftClickMenuHolder);
			}
		}
	});
	var previewContent = currentHolder.find(".preview-content-holder");
	if (!EditorHelper.isTransparentColor(previewContent.css("background-color"))){
		previewContent.css("pointer-events","auto");
	}
	previewContent.unbind("click").bind("click",function(e){
		var currentColor = previewContent.css("background-color");
		var isTransparent = EditorHelper.isTransparentColor(currentColor);
		if (currentHolder.closest(".left-menu-placeholder").length == 0 && !isTransparent){
			e.stopPropagation();
			if (EditorHelper.allowLeftClickMenu(currentHolder,e.target)){
				var currentItem = $(this);
				
				EditorHelper.closeLeftClickMenu()
				var leftClickMenuHolder = EditorHelper.creatLeftMenuHolder();//$("<div />").addClass("left-click-menu-holder  top-layer").attr("data-scroll-pos",$(window).scrollTop());
				var leftClickMenuUL = $("<ul />");
				var leftClickOptionChangeColor = EditorHelper.createMiniMenuRowBtn(currentHolder, "stripe-row", "Background Color", "#555", "/images/ui_icons/color_selector_ico.png");
				var colorPicker = $("<div />").addClass("stripe-quick-color-btn sp-menu");
				leftClickOptionChangeColor.append(colorPicker);
				leftClickMenuUL.append(leftClickOptionChangeColor);
				leftClickMenuHolder.append(leftClickMenuUL);
				
				var relevantStyleId = currentItem.closest(".item-content").attr("data-preview-style");
				EditorHelper.initQuickColorMenu(colorPicker,currentItem,relevantStyleId,".preview-content-holder","PREVIEW_CONTENT_HOLDER");
				EditorHelper.positionLeftClickMenu(e,leftClickMenuHolder);
				currentItem.addClass("mark-area");
			}
		}
	});
};


EditorHelper.initQuickColorMenu = function(btn,holder,styleid,relevantClass,moduleName,params){
	var colorsListHolder = $("<div/>").addClass("color-list-holder sp-menu top-layer");
	var colorsList = $("<ul/>").addClass("sp-menu");
	if (params && params.open_on_click){
		
		colorsListHolder.addClass("click-to-show")
		btn.closest("li").unbind("click").bind("click",function(){
			//hide other open color palettes
			btn.closest("li").siblings().find(".color-list-holder").removeClass("always-show");
			
			colorsListHolder.toggleClass("always-show");
		});
		
	}else{
		colorsListHolder.addClass("always-show");
	}
	
	colorsListHolder.append(colorsList);
	
	if (params && params.dont_add_colors){
		// colorsListHolder.css("margin-top","40px");
	}else {
		EditorHelper.createColorPaletteMenu(colorsList,holder,styleid,moduleName,params);
	}

	if (moduleName != "ITEM_PREVIEW" || holder.find(".multi").length > 0){
		if( params && params.background_class){
			EditorHelper.addImageToColorPalette(colorsList,holder,params.background_class,params.allow_image,params.include_bg_type);
		}
		
		if (params && params.include_effects){
			if (params.show_opacity) {
				EditorHelper.addOpacityController(colorsList,holder,styleid,params.background_class,params.effects_module);
			}
			var inProductPage = holder.closest(".item-content").is(".product-container"); 
			if (params.include_crop && !inProductPage){
				EditorHelper.addCropOption(colorsList,holder,params.background_class);
			}
			EditorHelper.addEffectsPalette(colorsList,holder,styleid,params.background_class,params.effects_module);
		}
	}
	if( params && params.background_class){
	}else{
		var numberOfOptions = colorsList.children(".color-option").length;
		var safetyStop = 0;
		if (numberOfOptions > 1){
			while (numberOfOptions % 3 != 2 && safetyStop < 50){
				colorsList.children(".color-option").last().prev().remove();
				numberOfOptions = colorsList.children(".color-option").length;
				safetyStop++;
			}
		}
	}
	
	btn.append(colorsListHolder);
	setTimeout(function(){
		colorsListHolder.parent().css({"visibility":"hidden", "display":"block"});
		var actualHeight = colorsListHolder.outerHeight(true);
		var actualPosition = colorsListHolder.offset().top - $(window).scrollTop() + 70;
		colorsListHolder.parent().css({"visibility":"", "display":""})
		if (actualPosition + actualHeight > $(window).height()){
			var newTop = -1 * ( actualHeight - ($(window).height() - actualPosition));
			colorsListHolder.css("top",newTop)
		}
	},0)
};


EditorHelper.createColorPaletteMenu = function(colorsList,holder,styleid,moduleName,params){
	var fieldType = "BACKGROUND_COLOR";
	var inputObj = EditorHelper.StyleSettings["PROPERTIES"][fieldType];
	var relevantColors = new Array(100);
	if ("PALETTES" in EditorHelper.SiteConfig){
		if ("COLORS_PALETTE" in EditorHelper.SiteConfig["PALETTES"]){
			relevantColors = EditorHelper.SiteConfig["PALETTES"]["COLORS_PALETTE"].slice();
		}
	}
	if (typeof relevantColors == "undefined" || relevantColors.length == 0){
		relevantColors = ["rgb(0,0,0)","rgb(255,255,255)","rgb(51,204,102)"];
	}else{
		relevantColors.unshift("rgb(0,0,0)");
		relevantColors.unshift("rgb(255,255,255)");
	}
	relevantColors.unshift("transparent");
	var prop = "BACKGROUND_COLOR";
	var props = "BACKGROUND_COLOR";
	if (typeof params != "undefined" && typeof params.prop != "undefined"){
		prop = params.prop;
		props = params.prop;
	}
	var secondTarget = null;
	if (typeof params != "undefined" && params.second_target != "undefined"){
		secondTarget = params.second_target;
	}
	var closeOnSelect = false;
	if (typeof params != "undefined" && typeof params.close_on_select != "undefined"){
		closeOnSelect = true;
	}
	
	for (i in relevantColors){
		var color = relevantColors[i];
		var colorOp = $("<li />").addClass("clickable sp-menu").css("background-color",color).addClass("color-option clickable");
		if (color == "transparent"){
			colorOp.css({"background-image": "url(/images/backgrounds/transparent_bg.png)","background-size": "50%"});
		}
		colorOp.bind("click",function(e){
			e.stopPropagation();
			var modules = moduleName;
			holder.removeClass("mark-area");
			var currentColor = $(this).css("background-color");
			if (secondTarget){
				secondTarget.css("background-color",currentColor);
			}

			EditorHelper.UpdateRealTimeStyle(styleid,moduleName,prop, currentColor);
			var timerKey = prop + styleid;
			//Handle the situation where the image hides the background color
			if (currentColor == "transparent" || currentColor == "rgba(0, 0, 0, 0)"){
				if (holder.closest(".multi_layout .middle-center").length > 0){
					if (!holder.is(".preview-element")){
						var moreparams = {};
						moreparams["css_name"] = EditorHelper.StyleSettings["PROPERTIES"]["BACKGROUND_COLOR"].css_name;
						moreparams["class_name"] =  EditorHelper.StyleSettings["MODULES"]["ITEM_PREVIEW"].CSS_CLASS;
						moreparams["top_class"] =  EditorHelper.StyleSettings["MODULES"]["ITEM_PREVIEW"].TOP_CSS_CLASS;
						moreparams["value"] = currentColor;
						moreparams["module"] = "ITEM_PREVIEW";
						moreparams["target"] = styleid;
						EditorHelper.handleStyleChange(moreparams);
						props += "|" + prop;
						modules += "|" + "ITEM_PREVIEW";
						currentColor += "|" + currentColor;
					}
				}
			}
			//Handle changing the background of an image to transparent while the item-preview color is not
			if (currentColor == "transparent" || currentColor == "rgba(0, 0, 0, 0)"){
				if (holder.closest(".multi_layout .middle-center").length > 0){
					if (holder.is(".inner-pic")){
						var evenmoreparams = {};
						evenmoreparams["css_name"] = EditorHelper.StyleSettings["PROPERTIES"]["BACKGROUND_COLOR"].css_name;
						evenmoreparams["class_name"] =  EditorHelper.StyleSettings["MODULES"]["ITEM_PREVIEW"].CSS_CLASS;
						evenmoreparams["top_class"] =  EditorHelper.StyleSettings["MODULES"]["ITEM_PREVIEW"].TOP_CSS_CLASS;
						evenmoreparams["value"] = currentColor;
						evenmoreparams["target"] = styleid;
						evenmoreparams["module"] = "ITEM_PREVIEW";
						EditorHelper.handleStyleChange(evenmoreparams);
						props += "|" + prop;
						modules += "|" + "ITEM_PREVIEW";
						currentColor += "|" + currentColor;
					}
				}
			}
			if (holder.is(".inner-pic")){
				if (holder.attr("id")!="no-image"){
					if (holder.css("opacity") == 1){
						var opacityParams = {};
						opacityParams["css_name"] = EditorHelper.StyleSettings["PROPERTIES"]["OPACITY"].css_name;
						opacityParams["class_name"] =  EditorHelper.StyleSettings["MODULES"]["PREVIEW_INLINE_IMAGE"].CSS_CLASS;
						opacityParams["top_class"] =  EditorHelper.StyleSettings["MODULES"]["PREVIEW_INLINE_IMAGE"].TOP_CSS_CLASS;
						opacityParams["value"] = 0.8;
						opacityParams["target"] = styleid;
						opacityParams["module"] = "PREVIEW_INLINE_IMAGE";
						EditorHelper.handleStyleChange(opacityParams);
						props += "|" + "OPACITY";
						modules += "|" + "PREVIEW_INLINE_IMAGE";
						currentColor += "|" + "0.8-FLOAT";
					}
				}
			}
			
			var saveObj = EditorHelper.invertTextColorIfNeeded(holder,currentColor,styleid,moduleName);
			if (!$.isEmptyObject(saveObj)){
				props += saveObj["PROPS"];
				modules += saveObj["MODULES"];
				currentColor += saveObj["VALUES"];
			}
			
			colorsList.find(".opacity-option").find(".hide-on-hover").css("opacity",0);
			colorsList.find(".opacity-option").find(".show-on-hover").css("opacity",1);
			colorsList.find(".opacity-option").find(".ui-draggable").addClass("animated-left").css("left","80px");
			setTimeout(function(){
				colorsList.find(".opacity-option").find(".ui-draggable").removeClass("animated-left").css("left","80px");
			},1500);
			
			EditorHelper.debounceSave(timerKey,function(){
				EditorHelper.updateMultipleStyleKeys({"styleid":styleid,"props":props,"values":currentColor,"modules":modules},function(){
					 XPRSHelper.updateParent({"deliver_to":"parent","action":"saved"});
				});
			});
			if (closeOnSelect){
				colorsList.remove();
			}
		});
		colorsList.append(colorOp);
	}
	
	
	if (typeof params != "undefined" && params.limit_colors){
		colorsList.children().slice(params.limit_colors,colorsList.children().length).remove();
	}
	
	
	var moreColors = $("<li />").addClass("clickable more color-picker sp-menu t-t").css({"display":"inline-block","width":"40px","height":"40px","padding":"0px","line-height":"40px","vertical-align":"top"}).text("...");
	moreColors.bind("click",function(e){
		e.stopPropagation();
	});
	colorsList.append(moreColors);
	var colorPickerOptions = {
			color:"rgb(0,0,0)",
			preferredFormat: "rgb",
			className: 'spectrum-custom',
		    showAlpha: true,
		    showButtons: false,
		    showInput:true,
		    clickoutFiresChange: true,
		    move: function(color) {
		    	if (color != null){
		    		var params = {};
					params["css_name"] = EditorHelper.StyleSettings["PROPERTIES"][prop].css_name;
					params["class_name"] =  EditorHelper.StyleSettings["MODULES"][moduleName].CSS_CLASS;
					params["top_class"] =  EditorHelper.StyleSettings["MODULES"][moduleName].TOP_CSS_CLASS;
					params["parent_class"] =  EditorHelper.StyleSettings["MODULES"][moduleName].PARENT_CSS_CLASS;
					params["value"] = color.toRgbString();
					params["target"] = styleid;
					params["module"] = moduleName;
					EditorHelper.handleStyleChange(params);
					if (secondTarget){
			    		secondTarget.css("background-color", color.toRgbString());
					}
		    	}
		    },
		    change: function(color) {
		    	if (color != null){
		    		var params = {};
					params["css_name"] = EditorHelper.StyleSettings["PROPERTIES"][prop].css_name;
					params["class_name"] =  EditorHelper.StyleSettings["MODULES"][moduleName].CSS_CLASS;
					params["top_class"] =  EditorHelper.StyleSettings["MODULES"][moduleName].TOP_CSS_CLASS;
					params["parent_class"] =  EditorHelper.StyleSettings["MODULES"][moduleName].PARENT_CSS_CLASS;
					params["value"] = color.toRgbString();
					params["target"] = styleid;
					params["module"] = moduleName;
					EditorHelper.handleStyleChange(params);
		    	}
		    },
		    beforeShow: function(color) {
		    	//set the alpha to 1 if selected color is transparent (in rgba)
		    	if (color!=null){
		    		var alphaVal = color.getAlpha();
		    		if (alphaVal==0){
		    			color.setAlpha(1);
		    			$(this).spectrum("set", color.toRgbString());
		    		}
		    	}
		    },
		    hide: function(color) {
		    	if (moduleName != ""){
		    		var newColor = "";
		    		if (color == null){
		    			newColor = "rgba(0, 0, 0, 0)";
		    		}else{
		    			newColor = color.toRgbString();
		    		}
		    		holder.removeClass("mark-area");

		    		
		    		
		    		var minDiff = 1000;
		    		var similarColor = newColor;
		    		if ("PALETTES" in  EditorHelper.SiteConfig && "COLORS_PALETTE" in EditorHelper.SiteConfig["PALETTES"]){
						for (var i = 0 ; i < EditorHelper.SiteConfig["PALETTES"]["COLORS_PALETTE"].length; i++){
							var currentDiff = ColorDiff.diff(newColor,EditorHelper.SiteConfig["PALETTES"]["COLORS_PALETTE"][i]);
							if (currentDiff < minDiff){
								minDiff = currentDiff;
								similarColor = EditorHelper.SiteConfig["PALETTES"]["COLORS_PALETTE"][i]
							}
						}
		    		}
					if (minDiff < 10){
						var message = "The color you have selected is very similar to another color you already have in your website palette. Which color do you want to use?"
						XPRSHelper.xprsAlert(message,{title: "A similar color already exists on your website", showCancelButton: true,confirmButtonText:"The one from my palette",cancelButtonText:"The new color","callbackfunc":function(isConfirm){
							   if(isConfirm){
								   newColor = similarColor;
						    		var changedParams = {};
						    		changedParams["css_name"] = EditorHelper.StyleSettings["PROPERTIES"][prop].css_name;
						    		changedParams["class_name"] =  EditorHelper.StyleSettings["MODULES"][moduleName].CSS_CLASS;
						    		changedParams["top_class"] =  EditorHelper.StyleSettings["MODULES"][moduleName].TOP_CSS_CLASS;
						    		changedParams["parent_class"] =  EditorHelper.StyleSettings["MODULES"][moduleName].PARENT_CSS_CLASS;
						    		changedParams["value"] = newColor;
						    		changedParams["target"] = styleid;
						    		changedParams["module"] = moduleName;
									EditorHelper.handleStyleChange(changedParams);
							   }else{
								   if (!("PALETTES" in EditorHelper.SiteConfig)){
						    			EditorHelper.SiteConfig["PALETTES"] = {}
						    		}
						    		if (!("COLORS_PALETTE" in EditorHelper.SiteConfig["PALETTES"])){
						    			EditorHelper.SiteConfig["PALETTES"]["COLORS_PALETTE"] = [];
						    		}else{
						    			if (EditorHelper.SiteConfig["PALETTES"]["COLORS_PALETTE"].length > 5){
						    				EditorHelper.SiteConfig["PALETTES"]["COLORS_PALETTE"].shift();
						    			}
						    		}
						    		EditorHelper.SiteConfig["PALETTES"]["COLORS_PALETTE"].push(newColor);
						    		XPRSHelper.POST("/update_specific_key", {vbid:EditorHelper.getRootId(),section:"CONFIG",updated_key:"PALETTES",updated_value:JSON.stringify(EditorHelper.SiteConfig["PALETTES"]),"type":"json"}, function(){
						    			
						    		});
							   }
					    		EditorHelper.updateMultipleStyleKeys({"styleid":styleid,"props":prop,"values":newColor,"modules":moduleName},function(){
									 XPRSHelper.updateParent({"deliver_to":"parent","action":"saved"});
								});
						}});
					}else{
						   if (!("PALETTES" in EditorHelper.SiteConfig)){
				    			EditorHelper.SiteConfig["PALETTES"] = {}
				    		}
				    		if (!("COLORS_PALETTE" in EditorHelper.SiteConfig["PALETTES"])){
				    			EditorHelper.SiteConfig["PALETTES"]["COLORS_PALETTE"] = [];
				    		}else{
				    			if (EditorHelper.SiteConfig["PALETTES"]["COLORS_PALETTE"].length > 5){
				    				EditorHelper.SiteConfig["PALETTES"]["COLORS_PALETTE"].shift();
				    			}
				    		}
				    		EditorHelper.SiteConfig["PALETTES"]["COLORS_PALETTE"].push(newColor);
				    		XPRSHelper.POST("/update_specific_key", {vbid:EditorHelper.getRootId(),section:"CONFIG",updated_key:"PALETTES",updated_value:JSON.stringify(EditorHelper.SiteConfig["PALETTES"]),"type":"json"}, function(){
				    			
				    		});
			    		EditorHelper.updateMultipleStyleKeys({"styleid":styleid,"props":prop,"values":newColor,"modules":moduleName},function(){
							 XPRSHelper.updateParent({"deliver_to":"parent","action":"saved"});
						});
					}
		    		
		    
		    	}
		    }
		};
		moreColors.spectrum(colorPickerOptions);
};


EditorHelper.invertTextColorIfNeeded = function(holder,currentColor,styleid,moduleName){
	var relevantColorsForInvert = {"ITEM_PREVIEW":true,"PREVIEW_ITEM_STRIPE":true,"PREVIEW_INLINE_IMAGE_HOLDER":true,"MENUFIED_PREVIEW_LINKS_HOLDER":true};
	if (!(moduleName in relevantColorsForInvert)){
		return {};
	}
	var matchToParentColor = false;
	var selectedTransparent = EditorHelper.isTransparentColor(currentColor);
	var isItemColor = holder.is(".item-content");
	var isPageColor = holder.is(".master.container");
	var isStripeColor = holder.is(".master.item-box");
	var stripeColorWithtransparentItemColor = true;
	var hasInnerPicInMiddle = false;
	
	//Selecting transparent color for item content
	if (selectedTransparent && isItemColor){
		currentColor = holder.closest(".master.item-box").css("background-color");
	}
	//invert only for black and white
	if (currentColor == "rgb(0, 0, 0)" || currentColor == "rgb(255, 255, 255)"){
		if (isStripeColor){
			var itemContentColor = holder.find(".item-content").not(".blocks_layout").css("background-color");
			if (typeof itemContentColor == "undefined"){
				stripeColorWithtransparentItemColor = true;
			}else{
				stripeColorWithtransparentItemColor = EditorHelper.isTransparentColor(itemContentColor);	
			}
			
			var hasHeader = holder.find(".stripe-header").length > 0;
			var isMiddleLayout = holder.find(".helper-div.middle-center").length > 0;
			if (isMiddleLayout){
				hasInnerPicInMiddle = holder.find(".helper-div.middle-center .inner-pic").not("#no-image").length > 0;
			}
		}
		
		var elementsToSwitch = $();
		if (isPageColor || !stripeColorWithtransparentItemColor || hasInnerPicInMiddle || (selectedTransparent && !isItemColor)){
		}else{
			if (holder.is(".preview-item-links")){
				elementsToSwitch = holder.find(".item-link");
			}else if (holder.is(".inner-pic")){
				var stripe = holder.closest(".master.item-box");
				var isMiddleLayout = stripe.find(".helper-div.middle-center").length > 0;
				if (isMiddleLayout && holder.attr("id") == "no-image"){
					elementsToSwitch = stripe.find(".preview-element");
				}
			}else{
				elementsToSwitch = holder.find(".preview-element");
			}
		}
		if (hasHeader){
			elementsToSwitch = elementsToSwitch.add(holder.find(".stripe-header .preview-element"));
		}
		
		
		var invertTable = {"rgb(0, 0, 0)":"rgb(255, 255, 255)","rgb(255, 255, 255)":"rgb(0, 0, 0)"};
		var invertColor = invertTable[currentColor];
		var saveObj = {};
		
		elementsToSwitch.each(function(){
			var currentElement = $(this);
			var relevantProp = "COLOR";
			if (!EditorHelper.isTransparentColor(currentElement.css("background-color"))){
				return false;
			}
			if (currentElement.is(".preview-divider")){
				relevantProp = "BORDER_COLOR";
			}
			var currentDiff = ColorDiff.diff(currentElement.css(EditorHelper.StyleSettings["PROPERTIES"][relevantProp].css_name),currentColor);
			if (currentElement.css(EditorHelper.StyleSettings["PROPERTIES"][relevantProp].css_name) == currentColor || currentDiff < 10){
				var moduleName = currentElement.attr("data-menu-name");
				if (moduleName in EditorHelper.StyleSettings["MODULES"]){
					var params = {};
					params["css_name"] = EditorHelper.StyleSettings["PROPERTIES"][relevantProp].css_name;
					params["class_name"] =  EditorHelper.StyleSettings["MODULES"][moduleName].CSS_CLASS;
					params["top_class"] =  EditorHelper.StyleSettings["MODULES"][moduleName].TOP_CSS_CLASS;
					params["value"] = invertColor;
					params["target"] = styleid;
					params["module"] = moduleName;
					EditorHelper.handleStyleChange(params);
					if ($.isEmptyObject(saveObj)){
						saveObj = {"PROPS":"","MODULES":"","VALUES":""};
					}
					saveObj["PROPS"] += "|" + relevantProp;
					saveObj["MODULES"] += "|" + moduleName;
					saveObj["VALUES"] += "|" + invertColor;
				}
			}
		});
		return saveObj;
	}else{
		return {};
	}
};


EditorHelper.addImageToColorPalette = function(colorsList,holder,imageHolderClass,allowImage,includeBgType){
	var currentStripeBackgroundDiv = holder.find(imageHolderClass).andSelf().filter(imageHolderClass)
	if (allowImage){
		var colorOp = $("<li />").addClass("clickable sp-menu");
		colorOp.css({"background-color":XPRSHelper.presetTypes["PIC"]["COLOR"],"background-image":"url(/images/ui_icons/pic_ico.png)","background-repeat":"no-repeat","background-position":"center","background-size":"60%"}).addClass("color-option clickable image_upload").attr("title", XPRSTranslator.translateText("Upload Image"));
		EditorHelper.initReplacePicUploader(colorOp,currentStripeBackgroundDiv,function(){
			EditorHelper.addDeleteImageToColorPalette(colorsList,holder,imageHolderClass,colorOp);
			if (currentStripeBackgroundDiv.is("body")){
				$(".toggle-select-holder.bg-type-toggle").show();
			}
		});
		
		var mediaCenterOp = $("<li />").addClass("clickable sp-menu");
		mediaCenterOp.css({"background-color":XPRSHelper.presetTypes["PIC"]["COLOR"],"background-image":"url(/images/ui_icons/mediaCenterIcon.png)","background-repeat":"no-repeat","background-position":"center","background-size":"60%"}).addClass("color-option clickable media_center").attr("title", XPRSTranslator.translateText("Media Center"));
		mediaCenterOp.unbind("click").bind("click",function(e){
			e.stopPropagation();
			EditorHelper.showDraggableTabbedPanel("media-center", currentStripeBackgroundDiv);
		});
		
		
		colorsList.prepend(mediaCenterOp);
		colorsList.prepend(colorOp);
	}
	if (currentStripeBackgroundDiv.is("body") || currentStripeBackgroundDiv.is(".preview-item-links")){
		if (currentStripeBackgroundDiv.css("background-image") != "none"){
			EditorHelper.addDeleteImageToColorPalette(colorsList,currentStripeBackgroundDiv,imageHolderClass,colorOp);
			$(".toggle-select-holder.bg-type-toggle").show();
		}
		return;
	}
	if (currentStripeBackgroundDiv.attr("id") != "no-image" && allowImage){
		EditorHelper.addDeleteImageToColorPalette(colorsList,holder,imageHolderClass,colorOp);
		if (includeBgType){
			colorsList.closest(".color-list-holder").find(".more.color-picker").css("display","block");
			var currentBgClass = currentStripeBackgroundDiv.attr("class"); 
			if (typeof currentBgClass != "undefined"){
				var bgTypes = ["normal","fixed","parallax50"];
				for (t in bgTypes){
					var bgTypeOp = $("<li />").addClass("clickable sp-menu t-t half-size").text(bgTypes[t].replace("50","")).attr("id" ,bgTypes[t] + "-bg");
					if (bgTypes[t] == "normal"){
						bgTypeOp.addClass("selected");
					}
					if (currentBgClass.indexOf("parallax-bg") != -1){
						colorsList.find("#fixed-bg").addClass("selected");
						colorsList.find("#normal-bg").removeClass("selected");
					}else{
						//fix currentBgclass undefined
						if (currentBgClass.indexOf(bgTypes[t]) != -1 || (currentBgClass.indexOf(bgTypes[t].replace("50",""))) != -1){
							bgTypeOp.addClass("selected");
							colorsList.find("#normal-bg").removeClass("selected");
						}
					}
					
					
					bgTypeOp.unbind("click").bind("click",function(e){
						e.stopPropagation();
						currentStripeBackgroundDiv.css("background-position-y","")
						var clickedBgOption = $(this);
						var newBgClass = clickedBgOption.attr("id");
						clickedBgOption.siblings(".half-size").removeClass("selected");
						clickedBgOption.addClass("selected");
						currentStripeBackgroundDiv.removeClass("parallax-bg").removeClass("fixed-bg").removeClass("parallax50-bg");
						if (clickedBgOption.attr("id") != "normal-bg"){
							currentStripeBackgroundDiv.addClass(newBgClass);
						}else{
							newBgClass = ""
						}
						var stripeId = currentStripeBackgroundDiv.closest(".master.item-box").attr("id"); 
						XPRSHelper.SAFEPOST("/update_specific_child_key",{"vbid":EditorHelper.getHolderParent(currentStripeBackgroundDiv).attr("id"),"child_vbid":currentStripeBackgroundDiv.attr("id"),"updated_key":"BACKGROUND_CLASS","updated_value":newBgClass,"stripe_id":stripeId},EditorHelper.getHolderParent(currentStripeBackgroundDiv).attr("id"),"UPDATE-CHILD",function() {
						});
						SpimeEngine.handleParallax();
					});
					colorsList.closest(".color-list-holder").find("ul").append(bgTypeOp);
				}
			}
		}
	}
	
};

EditorHelper.addDeleteImageToColorPalette = function(colorsList,holder,imageHolderClass,addImageOp){
	if(colorsList.find(".delete-pic").length == 0){
		var currentStripeBackgroundDiv = holder.find(imageHolderClass).andSelf().filter(imageHolderClass)
		var deleteImageOp = $("<li />").addClass("clickable sp-menu delete-pic");
		deleteImageOp.css({"background-color":"#666","background-image":"url(/images/ui_icons/pic_delete.png)","background-repeat":"no-repeat","background-position":"center","background-size":"60%"}).addClass("color-option clickable").attr("title", XPRSTranslator.translateText("Remove Image"));
		deleteImageOp.unbind("click").bind("click",function(e){
			e.stopPropagation();
			if (holder.is("body")){
				holder.css("background-image","none");
				EditorCore.deleteSpecificStyleKey({"styleid":holder.attr("data-root-style-id"),"module":"WEBSITE_PAGE","prop":"BACKGROUND_IMAGE"});
				$(".toggle-select-holder .bg-type-toggle").show();
			}else if (holder.is(".preview-item-links")) {
				holder.css("background-image","none");
				EditorHelper.deleteSpecificStyleKey({"styleid":holder.closest(".master.item-box").attr("data-preview-styleid"),"module":"MENUFIED_PREVIEW_LINKS_HOLDER","prop":"BACKGROUND_IMAGE"});
			}else{
				currentStripeBackgroundDiv.css("background-image","");
				var parentId = holder.closest(".item-box").attr("id");
				var stripeId = holder.closest(".master.item-box").attr("id");
				XPRSHelper.SAFEPOST("/remove_child",{"parent":parentId , "child": currentStripeBackgroundDiv.attr("id"),"stripe_id":stripeId},parentId,{"action_name":"REMOVE-CHILD","pretty_name":"Remove background"},function() {
					currentStripeBackgroundDiv.attr("id","no-image");
					holder.removeClass("mark-area");
				});
			}
			//remove the delete bg btn
			$(this).remove();
		});
		addImageOp.after(deleteImageOp);
	}
};


EditorHelper.addOpacityController = function(colorsList,holder,styleid,imageHolderClass,moduleName){
	var currentStripeBackgroundDiv = holder.find(imageHolderClass).andSelf().filter(imageHolderClass);
	if (currentStripeBackgroundDiv.attr("id") != "no-image"){
		var currentLeft  = parseInt(currentStripeBackgroundDiv.css("opacity") * 100)
		var opacityOp = $("<li />").addClass("clickable more sp-menu opacity-option").append("<span class='sp-menu hide-on-hover fast-animated-opacity t-t'>OPACITY</span>");
		var opacityRail = $("<div />").attr("id","opacity").css({"position":"absolute","overflow":"hidden","width":"105px","height":"10px","margin-left": "4px","margin-top":"-14px","background-color":"#222"}).addClass("sp-menu show-on-hover fast-animated-opacity");
		opacityOp.append(opacityRail);
		var opacityHandle = $("<div>").css({"width":"5px","height":"10px","background-color":"#69AEDB","left":currentLeft}).addClass("clickable sp-menu");
		opacityRail.append(opacityHandle);
		opacityRail.unbind("click").bind("click",function(e){
			e.stopPropagation();
			var currentX = e.pageX - $(this).offset().left;
			currentX = Math.min(100,currentX);
			currentX = Math.max(0,currentX);
			
			var params = {};
			params["css_name"] = EditorHelper.StyleSettings["PROPERTIES"]["OPACITY"].css_name;
			params["class_name"] =  EditorHelper.StyleSettings["MODULES"][moduleName].CSS_CLASS;
			params["top_class"] =  EditorHelper.StyleSettings["MODULES"][moduleName].TOP_CSS_CLASS;
			params["value"] = parseFloat(currentX)/100.0;
			params["target"] = styleid;
			params["module"] = moduleName;
			EditorHelper.handleStyleChange(params);
			opacityHandle.css("left",currentX);
				var timerKey = moduleName + "_OPACITY" + styleid;
				EditorHelper.debounceSave(timerKey,function(){
					EditorHelper.updateMultipleStyleKeys({"styleid":styleid,"props":"OPACITY","values":parseFloat(currentX)/100.0,"modules":moduleName},function(){
						XPRSHelper.updateParent({"deliver_to":"parent","action":"saved"});
					});
				});
		});
		opacityHandle.draggable({
			axis: "x",
			containment: "parent",
			start: function(event , ui){
			},
			drag: function( event, ui ) {
				var params = {};
				params["css_name"] = EditorHelper.StyleSettings["PROPERTIES"]["OPACITY"].css_name;
				params["class_name"] =  EditorHelper.StyleSettings["MODULES"][moduleName].CSS_CLASS;
				params["top_class"] =  EditorHelper.StyleSettings["MODULES"][moduleName].TOP_CSS_CLASS;
				params["value"] = parseFloat(ui.position.left)/100.0;
				params["target"] = styleid;
				params["module"] = moduleName;
				EditorHelper.handleStyleChange(params);
			},
			stop: function( event, ui ) {
				var value = parseFloat(ui.position.left)/100.0;
				var timerKey = moduleName + "_OPACITY" + styleid;
				EditorHelper.debounceSave(timerKey,function(){
					EditorHelper.updateMultipleStyleKeys({"styleid":styleid,"props":"OPACITY","values":value,"modules":moduleName},function(){
						XPRSHelper.updateParent({"deliver_to":"parent","action":"saved"});
					});
				});
			},
		});
		colorsList.append(opacityOp);
	}
};


EditorHelper.addEffectsPalette = function(colorsList,holder,styleid,imageHolderClass,moduleName){
	var currentStripeBackgroundDiv = holder.find(imageHolderClass).andSelf().filter(imageHolderClass);
	var demoImage = currentStripeBackgroundDiv.css("background-image");
	var noImage = false;
	if (!demoImage){
		demoImage = "url(https://lh6.ggpht.com/n9puTBNktxh5W0nSHbI5SRgfqh2jdZ9VuXVahgg4fcY9_aQFcDsfYGVwnNQk2rUHyjkfMlTqVHLdcwwW5GE)";
		noImage = true;
	}
	if (currentStripeBackgroundDiv.attr("id") != "no-image"){
		var effects = $("<li />").addClass("clickable more sp-menu effects-btn t-t").text("FILTERS").css("overflow","hidden");
		effects.bind("click",function(e){
			e.stopPropagation();
			if (!$(this).is(".showing-effects")){
				$(this).addClass("showing-effects");
				
				if (moduleName == "PREVIEW_ICON_HOLDER") {
					EditorHelper.addIconEffectOptions(colorsList,styleid,moduleName,demoImage)
				} else {
					EditorHelper.addEffectOptions(colorsList,styleid,moduleName,demoImage)
				}
			}
		});
		colorsList.append(effects);
		if (noImage){
			colorsList.closest(".with-image-only").hide();
		}
	}
};


EditorHelper.addIconEffectOptions = function(listHolder,styleid,moduleName,demoImage,vbid){
	allEffects = EditorHelper.StyleSettings["PROPERTIES"]["ICON_EFFECTS"].values;
	for(effect in allEffects){
		var effectOp = $("<li />").addClass("clickable sp-menu").css("overflow","hidden").attr("id",allEffects[effect]);
		var effectOpInner = $("<div />").addClass("sp-menu hover_none").css({"width":"100%","height":"100%","background-image":demoImage,"background-repeat":"no-repeat","background-position":"center","background-size":"cover"});
		effectOpInner.attr("style", effectOpInner.attr("style") + "; " +  EditorHelper.StyleSettings["CSS_CHUNKS"]["ICON_EFFECTS"][allEffects[effect]]);
		effectOpInner.attr("title",EditorHelper.StyleSettings["PROPERTIES"]["ICON_EFFECTS"].value_names[effect]);
		effectOp.append(effectOpInner);
		effectOp.addClass("color-option clickable");
		effectOp.unbind("click").bind("click",function(e){
			var currentOp = $(this);
			var styleChangeParams = {};
			styleChangeParams["target"] = styleid;
			styleChangeParams["css_chunk"] = "ICON_EFFECTS",
			styleChangeParams["class_name"]=EditorHelper.StyleSettings["MODULES"][moduleName].CSS_CLASS,
			styleChangeParams["value"]= currentOp.attr("id");
			styleChangeParams["module"] = moduleName;
			styleChangeParams["vbid"] = vbid;
			EditorHelper.handleStyleChange(styleChangeParams);
			var timerKey = moduleName + "_ICON_EFFECTS" + styleid;
			EditorHelper.debounceSave(timerKey,function(){
				EditorHelper.updateMultipleStyleKeys({"styleid":styleid,"props":"ICON_EFFECTS","values":currentOp.attr("id"),"modules":moduleName,"vbid":vbid},function(){
					XPRSHelper.updateParent({"deliver_to":"parent","action":"saved"});
				});
			});
		});
		listHolder.append(effectOp);
	}
};



EditorHelper.addEffectOptions = function(listHolder,styleid,moduleName,demoImage,vbid){
	allEffects = EditorHelper.StyleSettings["PROPERTIES"]["IMAGE_EFFECT_IDLE"].values;
	for(effect in allEffects){
		var effectOp = $("<li />").addClass("clickable sp-menu").css("overflow","hidden").attr("id",allEffects[effect]);
		var effectOpInner = $("<div />").addClass("sp-menu hover_none").css({"width":"100%","height":"100%","background-image":demoImage,"background-repeat":"no-repeat","background-position":"center","background-size":"cover"});
		effectOpInner.attr("style", effectOpInner.attr("style") + "; " +  EditorHelper.StyleSettings["CSS_CHUNKS"]["IMAGE_EFFECTS"][allEffects[effect]]);
		effectOpInner.attr("title",EditorHelper.StyleSettings["PROPERTIES"]["IMAGE_EFFECT_IDLE"].value_names[effect]);
		effectOp.append(effectOpInner);
		effectOp.addClass("color-option clickable");
		effectOp.unbind("click").bind("click",function(e){
			var currentOp = $(this);
			var styleChangeParams = {};
			styleChangeParams["target"] = styleid;
			styleChangeParams["css_chunk"] = "IMAGE_EFFECTS",
			styleChangeParams["class_name"]=EditorHelper.StyleSettings["MODULES"][moduleName].CSS_CLASS,
			styleChangeParams["value"]= currentOp.attr("id");
			styleChangeParams["module"] = moduleName;
			styleChangeParams["vbid"] = vbid;
			EditorHelper.handleStyleChange(styleChangeParams);
			var timerKey = moduleName + "_IMAGE_EFFECT" + styleid;
			EditorHelper.debounceSave(timerKey,function(){
				EditorHelper.updateMultipleStyleKeys({"styleid":styleid,"props":"IMAGE_EFFECT_IDLE","values":currentOp.attr("id"),"modules":moduleName,"vbid":vbid},function(){
					XPRSHelper.updateParent({"deliver_to":"parent","action":"saved"});
				});
			});
		});
		listHolder.append(effectOp);
	}
};

EditorHelper.addCropOption = function(colorsList,holder,imageHolderClass){
	var currentBackgroundDiv = holder.find(imageHolderClass).andSelf().filter(imageHolderClass);
	if (currentBackgroundDiv.attr("id") != "no-image"){
		var cropOp = $("<li />").addClass("clickable more sp-menu t-t").text("CROP");
		cropOp.bind("click",function(e){
			e.stopPropagation();
			EditorHelper.startCropMode(currentBackgroundDiv);
			EditorHelper.closeLeftClickMenu()
		});
		colorsList.append(cropOp);
	}
}

EditorHelper.deleteSpecificStyleKey = function(params,callbackFunc){
	XPRSHelper.SAFEPOST("/delete_specific_style_key",params,params.style_holder, "DELETE-" + params.prop,callbackFunc);
};


EditorHelper.widthSwitcherClick = function(btn,stripe){
	var stripeWrapper = stripe.find(".item-wrapper").first();
	var currentWidth = stripeWrapper.css("max-width").replace("px","");
	var vbid =  EditorHelper.getHolderId(stripe);
	var parentVbid = EditorHelper.getHolderId(EditorHelper.getParent(stripe));
	var newWidth = EditorHelper.PAGE_WIDTH;
	if (btn.attr("id") == "boxed-section"){
		//we should change to 980
		EditorHelper.ChangeStripeMaxWidth(stripe,EditorHelper.PAGE_WIDTH + "px");
	}else{
		EditorHelper.ChangeStripeMaxWidth(stripe,"none");
		newWidth = "none";
	}
	stripe.attr("data-width-resize","true");
	SpimeEngine.ArrangeHolder(stripe);
	stripe.removeAttr("data-width-resize");
	EditorHelper.updateStripeData({"vbid":vbid,"parent_vbid":parentVbid,"updated_key":"MAX_WIDTH","updated_value":newWidth,"module_name":"WRAPPER"});
	
	var newItemsMinWidth = stripe.attr("data-items-min-width");
	if (typeof newItemsMinWidth != "undefined"){
		var holderStyleId = stripe.attr("data-styleid");
		EditorHelper.updateStyleData({"vbid":vbid,"parent_vbid":parentVbid,"updated_key":"ARRANGER_ITEM_MIN_WIDTH","updated_value":newItemsMinWidth,"module_name":"GALLERY_PREVIEW","style_id":holderStyleId,"stripe_id":stripe.attr("id")});
	}
};

EditorHelper.initRawSettings = function(currentSwitchingPanel,clickedElement){
	var classHolder = clickedElement.closest(".page-raw-cover");
	if (classHolder.is(".dynamic-height")){
		currentSwitchingPanel.find("#dynamic-height").addClass("selected");
	}else{
		currentSwitchingPanel.find("#centered").addClass("selected");
	}
	currentSwitchingPanel.find(".toggle-option").unbind("click").bind("click",function(e){
		e.stopPropagation();
		classHolder.removeClass("dynamic-height centered").addClass($(this).attr("id"));
		$(this).siblings().removeClass("selected");
		$(this).addClass("selected");
		var stripeId = clickedElement.closest(".master.item-box").attr("id");
		XPRSHelper.SAFEPOST("/update_element_content",{element_id :clickedElement.attr("id") ,parent_id:EditorHelper.getPageId(),prop_name:"CLASS",prop_value:$(this).attr("id"),"stripe_id":stripeId},EditorHelper.getPageId(),"UPDATE-CHILD");
	});
};

EditorHelper.initRawOtherApps = function(currentSwitchingPanel,clickedElement){
	currentSwitchingPanel.find(".selected").removeClass("selected");

	var inlineListBtn = currentSwitchingPanel.find("#inline-widgets");
	var mediaListBtn = currentSwitchingPanel.find("#media-widgets");
	if (clickedElement.attr("data-menu-name") == "PREVIEW_INLINE_RAW"){
		inlineListBtn.addClass("selected");
	}else{
		mediaListBtn.addClass("selected");
	}
	var stripe = clickedElement.closest(".master.item-box");
	inlineListBtn.add(mediaListBtn).click(function(){
		var clickedBtn =  $(this);
		if (!clickedBtn.is("selected")){
			var parent = clickedElement.closest(".item-box");
			if (clickedElement.attr("data-menu-name") == "PREVIEW_INLINE_RAW"){
				var removeMe = false;
				if (clickedElement.find("#temp-raw-placeholder").length > 0 ){
					removeMe = clickedElement.attr("id");
					EditorHelper.handleDelete({"vbid":removeMe});
				}
				var otherWidget = parent.find("[data-menu-name='PREVIEW_RAW']").last();
				if (otherWidget.length == 0){ 
					EditorHelper.adddEl("RAW","PREVIEW_RAW",parent,parent,function(otherWidget){
						EditorHelper.showDraggableTabbedPanel("inline-raw-edit",otherWidget, {"selected-tab":"raw-other-apps"});
						setTimeout(function(){
							if (removeMe){
								var stripeId = stripe.attr("id");
								XPRSHelper.SAFEPOST("/remove_child",{"parent":parent.attr("id") , "child": removeMe,"stripe_id":stripeId},stripe.attr("id"),{"action_name":"REMOVE-CHILD","pretty_name":"Remove PREVIEW_INLINE_RAW"},function() {
								});
							}
						},2500);
					});
				}
			}else{
				var removeMe = false;
				if (clickedElement.find("#temp-raw-placeholder").length > 0 ){
					removeMe = clickedElement.attr("id");
					EditorHelper.handleDelete({"vbid":removeMe});
				}
				var otherWidget = parent.find("[data-menu-name='PREVIEW_INLINE_RAW']").last();
				if (otherWidget.length == 0){ 
					EditorHelper.adddEl("INLINE_RAW","PREVIEW_INLINE_RAW",parent,parent,function(otherWidget){
						EditorHelper.showDraggableTabbedPanel("inline-raw-edit",otherWidget, {"selected-tab":"raw-other-apps"});
						setTimeout(function(){
							if (removeMe){
								var stripeId = stripe.attr("id");
								XPRSHelper.SAFEPOST("/remove_child",{"parent":parent.attr("id") , "child": removeMe,"stripe_id":stripeId},stripe.attr("id"),{"action_name":"REMOVE-CHILD","pretty_name":"Remove PREVIEW_RAW"},function() {
								});
							}
						},2500);

					});
				}
		}
		if (otherWidget.length > 0){
			EditorHelper.showDraggableTabbedPanel("inline-raw-edit",otherWidget, {"selected-tab":"raw-other-apps"});
		}
		}
	});
	
	currentSwitchingPanel.find(".toggle-option").each(function(){
		var currentToggle = $(this);
		var appName = currentToggle.attr("id");
		if (clickedElement.hasClass("stripe_" + appName) ){
			currentToggle.addClass("selected");
			var removeBtn = $("<span />").addClass("remove-widget").text(" (remove)").click(function(e){
				e.stopPropagation();
				var presetType = stripe.attr("data-preset-type-id");
				var btnElementType = "PREVIEW_RAW";
				if (inlineListBtn.is(".selected")){
					btnElementType = "PREVIEW_INLINE_RAW";
				}
				var elementToDelete = stripe.find("[data-menu-name='"+btnElementType+"']").last();
				var parentOfElementId = stripe.attr("id");
				if (XPRSHelper.inPresetGroup(presetType,"SLIDESHOWS")){
					var visibleItem = stripe.find(".sub.item-box[data-visible='visible']");
					elementToDelete = visibleItem.find("[data-menu-name='"+btnElementType+"']").last();
					parentOfElementId = visibleItem.attr("id");
				}
				var vbid = elementToDelete.attr("id");
				EditorHelper.handleDelete({"vbid":vbid});
				var stripeId = stripe.attr("id");
				XPRSHelper.SAFEPOST("/remove_child",{"parent":parentOfElementId , "child": vbid,"stripe_id":stripeId},stripe.attr("id"),{"action_name":"REMOVE-CHILD","pretty_name":"Remove " + btnElementType},function() {
				});
				EditorHelper.closeDraggableTabbedPanel();
			});
			currentToggle.find(".app-name").append(removeBtn)
		}
	});
	if (!clickedElement.hasClass('page-app')) {
		currentSwitchingPanel.closest(".raw-edit , .inline-raw-edit").find("[data-relevant-panel='raw-other-apps']").show();
		currentSwitchingPanel.find(".stripe-apps-toggle .toggle-option").unbind("click").bind("click",function(){
			if($(this).hasClass("selected")) {
					var relevantDraggableTabbedPanel = currentSwitchingPanel.closest(".draggable-tabbed-panel-wrapper");
					EditorHelper.showTab(relevantDraggableTabbedPanel.find(".panel-selector-tab[data-relevant-panel='raw-parameters']"),relevantDraggableTabbedPanel)
			} else {

				$(this).addClass("selected");
				$(this).siblings().removeClass("selected");

				var appKind = $(this).attr('id');
				var appName = appKind.replace("_app", "");

				var newContentId = EditorHelper.shortUuid("static");
				var stripeId = clickedElement.closest(".master.item-box").attr("id");
				clickedElement.attr('class',function(i, c){return c.replace(/(^|\s)stripe_\S+/g, '');});
				clickedElement.removeClass("custom");
				clickedElement.addClass("stripe_"+appKind);
				clickedElement.find(".preview-raw-container").attr("data-raw-content-url","/html_src/" + newContentId);
				XPRSHelper.SAFEPOST("/update_multiple_child_keys",{"vbid":EditorHelper.getHolderParent(clickedElement).attr("id"),"child_vbid":clickedElement.attr("id"),"updated_keys":"TYPE|URL","updated_values":"stripe_"+appKind+"|/html_src/" + newContentId,"stripe_id":stripeId},EditorHelper.getHolderParent(clickedElement).attr("id"),"UPDATE-CHILD",function() {
					
				});
				XPRSHelper.POST("/update_html_src", {content_id:newContentId,content:'',from_template:appName,"element_id":clickedElement.attr("id")}, function(){
					setTimeout(function(){
						SpimeEngine.initRawHTML(clickedElement.find(".preview-raw-container"),true);
							EditorHelper.showDraggableTabbedPanel("inline-raw-edit",clickedElement, {"selected-tab":"raw-parameters"});
					},300);
				});
				
				var styleid = clickedElement.closest(".master.item-box").attr("data-preview-styleid");
				if (appKind.indexOf("inline") == -1){
					EditorHelper.resetPreviewInlineImageEffects(styleid);
				}
			}
		});
	}
}


EditorHelper.resetPreviewInlineImageEffects = function(styleid){
	EditorHelper.UpdateRealTimeStyle(styleid,"PREVIEW_INLINE_IMAGE","OPACITY",1);
	EditorHelper.UpdateRealTimeStyle(styleid,"PREVIEW_INLINE_IMAGE","PREVIEW_IMAGE_POSITION","center center");
	EditorHelper.UpdateRealTimeStyle(styleid,"PREVIEW_INLINE_IMAGE","PREVIEW_IMAGE_SIZE","cover");
	EditorHelper.UpdateRealTimeStyle(styleid,"PREVIEW_INLINE_IMAGE","IMAGE_SHAPE","square");
	var styleChangeParams = {};
	styleChangeParams["target"] = styleid;
	styleChangeParams["css_chunk"] = "IMAGE_EFFECTS",
	styleChangeParams["class_name"]=EditorHelper.StyleSettings["MODULES"]["PREVIEW_INLINE_IMAGE"].CSS_CLASS,
	styleChangeParams["value"]= "normal";
	styleChangeParams["module"] = "PREVIEW_INLINE_IMAGE";
	EditorHelper.handleStyleChange(styleChangeParams);
	EditorHelper.UpdateServerStyle(styleid,"PREVIEW_INLINE_IMAGE|PREVIEW_INLINE_IMAGE|PREVIEW_INLINE_IMAGE|PREVIEW_INLINE_IMAGE|PREVIEW_INLINE_IMAGE","OPACITY|PREVIEW_IMAGE_POSITION|PREVIEW_IMAGE_SIZE|IMAGE_SHAPE|IMAGE_EFFECT_IDLE","1.0-FLOAT|center center|cover|square|normal");
}


EditorHelper.initRawParameters = function(currentSwitchingPanel,clickedElement){
	var url = clickedElement.find(".raw-container, .preview-raw-container").attr("data-raw-content-url");
	var htmlCode;
	
	XPRSHelper.GET(url,{},function(html){
		if (currentSwitchingPanel.closest(".block-script").length > 0){
			htmlCode = SpimeEngine.unescapeHtml(html);
		}else{
			htmlCode = html;
		}
		
		var appSettings = $('<div/>').html(htmlCode);
		appSettings = appSettings.find("#app_settings");
		appSettings.css("display","block");
		
		if (typeof extraAppOptions == 'function') { 
			setTimeout(function(){
				extraAppOptions(); 
			},300);
		}

		EditorHelper.tanslatePopupSettings(appSettings);
		
		//populate the input values
		appSettings.find("input, select, textarea").each(function() {

			var paramName = $(this).attr("name");

			var regExPattern = escapeRegExp('/*<{*/') + escapeRegExp(paramName) + escapeRegExp('/*}*/') + '.*' + escapeRegExp('/*{*/') + '(.*)' + escapeRegExp('/*}>*/');
			var re = new RegExp(regExPattern, 'g');
			var matches = re.exec(htmlCode);
			
			if (matches != null && matches.length > 0) {
				newValue = matches[1];
				newValue = newValue.replace(/^('|")(.*)('|")$/, '$2');

				if($(this).attr("type") == "checkbox") {
					
					if($(this).attr("id")) {
						var arrayValues = JSON.parse(newValue);
						currValue = $(this).attr("id");
						var i = arrayValues.indexOf(currValue);
						
						if(i == -1) {
							$(this).prop('checked', false);
						} else {
							$(this).prop('checked', true); 
						}
						
					} else {

						if (newValue == 'true') {
							$(this).prop('checked', true); 
						} else {
							$(this).prop('checked', false); 
						}
					}
					
				} else {
	
					$(this).val(newValue);
					
					if ($(this).prop('tagName') == "SELECT") {
						$(this).find("option:selected").prop('selected','selected');
					}
				}
			}
		});
		if (XPRSHelper.getBrowser().toLowerCase().indexOf("chrome") == -1){
			currentSwitchingPanel.find("input").click(function(){$("body").enableSelection();$(this).focus()});
		}
		
		currentSwitchingPanel.prepend(appSettings);
	});
	var currentApp = currentSwitchingPanel.closest(".draggable-tabbed-panel-wrapper").find(".toggle-option.app.selected").attr("id");
		if (!currentApp){
			currentApp = clickedElement.attr("data-app-name");
		}
		if (!currentApp){
			if (clickedElement.is(".page_stripe_popup_app")){
				currentApp = "popapp"
			}
		}
	if (currentApp == "popapp"){
		var removeBtn = $("<div class='remove-popup-btn'>REMOVE</div>");
		removeBtn.click(function(e){
			e.stopPropagation();
			EditorHelper.removePopupApp();
		})
		currentSwitchingPanel.find("#update-html").after(removeBtn)
	}

	currentSwitchingPanel.find("#update-html").unbind("click").bind("click",function(){
		var btnHolder = $(this);
		btnHolder.addClass("loading-state");
		//parse the template values into the code.
		var specificAppId = EditorHelper.shortUuid("app");
		htmlCode = htmlCode.replace("id-placeholder",clickedElement.attr("id") + "-" + specificAppId);
		htmlCode = htmlCode.replace("id-placeholder",clickedElement.attr("id") + "-" + specificAppId);
		currentSwitchingPanel.find("input, select, textarea").each(function() {
			var paramName = $(this).attr("name");
			var paramVal = $(this).val();
			var regExPattern = '(' + escapeRegExp('/*<{*/') + escapeRegExp(paramName) + escapeRegExp('/*}*/') + '.*' + escapeRegExp('/*{*/') + ')(.*)(' + escapeRegExp('/*}>*/') + ')';
			var re = new RegExp(regExPattern, 'g');
			
			if($(this).attr("type") == "checkbox") {
				
				if($(this).attr("id")) {
					var matches = re.exec(htmlCode);
					var arrayValues = JSON.parse(matches[2]);
					
					currValue = $(this).attr("id");
					
					var i = arrayValues.indexOf(currValue);
					if($(this).prop("checked")) {
						if(i == -1) {
							arrayValues.push(currValue);
						}
					} else {
						if(i != -1) {
							arrayValues.splice(i, 1);
						}
					}
					
					htmlCode = htmlCode.replace(re,'$1' +JSON.stringify(arrayValues)+ '$3');
				} else {
					chcekBoxValue = false;
					if($(this).prop("checked")) {
						chcekBoxValue = true;
					} 
					
					htmlCode = htmlCode.replace(re,'$1' +chcekBoxValue+ '$3');
				}
				
			} else {
			
				if($(this).attr("type") == "number") {
					htmlCode = htmlCode.replace(re,'$1' +paramVal+ '$3');
				} else {
					htmlCode = htmlCode.replace(re,'$1"' +paramVal+ '"$3');
				}
			}
		});

		var contentToSave = htmlCode;
		var newContentId = EditorHelper.shortUuid("static");
		clickedElement.find(".raw-container, .preview-raw-container").attr("data-raw-content-url","/html_src/" + newContentId);
		var stripeId = clickedElement.closest(".master.item-box").attr("id");
		XPRSHelper.SAFEPOST("/update_multiple_child_keys",{"vbid":EditorHelper.getHolderParent(clickedElement).attr("id"),"child_vbid":clickedElement.attr("id"),"updated_keys":"URL","updated_values":"/html_src/" + newContentId,"stripe_id":stripeId},EditorHelper.getHolderParent(clickedElement).attr("id"),"UPDATE-CHILD",function() {
			
		});
		
		var currentElementId = clickedElement.attr("id");
		XPRSHelper.POST("/update_html_src", {content_id:newContentId,content:contentToSave,"element_id":currentElementId, "app":currentApp}, function(){
			setTimeout(function(){
				SpimeEngine.initRawHTML(clickedElement.find(".raw-container, .preview-raw-container"),true, function(){
					btnHolder.removeClass("loading-state");
					
					if($('.raw-edit.shown .popup-form-settings-panel').length > 0){

						var DOMContentLoaded_event = document.createEvent("Event");
						DOMContentLoaded_event.initEvent("xprs-app-loaded", true, true);
						window.document.dispatchEvent(DOMContentLoaded_event);
					}

				});
				
			},300);
		});
		
	});
};


EditorHelper.tanslatePopupSettings = function(divToTranslate){
	var selectorsToTranslate = ["#selectTemplateButton span",".app_text_label"]
	for (i in selectorsToTranslate){
		var elementToTranslate = divToTranslate.find(selectorsToTranslate[i])
		elementToTranslate.each(function(){
			$(this).text(XPRSTranslator.translateText($(this).text()))
		});
		
	}
};

function escapeRegExp(str) {
	  return str.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g, "\\$&");
}

EditorHelper.initLayoutSwitcher = function(panel,stripe){
	var helperDiv = stripe.find(".sub.item-box:not(.stripe-header) .helper-div");
	//This is a signle item
	if (helperDiv.length == 0){
		helperDiv = stripe.find(".helper-div");
	}
	var currentHelperDivClass = helperDiv.attr("class").replace("helper-div","").trim();
	var layoutListHolder = $("<div />").addClass("layout-list-holder top-layer");
	var layoutList = $("<ul/>").addClass("sp-menu");
	layoutListHolder.append(layoutList);
	panel.find(".layout-switcher-placeholder").replaceWith(layoutListHolder);
	var helperDivClasses = ["middle-left","middle-center","middle-right","top-center","bottom-center","middle-right-25","middle-left-25"];
	for (i in helperDivClasses){
		var layoutOp = $("<li />").addClass("layout-option").attr("id",helperDivClasses[i])
		if (helperDivClasses[i] != "blank"){
			layoutOp.css("background-image","url(/images/ui_icons/layout-"+helperDivClasses[i].replace("_","-")+".png?v=1)").addClass("clickable");
		}else{
			layoutOp.addClass("blank-op");
		}
		if (currentHelperDivClass == helperDivClasses[i]){
			layoutOp.addClass("selected");
		}
		layoutOp.not(".blank-op").unbind("click").bind("click",function(e){
			e.stopPropagation();
			var currentOP = $(this);
			helperDiv = stripe.find(".sub.item-box:not(.stripe-header) .helper-div");
			if (helperDiv.length == 0){
				helperDiv = stripe.find(".helper-div");
			}
			
			 helperDiv.find(".pic-side").css("margin-left", "" );
			 helperDiv.find(".pic-side").css("top", "" );
			 helperDiv.find(".pic-side").css("width",  "" );
			 helperDiv.find(".pic-side").css("height","" );
			
			currentHelperDivClass = helperDiv.attr("class").replace("helper-div","").trim();
			currentOP.siblings().removeClass("selected");
			currentOP.addClass("selected");
			for (var j in helperDivClasses){
				helperDiv.removeClass(helperDivClasses[j]);
			}
			helperDiv.addClass($(this).attr("id"));
			helperDiv.attr("data-orig-class",$(this).attr("id"));
			
			var selectedClass = currentOP.attr("id");
			var selectedVerticalAlign = selectedClass.split("-")[0];
			var selectedTextAlign = selectedClass.split("-")[1];
			var layoutInnerTextAlign = selectedTextAlign;
			var layoutOuterTextAlign = selectedTextAlign;
			var layoutVerticalAlign = selectedVerticalAlign;
			var modules = "ITEM_PREVIEW"//|PREVIEW_CONTENT_HOLDER|PREVIEW_CONTENT_WRAPPER|PREVIEW_CONTENT_WRAPPER";
			var props = "LAYOUT_CLASS"//|ALIGN|VERTICAL_ALIGN|ALIGN";
			var values = selectedClass// + "|" + layoutInnerTextAlign + "|" + layoutVerticalAlign + "|" + layoutInnerTextAlign;
			var styleid = stripe.attr("data-styleid");
			if (typeof styleid == "undefined"){
				styleid = stripe.attr("data-preview-styleid");
			}
			
			var affectedContainers = $("." + styleid);
			SpimeEngine.ArrangeHolder(EditorHelper.getHolderParent(affectedContainers.first()));
			SpimeEngine.ArrangeHolder(affectedContainers);
			
			var currentContainer = stripe.find(".sub.container");
			if (currentContainer.length == 0){
				SpimeEngine.initLayout(stripe.find(".item-wrapper"),".item-content");
				SpimeEngine.applyLayout(stripe.find(".item-wrapper"),".item-content");
			}else{
				SpimeEngine.initLayout(currentContainer,".item-box");
				SpimeEngine.applyLayout(currentContainer,".item-box");
				SpimeEngine.evenItemsHeights(currentContainer);
			}
			
			var timerKey = "ITEM_PREVIEW_LAYOUT_CLASS_" + styleid;
			EditorHelper.debounceSave(timerKey,function(){
				EditorHelper.UpdateServerStyle(styleid,modules,props,values,"",stripe.attr("id"));
			});
		});
		layoutList.append(layoutOp);
	}

	var alignListHolder = $("<div />").addClass("layout-list-holder top-layer");
	var alignList = $("<ul/>").addClass("sp-menu");
	alignListHolder.append(alignList);
	panel.find(".align-switcher-placeholder").replaceWith(alignListHolder);
	EditorHelper.addAlignOptions(alignList, stripe);
	alignListHolder.show();
	layoutListHolder.show();
};



EditorHelper.addAlignOptions = function(layoutList,stripe){
	var horizontalAligns = ["left","center","right"];
	var currenthorizontalAlign = stripe.find(".preview-content-holder").css("text-align");
	if (stripe.find(".preview-content-holder").length == 0){
		currenthorizontalAlign = stripe.find(".blocks-preview-content-holder").css("text-align");
	}
	for (i in horizontalAligns){
		var layoutOp = $("<li />").addClass("layout-option hor clickable").attr("id",horizontalAligns[i]).css("background-image","url(/images/ui_icons/align_" + horizontalAligns[i] + "_ico.png?v=1)");
		if (currenthorizontalAlign == horizontalAligns[i]){
			layoutOp.addClass("selected");
		}
		layoutOp.unbind("click").bind("click",function(e){
			e.stopPropagation();
			var clickedAlignBtn = $(this);
			clickedAlignBtn.siblings(".hor").removeClass("selected");
			clickedAlignBtn.addClass("selected");
			var styleid = stripe.attr("data-styleid");
			if (typeof styleid == "undefined"){
				styleid = stripe.attr("data-preview-styleid");
			}
			var uniqueStyleVbid;
			if (stripe.find(".flex").length > 0){
				uniqueStyleVbid = stripe.find(".sub.item-box[data-visible='visible']").attr("id");
			}
			var modules = "PREVIEW_CONTENT_HOLDER|PREVIEW_CONTENT_WRAPPER";
			if (stripe.attr("data-preset-type-id") == "ARTICLE"){
				modules = "BLOCKS_PREVIEW_CONTENT_HOLDER|BLOCKS_PREVIEW_CONTENT_WRAPPER";
			}
			EditorHelper.UpdateRealTimeStyle(styleid,modules,"ALIGN|ALIGN", clickedAlignBtn.attr("id"), uniqueStyleVbid);
			var props = "ALIGN|ALIGN";
			var values = clickedAlignBtn.attr("id") + "|" + clickedAlignBtn.attr("id");
			if (uniqueStyleVbid){
				uniqueStyleVbid = uniqueStyleVbid + "|" + uniqueStyleVbid;
			}

			var timerKey = "PREVIEW_CONTENT_HOLDER_ALIGN_" + styleid;
			EditorHelper.debounceSave(timerKey,function(){
				EditorHelper.updateMultipleStyleKeys({"styleid":styleid,"props":props,"values":values,"modules":modules,"vbid":uniqueStyleVbid},function(){
					XPRSHelper.updateParent({"deliver_to":"parent","action":"saved"});
				});
			});
		});
		layoutList.append(layoutOp);
	}
	
	if (stripe.attr("data-preset-type-id") != "ARTICLE"){
		var verticalAligns = ["bottom","middle","top"];
		var currentverticalAligns = stripe.find(".preview-content-wrapper").css("vertical-align");
		for (i in verticalAligns){
			var layoutOp = $("<li />").addClass("layout-option ver clickable ").attr("id",verticalAligns[i]).css("background-image","url(/images/ui_icons/align_" + verticalAligns[i] + "_ico.png?v=1)");
			if (currentverticalAligns == verticalAligns[i]){
				layoutOp.addClass("selected");
			}
			layoutOp.unbind("click").bind("click",function(e){
				e.stopPropagation();
				var clickedAlignBtn = $(this);
				clickedAlignBtn.siblings(".ver").removeClass("selected");
				clickedAlignBtn.addClass("selected");
				var params = {};
				var styleid = stripe.attr("data-styleid");
				if (typeof styleid == "undefined"){
					styleid = stripe.attr("data-preview-styleid");
				}
				params["css_name"] = EditorHelper.StyleSettings["PROPERTIES"]["VERTICAL_ALIGN"].css_name;
				params["class_name"] =  EditorHelper.StyleSettings["MODULES"]["PREVIEW_CONTENT_WRAPPER"].CSS_CLASS;
				params["units"] = EditorHelper.StyleSettings["PROPERTIES"]["VERTICAL_ALIGN"].units;
				params["value"] = clickedAlignBtn.attr("id");
				params["target"] = styleid;
				params["module"] = "PREVIEW_CONTENT_WRAPPER";
				EditorHelper.handleStyleChange(params);
				var timerKey = "PREVIEW_CONTENT_WRAPPER_VERTICAL_ALIGN_" + styleid;
				EditorHelper.debounceSave(timerKey,function(){
					EditorHelper.updateMultipleStyleKeys({"styleid":styleid,"props":"VERTICAL_ALIGN","values":clickedAlignBtn.attr("id"),"modules":"PREVIEW_CONTENT_WRAPPER"},function(){
						XPRSHelper.updateParent({"deliver_to":"parent","action":"saved"});
					});
				});
			});
			layoutList.append(layoutOp);
		}
	}
};

EditorHelper.alignSwitcherClick = function(btn,stripe,clickedElement){
	var uniqueStyleVbid;
	var contentBoxes = stripe.find(".preview-content-wrapper");
	var contentHolders = stripe.find(".preview-content-holder");
	if (stripe.find(".flex").length > 0){
		contentBoxes= stripe.find(".sub.item-box[data-visible='visible'] .preview-content-wrapper");
		contentHolders= stripe.find(".sub.item-box[data-visible='visible'] .preview-content-holder");
		uniqueStyleVbid = stripe.find(".sub.item-box[data-visible='visible']").attr("id");
	}
	var holderModule =  "PREVIEW_CONTENT_HOLDER";
	var wrapperModule =  "PREVIEW_CONTENT_WRAPPER";
	
	if (clickedElement){
		var blocksLayout = clickedElement.closest(".blocks_layout");
		if (blocksLayout.length > 0){
			contentBoxes = blocksLayout.find(".blocks-preview-content-wrapper");
			contentHolders= blocksLayout.find(".blocks-preview-content-holder");
			holderModule = "BLOCKS_PREVIEW_CONTENT_HOLDER";
			wrapperModule = "BLOCKS_PREVIEW_CONTENT_WRAPPER";
		}
	}
	
	if (contentBoxes.length > 0){
		var alignOptions = [{"box":"left","text":"left"},{"box":"center","text":"left"},{"box":"center","text":"center"},{"box":"center","text":"right"},{"box":"right","text":"right"}];
		if (stripe.find(".flex").length > 0 && stripe.find(".helper-div.middle-center").length > 0){
			alignOptions = [{"box":"left","text":"left"},{"box":"left","text":"center"},{"box":"left","text":"right"},
			                {"box":"center","text":"left"},{"box":"center","text":"center"},{"box":"center","text":"right"},
			                {"box":"right","text":"left"},{"box":"right","text":"center"},{"box":"right","text":"right"}];
		}
		var currentBoxAlign = contentBoxes.css("text-align");
		var currentTextAlign = contentHolders.css("text-align");
		var i = 0;
		for(i in alignOptions){
			if (alignOptions[i]["box"] == currentBoxAlign && alignOptions[i]["text"] == currentTextAlign){
				break;
			}
		}
		i++;
		if (i == alignOptions.length ){
			i = 0;
		}
		
		var styleIdHolder = stripe.find(".container");
		if (styleIdHolder.length == 0){
			styleIdHolder = stripe.find(".item-content");
		}
		var styleid = styleIdHolder.attr("data-preview-style");

		EditorHelper.UpdateRealTimeStyle(styleid,holderModule,"ALIGN", alignOptions[i]["text"], uniqueStyleVbid);
		EditorHelper.UpdateRealTimeStyle(styleid,wrapperModule,"ALIGN", alignOptions[i]["box"], uniqueStyleVbid);
		
		var timerKey = "PREVIEW_CONTENT_WRAPPER_ALIGN_" + styleid;
		EditorHelper.debounceSave(timerKey,function(){
			EditorHelper.updateMultipleStyleKeys({"styleid":styleid,"props":"ALIGN|ALIGN","values":alignOptions[i]["box"] + "|" + alignOptions[i]["text"],"modules":wrapperModule + "|" + holderModule,"vbid":uniqueStyleVbid + "|" + uniqueStyleVbid},function(){
				XPRSHelper.updateParent({"deliver_to":"parent","action":"saved"});
			});
		});
		
	}else if(stripe.is(".element-box")){
		//inline elements
		var alignOptions = ["left","center","right"];
		var textHolder = stripe.find(".text-element").parent();
		var currentTextAlign = textHolder.css("text-align");
		var i = 0;
		for(i in alignOptions){
			if (alignOptions[i]== currentTextAlign){
				break;
			}
		}
		i++;
		if (i == alignOptions.length ){
			i = 0;
		}
		textHolder.css("text-align",alignOptions[i]);
		var styleid = stripe.attr("data-styleid");
		if (typeof styleid == "undefined"){
			styleid = stripe.attr("data-preview-styleid");
		}
		var module = textHolder.attr("class").replace("-","_").toUpperCase();
		var timerKey = module + "_" + styleid;
		EditorHelper.debounceSave(timerKey,function(){
			EditorHelper.updateMultipleStyleKeys({"styleid":styleid,"props":"ALIGN","values":alignOptions[i],"modules":module},function(){
				XPRSHelper.updateParent({"deliver_to":"parent","action":"saved"});
			});
		});
	}
};

EditorHelper.debounceSave = function(timerKey,callbackFunc,interval){
	if (typeof interval == "undefined"){
		interval = 1000;
	}
	if (timerKey in EditorHelper.saveTimers){
		clearTimeout(EditorHelper.saveTimers[timerKey]);
	}
	EditorHelper.saveTimers[timerKey] = setTimeout(function(){
		callbackFunc();
		XPRSHelper.updateParent({"deliver_to" : "parent","action" : "saved"});
		delete EditorHelper.saveTimers[timerKey]; 
	},interval);
};



EditorHelper.reloadErredStripes = function(){
		var erredContainers = $(".erred-stripe");
		if (erredContainers.length > 0 ){
			console.log("found " + $(".erred-stripe").length  + " erred stripes")
			erredContainers.each(function(){
				var erredStripe = $(this).closest(".master.item-box");
				var erredStripeId = erredStripe.attr("id");
				if (typeof erredStripeId == "undefined" || typeof erredStripeId == "no-child"){
					setTimeout(function(){
						//top.location.reload();
					},5000);
				}else{
					EditorHelper.reloadErredStripe(erredStripe);
				}
			});
		}
};


EditorHelper.reloadErredStripe = function(erredStripe){
	var erredStripeId = erredStripe.attr("id");
	var stripeReloadCounter = erredStripe.attr("reload-counter") ? parseInt(erredStripe.attr("reload-counter")) : 0;
	if (typeof stripeReloadCounter == "undefined") stripeReloadCounter = 0;
	if (stripeReloadCounter < EditorHelper.MAX_RELOAD_TIMES){
		EditorHelper.reloadPart({"vbid":erredStripeId},function(){
			console.log("after reload of " + erredStripeId)
			var errorIndicator = erredStripe.find(".erred-stripe").length > 0;
			if (errorIndicator){
				console.log("still errors in " + erredStripeId)
				erredStripe.attr("reload-counter",stripeReloadCounter + 1);
				setTimeout(function(){
					EditorHelper.reloadErredStripe(erredStripe);
				},6000);
			} else{
				erredStripe.removeAttr("reload-counter");
			}
		});
	}else{
		XPRSHelper.POST("/log", {"log_info":"max reloads for " + erredStripeId ,"log_type":"stripe_error","url":XPRSHelper.getParentWindow().href});
		console.log("max reloads for " + erredStripeId)
	}
};

EditorHelper.reloadStyle = function(erredStyle,timeout){
	if (typeof timeout == "undefined"){
		timeout = 3000;
	}
	setTimeout(function(){
	var erredStyleDom = $(erredStyle);
	var styleReloadCounter = erredStyleDom.attr("reload-counter") ? parseInt(erredStyleDom.attr("reload-counter")) : 0;
	var styleToReloadId = erredStyleDom.attr("id");
	if (styleReloadCounter < EditorHelper.MAX_RELOAD_TIMES){
		if (typeof styleToReloadId != "undefined"){
			console.log("failed to load style " + styleToReloadId )
			var oldHref = erredStyleDom.attr("href");
			var styleLink =  $('<link rel="stylesheet" type="text/css" />').attr('href', oldHref).attr("id",styleToReloadId).attr("reload-counter",styleReloadCounter + 1).error(function(){
				EditorHelper.reloadStyle(this,timeout * 2);
			});
			$('head').append(styleLink);
			setTimeout(function(){
				var relevantStripes = $("." + styleToReloadId).closest(".master.item-box");
				relevantStripes.each(function(){
					var relevantStripe = $(this);
					var erredStripeId = relevantStripe.attr("id");
					EditorHelper.reloadPart({"vbid":erredStripeId});
				});
			},5000);
		}
	}
	},timeout);
};


EditorHelper.getTypeOf = function(item){
	var itemType = "";
	if (item.is(".master.item-box")){
		itemType ="stripe";
	}
	if (item.is(".sub.item-box")){
		itemType = "item-preview";
	}
	if (item.is(".preview-element")){
		itemType = "element-preview";
	}
	if (item.is(".master.container")){
		itemType = "page";
	}
	return itemType;
};


EditorHelper.initPresetMenu = function(){
	EditorHelper.presetIndex = 0;
	var menuDom = $("<div/>").attr("id","add-stripe-menu").addClass("shown");
	var noButtonsCreated = true;
	var buttonsCreated = {};
	var presetTabHolder = $("<ul />").addClass("preset-tab-holder");
	presetTabHolder.append("<div id='preset-tab-marker'></div>");
	var collectionTitle = $("<div>").addClass("collection-title t-t").text("Add a new section:");
	var closeBtn = $("<div />").addClass("close-btn clickable t-t").text("CLOSE");
	
	closeBtn.unbind("close").bind("click",function(){
		EditorHelper.closeAddStripeMenu();
	});
	
	var matrixBtn = $("<div />").addClass("matrix-btn clickable");
	matrixBtn.unbind("click").bind("click",function(){
		if (EditorHelper.viewerMode == "filmStrip"){
			EditorHelper.viewerMode = "matrix";
		} else {
			EditorHelper.viewerMode = "filmStrip";
			$("#empty-stripe").css("height","");
		}
		
		EditorHelper.arrangeCoverFlow(EditorHelper.presetIndex, EditorHelper.viewerMode)
		
	});
	
	var nextPageBtn = $("<div/>").addClass("next-page-btn add-stripe-arrow clickable").attr("data-current-page",1);
	var prevPageBtn = $("<div/>").addClass("prev-page-btn add-stripe-arrow clickable").attr("data-current-page",1);
		
	nextPageBtn.add(prevPageBtn).unbind("click").bind("click",function(){
		if ((EditorHelper.presetIndex < EditorHelper.presetNumber-1) && (EditorHelper.presetIndex >= 0)){
			if ($(this).is(".prev-page-btn")){
				EditorHelper.presetIndex = EditorHelper.presetIndex - 1;
			} else {
				EditorHelper.presetIndex = EditorHelper.presetIndex + 1;
			}
			if ($(this).is(".prev-page-btn") && EditorHelper.presetIndex == -1 && $(this).attr("data-current-page") == "1"){
				EditorHelper.presetIndex = 0;
			}else{
				if ($(".selected_stripe_to_add").index() == 0 && $(this).is(".prev-page-btn")){
					var currentSelectedTab = $(this).closest("#add-menu-wrapper").find(".preset-tab.selected");
					var nextPresetToShow = currentSelectedTab.prev();
					nextPresetToShow.siblings("li").removeClass("selected");
					nextPresetToShow.addClass("selected");
					$("#preset-tab-marker").css("top", nextPresetToShow.position().top);
					EditorHelper.showPresetCollection(nextPresetToShow.attr("id"));
				}else{
					
					EditorHelper.arrangeCoverFlow(EditorHelper.presetIndex, EditorHelper.viewerMode)
				}
			}
		//No more stripes in the category
		} else {
			
			var currentPage = $(this).attr("data-current-page");
			var pageToShow = parseInt(currentPage) + 1;
			if ($(this).is(".prev-page-btn")){
				pageToShow = parseInt(currentPage) - 1;
			}else{
				EditorHelper.presetIndex = 1;
			}
			
				
				var itemsToShow = $("#add-stripe-menu .item-type-btn-wrapper[data-page='page"+ pageToShow+"']");
				if (itemsToShow.length > 0){
					if ($(this).is(".prev-page-btn")){
						EditorHelper.presetIndex = itemsToShow.length - 1;
					}
					
					var currentItems = $("#add-stripe-menu .item-type-btn-wrapper[data-page='page"+ currentPage+"']");
					currentItems.fadeOut(500,function(){
						itemsToShow.fadeIn(500).css("display","inline-block");
					});
					
				}else{
					var currentSelectedTab = $(this).closest("#add-menu-wrapper").find(".preset-tab.selected");
					var nextPresetToShow = currentSelectedTab.next()
					if ($(this).is(".prev-page-btn")){
						var nextPresetToShow = currentSelectedTab.prev();
					}
					nextPresetToShow.siblings("li").removeClass("selected");
					nextPresetToShow.addClass("selected");
					$("#preset-tab-marker").css("top", nextPresetToShow.position().top);
					EditorHelper.showPresetCollection(nextPresetToShow.attr("id"));
				}
				$(this).parent().find(".add-stripe-arrow").attr("data-current-page",pageToShow)
			
		}
		
	});
	var firstTab = null;
	
	if (EditorHelper.shortcodesJson){
		for (i in EditorHelper.shortcodesJson["CHILDREN"]){
			var currentPresetType = "UNRESOLVED";
			if ("CHILD" in EditorHelper.shortcodesJson["CHILDREN"][i]){
				currentPresetType = EditorHelper.shortcodesJson["CHILDREN"][i]["CHILD"]["TYPE"];
				if (!(currentPresetType in buttonsCreated) && currentPresetType != "FOOTERS" && currentPresetType != "MENUS"){
					buttonsCreated[currentPresetType] = true;
					if (currentPresetType in XPRSHelper.presetTypes){
						noButtonsCreated = false;
						var presetTab = $("<li />").text(XPRSHelper.presetTypes[currentPresetType].NAME).addClass("preset-tab clickable t-t");
						presetTab.attr("id",currentPresetType)
						if (Object.keys(buttonsCreated).length == 1 && firstTab == null){
							presetTab.addClass("selected");
							firstTab = presetTab;
						}
						presetTab.unbind("click").bind("click",function(){
							var currentTab = $(this);
							$("#add-menu-wrapper").removeClass("showing-elements");
							var elem = $(this);
							var offset = elem.offset().top - elem.parent().offset().top;
							
							$("#preset-tab-marker").css("top", offset);
							currentTab.siblings("li").removeClass("selected");
							currentTab.addClass("selected");
							EditorHelper.showPresetCollection($(this).attr("id"));
						});
						presetTabHolder.append(presetTab);
						
					}
				}
			}
		}
		//create items to always show

		var allowElements = (LABEL_CONFIG && "SETTINGS" in LABEL_CONFIG && LABEL_CONFIG.SETTINGS.ALLOW_ELEMENTS == "allow");
		if (allowElements){
			var elementsTab = $("<li />").text("Elements").addClass("preset-tab clickable t-t");
			elementsTab.unbind("click").bind("click",function(){
				var currentTab = $(this);
				$("#add-menu-wrapper").addClass("showing-elements");
				$("#empty-stripe").css("height","");
				currentTab.siblings("li").removeClass("selected");
				currentTab.addClass("selected");
				var collectionHolder = $("#add-stripe-menu");
				collectionHolder.empty();
				var elementsButtonsHolder = $("<div />").addClass("elements-buttons-holder");
				collectionHolder.append(elementsButtonsHolder);
				for (presetType in XPRSHelper.presetTypes){
					if (XPRSHelper.presetTypes[presetType]["GROUP"] == "ELEMENTS" && presetType != "DRAGGABLE_PIC" ){
						elementsButtonsHolder.append(EditorHelper.createAddMenuBtn(XPRSHelper.presetTypes[presetType]));
					}
				}
			});
			presetTabHolder.append(elementsTab);
		}
		
		//Create elements
	}
	
	if(noButtonsCreated){
		console.log("no buttons created...");
	}
	var menuWrapper = $("<div id='add-menu-wrapper' />").css({"display":"none"}).addClass("animated");
	menuWrapper.append(presetTabHolder);
	menuWrapper.prepend(collectionTitle).append(matrixBtn).append(closeBtn);
	menuWrapper.append(nextPageBtn).append(prevPageBtn);
	menuWrapper.append(menuDom);
	$("body").append(menuWrapper);
	
	
	//add stripe button
	$("#add-menu-wrapper").append("<div id='add_stripe_btn' class='add-stripe-arrow clickable'></div>")
	$("#add_stripe_btn").unbind("click").click(function(e){
		$(".selected_stripe_to_add").first().find(".item-type-btn-thumb").click(); //mimicks the add new stripe click
	})
	
};


EditorHelper.initAddMenu = function(){
	var menuDom = $("<div/>").attr("id","add-stripe-menu").addClass("shown").attr("data-page","page1");
	var paginationDiv = EditorHelper.generatePaginationMenu();
	var noButtonsCreated = true;
	var buttonsCreated = {};
	if (EditorHelper.shortcodesJson){
		for (i in EditorHelper.shortcodesJson["CHILDREN"]){
			var currentPresetType = "UNRESOLVED";
			if ("CHILD" in EditorHelper.shortcodesJson["CHILDREN"][i]){
				currentPresetType = EditorHelper.shortcodesJson["CHILDREN"][i]["CHILD"]["TYPE"];
				if (!(currentPresetType in buttonsCreated) && currentPresetType != "FOOTERS" && currentPresetType != "MENUS"){
					buttonsCreated[currentPresetType] = true;
					if (currentPresetType in XPRSHelper.presetTypes){
						noButtonsCreated = false;
						menuDom.append(EditorHelper.createAddMenuBtn(XPRSHelper.presetTypes[currentPresetType]));
					}
				}
			}else{
				//this is an element we create them seperatly
			}
		}
		//Create elements
		for (presetType in XPRSHelper.presetTypes){
			if (XPRSHelper.presetTypes[presetType]["GROUP"] == "ELEMENTS" && presetType != "DRAGGABLE_PIC" ){
				menuDom.append(EditorHelper.createAddMenuBtn(XPRSHelper.presetTypes[presetType]));
			}
		}
	}else{
		//shortcodes not ready in editor helper
		//alert("shortcodes not ready!")
		shouldCreateButton = true;
	}
	
	if(noButtonsCreated){
		console.log("no buttons created...");
	}
	//var menuWrapper = $("<div id='add-menu-wrapper' />").css({"display":"none","-webkit-transform": "scale(0.7)","-moz-transform": "scale(0.7)","-ms-transform": "scale(0.7)"}).addClass("animated");
	var menuWrapper = $("<div id='add-menu-wrapper' />").css({"display":"none"}).addClass("animated");
	menuWrapper.append(menuDom);
	menuWrapper.append(paginationDiv);
	$("body").append(menuWrapper);
};


EditorHelper.generatePaginationMenu = function(){
	var paginationWrapper = $("<div />").attr("id","menu-pagination-wrapper").addClass("layer5");
	var paginationHolder = $("<div />").addClass("centrelized");
	var paginationDot1 = $("<div />").attr("id","page1").addClass("pagination-dot clickable selected");
	var paginationDot2 = $("<div />").attr("id","page2").addClass("pagination-dot clickable");
	paginationHolder.append(paginationDot1).append(paginationDot2);
	paginationDot1.add(paginationDot2).bind("click", ".pagination-dot", function(){
		if (!($(this).hasClass("selected"))){
			$(".pagination-dot").toggleClass("selected");
			$("#add-stripe-menu").attr("data-page",$(this).attr("id"));
			$("#add-stripe-menu .item-type-btn-wrapper").not("." + $(this).attr("id")).hide();
			$("#add-stripe-menu ." + $(this).attr("id") + ".item-type-btn-wrapper").fadeIn(500).css("display","inline-block");
		}
	});
	paginationWrapper.append(paginationHolder);
	return paginationWrapper;
};




EditorHelper.overrideLinks = function(currentHolder){
	currentHolder.find("a").not("[data-cke-saved-href]").each(function(){
		var currentLink = $(this);
		var currentHref = currentLink.attr("href");
		if (currentHref != "#" && currentHref != "javascript:void(0);"){
			currentLink.attr("data-href", currentHref);
			currentLink.attr("href","javascript:void(0);");
			currentLink.attr("data-target", currentLink.attr("target"));
			currentLink.removeAttr("target");
			
			if (currentLink.hasClass("image-link")){
				currentLink.removeClass("top-layer");
				currentLink.css("pointer-events","none")
			}
		}
		if (currentLink.hasClass("image-link")){
			currentLink.css("pointer-events","none");
		}
	});
};


EditorHelper.getRootId = function(){
	return $("body").attr("data-root-id");
};

EditorHelper.getPageId = function(){
	return $(".master.container").attr("id");
};

EditorHelper.createAddMenuBtn = function(btnType){
	if (btnType.GROUP != "ELEMENTS" && btnType.GROUP != "WIDGETS"){
		btnType.COLOR = "#5D99C2";
		btnType.kind  = "item";
	}else if (btnType.GROUP == "WIDGETS"){
		btnType.kind  = "widget";
	}else{
		btnType.kind  = "element";
	}
	var btnWrapper = $("<div class='item-type-btn-wrapper page"+ btnType.PAGE +"' />");
	var btnText = $("<div class='item-type-btn-text' />").text(XPRSTranslator.translateText(btnType.NAME));
	var btnDom = $("<div class='item-type-btn clickable' data-target-clone='"+btnType.TYPE+"' data-kind='"+ btnType.kind +"' style='background-color:"+ btnType.COLOR +";background-image:url(/images/ui_icons/"+btnType.TYPE.toLowerCase()+"_ico.png);' />");
	if (btnType.disabled){
		btnDom.css("opacity",0.2);
	}else{
		btnDom.unbind("click").bind("click",function(e){
			e.stopPropagation();
			if (btnType.kind == "element" || btnType.kind == "widget"){
				EditorHelper.addStripeClick($(this).attr("data-target-clone"),$(this).attr("data-kind"));
			}else{
				var currentPreset = $(this).attr("data-target-clone");
				if (currentPreset in EditorHelper.ShortcodeStyles){
					if (EditorHelper.ShortcodeStyles[currentPreset]["STYLE_COUNT"] > 1){
						EditorHelper.showPresetCollection(currentPreset);	
					}else{
						EditorHelper.addStripeClick($(this).attr("data-target-clone"),$(this).attr("data-kind"));	
					}
				}else{
					var thumbs = [];
					var vbids = [];
					if (EditorHelper.shortcodesJson){
						for (i in EditorHelper.shortcodesJson["CHILDREN"]){
							if ("CHILD" in EditorHelper.shortcodesJson["CHILDREN"][i]){
								if (currentPreset == EditorHelper.shortcodesJson["CHILDREN"][i]["CHILD"]["TYPE"]){
									if (EditorHelper.shortcodesJson["CHILDREN"][i]["CHILD"]["VBID"] != null){
										vbids.push(EditorHelper.shortcodesJson["CHILDREN"][i]["CHILD"]["VBID"]);
										if ("THUMB" in EditorHelper.shortcodesJson["CHILDREN"][i]["CHILD"]){
											thumbs.push(EditorHelper.shortcodesJson["CHILDREN"][i]["CHILD"]["THUMB"]);
										}else{
											thumbs.push("na");
										}
									}
								}
							}
						}
						if (vbids.length > 1){
							EditorHelper.ShortcodeStyles[currentPreset] = {};
							EditorHelper.ShortcodeStyles[currentPreset]["THUMBS"] = thumbs;
							EditorHelper.ShortcodeStyles[currentPreset]["VBIDS"] = vbids;
							EditorHelper.ShortcodeStyles[currentPreset]["STYLE_COUNT"] = vbids.length;
							EditorHelper.showPresetCollection(currentPreset);	
						}else{
							EditorHelper.addStripeClick($(this).attr("data-target-clone"),$(this).attr("data-kind"));	
						}
					}else{
						EditorHelper.addStripeClick($(this).attr("data-target-clone"),$(this).attr("data-kind"));	
					}
					
				}
				
			}
		});
	}
	btnDom.append(btnText);
	btnWrapper.append(btnDom);
	return btnWrapper;
};

EditorHelper.generateThumbsIfNeeded = function(currentPreset){
	if (!(currentPreset in EditorHelper.ShortcodeStyles)){
		if (EditorHelper.shortcodesJson){
			var thumbs = [];
			var vbids = [];
			var parentIds = [];
			for (i in EditorHelper.shortcodesJson["CHILDREN"]){
				if ("CHILD" in EditorHelper.shortcodesJson["CHILDREN"][i]){
					if (currentPreset == EditorHelper.shortcodesJson["CHILDREN"][i]["CHILD"]["TYPE"]){
						if (EditorHelper.shortcodesJson["CHILDREN"][i]["CHILD"]["VBID"] != null){
							vbids.push(EditorHelper.shortcodesJson["CHILDREN"][i]["CHILD"]["VBID"]);
							if ("PARENT" in EditorHelper.shortcodesJson["CHILDREN"][i]["CHILD"]){
								parentIds.push(EditorHelper.shortcodesJson["CHILDREN"][i]["CHILD"]["PARENT"])
							}else{
								parentIds.push(EditorHelper.shortcodesJson["ID"])
							}
							if ("THUMB" in EditorHelper.shortcodesJson["CHILDREN"][i]["CHILD"]){
								thumbs.push(EditorHelper.shortcodesJson["CHILDREN"][i]["CHILD"]["THUMB"]);
							}else{
								thumbs.push("na");
							}
						}
					}
				}
			}
			if (vbids.length > 0){
				EditorHelper.ShortcodeStyles[currentPreset] = {};
				EditorHelper.ShortcodeStyles[currentPreset]["THUMBS"] = thumbs;
				EditorHelper.ShortcodeStyles[currentPreset]["VBIDS"] = vbids;
				EditorHelper.ShortcodeStyles[currentPreset]["PARENT_IDS"] = parentIds;
				EditorHelper.ShortcodeStyles[currentPreset]["STYLE_COUNT"] = vbids.length;
			}
		}
	}
};


EditorHelper.arrangeCoverFlow = function(iii,viewMode){
	var heightArray = [0]
	var widthArray = [0]
	if ($("#xprs").hasClass("anchor-selection")){
		var secondaryMode = "h"
	} else {
		var secondaryMode = "v"
	}
	var addStripeMenu = $("#add-stripe-menu");
	///////// FILM STRIP ////////////////
	if (viewMode == "filmStrip") {
		$("#add-menu-wrapper").removeClass("filmstrip matrix");
		$("#add-menu-wrapper").addClass("filmstrip");
		if (secondaryMode == "v"){
			$("#add-stripe-menu .item-type-btn-wrapper.collection").css("height", "600px");
			addStripeMenu.css("height", "700px");
		}
		
		$("#add-stripe-menu .item-type-btn-wrapper.collection").css("top", "5%");
		var itemWidth = addStripeMenu.width()/2.7
		var middlePoz = addStripeMenu.height()/2 ;
		yPos = 0;
		xPos = 0;
		currentItemHeight = 0;
		currentItemWidth = 0;		
		var middlePozH = (addStripeMenu.width()-itemWidth)/2;
		$("#add-stripe-menu .item-type-btn-wrapper.collection").each(function( index ) {
			var currentThumb = $(this);
			heightt = currentThumb.find(".item-type-btn-thumb").height()
			widthh = currentThumb.find(".item-type-btn-thumb").width()
			if (heightt == 0){
				heightt = 250;
			} 
			yPos = yPos + heightt;
			xPos = xPos + widthh*1.8;
			heightArray.push(yPos)
			widthArray.push(xPos)
			
			if (index == iii){
				currentItemHeight = heightt;
				currentItemWidth = widthh;
			}
			
			if ((iii > index - 3) && (iii < index + 3)) {
				currentThumb.find(".item-type-btn").show();	
			} else {
				currentThumb.find(".item-type-btn").hide();	
			}
			
			if ((iii > index - 4) && (iii < index + 4)) {
				currentThumb.show();	
			} else {
				currentThumb.hide();	
			}
			
		})
		var middlePoz = (addStripeMenu.height()-currentItemHeight)/2;
		$("#add-stripe-menu .item-type-btn-wrapper.collection").each(function( index ) {
			var currentThumbHolder = $(this);
			var currentThumb = currentThumbHolder.find(".item-type-btn-thumb")
			currentThumbHolder.css("position", "absolute");
			var middlePozperItem = (200-currentThumb.height())/2;
			if (secondaryMode == "v"){
				currentThumbHolder.css("top", heightArray[index] - heightArray[iii] + middlePoz);
				currentThumbHolder.css("bottom", "none");
				currentThumbHolder.css("left", middlePozH);
				currentThumb.css("transform-origin", "50% 50%");
			} else {
				currentThumbHolder.css("left", widthArray[index] - widthArray[iii] + middlePozH);
				currentThumbHolder.css("top", "none");
				currentThumbHolder.css("bottom", "3%");
				currentThumb.css("transform-origin", "50% 93%");
			}
			currentThumbHolder.css("width", "600px");
			currentThumbHolder.css("height", "400px");
			currentThumbHolder.find(".item-type-btn").css("height", "300px")
			currentThumbHolder.find(".item-type-btn").css("width", itemWidth)
			currentThumb.css("width", itemWidth)
			currentThumb.css("position", "absolute")
			currentThumb.css("left", "0px")
			currentThumb.css("top", "0px")
			
			currentThumb.css("opacity","1")
			currentThumb.css("visibility","visible")
			currentThumb.css("outline","none");
			currentThumbHolder.removeClass("selected_stripe_to_add")
			
			if (index == iii){
				
				currentThumb.css("outline","3px #0F95EE solid");
				currentThumb.css("outline-offset","10px");
				
				currentThumbHolder.addClass("selected_stripe_to_add")
				
				if(secondaryMode == "v"){
				
					currentThumb.css("top", "0px")
					currentThumb.css("bottom","none");
					$(".adding-stripes-mode #empty-stripe.showing-collection").css("height", "800px" )
					$(".adding-stripes-mode #empty-stripe.showing-collection").css("transform-origin", "50% 50%");
					currentThumb.css("transform", "rotateX(0deg) scale(1.3)");
					
				} else {	
					
					currentThumb.css("top", "none")
					currentThumb.css("bottom","0px");
					
					if (currentItemHeight > 100){
						$(".adding-stripes-mode #empty-stripe.showing-collection").css("height", currentItemHeight*2+200 );
					}
					
					$(".adding-stripes-mode #empty-stripe.showing-collection").css("transform-origin", "50% 0%");
					currentThumb.css("transform", "rotateX(0deg) scale(2)");
					
				}
				
				currentThumbHolder.css("z-index", 9999);
				currentThumb.css("box-shadow", "2px 26px 21px 0px rgba(0, 0, 0, 0.27)")
				currentThumb.css("padding-top", "0px")
			
			
			} else { ///not focused item
				if(secondaryMode == "v"){
					currentThumb.css("transform", "rotateX(0deg) scale(0.8)");
				} else {
					currentThumb.css("transform", "rotateX(0deg) scale(2)");
				}
				currentThumbHolder.css("z-index", index);
				currentThumb.css("box-shadow", "1px 3px 5px 0px rgba(0, 0, 0, 0.05)")
				currentThumb.css("left", "0px")
				if (index > iii ){  /// items on the right / after
					if (secondaryMode == "v") {
						currentThumb.css("top", "30px")
						currentThumb.css("bottom","none");
					} else {
						currentThumb.css("top", "none")
						currentThumb.css("left", "500px")
						currentThumb.css("bottom","0px")
						currentThumb.css("opacity","0")
						currentThumb.css("visibility","hidden")
					}
				} else {  /// items on the left / before
					if (secondaryMode == "v") {
						currentThumb.css("top", "-30px")
						currentThumb.css("bottom","none");
					} else {
						currentThumb.css("top","none")
						currentThumb.css("left", "-500px")
						currentThumb.css("bottom","0px")
						currentThumb.css("opacity","0")
						currentThumb.css("visibility","hidden")
					}
					
				}
				
				
			}
		});
		
		
		
		
	}
/////////  MATRIX ////////////////
	addStripeMenu.css({"height": "100%","top":"0px","perspective": "1000px", "perspective-origin": "50% 65%"});
	containerHeight = addStripeMenu.height();
	containerWidth = addStripeMenu.width();
	itemWidth = 190;
	itemHeight = 160;
	if (viewMode == "matrix") {
		$("#add-stripe-menu .item-type-btn-wrapper .item-type-btn").show()
		$("#add-stripe-menu .item-type-btn-wrapper").show()
		$("#add-menu-wrapper").removeClass("filmstrip matrix");
		$("#add-menu-wrapper").addClass("matrix");
		$("#add-stripe-menu .item-type-btn-wrapper.collection").css("height", itemHeight);
		$("#add-stripe-menu .item-type-btn-wrapper.collection").css("top", "5%");
		var middlePoz = containerHeight/2 - 200;
		var maxItemsInRow = Math.floor(containerWidth / itemWidth);

		//find the heighest thumb 
		var maxThumb = 0;
		$("#add-stripe-menu .item-type-btn-wrapper.collection").each(function( index ) {
			thumbHeight = $(this).find(".item-type-btn-thumb").height();
			if ( thumbHeight > maxThumb){
				maxThumb = thumbHeight;
			}
		})
		var rowCounter = 0;
		var lineCounter = 0;
		var middlePosOffset = (containerWidth - (maxItemsInRow * itemWidth))/2
		$("#add-stripe-menu .item-type-btn-wrapper.collection").each(function( index ) {
			var currentThumbHolder = $(this);
			var currentThumb = currentThumbHolder.find(".item-type-btn-thumb")
			currentThumb.show();	
			currentThumbHolder.css("left",  itemWidth * rowCounter + middlePosOffset*2);
			currentThumbHolder.css("top",   itemHeight * lineCounter + itemHeight*0.4);
			if (rowCounter < maxItemsInRow-1){
				rowCounter = rowCounter+1;
			} else {
				rowCounter = 0;
				lineCounter = lineCounter + 1;
			}
			currentThumbHolder.css("position", "absolute");
			currentThumbHolder.css("bottom", "300px");
			currentThumbHolder.css("width", "150px");
			currentThumbHolder.css("height", "200px");
			currentThumbHolder.css("display", "inline-block");
			currentThumbHolder.find(".item-type-btn").css("height", "150px")
			currentThumbHolder.find(".item-type-btn").css("width", "150px")
			currentThumb.css("width", "150px")
			currentThumb.css("transform", "scale(1)")
			currentThumb.css("position", "absolute")
			currentThumb.css("top", "inherit")
			currentThumb.css("bottom", "10px")
			currentThumb.css("left", "0px")
		});
		if (lineCounter+1 > 4){
			var newHeight = itemHeight * (lineCounter+1) + itemHeight*0.4
			$("#empty-stripe").css("height",newHeight);
		}else{
			$("#empty-stripe").css("height","");
		}
		
	}
	
	
}

EditorHelper.showPresetCollection = function(currentPreset,params, scope){
	//we need to arrange the left menu in case we increase the site height and create a scrollbar
	if (typeof currentPreset == "undefined"){
		currentPreset = "PROMO";
	}
	EditorHelper.generateThumbsIfNeeded(currentPreset);
	EditorHelper.presetIndex = 0; //current index;
	EditorHelper.presetNumber = parseInt(EditorHelper.ShortcodeStyles[currentPreset]["STYLE_COUNT"]) //total number of presets from this type;
	if (scope) {
		var collectionHolder = scope.find("#add-stripe-menu")
	} else {
		var collectionHolder = $("#add-stripe-menu");
	}
	collectionHolder.empty();
	collectionHolder.closest("#add-menu-wrapper").find(".add-stripe-arrow").attr("data-current-page",1)
	var currentPage = 0;
	for (var i=0; i < parseInt(EditorHelper.ShortcodeStyles[currentPreset]["STYLE_COUNT"]) ; i++){
		if (i % 70 == 0){
			currentPage++;
		}
		var vbid= "na";
		var thumb = "na";
		var parentId = EditorHelper.shortcodesJson["ID"];
		if(typeof EditorHelper.ShortcodeStyles[currentPreset]["VBIDS"] != "undefined"){
			vbid = EditorHelper.ShortcodeStyles[currentPreset]["VBIDS"][i];
		}
		if(typeof EditorHelper.ShortcodeStyles[currentPreset]["THUMBS"] != "undefined"){
			thumb = EditorHelper.ShortcodeStyles[currentPreset]["THUMBS"][i];
		}
		if(typeof EditorHelper.ShortcodeStyles[currentPreset]["PARENT_IDS"] != "undefined"){
			parentId = EditorHelper.ShortcodeStyles[currentPreset]["PARENT_IDS"][i];
		}
		var btnWrapper = $("<div class='item-type-btn-wrapper collection' />").attr("data-thumb",thumb).attr("data-page","page" + currentPage);
		if (currentPage != 1){
			btnWrapper.hide();
		}
		var btnThumb =  $("<img class='item-type-btn-thumb' />");
		var btnText = $("<div class='item-type-btn-text' />").text(currentPreset.toLowerCase().replace(new RegExp("_", 'g')," ") + " " + (i+1)).css("text-transform","capitalize");
		var previewThumbImg = $("<img  />").addClass("add-menu-preview-thumb top-layer");
		
		if (thumb != "na"){
			previewThumbImg.attr("src",thumb + "=s600");
			btnThumb.attr("src",thumb + "=s600");
		}
		var btnDom = $("<div class='item-type-btn clickable' data-target-clone='"+vbid+"' data-kind='item' data-parent-id='"+ parentId +"' />");
		btnDom.append(btnThumb);
		btnWrapper.append(btnDom);
		collectionHolder.append(btnWrapper);
		
		btnDom.unbind("click").bind("click",function(){
			EditorHelper.addStripeClick(currentPreset,"item",$(this).attr("data-target-clone"),$(this).attr("data-parent-id"));
		});
	}
	
	
	collectionHolder.attr("data-page","collection");
	$("#empty-stripe").addClass("showing-collection");
	if ($(".left-menu-placeholder").length > 0){
		SpimeEngine.ArrangeHolder($(".master.item-box[data-preset-type-id='MENUS']"))
	}
	/// COVERFLOW
	$("#add-menu-wrapper.cloned #add-stripe-menu").css("opacity",0)	
	setTimeout(function(){ 
		$("#add-stripe-menu .item-type-btn-wrapper .item-type-btn").hide()
		EditorHelper.arrangeCoverFlow(0, EditorHelper.viewerMode);
		$("#add-menu-wrapper.cloned").css("opacity",1)	
		$("#add-menu-wrapper.cloned #add-stripe-menu").css("opacity",1)	
	}, 500);
	return true;
};


EditorHelper.addStripeClick = function(itemType,kind,vbidToClone,parentId){
	var holder = $("#empty-stripe");
	var holderTop = holder.offset().top;
	if (holderTop < $(window).scrollTop()){
		EditorHelper.scrollToItem({vbid:"empty-stripe"});
	}
	var prevHolder = holder.prevAll(".item-box:first");
	var prevHolderId = "first";
	if (prevHolder.length != 0 ){
		if (!(prevHolder.hasClass("injected"))){
			prevHolderId = prevHolder.attr("id");
		}
	}
	
	var loaderGif = $("<div id='loading-icon' style='background-size:50px 50px;background-image:url(/images/x_loader.gif);display:table-cell;vertical-align:middle;width: 100%;background-repeat: no-repeat;background-position: center;' />");
	if (kind=="item"){
		var presetType = holder.find(".preset-tab-holder .preset-tab.selected").attr("id");
		var currentPageId = EditorHelper.getMasterId();
		var templateFolderId = itemType;
		
		$(".rotated-45").removeClass("rotated-45");
		$("#add-stripe-menu").removeClass("shown");
		$(".add-stripe-img").attr("opened", "no");
		var currentPage = $("#add-menu-wrapper.cloned #add-stripe-menu").attr("data-page");
		$("#add-menu-wrapper #add-stripe-menu").attr("data-page",currentPage);
		XPRSHelper.onCssTransitionFinish($("#add-stripe-menu"),function() {
			var loaderGifWrapper = $("<div style='display:table;height:100%;width:100%;' />");
			loaderGifWrapper.append(loaderGif);
			$("#add-menu-wrapper").prepend(loaderGifWrapper);
			$("#menu-pagination-wrapper").hide();
			
			var shortcodesId = EditorHelper.shortcodesJson["ID"];
			if (parentId != "undefined"){
				shortcodesId = parentId;
			}
			
			holder.find(".add-stripe-arrow, .matrix-btn, .close-btn").fadeOut();
			$("#add-stripe-menu .item-type-btn-wrapper .item-type-btn").fadeOut();
			EditorHelper.safeCloneStripe(vbidToClone,holder,templateFolderId,currentPageId,shortcodesId,prevHolderId,true,function(){
				var whitelabelAllowEcommerce = true;
				if (LABEL_CONFIG && "SETTINGS" in LABEL_CONFIG && LABEL_CONFIG.SETTINGS.ALLOW_ECOMMERCE == "disallow" && SpimeEngine.ecommerceSolution == "DISABLED"){
					whitelabelAllowEcommerce = false;
				}
				if (presetType == "STORE" && whitelabelAllowEcommerce){
					EditorHelper.updateStoreCategory(holder,0)
				}else{
					swal.close();
				}
			});
		});
		
	}else if(kind=="element" || kind=="widget"){
		var params = {};
		params['element_type'] = itemType;
		var elementData = {};
		elementData[itemType] = "none";
		if (EditorHelper.shortcodesJson){
			for (i in EditorHelper.shortcodesJson["CHILDREN"]){
				if (itemType in EditorHelper.shortcodesJson["CHILDREN"][i]){
					//We must clone the object in order to keep the shortcodes json intact
					elementData[itemType] = $.extend(true, {}, EditorHelper.shortcodesJson["CHILDREN"][i][itemType]);
					if (itemType == "PIC" || itemType == "VIDEO"  || itemType == "MAP" || itemType == "HTML" || itemType == "RAW"){
						var originalElementId = EditorHelper.shortcodesJson["CHILDREN"][i][itemType]["VBID"];
						if ("STRIPE_DATA" in EditorHelper.shortcodesJson["STYLE"]){
							if (originalElementId in EditorHelper.shortcodesJson["STYLE"]["STRIPE_DATA"]){
								var picHeight = EditorHelper.shortcodesJson["STYLE"]["STRIPE_DATA"][originalElementId]["PROPERTIES"]["STRIPE"]["HEIGHT"]["value"];
								if ("WRAPPER" in EditorHelper.shortcodesJson["STYLE"]["STRIPE_DATA"][originalElementId]["PROPERTIES"]){
									if ("MAX_WIDTH" in EditorHelper.shortcodesJson["STYLE"]["STRIPE_DATA"][originalElementId]["PROPERTIES"]["WRAPPER"]){
										picWidth = EditorHelper.shortcodesJson["STYLE"]["STRIPE_DATA"][originalElementId]["PROPERTIES"]["WRAPPER"]["MAX_WIDTH"]["value"];
										params['pic_width'] = picWidth;
									}
								}
								if ("IMAGE_SPECIFIC" in EditorHelper.shortcodesJson["STYLE"]["STRIPE_DATA"][originalElementId]["PROPERTIES"]){
									if ("IMAGE_SIZE" in EditorHelper.shortcodesJson["STYLE"]["STRIPE_DATA"][originalElementId]["PROPERTIES"]["IMAGE_SPECIFIC"]){
										picSize = EditorHelper.shortcodesJson["STYLE"]["STRIPE_DATA"][originalElementId]["PROPERTIES"]["IMAGE_SPECIFIC"]["IMAGE_SIZE"]["value"];
										params['pic_size'] = picSize;
									}
									if ("IMAGE_POSITION" in EditorHelper.shortcodesJson["STYLE"]["STRIPE_DATA"][originalElementId]["PROPERTIES"]["IMAGE_SPECIFIC"]){
										picPosition = EditorHelper.shortcodesJson["STYLE"]["STRIPE_DATA"][originalElementId]["PROPERTIES"]["IMAGE_SPECIFIC"]["IMAGE_POSITION"]["value"];
										params['pic_position'] = picPosition;
									}
								}
								picHeight = parseInt(picHeight);
								
								params['pic_height'] = picHeight;
								
								params['orig_element_id'] = originalElementId;
							}
						}
					}
				}
			}
		}
		
		if (elementData[itemType] == "none"){
			elementData[itemType] = EditorHelper.defaultElementValues[itemType];
		}
		
		//catch the click , let page color menu be seen
		holder.unbind("click").bind("click",function(){});
		
		elementData[itemType]["VBID"] = EditorHelper.shortUuid();
		if (itemType == "HTML" || itemType == "RAW" || itemType == "INLINE_RAW"){
			elementData[itemType]["TYPE"] = "custom";
			elementData[itemType]["URL"] = "/html_src/" + EditorHelper.shortUuid("static");
		}
		params['element_data'] = JSON.stringify(elementData);
		params['template_src'] = 'xprs/';
		$(".rotated-45").removeClass("rotated-45");	
		$("#add-stripe-menu").removeClass("shown");
		$(".add-stripe-img").attr("opened", "no");
		var currentPage = $("#add-menu-wrapper.cloned #add-stripe-menu").attr("data-page");
		$("#add-menu-wrapper #add-stripe-menu").attr("data-page",currentPage);
		XPRSHelper.onCssTransitionFinish($(this),function() {
			var loaderGifWrapper = $("<div style='display:table;height:100%;width: 100%;' />");
			loaderGifWrapper.append(loaderGif);
			$("#add-menu-wrapper").prepend(loaderGifWrapper);
			EditorHelper.addElement(holder,prevHolderId,params,true);
		});
		
	}
	XPRSHelper.trackEvent('Added Section',"General",itemType,0,true);
};


EditorHelper.lastUsedShortcodePresetId = "";



EditorHelper.safeCloneStripe = function(vbid,holder,presetType,cloneInto,cloneFrom,afterId,askStyle,callbackFunc){
	holder.css("background-color","black");
	XPRSHelper.POST("/safe_clone", {"child_type":"STRIPE", "vbid":vbid ,"root_id":EditorHelper.getRootId(),"page_id":EditorHelper.getPageId(),"original_parent_id":cloneFrom, "clone_into": cloneInto, "clone_after_id":afterId,"from_template":true,"use_clone_stack":true}, function(result) {
		if (!(result.error)){
			if ("limit_reached" in result){
				EditorHelper.closeAddStripeMenu();
				if (LABEL_CONFIG && "META" in LABEL_CONFIG && LABEL_CONFIG.META.NAME == "aabaco"){
					if (typeof YSBApp != "undefined"){
						YSBApp.send({"action": "restricted-upsell", "appid": "ywebsite"});
					}
				}else{
					XPRSHelper.xprsAlert("Please upgrade your license in order to create more sections",{title: "Section Limit Reached", showCancelButton: false,confirmButtonText:"OK","callbackfunc":function(isConfirm){
					}});
				}
				return;
			}
			var cloneId = result.clone_id;
			holder.css("height",holder.height());
			holder.attr("id",cloneId);
			holder.attr("data-preset-type-id",presetType);
			var params = {};
			params["vbid"] = cloneId;
			params["parent_vbid"] = cloneInto; 
			var parentsList = EditorHelper.getParentsList(holder);
			parentsList.push(cloneId);
			holder.addClass("custom");
			EditorHelper.reloadPart(params,function(){
				setTimeout(function(){
					holder.removeClass("animated-height");
					holder.css("height","");
					EditorHelper.updateHandlersPosition(holder);
					SpimeEngine.ArrangeHolder(holder);
					SpimeEngine.initForms(holder);
					$(".floating-plus").removeClass("hidden");
					if(askStyle) {
						EditorHelper.askAboutWebsiteStyle(holder,false,callbackFunc);
					} else {
						if(typeof callbackFunc != 'undefined') {callbackFunc();}
					}
					
					EditorHelper.reloadErredStripes();
				},50);
			});
		}else{
			//TODO: create alternative if item type is not in shortcodes. (something like clone_from_master_shortcodes)
		}
	},"json");
};




EditorHelper.askAboutWebsiteStyle = function(holder,closeOnClick,callbackFunc){
	if ($(".master.container").is(".website-style")){
		var message = "Do you want to apply your own website style or use the original section style? (You can change your mind later)";
		XPRSHelper.xprsAlert(message,{title: "Apply website style?", showCancelButton: true,closeOnConfirm:closeOnClick,closeOnCancel:closeOnClick,confirmButtonText:"Yes please",cancelButtonText:"No, use original","callbackfunc":function(isConfirm){
			$(".xprs-alert .sa-button-container button.confirm").unbind('mouseenter mouseleave');
			var stripeId = holder.closest(".master.item-box").attr("id");
			if(isConfirm){
				holder.removeClass("custom");
				XPRSHelper.SAFEPOST("/update_css_class", {"vbid":holder.attr("id"),"updated_key":"STYLE_CLASS","delete_key":"True","stripe_id":stripeId}, holder.attr("id"), "CSS_CLASS");
			}else{
				holder.addClass("custom");
				XPRSHelper.SAFEPOST("/update_css_class", {"vbid":holder.attr("id"),"updated_key":"STYLE_CLASS","updated_value":"custom","stripe_id":stripeId}, holder.attr("id"), "CSS_CLASS");
			}
			if (typeof callbackFunc != "undefined"){
				callbackFunc();
			}
			
		 }});
		
		setTimeout(function(){
			$(".xprs-alert .sa-button-container button.confirm").hover(function(){holder.removeClass("custom")},function(){holder.addClass("custom")});
		},300);
		
	}else{
		if (typeof callbackFunc != "undefined"){
			callbackFunc();
		}
	}
};


EditorHelper.invalidateStripeData = function(currentPageId,callbackFunc){
	if (typeof callbackFunc != "undefined"){
		callbackFunc();
	}
};

EditorHelper.addElement = function(holder,afterId,params,updateEditor,callbackFunc){
	params["parent_vbid"] = EditorHelper.getHolderId(EditorHelper.getHolderParent(holder));
	params["after_id"] = afterId;
	params["stripe_id"] = holder.closest(".master.item-box").attr("id");
	
	XPRSHelper.POST("/add_element",params ,function(resp){
		var itemWrapper = $("<div class='item-wrapper'/>");
		var contentDiv = $("<div class='content' />");
		itemWrapper.append(contentDiv);
		contentDiv.html(resp["element_html"]);
		
		var elementId = itemWrapper.find(".element").attr("id");
		itemWrapper.addClass("element-wrapper" + " "+params.element_type.toLowerCase() +"-wrapper");
		holder.attr("id",elementId);
		holder.attr("data-holder-type","element");
		holder.attr("data-child-type",params.element_type);
		holder.attr("data-preset-type-id","");
		
		
		if (params.element_type=="PIC" || params.element_type=="VIDEO" || params.element_type=="MAP"){
			
			var parentVbid = EditorHelper.getHolderId(EditorHelper.getHolderParent(holder));
			itemWrapper.css("min-height",params.pic_height);
			if (typeof params.pic_width != "undefined"){
				itemWrapper.css("max-width",params.pic_width);
			}
			if (params.element_type=="PIC"){
				var imageElement = contentDiv.find(".image-source");
				var imageCover = contentDiv.find(".page-image-cover");
				var imageCoverPadding = parseInt(imageCover.css("padding-top")) + parseInt(imageCover.css("padding-bottom"));
			
				SpimeEngine.loadHighResImage(contentDiv.find(".load-high-res"));
				if (typeof params.pic_size != "undefined"){
					imageElement.css("background-size",params.pic_size);
				}
				if (typeof params.pic_position != "undefined"){
					imageElement.css("background-position",params.pic_position);
				}
				holder.height(params.pic_height - imageCoverPadding);
			}
			XPRSHelper.POST("/duplicate_specific_stripe_data", {
				duplicate_to : parentVbid,
				orig_item_id : params.orig_element_id ,
				new_item_id : elementId,
				original_parent:EditorHelper.shortcodesJson["ID"]
			}, function() {
			});
		}
		holder.addClass("element-box");
		holder.removeClass("animated-height");
		holder.html(itemWrapper);
		
		if (params.element_type=="VIDEO" ){
			SpimeEngine.sendVideoCommand(elementId,"play");
		}
		
		if (params.element_type=="MAP" ){
			SpimeEngine.initMap(holder.find(".map-frame"));
		}
		
		
		if (params.element_type == "SELF"){
			SpimeEngine.initSelfWidget(holder.find(".self-container"));
		}
		
		if (params.element_type == "RAW" || params.element_type == "INLINE_RAW"){
			SpimeEngine.initRawHTML(holder.find(".raw-container"));
		}
		
		//Get the stripe style 
		var stripeStyleId  = $(".master.container").attr("data-itemstyleid");
		holder.addClass(stripeStyleId);
		holder.attr("data-styleid",stripeStyleId);
		holder.css("height","");
		holder.hide().fadeIn();
		if (typeof callbackFunc != "undefined"){
			callbackFunc();
		}
		setTimeout(function(){
			EditorHelper.initStripeAfterReload(holder);	
		},10);
		
	},"json");
};



EditorHelper.handleAddLinkToMenu = function(params){
	var item = EditorHelper.getHolderById(params.vbid);
	var itemParent = EditorHelper.getParent(item);
	var parentType = EditorHelper.getTypeOf(itemParent);
	var selectedType = "LINK";
	var elementPlaceHolder = item.find(".element-placeholder[data-elementtype='"+selectedType+"']");
	var elementData = {};
	elementData["PREVIEW"] = {};
	elementData["PREVIEW"][selectedType] = EditorHelper.defaultElementValues[selectedType];
	if (typeof params.link_name != "undefined"){
		elementData["PREVIEW"][selectedType]["LABEL"] = params.link_name;
		elementData["PREVIEW"][selectedType]["TEXT"] = params.link_name;
	}
	elementData["PREVIEW"][selectedType]["CONTEXT"] = "PREVIEW";
	
	if (typeof params.link_href != "undefined"){
		elementData["PREVIEW"][selectedType]["LINK"] = {};
		elementData["PREVIEW"][selectedType]["LINK"]["TYPE"] = "EXISTING";
		elementData["PREVIEW"][selectedType]["LINK"]["URL"] = params.link_href
	}
	
	if (typeof params.new_vbid != "undefined"){
		elementData["PREVIEW"][selectedType]["VBID"] = params.new_vbid;
	}else{
		elementData["PREVIEW"][selectedType]["VBID"] = EditorHelper.shortUuid();
	}
	var getTemplateParams = {};
	getTemplateParams["element_type"] = "PREVIEW_LINK";
	getTemplateParams["element_data"] = JSON.stringify(elementData);
	getTemplateParams["template_src"] = "xprs/preview/"
	
	getTemplateParams["parent_vbid"] = item.attr("id");
	getTemplateParams["vbid"] = elementData["PREVIEW"][selectedType]["VBID"];
	getTemplateParams["after_id"] = "last";
		
	getTemplateParams["stripe_id"] = item.closest(".master.item-box").attr("id");
	
	
	
	
	XPRSHelper.POST("/add_element",getTemplateParams ,function(resp){
		var dataDiv = $(resp["element_html"]);
		dataDiv.addClass("custom")
		EditorHelper.addLeftClickMenu(dataDiv);
		dataDiv.hide();
		elementPlaceHolder.before(dataDiv);
		EditorHelper.overrideLinks(item);
		var stripe = item.closest(".master.item-box");
		stripe.removeAttr("data-original-menu-width")
		
		dataDiv.fadeIn();
		dataDiv.wrap("<li class='removable-parent' />");
		if (item.is(".header-box")){
			SpimeEngine.ArrangeHolder(item);
		}
		if (parentType == "stripe"){
			SpimeEngine.InitHolder(itemParent);
		}
		if (parentType == "item-preview"){
			var itemGrandParent = EditorHelper.getParent(itemParent);
			SpimeEngine.ArrangeHolder(itemGrandParent);
		}
		itemParent.find(".preview-content-holder").removeClass("empty-holder");
	},"json");
	var initiatedFromEditor = true;
	if (typeof params.initiated_from_editor != "undefined"){
		initiatedFromEditor = params.initiated_from_editor;
	}
};

EditorHelper.addPreviewTab = function(){
	var editorTab = $("<div/>").attr("id","editor-tab").addClass("clickable top-layer");
	editorTab.unbind("click").bind("click",function(event){
		event.stopPropagation();
		EditorHelper.updateParent({"deliver_to":"parent","action":"show-editor"});
		$(this).hide();
		$(".stripe-controls").removeClass("deactivated");
		EditorHelper.mode = "guest";
	});
	editorTab.hide();
	$("body").append(editorTab);
};

EditorHelper.initCopySectionBtn = function(controlsHolder,copyBtn){
	var stripeType = controlsHolder.attr("data-preset-type-id");
	var parentVbid = EditorHelper.getHolderId(EditorHelper.getParent(controlsHolder));
	copyBtn.unbind("click").bind("click",function(e){
		e.stopPropagation();
		if (!EditorHelper.allowLeftClickMenu($(this),e.target)){
			return;
		}
		//Allow copy paste only to items
		if (!controlsHolder.hasClass("element-box")){
			XPRSHelper.xprsAlert("The section was copied to the clipboard, to paste it add a new section and select '[Paste]'",{title: "Section copied to clipboard"});
			XPRSHelper.POST("/safe_clone", {
				vbid : controlsHolder.attr("id"),
				original_parent_id : parentVbid,
				child_type:"STRIPE"
			}, function(result) {
				if ("limit_reached" in result){
					EditorHelper.closeAddStripeMenu();
					if (LABEL_CONFIG && "META" in LABEL_CONFIG && LABEL_CONFIG.META.NAME == "aabaco"){
						if (typeof YSBApp != "undefined"){
							YSBApp.send({"action": "restricted-upsell", "appid": "ywebsite"});
						}
					}else{
						XPRSHelper.xprsAlert("Please upgrade your license in order to create more sections",{title: "Section Limit Reached", showCancelButton: false,confirmButtonText:"OK","callbackfunc":function(isConfirm){
						}});
					}
					return;
				}
				var cloneId = result.clone_id;
				var clipboardCookie = JSON.stringify({"clone_id":cloneId,"preset_type":stripeType,"parent_id":parentVbid,"original_id":controlsHolder.attr("id")});
				XPRSHelper.setXprsCookie("xprs-clipboard",clipboardCookie);
			});
		}
	});
};


EditorHelper.addStripePlusBtn = function(controlsHolder){
	var addBtn = $("<img id='add-stripe' class='add-stripe-img' src='/images/add_stripe.png' data-title='Add a new section' />");
	var addStripeHolder = $("<div/>").addClass("add-stripe-holder");
	addStripeHolder.append(addBtn);
	EditorHelper.initAddBtn(controlsHolder,addBtn,addStripeHolder);
	if (controlsHolder.next().find(".add-stripe-holder").length == 0){
		controlsHolder.next().append(addStripeHolder);
	}
	controlsHolder.next().hover( function(e){
		$(this).addClass("shown");
	},function(){
		$(this).removeClass("shown");
	});
};

EditorHelper.addStripeHoverControls = function(controlsHolder){
	EditorHelper.addStripePlusBtn(controlsHolder);
	EditorHelper.addSpacingHandlers(controlsHolder,"top");
	EditorHelper.addSpacingHandlers(controlsHolder,"bottom");
	EditorHelper.addMaxWidthControls(controlsHolder);
	
	controlsHolder.bind("mousemove",function(e){
		if(!($(e.relatedTarget).hasClass("menu-options"))  &&  !($(e.relatedTarget).hasClass("max-width-handle"))){
			var hoveredHolder = $(this);
			EditorHelper.holderMouseEnter(hoveredHolder,false,e);
		}
	});
	controlsHolder.bind("mouseleave",function(e){
		if(!($(e.relatedTarget).hasClass("menu-options")) &&  !($(e.relatedTarget).hasClass("max-width-handle"))){
			var hoveredHolder = $(this);
			EditorHelper.holderMouseOut(hoveredHolder);	
		}
	});
};


EditorHelper.addHoverControls = function(controlsHolder){
	if (controlsHolder.hasClass("master")){
		EditorHelper.addStripeHoverControls(controlsHolder);
	}
	EditorHelper.addLeftClickMenu(controlsHolder);
};

EditorHelper.getStripeData = function(controlsHolder,propKey){
	return controlsHolder.find(".item-wrapper .stripe-data").attr("data-" + propKey);
};

EditorHelper.setStripeData = function(controlsHolder,propKey,newVal){
	return controlsHolder.find(".item-wrapper .stripe-data").attr("data-" + propKey,newVal);
};



EditorHelper.addSpacingHandlers = function(controlsHolder,topOrBottom){
	var verticalPosition = "10px";
	var currentSpacing = parseInt(controlsHolder.css("padding-" + topOrBottom));
	if (topOrBottom == "top"){
		verticalPosition = (currentSpacing + 10) + "px";
	}
	var verticalSpacingMenu =  $('<div class="not-selectable vertical-spacing-menu pro-feature fast-animated-opacity  layer5" />').css(topOrBottom,verticalPosition).addClass(topOrBottom);
	var plusBtn = $('<div class="clickable vertical-spacing-btn plus">+</div>');
	var minusBtn = $('<div class="clickable vertical-spacing-btn minus">-</div>');
	 verticalSpacingMenu.hover(function(){
		 EditorHelper.markSpacing(controlsHolder,currentSpacing);
	 },function(){
		 EditorHelper.unmarkSpacing(controlsHolder);
	 });
	
	var spacingField = $('<div class="vertical-spacing-field">'+currentSpacing+'</div>').addClass(topOrBottom);
	verticalSpacingMenu.append(plusBtn).append(spacingField).append(minusBtn);
	verticalSpacingMenu.find(".vertical-spacing-btn").unbind("click").bind("click",function(e){
		e.stopPropagation();
		var valueField = verticalSpacingMenu.find(".vertical-spacing-field");
		var currentPadding = parseInt(valueField.text());
		if ($(this).hasClass("minus")){
			if (currentPadding >=5 ){
				currentPadding -= 5;
			}
		}else{
			currentPadding += 5;
		}
		if (topOrBottom == "top"){
			verticalSpacingMenu.css("top",(currentPadding + 10) + "px");
		}
		EditorHelper.changeStripePadding(controlsHolder,topOrBottom,currentPadding,false);
	});
	controlsHolder.append(verticalSpacingMenu);
};

EditorHelper.changeStripePadding = function(holder,paddingDirection,newValue,skipUpdate){
	var units = "px";
	if (paddingDirection == "left" || paddingDirection == "right"){
		units = "%";
		var newWidth = 100 - newValue*2;
		holder.css({"padding-left":newValue+units,"padding-right":newValue+units});
		holder.css("width",newWidth + units);
	}else{
		var vbid = EditorHelper.getHolderId(holder);
		var parentVbid = EditorHelper.getHolderId(EditorHelper.getParent(holder));
		if (!skipUpdate){
			var valueField = holder.find(".vertical-spacing-field." + paddingDirection);
			EditorHelper.updateStripeData({"vbid":vbid,"parent_vbid":parentVbid,"updated_key":"PADDING_"+paddingDirection.toUpperCase(),"updated_value":newValue,"module_name":"STRIPE"});
			valueField.html(newValue);
		}
		holder.css("padding-" + paddingDirection,newValue + units);
		if (paddingDirection == "top"){
			var stripeBackground = holder.find(".stripe-background");
			stripeBackground.css("margin-top",-1 * newValue);
			EditorCore.saveStyleChange("STRIPE_BACKGROUND",{"name":"MARGIN_TOP","initiatorId":vbid},-1 * newValue,holder.attr("data-preview-styleid"));
		}
	}
	
	SpimeEngine.ArrangeHolder(holder);
	
};


EditorHelper.initChooseLinkMenu = function(btn,clickedElement,menuUL){
	
	btn.unbind("click").bind("click",function(e){
		e.stopPropagation();
		EditorHelper.showChooseLinkMenu(clickedElement,menuUL);
	});
};


EditorHelper.showChooseLinkMenu = function(clickedElement,menuUL,mode){
	var holderParent = EditorHelper.getHolderParent(clickedElement);
	var stripeParent = EditorHelper.getStripeParent(clickedElement);
	var stripeParentType = stripeParent.attr("data-preset-type-id");
	var wrappingLink = EditorHelper.getWrappingLink(clickedElement);
	var linkBehavior = "NONE";
	var textForMenu = clickedElement.attr("data-menu-name").replace("PREVIEW_","").replace("BLOCKS_","").toLowerCase();
	var itemHref = "";
	if (wrappingLink.length > 0 ){
		linkBehavior = wrappingLink.attr("data-link-type");
		itemHref =  wrappingLink.attr("data-href");
	}
	
	if (textForMenu == "social"){
		var socialUrl = clickedElement.find(".social-link-url").attr("data-href");
		window.open(socialUrl);
	}else{
		menuUL.empty().addClass("sub-menu").removeAttr("data-lang");
		//only if a link exists show the remove link option
		if (linkBehavior != "NONE"){
			//Init no link button
			var noLinkBtn =  $("<li id='no-link-btn' data-behavior-type='NOTHING' class='t-t'>Remove Link</li>");
			EditorHelper.initSetLinkBtn(clickedElement,holderParent,noLinkBtn,mode);
			menuUL.append(noLinkBtn);
		}
		
		if (stripeParentType == "BLOG"){
			var postBtn = $("<li id='new-page-btn' data-behavior-type='POST' class='t-t'>Post</li>");
			EditorHelper.initSetLinkBtn(clickedElement,holderParent,postBtn,mode);
			menuUL.append(postBtn);
		}
		
		if (EditorHelper.isProduct(clickedElement)){
			var addToCartBtn = $("<li id='new-page-btn' data-behavior-type='BUY' class='t-t'>Add to Cart</li>");
			EditorHelper.initSetLinkBtn(clickedElement,holderParent,addToCartBtn,mode);
			menuUL.append(addToCartBtn);
		}
		
		var choosepageBtn = $("<li id='new-page-btn' data-behavior-type='EXISTING' class='t-t'>Page</li>");
		EditorHelper.initSetLinkBtn(clickedElement,holderParent,choosepageBtn,mode);
		menuUL.append(choosepageBtn);
		
		//Init External url button
		var externalPageBtn = $("<li id='external-page-btn' data-placeholder='http://www.example.com' data-behavior-type='EXTERNAL'><span  class='t-t part-of-menu'>External Url</span></li>");
		EditorHelper.initSetLinkBtn(clickedElement,holderParent,externalPageBtn,mode);
		menuUL.append(externalPageBtn);
		if (linkBehavior == "EXTERNAL"){
			EditorHelper.initExternalUrl(externalPageBtn,clickedElement,holderParent,itemHref);
		}
		
		//Init Anchor button
		var pageAnchorBtn = $("<li id='anchor-link-btn' data-behavior-type='ANCHOR' class='t-t'>Scroll to</li>");
		EditorHelper.initSetLinkBtn(clickedElement,holderParent,pageAnchorBtn,mode);
		menuUL.append(pageAnchorBtn);
		
		var isPreviewElement = clickedElement.hasClass("preview-element");
		var parentIsMenuOrFooter = ((holderParent.attr("data-preset-type-id")=="MENUS") || (holderParent.attr("data-preset-type-id")=="FOOTERS"));
		var parentContainsAForm = (holderParent.find(".Field").length > 0);
		var clickedElementIsButton = (clickedElement.hasClass("Link"));
		if (isPreviewElement && parentContainsAForm && clickedElementIsButton){
			var submitBtn =  $("<li id='submit-btn' class='has-select' data-behavior-type='SUBMIT'>"+ XPRSTranslator.translateText("Submit  ") +"</li>");
			menuUL.append(submitBtn);
			EditorHelper.initSetLinkBtn(clickedElement,holderParent,submitBtn,mode);
			if (linkBehavior == "SUBMIT"){
				EditorHelper.initSubmitFormBtn(submitBtn,clickedElement,holderParent,itemHref);
			}
		}
		
		var showLightboxOption = isPreviewElement && !(parentIsMenuOrFooter);
		if (showLightboxOption){
			//Init lightbox button
			var lightboxBtn =  $("<li id='more-btn' data-behavior-type='LIGHTBOX' class='t-t'>Lightbox</li>");
			EditorHelper.initSetLinkBtn(clickedElement,holderParent,lightboxBtn,mode);
			menuUL.append(lightboxBtn);
		}
		//Select current link type
		var selectedOption = menuUL.children("[data-behavior-type='"+ linkBehavior +"']");
		selectedOption.addClass("selected");
		menuUL.prepend(selectedOption);

		//Init file upload
		if ($("body[data-allow-file-upload]").length > 0 && EditorHelper.getCurrentUser() != "guest"){
			var fileBtn = $("<li id='file-link-btn' data-behavior-type='FILE'><span class='t-t'>File</span></li>");
			EditorHelper.initFileUpload(fileBtn, function(fileUrl){
				EditorCore.setElementLink(clickedElement.attr("id"), holderParent.attr("id"), "FILE",fileUrl);
				EditorHelper.wrapElementWithLink(clickedElement,fileUrl,"FILE");
				$(".color-picker").spectrum("hide");
				fileBtn.closest(".left-click-menu-holder").remove();
			});
		
			menuUL.append(fileBtn);
		}
		var mailtoBtn =  $("<li id='more-btn' data-prefix='mailto:' data-placeholder='example@example.com' data-behavior-type='EXTERNAL' class='t-t'>Mail</li>");
		EditorHelper.initSetLinkBtn(clickedElement,holderParent,mailtoBtn,mode);
		menuUL.append(mailtoBtn);

		var telBtn =  $("<li id='more-btn' data-prefix='tel:' data-placeholder='555-111-333' data-behavior-type='EXTERNAL' class='t-t'>Telephone</li>");
		EditorHelper.initSetLinkBtn(clickedElement,holderParent,telBtn,mode);
		menuUL.append(telBtn);



	}
	XPRSTranslator.translateDom(menuUL);

};


EditorHelper.isProduct = function(clickedElement){
	var previewPrice = clickedElement.closest(".item-box").find(".preview-price");
	var whitelabelAllowEcommerce = true;
	if (LABEL_CONFIG && "SETTINGS" in LABEL_CONFIG && LABEL_CONFIG.SETTINGS.ALLOW_ECOMMERCE == "disallow" && SpimeEngine.ecommerceSolution == "DISABLED"){
		whitelabelAllowEcommerce = false;
	}
	return (previewPrice.length > 0 && whitelabelAllowEcommerce);
};






EditorHelper.allowLeftClickMenu = function(initiator,related){
	if ($("body").is(".loading")){
		return false;
	}
	$(".color-picker").spectrum("hide");
	var editedElements = $(".edit-on");
	var inModuleMode = $("#xprs").hasClass("site-thumb");
	var inCropMode = $(".crop-mode").length > 0;
	var inAlignControlMode = $("#align-controller-holder.cloned").length > 0;
	var beingResized = $(".being-resized").length > 0;
	var draggables = $(".draggable-div-holder .ui-draggable")
	var draggablesExists = draggables.length > 0;
	
	if (draggablesExists && !initiator.is(".draggable-pic") && !beingResized){
		draggables.resizable("destroy").draggable("destroy");
		if (initiator.is(".draggable-pic")){
			EditorHelper.startDraggableMode(initiator);
			return true
		}else{
			$(".resizing-dragging").removeClass("resizing-dragging");	
		}
		return false;
	}else{
		if (initiator.is(".draggable-pic") && beingResized ){
			return false
		}
	}
	

	if (inAlignControlMode){
			$(".being-edited").resizable('destroy');
			$(".being-edited").draggable('destroy');
			$(".being-edited").removeClass("being-edited");
			$("#align-controller-holder.cloned").remove();
			$(".inner-pic-height-controller-holder , .inner-pic-width-controller-holder ").remove();
	}
	
	if (!initiator.hasClass("edit-on") && !initiator.is("#quick-style-menu.cloned") && !initiator.is(".fontSelectUl")){
		var openQuickStyleMenus = $("#quick-style-menu.cloned");
		
		if (openQuickStyleMenus.length > 0 || $(".text-sidebar-container").length > 0){
			// if (!$(related).is(".edit-on") && !EditorHelper.isTextSelected()){
			if (!$(related).is(".edit-on")){
				//$("#quick-style-menu.cloned , .fontSelectUl").remove();
				var oldMenu = $("#quick-style-menu.cloned");
				if (oldMenu.length > 0 || $(".text-sidebar-container").length > 0){
					oldMenu.find(".color-picker").spectrum("destroy");
					$(".fontSelectUl").remove();
					$(".text-sidebar-container").removeClass("text-sidebar-container")
					$(".text-edit-sidebar").remove();
					oldMenu.remove();
					$(".master.container.narrow-site").css("overflow","");
				}
				EditorHelper.stopElementEditMode($(".edit-on"));
				EditorHelper.removeAllSelections();
				return false;
			}else{
				return false;
			}
		}
	}
	
	if (inCropMode){
		//if (initiator.closest(".item-box").find(".crop-mode").length > 0){
		if (initiator.hasClass("crop-mode")){
			//clicked element is a part of the crop process disallow click
		}else{
			//clicked element is not a part of the crop process. stop crop
			EditorHelper.stopCropMode();
			return true;
		}
	}
	if (typeof VueEditor != "undefined" && !inModuleMode && !inCropMode){
		VueEditor._self.$store.commit("SET_DATA", {section: "volatile",entry: "openDropdown",value: ""});
		VueEditor._router.push("/");
	}
	return (editedElements.length == 0 && !inModuleMode && !inCropMode);
};

EditorHelper.removeUnusedUi = function(){
	EditorHelper.stopCropMode();
};


EditorHelper.startAnchorSelectionMode = function(clickedElement,item){
	$("#xprs").addClass("anchor-selection");
	$('body,html').scrollTop(0);
	$("#xprs").one("click",function(e){
		EditorHelper.stopAnchorSelectionMode();
	});
	
	
	$(".master.item-box").addClass("is-blocked").append($("<div class='anchor-selection-blocker active' />").unbind("click").bind("click",function(e){
		e.stopPropagation();
		var linkUrl = "#" + $(this).closest(".master.item-box").attr("id")
		$(this).addClass("selected");
		$(".anchor-selection-blocker").unbind("click").removeClass("active");
		setTimeout(function(){
			EditorHelper.scrollToItem({"vbid":item.attr("id")},function(){
				EditorHelper.stopAnchorSelectionMode();
				setTimeout(function(){
					EditorHelper.wrapElementWithLink(clickedElement,linkUrl,"ANCHOR");
				},1000);
				EditorCore.setElementLink(clickedElement.attr("id"), item.attr("id"), "ANCHOR", linkUrl);
			});
		},2000);
		
	}));
	$(".floating-plus").removeClass("open").addClass("hidden");
};

EditorHelper.stopAnchorSelectionMode = function(){
	$("#xprs").removeClass("anchor-selection adding-stripes-mode");
	$(".anchor-selection-blocker").remove();
	$(".add-stripe-selection-blocker").remove();
	$(".is-blocked").removeClass("is-blocked");
	$(".rotated-45").removeClass("rotated-45");
	$(".add-stripe-img").attr("opened", "no");
	$(".floating-plus").removeClass("hidden");
};


EditorHelper.getHolderParentId = function(vbid){
	var holder = EditorHelper.getHolderById(vbid);
	var holderParent = EditorHelper.getHolderParent(holder);
	return EditorHelper.getHolderId(holderParent);
};


EditorHelper.creatLeftMenuHolder = function(){
	var leftClickMenuHolder = $("<div />").addClass("left-click-menu-holder part-of-menu top-layer ").attr("data-scroll-pos",$(window).scrollTop());
	leftClickMenuHolder.unbind("mouseout").bind("mouseout",function(e){
		var relatedTargetClass = $(e.relatedTarget).attr("class");
		var isPartOfColorPicker = (relatedTargetClass) ?  (relatedTargetClass.indexOf("sp-") != -1) : false;
		var selectOpen = $(e.target).is("select");
		if (!($(e.relatedTarget).is(".left-click-sub-menu")) && !($(e.relatedTarget).is("li")) &&  !($(e.relatedTarget).hasClass("part-of-menu")) &&  ($(e.relatedTarget).attr("name")!="qqfile") && !isPartOfColorPicker && !selectOpen){
			//Comment the line below in debug to make to hold the left menu open.
			//$("body").disableSelection();
			$(".marked-ecommerce").removeClass("marked-ecommerce");
			$(".marked-delete").removeClass("marked-delete");
			$(".marked").find(".marker").remove();
			$(".marked").removeClass("marked");
			$(".color-picker").spectrum("hide");
			$(this).remove();
		}
	});
	return leftClickMenuHolder;
};


EditorHelper.getElementTypeName = function(clickedElement){
	var textForMenu = clickedElement.attr("data-menu-name").replace("PREVIEW_","").replace("BLOCKS_","").replace("HEADER_","").toLowerCase().replace("_"," ").replace("inline", "").trim();
	if (textForMenu=="link") textForMenu = "button";
	return textForMenu;
}

EditorHelper.createElementRow = function(clickedElement, leftClickMenuHolder){
	var leftClickOptionEdit = $("<li class='part-of-menu' />");
	EditorHelper.addElementMainAction(clickedElement, leftClickOptionEdit, leftClickMenuHolder);
	EditorHelper.addElementRowOptions(clickedElement, leftClickOptionEdit);
	
	return leftClickOptionEdit;
}

EditorHelper.addElementMainAction = function(clickedElement, leftClickOptionEdit, leftClickMenuHolder){
	var textForMenu = EditorHelper.getElementTypeName(clickedElement);
	var textCapitalize = textForMenu.replace("raw","widget");
	textCapitalize = textCapitalize.toUpperCase().substring(0,1) + textCapitalize.substring(1);
	var btnText = XPRSTranslator.translateText("Edit " + textCapitalize);
	var leftClickOptionEditText = $("<span class='action-name part-of-menu extended element-row' />");
	//Dragable state
	if(textForMenu == "draggable pic" ){
		EditorHelper.startDraggableMode(clickedElement);
	}
	var showMarker = (textForMenu == "image" || textForMenu == "video" || textForMenu == "map");
	EditorHelper.markOnHover(leftClickOptionEdit, clickedElement, showMarker);



	leftClickOptionEditText.append("<span class='action-text part-of-menu'>" + btnText + "</span>");
	leftClickOptionEdit.append(leftClickOptionEditText);
	var presetMenuName = clickedElement.attr("data-menu-name").replace("PREVIEW_","").replace("BLOCKS_","").replace("IMAGE","PIC").replace("HEADER_","");
	var relevantColor = XPRSHelper.presetTypes[presetMenuName]["COLOR"];
	leftClickOptionEditText.css("background-color",relevantColor);
		if (textForMenu == "image" || textForMenu == "icon" || textForMenu == "draggable pic"){
			if (clickedElement.attr("id") == "no-image" && clickedElement.closest(".master.item-box").find(".helper-div.middle-center").length > 0){
				leftClickOptionEditText.empty().append("<span class='t-t part-of-menu action-text'>Change Color</span>"  );
			}else{
				leftClickOptionEditText.empty().append("<span class='t-t part-of-menu action-text'>Upload " + textForMenu + "</span>" );
			}

			var menuIcon = $("<div class='part-of-menu left-menu-icon' />");
			leftClickOptionEdit.prepend(menuIcon);
			if (clickedElement.attr("id") == "no-image" && clickedElement.closest(".master.item-box").find(".helper-div.middle-center").length > 0){
				var relevantColor = clickedElement.closest(".inner-pic-holder").css("background-color");
				
				menuIcon.css({
					"background-image":(EditorHelper.isTransparentColor(relevantColor)? "url(/images/backgrounds/transparent_bg.png)":"none"),
					"border-radius":"30px",
					"background-color":relevantColor,
					"box-sizing": "border-box",
					"border": "17px solid rgb(0, 204, 153)"
				});
				menuIcon.parent().css("background-color", "rgb(0, 204, 153)");
			}else{
				menuIcon.css({"background-color":relevantColor,"background-image":"url('/images/ui_icons/replace_image_ico.png')"});
				if (textForMenu == "draggable pic"){
					menuIcon.css({"background-color":relevantColor,"background-image":"url('/images/ui_icons/draggable_pic_ico.png')"});
				}
			}
			
			if (textForMenu == "image" || textForMenu == "icon" || textForMenu == "draggable pic"){
				if (clickedElement.attr("id") != "no-image" || clickedElement.closest(".master.item-box").find(".helper-div.middle-center").length == 0 ){
					EditorHelper.initReplacePicUploader(leftClickOptionEdit,clickedElement);
				}else{
					leftClickOptionEdit.unbind("click touch").bind("click",function(e){
						e.stopPropagation();
						leftClickOptionEdit.find(".stripe-quick-color-btn").show();
						leftClickOptionEdit.find(".color-list-holder").css("transform","translateX(50px)");
					});
					var styleid = clickedElement.closest(".master.item-box").attr("data-styleid");
					if (typeof styleid == "undefined"){
						styleid = clickedElement.closest(".master.item-box").attr("data-preview-styleid");
					}
					var colorPicker = $("<div />").addClass("stripe-quick-color-btn sp-menu inline for-multi");
					leftClickOptionEdit.append(colorPicker);
					var colorProps = {"include_crop":true,"allow_image":true,"background_class":".inner-pic","include_effects":true,"use_style_effects":true,"show_opacity":true,"effects_module":"PREVIEW_INLINE_IMAGE","include_bg_type":true}
					EditorHelper.initQuickColorMenu(colorPicker,clickedElement,styleid,".inner-pic","PREVIEW_INLINE_IMAGE_HOLDER",{})
				}
			}
		}else{
			var menuIcon = $("<div class='part-of-menu left-menu-icon' />").css({"background-color":relevantColor,"background-image":"url('/images/ui_icons/"+ textForMenu +"_ico.png')"});
			leftClickOptionEdit.prepend(menuIcon);

			leftClickOptionEdit.unbind("click").bind("click",function(e){
				e.stopPropagation();
				var holderParent = EditorHelper.getHolderParent(clickedElement);
				var parentVbid = EditorHelper.getHolderId(holderParent);

				if (textForMenu == "html"){
					EditorHelper.initHTMLEditor($(this),clickedElement);
				}
				if (textForMenu == "field"){
					EditorHelper.initFieldSelection(leftClickOptionEdit, clickedElement, parentVbid);
					leftClickMenuHolder.unbind("mouseout");
					leftClickOptionEdit.closest(".top-menu").find("li").not(leftClickOptionEdit).remove();
					return;
				}
				if (textForMenu == "map"){
					EditorHelper.showDraggableTabbedPanel("map-panel", clickedElement);
					
					
		
				}
				
				if (textForMenu == "video"){
					EditorHelper.showDraggableTabbedPanel("video-panel", clickedElement);
				}
				if (textForMenu == "divider"){
					EditorHelper.showDividerQuickStyleMenu(clickedElement);
				}
				if ((textForMenu == "social") || (textForMenu == "raw")){
					if (textForMenu == "social") {
						EditorHelper.showDraggableTabbedPanel("social-edit",clickedElement);
						EditorHelper.showSocialQuickStyleMenu(clickedElement);
						leftClickMenuHolder.remove();
						EditorHelper.startElementEditMode(clickedElement);
					} else {
						var selectedTab = "raw-parameters";
						if(clickedElement.attr("class").indexOf('stripe_') == -1 && clickedElement.attr("class").indexOf('inline_') == -1) selectedTab = "arrange-code";
						if (clickedElement.closest(".preview-raw-wrapper").is(".inline-raw")){
							EditorHelper.showDraggableTabbedPanel("inline-raw-edit",clickedElement,{"selected-tab":selectedTab});
						}else{
							EditorHelper.showDraggableTabbedPanel("inline-raw-edit",clickedElement,{"selected-tab":selectedTab});
						}
						leftClickMenuHolder.remove();
						EditorHelper.startElementEditMode(clickedElement);
					}
				}else{
					leftClickMenuHolder.remove();
					EditorHelper.startElementEditMode(clickedElement);
				}
			});
		}
}

EditorHelper.addElementSpecificRowOptions = function(clickedElement, leftClickOptionEdit){
	var textForMenu = EditorHelper.getElementTypeName(clickedElement);
	var holderParent = EditorHelper.getHolderParent(clickedElement);
	switch(textForMenu){
		case "button":
			//button style
			if (clickedElement.is(".preview-element") && holderParent.attr("data-preset-type-id") != "MENUS"){
				var btn = EditorHelper.createBoxBtn("/images/ui_icons/lightning_icon.png", "Button Style");
				btn.unbind("click").bind("click",function(e){
					e.stopPropagation();
					EditorHelper.showDraggableTabbedPanel("buttons-style-wrapper", clickedElement)
				});
				leftClickOptionEdit.append(btn)
			}
			break;
		case "field":
			//field style
			if (clickedElement.is(".preview-element")){
				var btn = EditorHelper.createBoxBtn("/images/ui_icons/lightning_icon.png", "Field Style");
				btn.unbind("click").bind("click",function(e){
					e.stopPropagation();
					EditorHelper.showDraggableTabbedPanel("form-field-style", clickedElement)
				});
				leftClickOptionEdit.append(btn)
			}
			//Form settings - Item 
			var submitBtnElement = clickedElement.closest(".item-content").find("[data-menu-name='PREVIEW_LINK']");
			if (submitBtnElement.length > 0){
				var wrappingLink = EditorHelper.getWrappingLink(submitBtnElement);
				var itemHref = "";
				if (wrappingLink.length > 0 ){
					linkBehavior = wrappingLink.attr("data-link-type");
					itemHref =  wrappingLink.attr("data-href");
				}
				var formSettingsBtn = EditorHelper.createBoxBtn("/images/ui_icons/form_ico.png", "Form Settings");
				formSettingsBtn.unbind("click").bind("click",function(){
					//$("body").enableSelection();
					var submitMenuHolder = $("<li/>").attr("id","submit-btn").css("background-color","#333").text(XPRSTranslator.translateText("Form Settings"));
					formSettingsBtn.closest(".top-menu").empty().append(submitMenuHolder).addClass("sub-menu").removeAttr("data-lang");
					EditorHelper.initSubmitFormBtn(submitMenuHolder,submitBtnElement,holderParent,itemHref);
				});
				leftClickOptionEdit.append(formSettingsBtn);
			}
			break;
	}
	if (textForMenu == "image" || textForMenu == "icon" || textForMenu == "draggable pic" || textForMenu == "video"){
		if (clickedElement.attr("id") == "no-image" && clickedElement.closest(".master.item-box").find(".helper-div.middle-center").length > 0){
			var replacePicMini = EditorHelper.createBoxBtn("/images/ui_icons/replace_image_ico.png", "Upload Pic");
			EditorHelper.initReplacePicUploader(replacePicMini,clickedElement);
			leftClickOptionEdit.append(replacePicMini);
		}
		var mediaCenterGotoBtn = EditorHelper.createBoxBtn("/images/ui_icons/mediaCenter.png", "Media Center");
		mediaCenterGotoBtn.css("background-size","18px");
		mediaCenterGotoBtn.unbind("click").bind("click",function(e){
			e.stopPropagation();
			EditorHelper.showDraggableTabbedPanel("media-center", clickedElement);
		});
		leftClickOptionEdit.append(mediaCenterGotoBtn);
	}

		//Resize icon
		if (textForMenu == "icon" || (textForMenu == "image" && clickedElement.closest(".blocks_layout").length > 0)){
			var leftClickOptionIconResize = $("<span/>");

			var menuIcon = $("<div class='part-of-menu left-menu-icon hover-icon' />").css({"background-image":"url('/images/ui_icons/resize_ico.png')", "background-size":"30px"});
			leftClickOptionIconResize.append(menuIcon);
			var buttonsList = $("<ul/>").addClass("resize-buttons-holder sp-menu");
			var styleid = clickedElement.closest(".master.item-box").attr("data-styleid");
			if (typeof styleid == "undefined"){
				styleid = clickedElement.closest(".master.item-box").attr("data-preview-styleid");
			}
			var plusOp = $("<li />").addClass("resize-option clickable").attr("id","plus").css({"background-image":"url('/images/ui_icons/increase_ico.png')", "background-size":"75%"}).attr("title", XPRSTranslator.translateText("Enlarge"));
			var minusOp = $("<li />").addClass("resize-option clickable").attr("id","minus").css({"background-image":"url('/images/ui_icons/decrease_ico.png')",  "background-size":"75%"}).attr("title", XPRSTranslator.translateText("Shrink"));
			var resizeButtons = plusOp.add(minusOp);
			var moduleName = clickedElement.attr("data-menu-name")
			resizeButtons.unbind("click").bind("click",function(e){
				e.stopPropagation();
				var currentOP = $(this);
				var sizeValue = clickedElement.width();
				if (currentOP.attr("id") == "plus"){
					sizeValue += 10;
				}else{
					if (sizeValue > 20){
						sizeValue -= 10;
					}
				}
				clickedElement.attr("data-width-before-shrink",sizeValue);
				var params = {};
				params["css_name"] = EditorHelper.StyleSettings["PROPERTIES"]["BACKGROUND_SIZE"].css_name;
				params["class_name"] =  EditorHelper.StyleSettings["MODULES"][moduleName].CSS_CLASS;
				params["value"] = sizeValue;
				params["units"] = "px";
				params["target"] = styleid;
				params["module"] = moduleName;
				EditorHelper.handleStyleChange(params);
				var timerKey = "BACKGROUND_SIZE" + "_" + moduleName + styleid;
				EditorHelper.debounceSave(timerKey,function(){
					EditorHelper.updateMultipleStyleKeys({"styleid":styleid,"props":"BACKGROUND_SIZE","values":sizeValue+"-INT","modules":moduleName},function(){
							XPRSHelper.updateParent({"deliver_to":"parent","action":"saved"});
					});
				});
			});
			buttonsList.append(resizeButtons);
			menuIcon.append(buttonsList);
			leftClickOptionEdit.append(leftClickOptionIconResize);
		}

	//Icon change color
	if((textForMenu == "icon") && clickedElement.closest(".blocks_layout").length == 0) {
		var leftClickOptionChangeColor = $("<li/>").addClass("image-with-menu")
		leftClickOptionChangeColorText = $("<span class='action-name part-of-menu extended t-t' />");
		leftClickOptionChangeColorText.text("Change color");
		var menuIcon = $("<div class='part-of-menu left-menu-icon' />").css({"background-image":"url('/images/ui_icons/color_selector_ico.png')","background-size":"30px"});
		leftClickOptionChangeColor.append(menuIcon);
		var styleid = clickedElement.closest(".master.item-box").attr("data-styleid");
		if (typeof styleid == "undefined"){
			styleid = clickedElement.closest(".master.item-box").attr("data-preview-styleid");
		}
		var colorPicker = $("<div />").addClass("stripe-quick-color-btn sp-menu inline for-multi");
		leftClickOptionChangeColor.append(colorPicker);
		var colorProps = {"include_crop":false,"allow_image":false,"background_class":".icon-source","include_effects":true,"use_style_effects":false,"show_opacity":false,"effects_module":"PREVIEW_ICON_HOLDER","dont_add_colors":true}
		var iconURL = clickedElement.attr("src");
		clickedElement.css("background-image","url("+iconURL+")");
		EditorHelper.initQuickColorMenu(colorPicker,clickedElement,styleid,".preview-icon-holder","PREVIEW_ICON_HOLDER",colorProps);
		clickedElement.css("background-image","none");
		leftClickOptionEdit.append(leftClickOptionChangeColor);
	}

	if (textForMenu == "draggable pic"){
		var leftClickOptionChangeColor = $("<li/>").addClass("image-with-menu");
		var menuIcon = $("<div class='part-of-menu left-menu-icon' />").css({"background-image":"url('/images/ui_icons/color_selector_ico.png')","background-size":"30px"}).attr("title",XPRSTranslator.translateText("Image Options"));
		leftClickOptionChangeColor.append(menuIcon);
		var styleid = clickedElement.closest(".master.item-box").attr("data-styleid");
		if (typeof styleid == "undefined"){
			styleid = clickedElement.closest(".master.item-box").attr("data-preview-styleid");
		}
		var colorPicker = $("<div />").addClass("stripe-quick-color-btn sp-menu inline for-multi");
		leftClickOptionChangeColor.append(colorPicker);
		var colorsListHolder = $("<div/>").addClass("color-list-holder sp-menu top-layer");
		var colorsList = $("<ul/>").addClass("sp-menu");
		var currentState = "cover";
		var btnText = "Fit"
		if (clickedElement.css("background-size") == "cover"){
			btnText = "COVER";
			currentState = "cover";
		}else{
			btnText = "FIT";
			currentState = "contain";
		}
		var cropOp = $("<li />").addClass("clickable more sp-menu t-t").attr("data-state",currentState).text(btnText)
		cropOp.unbind("click").bind("click",function(e){
			var styleid = clickedElement.closest(".master.item-box").attr("data-styleid");
			if (typeof styleid == "undefined"){
				styleid = clickedElement.closest(".master.item-box").attr("data-preview-styleid");
			}
			var newVal = "cover";
			var bgPos = "center center";
			if ($(this).attr("data-state") == "cover"){
				newVal = "contain";
				$(this).text("COVER");
				bgPos = "top left";
				EditorHelper.fitDragBoxToImage(clickedElement);
			}else{
				newVal = "cover";
				$(this).text("FIT");
				EditorHelper.updateMultipleStyleKeys({"styleid":styleid,"props":"IMAGE_SIZE|IMAGE_POSITION","values":newVal + "|center center","modules":"DRAGGABLE_PIC|DRAGGABLE_PIC","vbid":clickedElement.attr("id")+"|"+clickedElement.attr("id")},function(){
					
				});
			}
			EditorHelper.UpdateRealTimeStyle(styleid,"DRAGGABLE_PIC","IMAGE_SIZE",newVal,clickedElement.attr("id"));
			EditorHelper.UpdateRealTimeStyle(styleid,"DRAGGABLE_PIC","IMAGE_POSITION",bgPos,clickedElement.attr("id"));
			$(this).attr("data-state",newVal);
			EditorHelper.closeLeftClickMenu();
			$(".draggable-div-holder .ui-draggable").draggable("destroy").resizable("destroy")
		});
		colorsList.append(cropOp)
		EditorHelper.addEffectOptions(colorsList,styleid,"DRAGGABLE_PIC",clickedElement.css("background-image"),clickedElement.attr("id"))
		colorsListHolder.append(colorsList)
		colorPicker.append(colorsListHolder);
		leftClickOptionEdit.append(leftClickOptionChangeColor);
	}


	//Image video Change color
	if ((textForMenu == "image" ) && clickedElement.closest(".blocks_layout").length == 0) {
		if ( clickedElement.closest(".multi_layout").length == 0){
			var menuIcon = $("<span class='mini-menu-square-btn part-of-menu clickable' title='Crop' />").css({"background-image":"url('/images/ui_icons/crop_ico.png')"});
			menuIcon.unbind("click").bind("click",function(e){
				EditorHelper.startCropMode(clickedElement);
				EditorHelper.closeLeftClickMenu();
			});
			leftClickOptionEdit.append(menuIcon);
		}else{

			var leftClickOptionChangeColor = EditorHelper.createBoxBtn("/images/ui_icons/color_selector_ico.png", "Image Settings");
			var relevantColor = clickedElement.closest(".inner-pic-holder").css("background-color");
			leftClickOptionChangeColor.css({
				"background-image":(EditorHelper.isTransparentColor(relevantColor)? "url(/images/backgrounds/transparent_bg.png)":"none"),
				 "border-radius":"30px",
				 "background-color":relevantColor,
				 "box-sizing": "border-box",
				 "border": "17px solid " + XPRSHelper.presetTypes[textForMenu.toUpperCase()]["COLOR"]
			});


			leftClickOptionChangeColor.unbind("click touch").bind("click",function(e){
				e.stopPropagation();
				// leftClickOptionChangeColor.find(".stripe-quick-color-btn").show();
				EditorHelper.showDraggableTabbedPanel("image-panel", clickedElement);
			});
			// var menuIcon = $("<div class='part-of-menu left-menu-icon' />").css({"background-image":"url('/images/ui_icons/color_selector_ico.png')","background-size":"30px"}).attr("title",XPRSTranslator.translateText("Image Options"));
			// leftClickOptionChangeColor.append(menuIcon);
			var styleid = clickedElement.closest(".master.item-box").attr("data-styleid");
			if (typeof styleid == "undefined"){
				styleid = clickedElement.closest(".master.item-box").attr("data-preview-styleid");
			}
			var colorPicker = $("<div />").addClass("stripe-quick-color-btn sp-menu inline for-multi");
			
			leftClickOptionChangeColor.append(colorPicker);
			
			var colorProps = {"include_crop":true,"allow_image":true,"background_class":".inner-pic","include_effects":true,"use_style_effects":true,"show_opacity":true,"effects_module":"PREVIEW_INLINE_IMAGE","include_bg_type":true}
			if (textForMenu == "video"){
				colorProps["include_crop"] = false
				colorProps["allow_image"] = false
			}
			EditorHelper.initQuickColorMenu(colorPicker,clickedElement,styleid,".inner-pic","PREVIEW_INLINE_IMAGE_HOLDER",colorProps)
			if (clickedElement.attr("id") != "no-image" || clickedElement.closest(".master.item-box").find(".helper-div.middle-center").length == 0){
				leftClickOptionEdit.append(leftClickOptionChangeColor);
			}
		}
	}
}

EditorHelper.addElementRowOptions = function(clickedElement, leftClickOptionEdit){
	var extraOptions = $("<div />").addClass("extended-menu extended part-of-menu");
	var moreBtn = $("<span class='show-more part-of-menu' />").text(":");
	leftClickOptionEdit.find(".action-name").append(moreBtn);
	EditorHelper.addElementSpecificRowOptions(clickedElement, extraOptions);
	extraOptions.append(EditorHelper.elementOrderControlBtn(clickedElement));
	extraOptions.append(EditorHelper.addElementMiniMenu(clickedElement));
	extraOptions.append(EditorHelper.deleteElementMiniMenu(clickedElement));
	leftClickOptionEdit.find(".action-name").append(extraOptions);
}

EditorHelper.addElementMiniMenu = function(clickedElement){
	var btn = EditorHelper.createBoxBtn("/images/ui_icons/add_stripe.png", "Add Element");
	btn.unbind("click").bind("click",function(e){
		e.stopPropagation();
		if (clickedElement.closest(".blocks_layout").length > 0){
			$(".inline-add-element-btn-wrapper").removeClass("inline-add-element-btn-wrapper");
			clickedElement.addClass("inline-add-element-btn-wrapper");
		}
		var clonedElementStack = $("#bottom-toggle-menu-holder").clone();
		EditorHelper.updateToggleButtonsState(clickedElement, clonedElementStack);
		
		EditorHelper.closeLeftClickMenu();
		var leftClickMenuHolder = $("<div />").addClass("left-click-menu-holder  top-layer").attr("data-scroll-pos",$(window).scrollTop());
		var leftClickMenuUL = $("<ul />");
		
		var addElementTitle = $("<li />").text("Add Element:").addClass("not-clickable");
		var stackHolder = $("<li />").addClass("part-of-menu stack-li");
		stackHolder.append(clonedElementStack);
		
		leftClickMenuUL.append(addElementTitle);
		leftClickMenuUL.append(stackHolder);
		var holderPadding = 50; //the safe border to keep menu from disappearing
		holderPadding += 10; //offset from cursor location
		leftClickMenuHolder.css({"top":e.pageY - holderPadding - $(window).scrollTop() ,"right":$(window).width() - e.pageX - holderPadding});
		
		leftClickMenuHolder.append(leftClickMenuUL);
		leftClickMenuHolder.css({"top":e.pageY - holderPadding - $(window).scrollTop(),"right":$(window).width() - e.pageX - holderPadding });
		leftClickMenuHolder.appendTo($("body"));
	
		if (e.pageX < 550 ){
			leftClickMenuHolder.css({"right":"","left":e.pageX - holderPadding});
		}
		
		leftClickMenuHolder.css("padding",holderPadding)
		
		leftClickMenuHolder.unbind("mouseleave").bind("mouseleave",function(e){
			var relatedTargetClass = $(e.relatedTarget).attr("class");
			var isPartOfColorPicker = (relatedTargetClass) ?  (relatedTargetClass.indexOf("sp-") != -1) : false;
			if (!($(e.relatedTarget).is(".left-click-sub-menu")) && !($(e.relatedTarget).is("li")) &&  !($(e.relatedTarget).hasClass("part-of-menu")) &&  ($(e.relatedTarget).attr("name")!="qqfile") && !isPartOfColorPicker){
				EditorHelper.closeLeftClickMenu()
			}
		});
		
		XPRSTranslator.translateDom(leftClickMenuHolder);
		setTimeout(function(){
			leftClickMenuHolder.addClass("shown");
		},10);
		
		clonedElementStack.show();
		
	});
	return btn;
}

EditorHelper.deleteElementMiniMenu = function(clickedElement){
	var btn = $();
	var textForMenu = EditorHelper.getElementTypeName(clickedElement);
	if (clickedElement.attr("id") == "no-image"){
		return btn;
	}
	var textCapitalize = textForMenu.replace("raw","widget");
	textCapitalize = textCapitalize.toUpperCase().substring(0,1) + textCapitalize.substring(1)
	btn = EditorHelper.createBoxBtn("/images/ui_icons/delete_site.png", "Delete " + textCapitalize);
	btn.hover(
		function(){
			clickedElement.addClass("marked-delete");
		},function(){
			clickedElement.removeClass("marked-delete");
		});
		btn.unbind("click").bind("click",function(e){
		e.stopPropagation();
		var btnClicked = $(this);
		var holderParent = EditorHelper.getHolderParent(clickedElement);
		var notTheLastItem = EditorHelper.getHolderParent(holderParent).find(".sub.item-box").length > 1;
		var parentId = EditorHelper.getHolderParent(clickedElement).attr("id");
		var vbid = clickedElement.attr("id");
		if (typeof vbid == "undefined"){
			vbid = clickedElement.closest(".preview-element").attr("id");
		}
		if (typeof vbid == "undefined"){
			vbid = clickedElement.parent().attr("id");
		}
			
		var messageReason = "";
		
		var stripePreset = holderParent.is(".master.item-box") ? holderParent.attr("data-preset-type-id") : EditorHelper.getHolderParent(holderParent).attr("data-preset-type-id") ;
		
		var isLastElement =  notTheLastItem && holderParent.is(".sub.item-box") && holderParent.find(".preview-element").not("#no-image").length == 1;
		if (isLastElement){
			messageReason = "This is the last element in the item,\n";
		}
		if (isLastElement){
			var message = messageReason + "Do you want to remove the entire item?";
			XPRSHelper.xprsAlert(message,{title: "Last element.. Delete entire item?", showCancelButton: true,confirmButtonText:"Yes please",cancelButtonText:"No, Element only","callbackfunc":function(isConfirm){
				if(isConfirm){
					vbid = holderParent.attr("id");
					parentId = EditorHelper.getHolderParent(holderParent).attr("id");
				}
				EditorHelper.handleDelete({"vbid":vbid});
				var stripeId = holderParent.closest(".master.item-box").attr("id");
				XPRSHelper.SAFEPOST("/remove_child",{"parent":parentId , "child": vbid,"stripe_id":stripeId},parentId,{"action_name":"REMOVE-CHILD","pretty_name":"Remove Item"},function() {
				});
			}});
			EditorHelper.closeLeftClickMenu();
			return;
		}
			
		if (stripePreset != "BLOG" && (XPRSHelper.inPresetGroup(stripePreset,"GALLERIES")|| XPRSHelper.inPresetGroup(stripePreset,"FEATURES")) && ((textForMenu == "icon") || (textForMenu == "divider") ||  (textForMenu == "title") || (textForMenu == "subtitle")|| (textForMenu == "body"))){
			if (!holderParent.is(".stripe-header")){
				EditorHelper.closeLeftClickMenu();
				var message = "The element will be removed from all of the items in the current section";
				XPRSHelper.xprsAlert(message,{title: "Remove from all items?", showCancelButton: true,confirmButtonText:"Yes please",cancelButtonText:"No, this item only","callbackfunc":function(isConfirm){
					var stripeId = holderParent.closest(".master.item-box").attr("id");
					var elementType = clickedElement.attr("data-menu-name");
					if(isConfirm){
						var elementsToDelete = holderParent.closest(".master.item-box").find("[data-menu-name='"+elementType+"']");
						var elementsToDeleteIds = {};
						elementsToDelete.each(function(){
							var currentElId = $(this).attr("id");
							var itemParent = $(this).closest(".sub.item-box");
							elementsToDeleteIds[itemParent.attr("id")] = {};
							elementsToDeleteIds[itemParent.attr("id")] = currentElId;
							EditorHelper.handleDelete({"vbid":currentElId});
						});
						XPRSHelper.SAFEPOST("/remove_multiple_elements",{"elemets_ids":JSON.stringify(elementsToDeleteIds),"stripe_id":stripeId},holderParent.closest(".master.item-box").attr("id"),{"action_name":"REMOVE-MULTI","pretty_name":"Remove " + elementsToDelete.length + " " + elementType.toLowerCase().replace("preview_","") + "s"},function() {
							SpimeEngine.ArrangeHolder(holderParent.closest(".master.item-box"))
						});
					}else{
						EditorHelper.handleDelete({"vbid":clickedElement.attr("id")});
						XPRSHelper.SAFEPOST("/remove_child",{"parent":parentId , "child": vbid,"stripe_id":stripeId},parentId,{"action_name":"REMOVE-CHILD","pretty_name":"Remove " + elementType.toLowerCase().replace("preview_","")},function() {
						});
					}
					
				}});
				return;
			}
		}
		if (textForMenu == "cart"){
			clickedElement.remove();
			XPRSHelper.SAFEPOST("/update_specific_key",{"vbid":parentId , "section": "META","updated_key":"SHOW_CART","delete_key":"True"},parentId,"SHOW-CART",function() {
				
			});
			EditorHelper.closeLeftClickMenu();
			return
		}

		if (textForMenu == "button" && holderParent.attr("data-preset-type-id") == "MENUS"){
			if (clickedElement.closest("a").attr("data-link-type") == "EXISTING"){
				var thisPageLink = clickedElement.closest("a[data-link-type='EXISTING']").filter("[data-href$='"+EditorHelper.getPageId()+"']").length;
				if (thisPageLink > 0){
					XPRSHelper.updateParent({"deliver_to":"parent","action":"show-add-to-menu"});
				}
				
			}
			
		}
			
		var thisIsTheLastElement = EditorHelper.isLastElement(clickedElement);
		if (thisIsTheLastElement){
			var message = "This is the last element , Do you want to remove the entire item?";
			XPRSHelper.xprsAlert(message,{title: "Delete entire item?", showCancelButton: true,confirmButtonText:"Yes please",cancelButtonText:"No, Element only","callbackfunc":function(isConfirm){
				if(isConfirm){
					vbid = holderParent.attr("id");
					parentId = EditorHelper.getHolderParent(holderParent).attr("id");
				}
				EditorHelper.handleDelete({"vbid":vbid});
				var stripeId = holderParent.closest(".master.item-box").attr("id");
				XPRSHelper.SAFEPOST("/remove_child",{"parent":parentId , "child": vbid,"stripe_id":stripeId},parentId,{"action_name":"REMOVE-CHILD","pretty_name":"Remove Item"},function() {
				});
			}});
			btnClicked.closest(".left-click-menu-holder").remove();
			return;
		}
		var stripeId = holderParent.closest(".master.item-box").attr("id");
		if (clickedElement.is(".submenu-title")){
			
			XPRSHelper.xprsAlert("Are you sure you want to remove all links in submenu?",{title: "All links in the submenu will be deleted as well!",closeOnCancel:true, showCancelButton: true,confirmButtonText:"Remove All",cancelButtonText:"Cancel","callbackfunc":function(isConfirm){
				if(isConfirm) {
					EditorHelper.handleDelete({"vbid":vbid});
					var submenuLinks = clickedElement.find(".submenu-link");
					childrenToRemove = vbid;
					submenuLinks.each(function(){
							childrenToRemove += "|" + $(this).attr("id")
						});
					XPRSHelper.SAFEPOST("/remove_child",{"parent":parentId , "child": childrenToRemove,"stripe_id":stripeId},parentId,{"action_name":"REMOVE-SUBMENU","pretty_name":"Remove Submenu"},function() {
						});
					EditorHelper.closeLeftClickMenu();
				}
			}});
		}else{
			EditorHelper.handleDelete({"vbid":vbid});
			var actionName = "REMOVE-CHILD";
			if (clickedElement.is(".submenu-link")){
				actionName = "REMOVE-SUBMENU-LINK";
			}
			XPRSHelper.SAFEPOST("/remove_child",{"parent":parentId , "child": vbid,"stripe_id":stripeId},parentId,{"action_name":actionName,"pretty_name":"Remove " + textForMenu},function() {
			});
			
			EditorHelper.closeLeftClickMenu();
		}	
	});
	return btn;
}


EditorHelper.createBoxBtn = function(iconSrc, tooltip){
	tooltip = XPRSTranslator.translateText(tooltip);
	var boxBtn = $("<span />").addClass("mini-menu-square-btn part-of-menu clickable").css("background-image","url("+ iconSrc +")").attr("title", XPRSTranslator.translateText(tooltip));
	return boxBtn;
}

EditorHelper.elementOrderControlBtn = function(clickedElement){
	//Element order - element
	var textForMenu = EditorHelper.getElementTypeName(clickedElement);
	if (textForMenu == "image" && clickedElement.closest(".blocks_layout").length == 0){
		return $();
	}
	var holderParent = EditorHelper.getHolderParent(clickedElement);
	if ((clickedElement.closest(".multi_layout").length > 0 || clickedElement.closest(".blocks_layout").length > 0) && (textForMenu != "map")  && (textForMenu != "raw" || isInlineRaw) && (textForMenu != "video")){

	var isInlineRaw = clickedElement.closest(".preview-raw-wrapper").is(".inline-raw");
	var draggablePicsCount = 0;


	//Should show layers
	if (textForMenu == "draggable pic"){
		draggablePicsCount = clickedElement.closest(".draggable-div-holder").find(".draggable-pic-wrapper").length;
	}
	var MoveButtonsHolder = $("<div/>").addClass("resize-buttons-holder");
	var buttonsList = $("<ul/>").addClass("sp-menu").click(function(e){e.stopPropagation()});
	MoveButtonsHolder.append(buttonsList);
	var styleid = clickedElement.closest(".master.item-box").attr("data-styleid");
	if (typeof styleid == "undefined"){
		styleid = clickedElement.closest(".master.item-box").attr("data-preview-styleid");
	}

	
	var moveUpOp = $("<li />").addClass("resize-option clickable").attr("id","up").css({"background-image":"url('/images/ui_icons/move_element_up_ico.png')"}).attr("title",XPRSTranslator.translateText("Move Up"));
	var moveDownOp = $("<li />").addClass("resize-option clickable").attr("id","down").css({"background-image":"url('/images/ui_icons/move_element_down_ico.png')"}).attr("title",XPRSTranslator.translateText("Move Down"));
	if (textForMenu == "draggable pic"){
		moveDownOp.attr("title", XPRSTranslator.translateText("Send Back"))
		moveUpOp.attr("title", XPRSTranslator.translateText("Bring to Front"))
	}
	EditorHelper.updateMoveArrowsState(textForMenu,clickedElement,moveUpOp,moveDownOp);
	var moveButtons = moveUpOp.add(moveDownOp);
	moveButtons.unbind("click").bind("click",function(e){
		e.stopPropagation();
		var direction = $(this).is("#up") ? "up" : "down";
		if (textForMenu == "draggable pic"){
				direction = $(this).is("#up") ? "down" : "up";
		}
		if (textForMenu == "draggable pic" || draggablePicsCount > 1){
			EditorHelper.orderDraggableImages(holderParent,clickedElement,direction);
		}else{
			var switchedWith = EditorHelper.moveElement(clickedElement,direction);
			var moveElementParams = {"parent":holderParent.attr("id") , "vbid": clickedElement.attr("id"),"direction":direction};
			var stripeId = clickedElement.closest(".master.item-box").attr("id");
			moveElementParams["stripe_id"] = stripeId;
			if (clickedElement.closest(".sub.container.matrix").length > 0 && switchedWith != null){
				moveElementParams["update_native_order"] = true;
				moveElementParams["container_id"] = EditorHelper.getHolderParent(holderParent).attr("id");
				moveElementParams["element_type"] = clickedElement.attr("data-menu-name");
				moveElementParams["sibling_type"] = switchedWith.find(".magic-circle-holder").attr("data-menu-name");
				if (moveElementParams["sibling_type"] == "PREVIEW_LINK"){
					moveElementParams["sibling_type"] = "PREVIEW_LINKS"
				}
			}
			var isBlocks = clickedElement.closest(".blocks_layout").length > 0;
			if (isBlocks){
				moveElementParams["no_skip"] = true;
			}
			XPRSHelper.SAFEPOST("/move_element",moveElementParams,holderParent.attr("id"),"MOVE-ELEMENT",function(res){
				if ("NATIVE_ORDER" in res){
					EditorHelper.handleNativeOrderChange(EditorHelper.getHolderParent(holderParent),res["NATIVE_ORDER"]);
				}
			});
		}
		EditorHelper.updateMoveArrowsState(textForMenu,clickedElement,moveUpOp,moveDownOp);
	});
	buttonsList.append(moveButtons);
	if (textForMenu != "draggable pic" || draggablePicsCount > 1){
		return buttonsList;
	}
}
	
}


EditorHelper.markOnHover = function(btn, target, useMarker, forceColor){
	btn.hover(function(){
		target.addClass("marked");
		if (useMarker){
			var marker = $("<div class='marker' />");
			if (forceColor){
				marker.css("border-color", forceColor);
			}
			marker.hide();
			target.append(marker);
			marker.fadeIn();
		}
	},function(){
		if (useMarker){
			target.find(".marker").remove();
		}
		target.removeClass("marked");
	});
}


EditorHelper.createLinkRow = function(clickedElement, leftClickMenuHolder, leftClickMenuUL){
	var textForMenu = EditorHelper.getElementTypeName(clickedElement);
	var holderParent = EditorHelper.getHolderParent(clickedElement);
	var presetType = holderParent.closest(".master.item-box").attr("data-preset-type-id");
	// ECOMMERCE
	var priceElement = clickedElement.closest(".item-box").find(".preview-price");
	var notBlocks = clickedElement.closest(".blocks").length == 0;
	var priceExists = (priceElement.length > 0);
	var isStore = clickedElement.closest(".master.item-box").attr("data-preset-type-id") == "STORE" && notBlocks;

	//if (clickedElement.attr("id") != "no-image" && ( priceExists || isStore || (presetType && presetType != "MENUS"  && presetType != "FOOTERS" && notBlocks &&  textForMenu != "icon" &&   textForMenu != "raw" && textForMenu != "divider" &&  textForMenu != "map" &&  textForMenu != "video" &&  textForMenu != "social"  &&  textForMenu != "title" &&  textForMenu != "subtitle"  &&  textForMenu != "body" &&  textForMenu !="draggable pic"))){
	if (( priceExists || isStore || (presetType && presetType == "STORE")) && notBlocks ){
		var whitelabelAllowEcommerce = true;
		if (LABEL_CONFIG && "SETTINGS" in LABEL_CONFIG && LABEL_CONFIG.SETTINGS.ALLOW_ECOMMERCE == "disallow" && SpimeEngine.ecommerceSolution == "DISABLED"){
			whitelabelAllowEcommerce = false;
		}
		if (whitelabelAllowEcommerce){
			//Add product
			var leftClickOptionSellProduct = $("<li/>").addClass("sell-product");
			leftClickOptionSellProduct.hover(function(){clickedElement.closest(".sub.item-box").addClass("marked-ecommerce")},function(){clickedElement.closest(".sub.item-box").removeClass("marked-ecommerce")});
			var leftClickOptionSellProductText = $("<span class='action-name part-of-menu extended link-row' />");
			var mode = "add";
			var pid = "N/A";
			if (priceExists){
				pid = priceElement.attr("data-product-id");
			}
			var cartIcon  = $("<div class='part-of-menu left-menu-icon' />").css({"background-image":"url('/images/ui_icons/cart_ico.png')","background-size":"80%","background-repeat":"no-repeat"});
			leftClickOptionSellProduct.append(cartIcon);
			if (priceElement.length == 0 || pid == "N/A"){
				leftClickOptionSellProductText.html(XPRSTranslator.translateText("Sell this product") + " <span class='t-t part-of-menu'>(beta)</span>");
				leftClickOptionSellProduct.add(cartIcon).unbind("click").bind("click",function(e){
					e.stopPropagation();
					EditorHelper.editProduct(clickedElement,mode);
				});
			}else{
				mode = "update";
				if (clickedElement.closest(".master.item-box").is(".show-product-inner-page")){
					leftClickOptionSellProductText.text(XPRSTranslator.translateText("Go To Product Page  "));
				}else{
					leftClickOptionSellProductText.text(XPRSTranslator.translateText("Test Buy  "));
				}
				
				var editGotoBtn = $("<span />").text(" (edit)").addClass("edit-goto part-of-menu t-t");
				leftClickOptionSellProductText.append(editGotoBtn)
				editGotoBtn.unbind("click").bind("click",function(e){
					e.stopPropagation();
					EditorHelper.editProduct(clickedElement,mode);
				});
				leftClickOptionSellProductText.add(cartIcon).unbind("click").bind("click",function(e){
					e.stopPropagation();
					SpimeEngine.buyProduct(pid);
				});
				
			}
			
			leftClickOptionSellProduct.append(leftClickOptionSellProductText);
			if (priceExists || isStore){
				// leftClickOptionSellProduct.css("background-color",XPRSHelper.presetTypes["PRICE"]["COLOR"]).addClass("override-bg");
				// leftClickOptionSellProductText.css("background-color",XPRSHelper.presetTypes["PRICE"]["COLOR"]).addClass("override-bg");
				leftClickMenuUL.prepend(leftClickOptionSellProduct);
				// leftClickMenuUL.addClass("ecommerce-mode");
				
			}else{
				var theDeleteOption = leftClickMenuUL.find(".remove-option");
				leftClickMenuUL.append(leftClickOptionSellProduct);
				//The remove element option should always be the last
				if (theDeleteOption.length > 0 ){
					leftClickMenuUL.append(theDeleteOption);
				}
				
			}
			return leftClickOptionSellProduct;
		}
	}

	var wrappingLink = EditorHelper.getWrappingLink(clickedElement);
	var linkBehavior = "NONE";
	var itemHref = "";
	if (wrappingLink.length > 0 ){
		linkBehavior = wrappingLink.attr("data-link-type");
		itemHref =  wrappingLink.attr("data-href");
	}
	var leftClickOptionSetLink = $("<li/>");

	
	var showMarker = (textForMenu == "image" || textForMenu == "video" || textForMenu == "map");
	EditorHelper.markOnHover(leftClickOptionSetLink, clickedElement, showMarker);

	
	if (textForMenu != "field" && textForMenu != "html" && textForMenu != "raw" && textForMenu != "self" && textForMenu != "price" && textForMenu != "cart" && textForMenu != "divider" && textForMenu != "social" && textForMenu != "draggable pic"){
		leftClickOptionSetLinkText = $("<span class='action-name part-of-menu extended link-row' />");
		leftClickOptionSetLinkText.text(XPRSTranslator.translateText("Link To... "));
		var menuIcon = $("<div class='part-of-menu left-menu-icon' />").css({"background-image":"url('/images/ui_icons/go_to_ico.png')"});
		if(linkBehavior == "POST") {
			menuIcon = $("<div class='part-of-menu left-menu-icon' />").css({"background-image":"url('/images/ui_icons/edit_icon.png')","background-size":"70%"});
		}
		leftClickOptionSetLink.append(menuIcon);
		leftClickOptionSetLink.append(leftClickOptionSetLinkText);
		if (textForMenu == "pagination settings"){
			leftClickOptionSetLinkText.text(XPRSTranslator.translateText("Show More"));
			leftClickOptionSetLink.unbind("click").bind("click",function(e){
				SpimeEngine.showMoreInHolder(holderParent);
			});
		}else{
			if (linkBehavior != "NONE"){
				if (linkBehavior == "LIGHTBOX"){
					leftClickOptionSetLinkText.text(XPRSTranslator.translateText("Open Lightbox  "));
				}
				if (linkBehavior == "SUBMIT"){
					leftClickOptionSetLinkText.text(XPRSTranslator.translateText("Submit  "));
				}
				if (linkBehavior=="EXISTING"){
					var pageId = itemHref.substring(itemHref.lastIndexOf("/") + 1);
					var rootId = EditorHelper.getRootId();
					if (pageId == rootId){
						leftClickOptionSetLinkText.text(XPRSTranslator.translateText("Go Home  "));
					}else{
						var pageName = EditorHelper.getPageName(pageId);
						leftClickOptionSetLinkText.text(XPRSTranslator.translateText("Go to") + " " + pageName + "  ");
					}
				}
				if (linkBehavior=="FILE"){
					leftClickOptionSetLinkText.text(XPRSTranslator.translateText("Download File  "));
				}
				if (linkBehavior=="ANCHOR"){
					leftClickOptionSetLinkText.text(XPRSTranslator.translateText("Scroll to Section  "));
				}
				if (linkBehavior=="BUY"){
					leftClickOptionSetLinkText.text(XPRSTranslator.translateText("Add to Cart   "));
				}
				var editGotoBtn = $("<span />").text(" (edit)").addClass("edit-goto part-of-menu t-t");
				if (linkBehavior=="POST"){
					leftClickOptionSetLinkText.text(XPRSTranslator.translateText("Edit POST  "));
					editGotoBtn = $("<span />").text("(link)").addClass("edit-goto part-of-menu t-t");
				}
				if(linkBehavior=="EXTERNAL" && itemHref.startsWith("mailto:")){
					leftClickOptionSetLinkText.text(XPRSTranslator.translateText("Mail to  "));
				}
				if(linkBehavior=="EXTERNAL" && itemHref.startsWith("tel:")){
					leftClickOptionSetLinkText.text(XPRSTranslator.translateText("Call  "));
				}
				leftClickMenuHolder.addClass("left-click-sub-menu");
				EditorHelper.initChooseLinkMenu(editGotoBtn,clickedElement,leftClickMenuUL);
				leftClickOptionSetLinkText.append(editGotoBtn);
				leftClickOptionSetLink.unbind("click").bind("click",function(e){
					e.stopPropagation();
					if (linkBehavior == "SUBMIT"){
						SpimeEngine.submitClick(clickedElement.closest("a"),clickedElement.closest("a").attr("data-href") );
					}else if (linkBehavior == "FILE"){
						window.location.href = clickedElement.closest("a").attr("data-href");
					}else if (linkBehavior=="LIGHTBOX"){
						$('body,html').scrollTop(0);
						LightBox.itemClick(clickedElement.closest(".item-content"));
					}else if(linkBehavior=="ANCHOR"){
						leftClickMenuHolder.remove();
						var menuOffset = SpimeEngine.calculateScrollOffset();
						$(".marked").removeClass("marked");
						$('body,html').animate({scrollTop:$(itemHref).offset().top + $("body").scrollTop() - menuOffset},2000,'easeOutQuart');
					}else if (linkBehavior=="POST"){
						leftClickOptionSetLinkText.text(XPRSTranslator.translateText("Loading post..."));
						XPRSHelper.POST("/create_post", {"vbid":holderParent.attr("id"),"root_id":EditorHelper.getRootId()}, function(result){
							var waitTime = 1000;
							setTimeout(function(){
								var pageUrl = EditorHelper.getAbsoluteUrl() + "/" + EditorHelper.getRootId() + "/" + result;
								EditorHelper.updateParent({"deliver_to":"parent","action":"viewer-link-click","href":pageUrl,"type":linkBehavior});
							},waitTime);
							
						});
					}else if (linkBehavior=="BUY"){
						whitelabelAllowEcommerce = true;
						if (LABEL_CONFIG && "SETTINGS" in LABEL_CONFIG && LABEL_CONFIG.SETTINGS.ALLOW_ECOMMERCE == "disallow" && SpimeEngine.ecommerceSolution == "DISABLED"){
							whitelabelAllowEcommerce = false;
						}
						var previewPrice = clickedElement.closest(".item-box").find(".preview-price");
						var pid = "N/A";
						if (previewPrice.length > 0 ){
							var pid = previewPrice.attr("data-product-id");
							if (pid != "N/A"){
								SpimeEngine.buyProduct(pid);
							}
						}
						if (whitelabelAllowEcommerce && ((previewPrice.length > 0 && pid == "N/A") || previewPrice.length == 0 )){
							
							var message = "Do you want to create a product for this item?";
							XPRSHelper.xprsAlert(message,{title: "No product attached", showCancelButton: true,confirmButtonText:"Yes please",cancelButtonText:"Nope","callbackfunc":function(isConfirm){
								if(isConfirm){
									EditorHelper.editProduct(clickedElement,"add");
								}
							 }});
						}
					}else{
						EditorHelper.updateParent({"deliver_to":"parent","action":"viewer-link-click","href":itemHref,"type":linkBehavior});
					}
				});
			}else{
				leftClickMenuHolder.addClass("left-click-sub-menu");
				EditorHelper.initChooseLinkMenu(leftClickOptionSetLink,clickedElement,leftClickMenuUL);
			}
		}
	}
	return leftClickOptionSetLink;
}

EditorHelper.createItemRow = function(clickedElement){
	var itemEdit = EditorHelper.createMiniMenuRowBtn(clickedElement, "item-row", "Item Settings", "#555", "/images/ui_icons/menu_item_ico.png");
	EditorHelper.initEditBtn(clickedElement.closest(".sub.item-box"), itemEdit)
	EditorHelper.addItemRowOptions(clickedElement, itemEdit);
	EditorHelper.markOnHover(itemEdit, clickedElement.closest(".sub.item-box"), true);
	return itemEdit;

}


EditorHelper.createMiniMenuRowBtn = function(clickedElement, rowClass, btnText, btnColor, btnIcon){
	var rowBtn = $("<li/>").addClass("part-of-menu");
	var btnText = $("<span class='action-name part-of-menu extended' />").addClass(rowClass).append("<span class='action-text part-of-menu t-t'>" + btnText + "</span>");
	var btnIcon = $("<div class='part-of-menu left-menu-icon' />").css({"background-image":"url(" + btnIcon + ")"});
	rowBtn.append(btnIcon).append(btnText);
	return rowBtn;
}


EditorHelper.createStripeRow = function(clickedElement){
	var holderParent = clickedElement.closest(".master.item-box")
	var presetType = holderParent.attr("data-preset-type-id");
	var editText = (presetType == "MENUS")? "Menu Settings" : "Section Settings";
	var leftClickOptionManageParent = EditorHelper.createMiniMenuRowBtn(clickedElement, "stripe-row", editText, "#555", "/images/ui_icons/menu_section_ico.png");
	if (holderParent.attr("data-preset-type-id") == "MENUS"){
		leftClickOptionManageParent.unbind("click").bind("click",function(e){
			e.stopPropagation();
			EditorHelper.showDraggableTabbedPanel("menu-edit",clickedElement, {"selected-tab":"arrange-menu"});
		});
	}else{
		EditorHelper.initEditBtn(clickedElement.closest(".master.item-box"),leftClickOptionManageParent)
	}
	EditorHelper.markOnHover(leftClickOptionManageParent, clickedElement.closest(".master.item-box"), true);
	EditorHelper.addStripeRowOptions(clickedElement, leftClickOptionManageParent);
	return leftClickOptionManageParent;
}

EditorHelper.addStripeRowOptions = function(clickedElement, leftClickOptionEdit){
	var extraOptions = $("<div />").addClass("extended-menu extended part-of-menu");
	var moreBtn = $("<span class='show-more part-of-menu' />").text(":");
	leftClickOptionEdit.find(".action-name").append(moreBtn);
	var holderParent = clickedElement.closest(".master.item-box");
	var presetType = holderParent.attr("data-preset-type-id");

	if (presetType != "MENUS" && presetType != "FOOTERS"){
		extraOptions.append(EditorHelper.stripeOrderControlBtn(clickedElement));
	}
	extraOptions.append(EditorHelper.stripeAddMiniMenu(clickedElement));
	if (presetType != "MENUS" && presetType != "FOOTERS"){
		extraOptions.append(EditorHelper.stripeCloneMiniMenu(clickedElement));
		extraOptions.append(EditorHelper.stripeDeleteMiniMenu(clickedElement));
	}
	leftClickOptionEdit.find(".action-name").append(extraOptions);
}

EditorHelper.addItemRowOptions = function(clickedElement, leftClickOptionEdit){
	var holderParent = clickedElement.closest(".master.item-box");
	var presetType = holderParent.attr("data-preset-type-id");
	if (holderParent.find(".sub.item-box").length > 1 || XPRSHelper.inPresetGroup(presetType,"SLIDESHOWS")){
		var extraOptions = $("<div />").addClass("extended-menu extended part-of-menu");
		var moreBtn = $("<span class='show-more part-of-menu ' />").text(":");
		leftClickOptionEdit.find(".action-name").append(moreBtn);
		extraOptions.append(EditorHelper.itemOrderControlBtn(clickedElement));
		extraOptions.append(EditorHelper.itemCloneMiniMenu(clickedElement));
		extraOptions.append(EditorHelper.itemDeleteMiniMenu(clickedElement));
		leftClickOptionEdit.find(".action-name").append(extraOptions);
	}	
}


EditorHelper.itemCloneMiniMenu = function(clickedElement){
	if (clickedElement.closest(".blocks_layout").length > 0){
		return $();
	}
	var btn = EditorHelper.createBoxBtn("/images/ui_icons/clone_on.png", "Clone Item");
	btn.click(function(e){
		e.stopPropagation();
		EditorHelper.cloneItemFromManage(clickedElement.closest(".sub.item-box"), false);
	});
	return btn;
}

EditorHelper.itemDeleteMiniMenu = function(clickedElement){
	var btn = EditorHelper.createBoxBtn("/images/ui_icons/sure.png", "Delete Item");
	var holderParent = EditorHelper.getHolderParent(clickedElement);
	var isProductHolder = clickedElement.closest(".master.item-box").find(".product-container").length > 0;
	if (holderParent.attr("data-preset-type-id") != "MENUS" && !isProductHolder){
		// optionNum = "third";
		btn.hover(function(){
			var item = clickedElement.closest(".sub.item-box");
			item.addClass("marked-delete");

		},function(){
			var item = clickedElement.closest(".sub.item-box");
			item.removeClass("marked-delete");
		});
		btn.unbind("click").bind("click",function(e){
			e.stopPropagation();
			var vbid = holderParent.attr("id");
			var stripe = holderParent.closest(".master.item-box");
			if (stripe.find(".sub.item-box").not(".stripe-header").length == 1){
				var message = "This is the only item in this section, deleting it will delete the entire section";
				XPRSHelper.xprsAlert(message,{title: "Last item.. Delete entire Section?", showCancelButton: true,confirmButtonText:"Ok",cancelButtonText:"Cancel","callbackfunc":function(isConfirm){
					if (isConfirm){
						EditorHelper.deleteSection(stripe, function(){
							EditorHelper.closeLeftClickMenu();
						});
						
					}else{
						EditorHelper.closeLeftClickMenu();
					}
				}});
				return
			}
			var parentId = EditorHelper.getHolderParent(holderParent).attr("id");
			EditorHelper.handleDelete({"vbid":vbid});
			var stripeId = holderParent.closest(".master.item-box").attr("id");
			var isStripeHeader = clickedElement.closest(".stripe-header-wrapper").length > 0;
			var undoAction = (isStripeHeader) ? "REMOVE-CHILD-NO-UNDO" : "REMOVE-CHILD";
			XPRSHelper.SAFEPOST("/remove_child",{"parent":parentId , "child": vbid,"stripe_id":stripeId},parentId,{"action_name":undoAction,"pretty_name":"Remove Item"},function() {
				if (isStripeHeader){
					clickedElement.closest(".master.item-box").find(".stripe-header-wrapper").remove();
				}
			});
			EditorHelper.closeLeftClickMenu();
		});
	}
	return btn;
}

EditorHelper.itemOrderControlBtn = function(clickedElement){
	var item = clickedElement.closest(".sub.item-box");
	if (clickedElement.closest(".blocks_layout").length > 0 || item.siblings().length == 0){
		return $();
	}
	var moveButtonsHolder = $("<div/>").addClass("resize-buttons-holder");
	var buttonsList = $("<ul/>").addClass("sp-menu rotate-270");
	moveButtonsHolder.append(buttonsList);
	
	var moveUpOp = $("<li />").addClass("resize-option clickable").attr("id","up").css({"background-image":"url('/images/ui_icons/move_element_up_ico.png')"}).attr("title", XPRSTranslator.translateText("Move Left"));
	var moveDownOp = $("<li />").addClass("resize-option clickable").attr("id","down").css({"background-image":"url('/images/ui_icons/move_element_down_ico.png')"}).attr("title", XPRSTranslator.translateText("Move Right"));
	if (item.next(".sub.item-box").length == 0){
		moveDownOp.addClass("not-active");
	}
	if (item.prev(".sub.item-box").length == 0){
		moveUpOp.addClass("not-active");
	}
	EditorHelper.initMoveUpBtn(clickedElement.closest(".sub.item-box"), moveUpOp);
	EditorHelper.initMoveDownBtn(clickedElement.closest(".sub.item-box"), moveDownOp);
	buttonsList.append(moveUpOp).append(moveDownOp);
	return buttonsList;
}




EditorHelper.stripeAddMiniMenu = function(clickedElement){
	var btn = EditorHelper.createBoxBtn("/images/ui_icons/add_stripe.png", "Add Section");
	btn.click(function(e){
		e.stopPropagation();
		clickedElement.closest(".master.item-box").next(".control-handle").find("#add-stripe").click();
	});
	return btn;
}

EditorHelper.stripeDeleteMiniMenu = function(clickedElement){
	var btn = EditorHelper.createBoxBtn("/images/ui_icons/sure.png", "Delete Section");
	EditorHelper.initDeleteBtn(clickedElement.closest(".master.item-box"), btn);
	return btn;
}

EditorHelper.stripeOrderControlBtn = function(clickedElement){
	var stripe = clickedElement.closest(".master.item-box");
	var moveButtonsHolder = $("<div/>").addClass("resize-buttons-holder");
	var buttonsList = $("<ul/>").addClass("sp-menu");
	moveButtonsHolder.append(buttonsList);
	
	var moveUpOp = $("<li />").addClass("resize-option clickable").attr("id","up").css({"background-image":"url('/images/ui_icons/move_element_up_ico.png')"}).attr("title", XPRSTranslator.translateText("Move Up"));
	var moveDownOp = $("<li />").addClass("resize-option clickable").attr("id","down").css({"background-image":"url('/images/ui_icons/move_element_down_ico.png')"}).attr("title", XPRSTranslator.translateText("Move Down"));
	// EditorHelper.updateMoveArrowsState(textForMenu,clickedElement,moveUpOp,moveDownOp);
	if (stripe.prevAll(".master.item-box:first").length == 0 ){
		moveUpOp.addClass("not-active");
	}else if(stripe.prevAll(".master.item-box:first").attr("data-preset-type-id") == "MENUS"){
		moveUpOp.addClass("not-active");
	}
	if (stripe.nextAll(".master.item-box:first").length == 0 ){
		moveDownOp.addClass("not-active");
	}else if(stripe.nextAll(".master.item-box:first").attr("data-preset-type-id") == "FOOTERS"){
		moveDownOp.addClass("not-active");
	}

	EditorHelper.initMoveUpBtn(stripe, moveUpOp);
	EditorHelper.initMoveDownBtn(stripe, moveDownOp);
	buttonsList.append(moveUpOp).append(moveDownOp);
	return buttonsList;
}



EditorHelper.stripeCloneMiniMenu = function(clickedElement){
	var btn = EditorHelper.createBoxBtn("/images/ui_icons/clone_on.png", "Copy Section");
	EditorHelper.initCopySectionBtn(clickedElement.closest(".master.item-box"),btn);
	return btn;
}

EditorHelper.showMiniMenu = function(clickedElement, e){
	var leftClickMenuHolder = EditorHelper.creatLeftMenuHolder()
	var leftClickMenuUL = $("<ul />").addClass("top-menu");

	var textForMenu = EditorHelper.getElementTypeName(clickedElement);

	var leftClickOptionEdit = EditorHelper.createElementRow(clickedElement, leftClickMenuHolder);
	leftClickMenuUL.append(leftClickOptionEdit);

	var leftClickOptionSetLink = EditorHelper.createLinkRow(clickedElement,leftClickMenuHolder,  leftClickMenuUL);
	leftClickMenuUL.append(leftClickOptionSetLink);


	if (clickedElement.closest("#items-holder").length > 0){
		var leftClickOptionItem = EditorHelper.createItemRow(clickedElement);
		leftClickMenuUL.append(leftClickOptionItem);
	}

	// if ((holderParent.hasClass("sub item-box") && textForMenu != "pagination settings") || holderParent.attr("data-preset-type-id") == "MENUS"){
		var leftClickOptionManageParent = EditorHelper.createStripeRow(clickedElement);
		leftClickMenuUL.append(leftClickOptionManageParent);
	// }

	XPRSTranslator.translateDom(leftClickMenuUL);
	leftClickMenuHolder.append(leftClickMenuUL);
	EditorHelper.positionLeftClickMenu(e,leftClickMenuHolder);
};

EditorHelper.addLeftClickMenu = function(controlsHolder){
	var attachClickTo = controlsHolder.find(".magic-circle-holder");
	if (controlsHolder.hasClass("magic-circle-holder")){
		attachClickTo = attachClickTo.add(controlsHolder);
	}
	//sometimes cached stripes does not have a video blockers
	attachClickTo.filter(".preview-video-source").each(function(){
		if ($(this).find(".video-blocker").length == 0){
			$(this).prepend($("<div class='video-blocker'></div>"));
		}
	});

	attachClickTo.unbind("click touch").bind("click touch",function(e){
		e.stopPropagation();
		e.preventDefault();
		if (EditorHelper.allowLeftClickMenu($(this),e.target)){
			EditorHelper.closeAddStripeMenu();
			var clickedElement = $(this);
			EditorHelper.closeLeftClickMenu();
			if (clickedElement.is(".submenu-title:not(.menu-opened)")){
				menu_layout.toggleSubmenu(clickedElement);
				return
			};
			if (clickedElement.closest(".submenu").length == 0 && !clickedElement.is(".menu-opened")){
				menu_layout.closeOpenedSubmenus();
			}
			$(".floating-plus").removeClass("open");
			EditorHelper.showMiniMenu(clickedElement, e);
			this.blur();
			window.focus();
			return false;
			
		}
	});
};


EditorHelper.startDraggableMode = function(currentDraggablePic){
	var draggablePicHolder = currentDraggablePic.closest(".draggable-pic-wrapper");
	//do not bind draggable to an already draggable element
	if (draggablePicHolder.is(".ui-draggable.ui-resizable")){
		return;
	}
	//check if there are other draggables and turn them off
	var draggables = $(".draggable-div-holder .ui-draggable")
	var draggablesExists = draggables.length > 0;
	if (draggablesExists){
		draggables.resizable("destroy").draggable("destroy");
		$(".resizing-dragging").removeClass("resizing-dragging");
	}
	draggablePicHolder.unbind("click").bind("click",function(e){
		e.stopPropagation();
	})
	
	//Allowing dragging under overlay menus
	currentDraggablePic.closest(".master.item-box").addClass("resizing-dragging");
	if (currentDraggablePic.closest(".master.item-box").prev().prev(".force-transparency").length > 0){
		currentDraggablePic.closest(".master.item-box").prev().prev(".force-transparency").addClass("resizing-dragging");
	}
	
	draggablePicHolder.draggable({
		grid: [ 1, 1 ],
		start:function(event,  ui){
			clearTimeout(EditorHelper.draggableImageTimeout);
			$(this).addClass("being-resized");
		},
		stop:function(event, ui){
			event.stopPropagation();
			var relevantImage = $(this);
			var styleid = currentDraggablePic.closest(".master.item-box").attr("data-styleid");
			if (typeof styleid == "undefined"){
				styleid = currentDraggablePic.closest(".master.item-box").attr("data-preview-styleid");
			}
			var values = parseInt(relevantImage.position().left) + "-INT|" + parseInt(relevantImage.position().top) + "-INT";
			var modules = "DRAGGABLE_PIC_WRAPPER|DRAGGABLE_PIC_WRAPPER";
			if ($("#xprs").is(".tablet-mode")){
				modules = "TABLET_DRAGGABLE_PIC_WRAPPER|TABLET_DRAGGABLE_PIC_WRAPPER";
			}
			if($("#xprs").is(".phone-mode")){
				modules = "PHONE_DRAGGABLE_PIC_WRAPPER|PHONE_DRAGGABLE_PIC_WRAPPER";
			}
			
			var singleModule = modules.substring(modules.indexOf("|")).replace("|","")
			var relevantVbid = relevantImage.find(".magic-circle-holder").attr("id") + "-wrapper";
			EditorHelper.UpdateRealTimeStyle(styleid,singleModule,"POSITION_LEFT",parseInt(relevantImage.position().left),relevantVbid);
			EditorHelper.UpdateRealTimeStyle(styleid,singleModule,"POSITION_TOP",parseInt(relevantImage.position().top),relevantVbid);
			relevantImage.css({"left":"","top":""})
			EditorHelper.UpdateServerStyle(styleid,modules,"POSITION_LEFT|POSITION_TOP",values,relevantVbid + "|" +relevantVbid);
			EditorHelper.draggableImageTimeout = setTimeout(function(){
				 relevantImage.removeClass("being-resized");
			 },500);
		}
	});
	
	var aspectRatio = false;
	if (currentDraggablePic.css("background-size") == "contain"){
		aspectRatio = true;
	}
	draggablePicHolder.resizable({
		handles: 'n, e, s, w, ne, se, sw, nw',
		grid: [ 1, 1 ],
		aspectRatio:aspectRatio,
		start:function(event,  ui){
			clearTimeout(EditorHelper.draggableImageTimeout);
			$(this).addClass("being-resized");
		},
		stop:function(){
			var relevantImage = $(this);
			var currentHandle = relevantImage.data('ui-resizable').axis;
			//we also change position
			
			var styleid = currentDraggablePic.closest(".master.item-box").attr("data-styleid");
			if (typeof styleid == "undefined"){
				styleid = currentDraggablePic.closest(".master.item-box").attr("data-preview-styleid");
			}
			var pixelHeight = parseInt(relevantImage.height());
			//percentHeight = Math.round((percentHeight / parseFloat(relevantImage.parent().height()) * 100.0));
			var width = parseInt(relevantImage.width());
			if (currentDraggablePic.css("background-size") == "contain"){
				var originalImageHeight = parseInt(currentDraggablePic.attr("data-orig-height"));
				var originalImageWidth = parseInt(currentDraggablePic.attr("data-orig-width"));
				var originalRatio = originalImageWidth/originalImageHeight;
				var currentWrapperWidth = draggablePicHolder.width();
				var currentWrapperHeight = draggablePicHolder.height();
				var picWrapperNewWidth = parseInt(currentWrapperHeight*originalRatio);
				width = picWrapperNewWidth;
			}
			
			var relevantVbid = relevantImage.find(".magic-circle-holder").attr("id") + "-wrapper";
			var values = pixelHeight + "-INT|" + width + "-INT";
			var modules = "DRAGGABLE_PIC_WRAPPER|DRAGGABLE_PIC_WRAPPER";
			var finalVbid = relevantVbid;
			var props = "PIXEL_HEIGHT|PIXEL_WIDTH";
			finalVbid = finalVbid + "|" + finalVbid
			if ($("#xprs").is(".tablet-mode")){
				modules = "TABLET_DRAGGABLE_PIC_WRAPPER|TABLET_DRAGGABLE_PIC_WRAPPER";
			}
			if($("#xprs").is(".phone-mode")){
				modules = "PHONE_DRAGGABLE_PIC_WRAPPER|PHONE_DRAGGABLE_PIC_WRAPPER";
			}
			
			var singleModule = modules.substring(modules.indexOf("|")).replace("|","");
			if (currentHandle.indexOf("w") != -1 || currentHandle.indexOf("n") != -1 ){
				EditorHelper.UpdateRealTimeStyle(styleid,singleModule,"POSITION_LEFT",parseInt($(this).position().left),relevantVbid);
				EditorHelper.UpdateRealTimeStyle(styleid,singleModule,"POSITION_TOP",parseInt($(this).position().top),relevantVbid);
				modules = modules + "|" + modules;
				finalVbid = finalVbid + "|" + finalVbid
				props = props + "|" +"POSITION_LEFT|POSITION_TOP";
				values = values + "|" + parseInt(relevantImage.position().left) + "-INT|" + parseInt(relevantImage.position().top) + "-INT";
			}
			
			EditorHelper.UpdateRealTimeStyle(styleid,singleModule,"PIXEL_WIDTH",width,relevantVbid);
			EditorHelper.UpdateRealTimeStyle(styleid,singleModule,"PIXEL_HEIGHT",pixelHeight,relevantVbid);
			relevantImage.css({"width":"","height":"","left":"","top":""})
			
			
//			EditorHelper.updateMultipleStyleKeys({"styleid":styleid,"props":props,"values":values,"modules":modules,"vbid":finalVbid},function(){
//				
//			});
			
			EditorHelper.UpdateServerStyle(styleid,modules,props,values,finalVbid);
			
			EditorHelper.draggableImageTimeout = setTimeout(function(){
				 relevantImage.removeClass("being-resized");
			},500);
		}
	});
	
};

EditorHelper.initFieldSelection = function(leftClickOptionEdit, clickedElement, parentVbid){
	leftClickOptionEdit.addClass("extra-edit no-hover");
	leftClickOptionEdit.unbind("click");
	var oldLabel = clickedElement.attr("name");
	var inputText = $("<input class='part-of-menu' type='text' placeholder='"+ oldLabel +"' />");
	
	
	var saveBtn = $("<input class='part-of-menu' type='button' value='"+XPRSTranslator.translateText("SAVE")+"' />");
	
	var inputHolder = $("<div/>").addClass("part-of-menu");
	leftClickOptionEdit.empty();
	inputHolder.append(inputText).append(saveBtn);
	leftClickOptionEdit.append(inputHolder);
	var isMandatory = $("<input type='checkbox' id='required-field' />");
	if (clickedElement.parent().find("[required]").length > 0 || clickedElement.hasClass("field-mandatory")){
		isMandatory.prop("checked",true);
	}
	var isMandatoryLabel = $("<label class='is-mandatory-label' />");
	isMandatoryLabel.append(isMandatory).append("<span>Mandatory field</span>");
	leftClickOptionEdit.append(isMandatoryLabel);
	var tabs = $("<div class='field-selection-tabs'><div class='tabs-menu'></div></div>");
	var singleTabBtn = $("<span data-tab='.field-selection-single' />").text(XPRSTranslator.translateText("Single Value"));
	var multiTabBtn = $("<span data-tab='.field-selection-multi' />").text(XPRSTranslator.translateText("Multi Options"));
	singleTabBtn.add(multiTabBtn).unbind("click").bind("click",function(e){
		e.stopPropagation();
		$(this).addClass("selected").siblings().removeClass("selected");
		leftClickOptionEdit.find(".field-selection-tab").removeClass("visible");
		var relevantTab = leftClickOptionEdit.find($(this).attr("data-tab"));
		relevantTab.addClass("visible");
		if (relevantTab.find(".selected").length == 0){
			relevantTab.find(".small-toggle-selector").first().addClass("selected");
		}
	});
	tabs.find(".tabs-menu").append(singleTabBtn).append(multiTabBtn)
	var singleTab = $("<div class='field-selection-single field-selection-tab'>");
	var multiTab = $("<div class='field-selection-multi field-selection-tab'>");
	tabs.append(singleTab).append(multiTab);
	leftClickOptionEdit.append(tabs);

	var singleFieldTypes = ["Text", "Email", "Phone", "Date", "Checkbox", "Message"];
	for (let t in singleFieldTypes){
		EditorHelper.createMultiToggleBtn(clickedElement, singleFieldTypes[t], singleTab);
	}
	var multiFieldTypes = ["Dropdown"];
	for (let t in multiFieldTypes){
		EditorHelper.createMultiToggleBtn(clickedElement, multiFieldTypes[t], multiTab);
	}
	if (singleTab.is(".visible")){
		singleTabBtn.addClass("selected");
	}else{
		multiTabBtn.addClass("selected");
	}
	var optionsFactory = $("<div class='options-factory nice-scroller'><span class='options-factory-title'>Options:</span></div>");
	var optionsList = $("<div class='option-factory-list' />");
	//populate list
	if (clickedElement.find("option").length > 0){
		clickedElement.find("option").not(".select-title").each(function(){
			var newOptionField = EditorHelper.createNewFieldOption($(this).val());
			optionsList.append(newOptionField)
		})
	}
	var addNewOption = $("<input type='text' class='add-new-field-option field-option' placeholder='Add new' />");
	var addOptionBtn = $("<i class='fa fa-plus'></i>");
	addOptionBtn.unbind("click").bind("click", function(e){
		e.stopPropagation();
		var newOptionField = $(this).prev(".add-new-field-option");
		if (newOptionField.val() == ""){
			return;
		}
		var newOptionRow = EditorHelper.createNewFieldOption(newOptionField.val());
		newOptionField.val("");

		newOptionField.parent().before(newOptionRow);
		newOptionField.focus();

	});
	var addNewOptionRow = $("<span />");
	addNewOptionRow.append(addNewOption).append(addOptionBtn);
	optionsList.append(addNewOptionRow);
	optionsFactory.append(optionsList);
	multiTab.append(optionsFactory)

	
	saveBtn.unbind("click").bind("click",function(){
		clickedElement = $("#" + parentVbid + " #" + clickedElement.attr("id"));
		var fieldValue = inputText.val();
		var re = /p+(a+|||@|||||)(s+|5+)(w+|v+)(o|||||||0)r+d+/i; 
		if (fieldValue.match(re) != null){
			var message = "We do not tolerate or condone activities related to spam, phishing and internet fraud. We have a strict policy against using such field names in forms built with our editor. We marked the current website as suspicious.";
			XPRSHelper.xprsAlert(message,{title: "Field Name is Not Allowed", showCancelButton: false,confirmButtonText:"OK","callbackfunc":function(isConfirm){
			}});
			EditorHelper.closeLeftClickMenu();
			return;
		}
		if (fieldValue == ""){
			fieldValue = inputText.attr("placeholder");
		}

		var selectedType = saveBtn.closest(".left-click-menu-holder").find(".field-selection-tab.visible .multi-selector.selected").attr("data-value");
		
		var stripeId = clickedElement.closest(".master.item-box").attr("id");
		var optionsValue = "";
		saveBtn.closest(".left-click-menu-holder").find(".field-option").not(".add-new-field-option ").each(function(){
			optionsValue += $(this).val() + ";;;";
		});
		optionsValue = (optionsValue != "") ? optionsValue.slice(0, -3) : optionsValue;
		var fieldRequired = isMandatory.is(":checked");
		var updatedKeys = "LABEL|TEXT|TYPE|OPTIONS|MANDATORY";
		var updatedValues = fieldValue + "|" + fieldValue + "|" + selectedType + "|" + optionsValue + "|" + fieldRequired
		XPRSHelper.SAFEPOST("/update_multiple_child_keys",{"vbid":parentVbid,"child_vbid":clickedElement.attr("id"),"updated_keys":updatedKeys,"updated_values":updatedValues,"stripe_id":stripeId},EditorHelper.getHolderParent(clickedElement).attr("id"),"UPDATE-CHILD",function() {
		});

		EditorHelper.renderFormField(clickedElement, fieldValue, selectedType, optionsValue, fieldRequired);
		
		EditorHelper.closeLeftClickMenu();
	});
	
	inputText.unbind("keypress").bind("keypress",function(event) {
		if (event.keyCode == 13) {
			saveBtn.click(); 
		}
	});
	
	
	inputText.focus();
}


EditorHelper.renderFormField = function(clickedElement, fieldValue, selectedType, optionsValue, fieldRequired){
	var fieldHolder = clickedElement.closest(".field-holder");
	var newField = $();
	switch(selectedType){
		case "text":
		case "email":
		case "phone":
			newField = $("<input />").addClass("placeholder-mode").attr("type","text").attr("name",fieldValue).attr("placeholder", ((fieldRequired)?"* ":"") + fieldValue).attr("data-placeholder",((fieldRequired)?"* ":"") + fieldValue).val(((fieldRequired)?"* ":"") + fieldValue);
			if (fieldRequired){
				newField.attr('required', 'required');
			}
			break;
		case "date":
			newField = $("<label />").addClass("no-value for-date").attr("name",fieldValue);
			var dateField = $("<input type='date' />").addClass("preview-element Field placeholder-mode").attr("name",fieldValue);
			if (fieldRequired){
				dateField.attr('required', 'required');
			}
			var spanTitle = $("<span />").text(((fieldRequired)?"* ":"") + fieldValue);
			newField.append(spanTitle).append(dateField);
			break;
		case "checkbox":
			newField = $("<label />").addClass("no-value").attr("name",fieldValue);
			var checkboxField = $("<input type='checkbox' />").addClass("Field").attr("name",fieldValue);
			var spanTitle = $("<span />").text(fieldValue);
			newField.append(checkboxField).append(spanTitle);
			break;
		case "message":
			newField = $("<textarea/>").attr("id",clickedElement.attr("id")).attr("class",clickedElement.attr("class")).attr("name",fieldValue).attr("placeholder",((fieldRequired)?"* ":"") + fieldValue);
			var attributes = clickedElement.prop("attributes");
			if (fieldRequired){
				newField.attr('required', 'required');
			}
			break;
		case "dropdown":
			newField = $("<select />").attr("name",fieldValue);
			var optionsValuesArr = optionsValue.split(";;;");
			newField.append($("<option />").text(((fieldRequired)?"* ":"") + fieldValue).addClass("select-title").val(""));
			for (var o in optionsValuesArr){
				newField.append($("<option />").text(optionsValuesArr[o]).val(optionsValuesArr[o]));
			}
			if (fieldRequired){
				newField.attr('required', 'required');
			}
			break;
	}
	newField.attr("id", clickedElement.attr("id")).addClass("field-" + selectedType).addClass("preview-element Field magic-circle-holder");
	newField.attr("data-menu-name", "PREVIEW_FIELD");
	EditorHelper.addLeftClickMenu(newField)
	fieldHolder.empty().append(newField)
};

EditorHelper.createNewFieldOption = function(fieldValue){
	var newOption = $("<input type='text' class='field-option' />");
	newOption.val(fieldValue);
	var newOptionRow = $("<div class='field-option-row' />");
	var upArrowOption = $("<i class='fa fa-arrow-up option-btn'></i>").click(function(e){
		e.stopPropagation();
		var prevRow = $(this).parent().prev();
		prevRow.before($(this).parent());
	});
	var downArrowOption = $("<i class='fa fa-arrow-down option-btn'></i>").click(function(e){
		e.stopPropagation();
		var nextRow = $(this).parent().next();
		nextRow.after($(this).parent());
	});
	var removeOption = $("<i class='fa fa-remove option-btn'></i>").click(function(e){
		e.stopPropagation();
		$(this).parent().remove()
	});
	newOptionRow.append(newOption).append(upArrowOption).append(downArrowOption).append(removeOption);
	return newOptionRow;
}



EditorHelper.fitDragBoxToImage = function(clickedElement,itemForPosition){
		if (clickedElement.is(".draggable-pic-wrapper")){
			clickedElement = clickedElement.find(".magic-circle-holder");
		}
		var styleid = clickedElement.closest(".master.item-box").attr("data-styleid");
		if (typeof styleid == "undefined"){
			styleid = clickedElement.closest(".master.item-box").attr("data-preview-styleid");
		}
		var originalImageHeight = parseInt(clickedElement.attr("data-orig-height"));
		var originalImageWidth = parseInt(clickedElement.attr("data-orig-width"));
		var originalRatio = originalImageWidth/originalImageHeight;
		var picWrapper = clickedElement.closest(".draggable-pic-wrapper");
		var currentWrapperWidth = picWrapper.width();
		var currentWrapperHeight = picWrapper.height();
		var picWrapperNewWidth = parseInt(currentWrapperHeight*originalRatio);
		
		var parentHeight = picWrapper.parent().height();
		if (itemForPosition){
			parentHeight = itemForPosition.find(".draggable-div-holder").height();
		}
		
		
		//var percentHeight = percentHeight = Math.round((picWrapperNewHeight / parseFloat(parentHeight) * 100.0));
		
		var modules = "DRAGGABLE_PIC|DRAGGABLE_PIC_WRAPPER|DRAGGABLE_PIC";
		var props = "IMAGE_SIZE|PIXEL_WIDTH|IMAGE_POSITION";
		var values = "contain|" + picWrapperNewWidth + "-INT|top left";
		var vbids = clickedElement.attr("id") + "|" + clickedElement.attr("id") + "-wrapper|"+ clickedElement.attr("id");
		
		
		//picWrapper.height(picWrapperNewHeight)
		//console.log("originalImageHeight " + originalImageHeight + " originalImageWidth " + originalImageWidth +" originalRatio " + originalRatio + " picWrapperNewHeight " + picWrapperNewHeight +" percentHeight " + percentHeight + " parentHeight " + parentHeight);
		if (itemForPosition){
			var centerLeft = parseInt((itemForPosition.find(".draggable-div-holder").width() / 2) - (picWrapperNewWidth / 2));
			var centerTop = parseInt((itemForPosition.find(".draggable-div-holder").height() / 2) - (currentWrapperHeight / 2));
			EditorHelper.UpdateRealTimeStyle(styleid,"DRAGGABLE_PIC_WRAPPER","POSITION_LEFT",centerLeft,clickedElement.attr("id") + "-wrapper");
			EditorHelper.UpdateRealTimeStyle(styleid,"DRAGGABLE_PIC_WRAPPER","POSITION_TOP",centerTop,clickedElement.attr("id") + "-wrapper");
			
			modules += "|DRAGGABLE_PIC_WRAPPER|DRAGGABLE_PIC_WRAPPER";
			props += "|POSITION_LEFT|POSITION_TOP";
			values += "|" + centerLeft+"-INT|" + centerTop + "-INT";
			vbids += "|" + clickedElement.attr("id") + "-wrapper|" + clickedElement.attr("id") + "-wrapper"
			
		}
		EditorHelper.UpdateRealTimeStyle(styleid,"DRAGGABLE_PIC_WRAPPER","PIXEL_WIDTH",picWrapperNewWidth,clickedElement.attr("id") + "-wrapper");

		EditorHelper.updateMultipleStyleKeys({"styleid":styleid,"props":props,"values":values,"modules":modules,"vbid":vbids},function(){
	
		});
		
};



EditorHelper.positionLeftClickMenu = function(e,leftClickMenuHolder){
	var holderPadding = 150; //the safe border to keep menu from disappearing
	leftClickMenuHolder.css({"padding":holderPadding});
	holderPadding += 20; //offset from cursor location
	var menuTop = e.pageY - holderPadding - $(window).scrollTop();
	var menuLeft = e.pageX - holderPadding;
	//FIREFOX FIX
	if (e.target.tagName == "SELECT" && navigator.userAgent.toLowerCase().indexOf('firefox') > -1){
		if (e.pageY == $(window).scrollTop()){
			console.log(e)
			menuTop = $(e.target).offset().top - holderPadding - $(window).scrollTop()
			menuLeft = $(e.target).offset().left - holderPadding + ($(e.target).width() / 2)
		}
	}
	leftClickMenuHolder.css({"top":menuTop ,"left":menuLeft});
	leftClickMenuHolder.appendTo($("body"));
	var menuHeight = leftClickMenuHolder.height();
	
	if (menuLeft + 400 > $(window).width()){
		leftClickMenuHolder.addClass("flipped-horizontal")
	}
	
	if ((menuTop + menuHeight +holderPadding ) > $(window).height() ){
		//var correctionY = (menuTop + menuHeight + holderPadding*2) - $(window).height();
		var correctionY = (menuHeight - holderPadding /2 )
		leftClickMenuHolder.css({"top":menuTop - correctionY - 30,"left":menuLeft});
		EditorHelper.flipLeftClickMenuVertically(leftClickMenuHolder);
	}
	
	setTimeout(function(){
		leftClickMenuHolder.addClass("shown");
	},10);
};



EditorHelper.flipLeftClickMenuVertically = function(leftClickMenuHolder){
	leftClickMenuHolder.addClass("verticaly-flipped")
	var listItems = leftClickMenuHolder.find("ul").first().children('li');
	leftClickMenuHolder.find("ul").first().append(listItems.get().reverse());
};




EditorHelper.updateMoveArrowsState = function(textForMenu,clickedElement,moveUpOp,moveDownOp){
	moveUpOp.removeClass("not-active");
	moveDownOp.removeClass("not-active");
	var nextElementsExist = false;
	var prevElementsExist = false;
	if (textForMenu == "draggable pic"){
		nextElementsExist = clickedElement.closest(".draggable-pic-wrapper").nextAll(".draggable-pic-wrapper").length > 0;
		prevElementsExist = clickedElement.closest(".draggable-pic-wrapper").prevAll(".draggable-pic-wrapper").length > 0;
	}else{
		var nextElements = clickedElement.closest(".order-handle").nextAll(".order-handle");
		nextElements.each(function(){
			var nextElem = $(this);
			if (nextElem.is(".preview-form")){
				if (nextElem.children().not(".element-placeholder").length > 0){
					nextElementsExist = true;
					return false;
				} 
			}else if (nextElem.is(".preview-item-links") ){
				if (nextElem.find(".preview-links-wrapper").children().not(".element-placeholder").length > 0){
					nextElementsExist = true;
					return false;
				}
			}else{
				nextElementsExist = true;
				return false;
			}
		});
		var prevElements = clickedElement.closest(".order-handle").prevAll(".order-handle");
		prevElements.each(function(){
			var prevElem = $(this);
			if (prevElem.is(".preview-form")){
				if (prevElem.children().not(".element-placeholder").length > 0){
					prevElementsExist = true;
					return false;
				} 
			}else if (prevElem.is(".preview-item-links") ){
				if (prevElem.find(".preview-links-wrapper").children().not(".element-placeholder").length > 0){
					prevElementsExist = true;
					return false;
				}
			}else{
				prevElementsExist = true;
				return false;
			}
		});
	}
	
	if (!prevElementsExist){
		if (textForMenu == "draggable pic"){
			moveDownOp.addClass("not-active");
		}else{
			moveUpOp.addClass("not-active");
		}
	}
	if (!nextElementsExist){
		if (textForMenu == "draggable pic"){
			moveUpOp.addClass("not-active");
		}else{
			moveDownOp.addClass("not-active");
		}
	}
};

EditorHelper.orderDraggableImages = function(holderParent,clickedElement,direction){
	var elementHolder = clickedElement.closest(".draggable-pic-wrapper");
	var swapWithHolder = $();
	if (direction=="up"){
		swapWithHolder = elementHolder.prev(".draggable-pic-wrapper");
		elementHolder.insertBefore(swapWithHolder);
	}else{
		swapWithHolder =  elementHolder.next(".draggable-pic-wrapper");
		elementHolder.insertAfter(swapWithHolder);
	}
	var swapWithElement = swapWithHolder.find(".magic-circle-holder");
	var stripeId = holderParent.closest(".master.item-box").attr("id");
	XPRSHelper.SAFEPOST("/swap_elements",{"vbid1":clickedElement.attr("id"),"vbid2":swapWithElement.attr("id"),"parent":holderParent.attr("id"),"stripe_id":stripeId},holderParent.attr("id"),"MOVE-CHILD",function(res){
		
	});
};


EditorHelper.moveElement = function(clickedElement, direction){
	var elementHolder = clickedElement.closest(".order-handle");
	var switchedWith = null;
	elementHolder.prev(".upper-line-break").remove();
	elementHolder.next(".lower-line-break").remove();
	if (direction=="up"){
		var putBefore = $(elementHolder.prevAll(".order-handle").get().reverse())//.first();
		putBefore.each(function(){
			if ($(this).find(".magic-circle-holder").length > 0){
				putBefore = $(this);
				return
			}
		});
		switchedWith = putBefore;
		if (putBefore.prev(".upper-line-break").length > 0){
			putBefore = putBefore.prev(".upper-line-break");
		}
		elementHolder.insertBefore(putBefore);
	}else{
		var putAfter = $(elementHolder.nextAll(".order-handle").get().reverse())//.first();
		putAfter.each(function(){
			if ($(this).find(".magic-circle-holder").length > 0){
				putAfter = $(this);
				return
			}
		});
		switchedWith = putAfter;
		if (putAfter.next(".lower-line-break").length > 0){
			putAfter = putAfter.next(".lower-line-break");
		}
		elementHolder.insertAfter(putAfter);
	}
	if (!clickedElement.is(".item-link")){
		elementHolder.after($("<br class='lower-line-break' />"));
		elementHolder.before($("<br class='upper-line-break' />"));
	}
	return switchedWith;
};




EditorHelper.editProduct = function(clickedElement,mode){
	if (clickedElement.is(".item-details")){
		clickedElement = clickedElement.closest(".item-box").find(".preview-element.image-source.background-div");
	}
	EditorHelper.editProductAfterLogin(clickedElement,mode);
};


EditorHelper.populateEditProduct = function(panel,clickedElement,params){
	
	var inProductPage = clickedElement.closest(".item-content").is(".product-container"); 
	if (!inProductPage){
	if (clickedElement.closest(".master.item-box").hasClass("show-product-inner-page")){
		panel.find("#show-product-page").attr("checked","checked");
	}
	panel.find("#show-product-page").unbind("change").bind("change",function(){
		$(this).addClass("dirty")
	});
	}else{
		panel.find("#show-product-page").closest(".product-page").hide();
	}
	var item = clickedElement.closest(".item-box");
	var mode = params.mode;
	EditorHelper.populateProductFields(item,panel,mode);
	panel.removeClass("add edit").addClass(mode);
	panel.find("form").unbind("submit").bind("submit",function(e) {
		e.preventDefault();
		$(this).find("submit").attr("disabled", "disabled");
		var productName = $(this).find("#product-name");
		var priceElement = clickedElement.closest(".item-box").find(".preview-price");
		if (EditorHelper.validateProductFields(panel,mode)){
			var loadingDiv = $("<div />").addClass("loading-div").css({"height":"100%","width": "100%","position": "absolute","top": "0px","background-color":"#333"});
			panel.append(loadingDiv);
			var formParams =  $( this ).serialize();
			var callbackOnly = false;
			if (SpimeEngine.ecommerceSolution == "IMOS"){
				callbackOnly = true;
			}
			var newPrice = $(this).find("#product-price").val();
			if (newPrice){
				newPrice = newPrice.trim();
			}

			$("body").attr("data-default-currency",$(this).find("#product-currency").val())
			if (mode == "add"){
				
				if (priceElement.length > 0){
					var parentId = EditorHelper.getParent(clickedElement).attr("id")
					EditorHelper.handleDelete({"vbid":priceElement.attr("id")});
					var stripeId = clickedElement.closest(".master.item-box").attr("id");
					XPRSHelper.SAFEPOST("/remove_child",{"parent":parentId , "child": priceElement.attr("id"),"stripe_id":stripeId},parentId,"REMOVE-CHILD-NO-UNDO",function() {
						//EditorHelper.updateParent({"deliver_to":"editor","action":"delete-holder","vbid":priceElement.attr("id"),"parent_vbid":parentId});
					});
				}
				panel.find(".loading-div").remove();
				var elementData = {};
				elementData["PREVIEW"] = {};
				elementData["PREVIEW"]["PRICE"] = EditorHelper.defaultElementValues["PRICE"];
				elementData["PREVIEW"]["PRICE"]["VBID"] = EditorHelper.shortUuid();
				elementData["PREVIEW"]["PRICE"]["PRODUCT_ID"] = EditorHelper.shortUuid();
				elementData["PREVIEW"]["PRICE"]["TEXT"] = EditorHelper.defaultElementValues["PRICE"];;
				elementData["PREVIEW"]["PRICE"]["CONTEXT"] = "PREVIEW";
				EditorHelper.addPreviewElement("PRICE",elementData,item.attr("id"));
				// if no button at all
				if (item.find(".preview-element.item-link").length  == 0){
					var message = "It is common to add a 'Buy Now' button to products, Do you want to add one automatically?";
					XPRSHelper.xprsAlert(message,{title: " Add 'Buy Now' button?", showCancelButton: true,confirmButtonText:"Yes please",cancelButtonText:"No, thank you","callbackfunc":function(isConfirm){
							if(isConfirm){
								elementData["PREVIEW"] = {};
								elementData["PREVIEW"]["LINK"] = EditorHelper.defaultElementValues["LINK"];
								elementData["PREVIEW"]["LINK"]["VBID"] = EditorHelper.shortUuid();
								elementData["PREVIEW"]["LINK"]["CONTEXT"] = "PREVIEW";
								elementData["PREVIEW"]["LINK"]["TEXT"] = "Buy Now";
								elementData["PREVIEW"]["LINK"]["LABEL"] = "Buy Now";
								elementData["PREVIEW"]["LINK"]["LINK"] = {"TYPE":"BUY","URL":"#"};
								EditorHelper.addPreviewElement("LINK",elementData,item.attr("id"));
							}
					}});
				}
				XPRSHelper.trackEvent("Added Product", "General", "");
			}else{
				priceElement.text(newPrice);
				var stripeId = clickedElement.closest(".master.item-box").attr("id");
				var updatedProductKeys = "PRICE|TEXT";
				var updatedProductValues = newPrice + "|" + newPrice

				XPRSHelper.SAFEPOST("/update_multiple_child_keys",{"vbid":EditorHelper.getHolderParent(clickedElement).attr("id"),"child_vbid":priceElement.attr("id"),"updated_keys":updatedProductKeys,"updated_values":updatedProductValues,"stripe_id":stripeId},EditorHelper.getHolderParent(clickedElement).attr("id"),"UPDATE-CHILD",function() {
					var currentPageId = EditorHelper.getMasterId();
					//EditorHelper.updateParent({"deliver_to":"editor","action":"invalidate","vbid":currentPageId});
					panel.find(".loading-div").remove();
					//editProductPopupWrapper.css("display","none");
				});
				
			}
		}
		
		
		
		
		if (productName.is(".dirty")){
			var previewTitle =  clickedElement.closest(".item-box").find(".preview-title");
			if (previewTitle.length > 0){
				previewTitle.text(productName.val())
				productName.removeClass("dirty")
				var stripeId = clickedElement.closest(".master.item-box").attr("id");
				XPRSHelper.SAFEPOST("/update_element_content",{element_id :previewTitle.attr("id") ,parent_id:EditorHelper.getParent(clickedElement).attr("id"),prop_name:"TEXT",prop_value:productName.val(),"stripe_id":stripeId},EditorHelper.getParent(clickedElement).attr("id"),"UPDATE-CHILD");
			}
		}
		
		if (panel.find("#show-product-page").is(".dirty")){
			var stripe = clickedElement.closest(".master.item-box");
			if (panel.find("#show-product-page").is(":checked")){
				stripe.addClass("show-product-inner-page");
				XPRSHelper.SAFEPOST("/update_css_class", {"vbid":stripe.attr("id"),"updated_key":"PRODUCT_INNER_PAGE","updated_value":"show-product-inner-page","stripe_id":stripeId}, EditorHelper.getRootId(), "CSS_CLASS");
			}else{
				stripe.removeClass("show-product-inner-page");
				XPRSHelper.SAFEPOST("/update_css_class", {"vbid":stripe.attr("id"),"updated_key":"PRODUCT_INNER_PAGE","delete_key":"True","stripe_id":stripe.attr("id")}, stripe.attr("id"), "CSS_CLASS");
			}
			
		}
		panel.find(".dirty").removeClass("dirty")
		return false;
	});
	
}

EditorHelper.editProductAfterLogin = function(clickedElement,mode){
		if (mode == "add" && (SpimeEngine.ecommerceSolution == "DISABLED" || SpimeEngine.ecommerceSolution == "IMOS")){
				EditorHelper.addPriceElementIfNeeded(clickedElement,function(alreadyAdded){
				var stripe = clickedElement.closest(".master.item-box");
				EditorHelper.updateStoreCategory(stripe,alreadyAdded);
				return;
			});
			
		}
		EditorHelper.showDraggableTabbedPanel("e-commerce", clickedElement,{"mode":mode})
		return;
};


EditorHelper.addPriceElementIfNeeded = function(clickedElement,callbackFunc){
	var priceAdded = 0;
	var priceElement = clickedElement.closest(".item-box").find(".preview-price");
	//clicked element does not have a price
	if (priceElement.length == 0){
		var elementData = {};
		elementData["PREVIEW"] = {};
		elementData["PREVIEW"]["PRICE"] = EditorHelper.defaultElementValues["PRICE"];
		elementData["PREVIEW"]["PRICE"]["VBID"] = EditorHelper.shortUuid();
		elementData["PREVIEW"]["PRICE"]["PRODUCT_ID"] = elementData["PREVIEW"]["PRICE"]["VBID"].replace("vbid-","product-");
		elementData["PREVIEW"]["PRICE"]["TEXT"] = 20.0;
		elementData["PREVIEW"]["PRICE"]["CONTEXT"] = "PREVIEW";
		EditorHelper.addPreviewElement("PRICE",elementData,clickedElement.closest(".item-box").attr("id"));
		priceAdded = 1;
	}
	var item = clickedElement.closest(".item-box");
	if (item.find(".preview-element.item-link").length  == 0){
		var message = "It is common to add a 'Buy Now' button to products, Do you want to add one automatically?";
		XPRSHelper.xprsAlert(message,{title: " Add 'Buy Now' button?", showCancelButton: true,closeOnCancel:false,closeOnConfirm:false,confirmButtonText:"Yes please",cancelButtonText:"No, thank you","callbackfunc":function(isConfirm){
			   if(isConfirm){
					elementData["PREVIEW"] = {};
					elementData["PREVIEW"]["LINK"] = EditorHelper.defaultElementValues["LINK"];
					elementData["PREVIEW"]["LINK"]["VBID"] = EditorHelper.shortUuid();
					elementData["PREVIEW"]["LINK"]["CONTEXT"] = "PREVIEW";
					elementData["PREVIEW"]["LINK"]["TEXT"] = "Buy Now";
					elementData["PREVIEW"]["LINK"]["LABEL"] = "Buy Now";
					elementData["PREVIEW"]["LINK"]["LINK"] = {"TYPE":"BUY","URL":"#"};
					EditorHelper.addPreviewElement("LINK",elementData,item.attr("id"));
			   }
			   if (typeof callbackFunc != "undefined"){
					callbackFunc(priceAdded)
				}
		}});
	}else{
		if (typeof callbackFunc != "undefined"){
			callbackFunc(priceAdded)
		}
		
	}
};

EditorHelper.updateStoreCategory = function(stripe,alreadyAdded){
	var categoryId = stripe.attr("id");
	var addToCategory = "";
	//This is a standalone stripe, we need to add it to a special category
	if (stripe.is(".page-box")){
		categoryId = EditorHelper.getRootId() + "-STORE-STANDALONE";
		addToCategory = stripe.attr("id")
	}
	
	var newProductsCount = stripe.find(".preview-price[data-product-id='N/A']").each(function(){
		var currentPrice = $(this);
		var currentItem = currentPrice.closest(".item-box")
		currentPrice.attr("data-product-id",currentPrice.attr("id").replace("vbid-","product-"));
		XPRSHelper.SAFEPOST("/update_specific_child_key",{"vbid":currentItem.attr("id"),"child_vbid":currentPrice.attr("id"),"updated_key":"PRODUCT_ID","updated_value":currentPrice.attr("id").replace("vbid-","product-"),"stripe_id":stripe.attr("id")},currentItem.attr("id"),"UPDATE-CHILD",function() {});
	}).length;
	
	newProductsCount = newProductsCount + alreadyAdded;
	
	//Create -STORE if needed and add the category to the store
	XPRSHelper.SAFEPOST("/update_store_category",{"root_id":EditorHelper.getRootId(),"category_id":categoryId,"item_id":addToCategory},stripe.attr("id"),"UPDATE-CHILD",function() {
		$("body").attr("data-os-store-id",EditorHelper.getRootId() + "-STORE");
		$("body").attr("data-ecommerce-solution","IMOS");
		SpimeEngine.ecommerceSolution = "IMOS";
		EditorHelper.createImosSiteIfNeeded(function(){
			var message = "We added " + newProductsCount + " new product" + ((newProductsCount > 1) ? "s" : "") + " to your store. Use the dashboard to manage and configure your store";
			XPRSHelper.xprsAlert(message,{title: "New Products were added", showCancelButton: true,confirmButtonText:"Open dashboard",cancelButtonText:"Close","callbackfunc":function(isConfirm){
				   if(isConfirm){
					   EditorHelper.openImosDashboard("store","",{"vbid":stripe.attr("id")});
				   }
			}});
		});
	});
};


EditorHelper.validateProductFields = function(popupWrapper,mode){
	var form = popupWrapper.find("form");
	var priceField = form.find("#product-price");
	var nameField = form.find("#product-name");
	var price = priceField.val();
	var productName = nameField.val()
	var validationResult = false;
	if ((price) && (!(isNaN(price))) && (price>0) && productName){
		validationResult = true;
	}else{
		if (!productName){
			nameField.addClass("validation-error");
			setTimeout(function(){
				nameField.removeClass("validation-error");
			},2000);
		}else{
			form.find("#product-price").addClass("validation-error");
			setTimeout(function(){
				form.find("#product-price").removeClass("validation-error");
			},2000);
		}
	}
	return validationResult;
};



EditorHelper.populateProductFields = function(item,popupWrapper,mode){
	var productObj = {}
	var form = popupWrapper.find("form");
	var formTitle = popupWrapper.find("#xprs-popup-title");
	form.find("#product-productid").attr("readonly","readonly");
	var previewImage = item.find(".inner-pic.preview-element");
	if (previewImage.length ==0){
		previewImage = item.find(".image-source.preview-element");
	}
	if (previewImage.length > 0){
		var originalSrc = previewImage.css("background-image");
		var imageSrc = originalSrc;
		if (imageSrc.indexOf(",") != -1){
			imageSrc = imageSrc.split(",")[0];
			imageSrc = imageSrc.replace('"','').replace('"','');
		}
		imageSrc = imageSrc.replace("url(","").replace(")","");
		var imageSrc = imageSrc.substring(0,imageSrc.indexOf("=s"));
		imageSrc += "=s60";
		if (imageSrc != "none"){
			popupWrapper.find("#product-image-display").css("background-image",originalSrc);
			form.find("#product-image").val(imageSrc);
			form.find("#product-imagename").val(item.find(".preview-title").text().replace(/&nbsp;/gi, ' '));
		}else{
			popupWrapper.find("#product-image-display").css("background-image","url(/images/ui_icons/product_ico.png)");
		}
	}else{
		popupWrapper.find("#product-image-display").css("background-image","url(/images/ui_icons/product_ico.png)");
	}
	
	var storeDefaultCurrency = $("body").attr("data-default-currency");
	if (typeof storeDefaultCurrency == "undefined" || storeDefaultCurrency == ""){
		storeDefaultCurrency = "USD"
	}
	popupWrapper.find("#product-currency").val(storeDefaultCurrency)
	
	
	if (SpimeEngine.ecommerceSolution == "IMOS"){
		popupWrapper.find("#product-currency").prop('disabled', 'disabled').css("-webkit-appearance","none");
	}
	
	EditorHelper.initReplacePicUploader(popupWrapper.find(".upload-product-pic"),previewImage,function(){
		EditorHelper.populateProductFields(item,popupWrapper,mode);
		popupWrapper.find("form").submit();
	});
	
	form.find("#product-name").unbind("keydown").bind("keydown",function(){
		$(this).addClass("dirty");
	});
	
	form.find("#product-currency").unbind("change").bind("change",function(){
		$(this).addClass("dirty");
	});
	
	form.find("#product-price").unbind("keydown").bind("keydown",function(){
		$(this).addClass("dirty");
	});
	
	if (mode == "add"){
		formTitle.text("E-commerce - Add Product");
		form.find("#product-name").val(item.find(".preview-title").text().replace(/&nbsp;/gi, ' '));
		//form.find("#product-strapline").val(item.find(".preview-subtitle").text()); //creates error
		form.find("#product-price").val("");
	}else{
		formTitle.text("E-commerce - Edit Product");
		var productId = item.find(".preview-price").attr("data-product-id");
		form.find("#product-productid").val(productId);
		var loadingDiv = $("<div />").addClass("loading-div")
		popupWrapper.find("#xprs-popup-holder").append(loadingDiv);
		form.find("#product-name").val(item.find(".preview-title").text().replace(/&nbsp;/gi, ' '));
		form.find("#product-price").val(item.find(".preview-price").text().trim());
		
	}
	return productObj;
};



EditorHelper.addPreviewElement = function(selectedType,elementData,itemVbid){
	var templateSrc = "xprs/preview/";
	var item = EditorHelper.getHolderById(itemVbid);
	if (item.find(".multi_layout").length > 0 ){
		templateSrc = "xprs/ordered/";
	}	
	var itemParent = EditorHelper.getParent(item);
	var parentType = EditorHelper.getTypeOf(itemParent);
	var elementPlaceHolder = EditorHelper.getElementPlaceholder(selectedType,item);
	
	
	var getTemplateParams = {};
	getTemplateParams["element_type"] = "PREVIEW_" + selectedType;
	getTemplateParams["element_data"] = JSON.stringify(elementData);
	getTemplateParams["template_src"] = templateSrc;
	
	getTemplateParams["parent_vbid"] = item.attr("id");
	getTemplateParams["vbid"] = elementData["PREVIEW"][selectedType]["VBID"]
	getTemplateParams["after_id"] = "last";
	getTemplateParams["stripe_id"] = item.closest(".master.item-box").attr("id");
	
	
	XPRSHelper.POST("/add_element",getTemplateParams ,function(resp){
		var dataDiv = $(resp["element_html"]);
		EditorHelper.addLeftClickMenu(dataDiv);
		dataDiv.hide();
		elementPlaceHolder.first().replaceWith(dataDiv);
		
		dataDiv.fadeIn();
		if (parentType == "stripe"){
			SpimeEngine.InitHolder(itemParent);
		}
		if (parentType == "item-preview"){
			var itemGrandParent = EditorHelper.getParent(itemParent);
			SpimeEngine.ArrangeHolder(itemGrandParent);
		}
		itemParent.find(".preview-content-holder").removeClass("empty-holder");
	},"json");
};


EditorHelper.initHTMLEditor = function(btn,clickedElement){
	var stripe = clickedElement.closest(".master.item-box");
	stripe.addClass("src-edit");
	EditorHelper.updateParent({"deliver_to":"parent","action":"block-control-panel"});
	EditorHelper.closeAddStripeMenu();
	
	EditorHelper.hideStripesSeperators();
	EditorHelper.scrollToItem({"vbid":stripe.attr("id")});
	
	var saveBtn = $("<div />").attr("id","save-html").text(XPRSTranslator.translateText("SAVE"));
	var htmlEditorHolder = $("<div />").addClass("html-editor-holder loading");
	htmlEditorHolder.unbind("click").bind("click",function(e){e.stopPropagation();});
	var htmlEditor = $("<div />").addClass("html-editor");
	var preHolder = $("<pre />").attr('contenteditable','true').addClass("language-markup");
	var centerContentHolder = $("<div />").addClass("center-content-holder");
	var centerContentCheckBox = $("<input class='center-content' type='checkbox' value='TRUE'>");
	centerContentCheckBox.unbind("change").bind("change",function() {
        if($(this).is(":checked")) {
        	stripe.find("iframe.html-frame").attr("data-center-content","TRUE")
        }else{
        	stripe.find("iframe.html-frame").attr("data-center-content","FALSE")
        }
        $('#textbox1').val($(this).is(':checked'));        
    });
	centerContentText = $("<span />").text("Center the content");
	centerContentHolder.append(centerContentCheckBox).append(centerContentText);

	htmlEditor.append(preHolder);
	htmlEditorHolder.append(centerContentHolder);
	htmlEditorHolder.append(htmlEditor);
	
	
	EditorHelper.blockAllButHolder(stripe,function(){
		EditorHelper.saveAndCloseHTMLEditor(htmlEditorHolder,preHolder,clickedElement);
	});
	
	stripe.find("iframe.html-frame").css("visibility","hidden");
	stripe.append(htmlEditorHolder);
	htmlEditorHolder.prepend(saveBtn);
	saveBtn.unbind("click").bind("click",function(e){
		e.stopPropagation();
		EditorHelper.saveAndCloseHTMLEditor(htmlEditorHolder,preHolder,clickedElement);
	});
	var centerContent = stripe.find("iframe.html-frame").attr("data-center-content")
	if (centerContent == "TRUE"){
		centerContentCheckBox.attr('checked', true);
	}else{
		centerContentCheckBox.attr('checked', false);
	}
	XPRSHelper.GET(stripe.find("iframe.html-frame").attr("src"), {"from_editor":true}, function(htmlContent){
		preHolder.text(htmlContent);
				htmlEditorHolder.removeClass("loading");
	});
	
};

EditorHelper.saveAndCloseHTMLEditor = function(htmlEditorHolder,preHolder,clickedElement){
	var stripe = clickedElement.closest(".master.item-box");
	htmlEditorHolder.addClass("loading");
	EditorHelper.updateParent({"deliver_to":"parent","action":"unblock-control-panel"});
	EditorHelper.removeAllBlocks();
	EditorHelper.showStripesSeperators();
	var centerContent = stripe.find(".center-content").is(":checked") ? "TRUE" : "FALSE";
	var contentToSave = preHolder.text();
	var newContentId = EditorHelper.shortUuid("static");
	var stripeId = clickedElement.closest(".master.item-box").attr("id");
	XPRSHelper.SAFEPOST("/update_multiple_child_keys",{"vbid":EditorHelper.getHolderParent(clickedElement).attr("id"),"child_vbid":clickedElement.attr("id"),"updated_keys":"URL|CENTER","updated_values":"/html_src/" + newContentId + "|" + centerContent,"stripe_id":stripeId},EditorHelper.getHolderParent(clickedElement).attr("id"),"UPDATE-CHILD",function() {
	//XPRSHelper.SAFEPOST("/update_multiple_child_keys",{"vbid":EditorHelper.getHolderParent(clickedElement).attr("id"),"child_vbid":clickedElement.attr("id"),"updated_keys":"PRICE|TEXT","updated_values":newPrice + "|" + newPrice},EditorHelper.getHolderParent(clickedElement).attr("id"),"UPDATE-CHILD",function() {
		var currentPageId = EditorHelper.getMasterId();
		//EditorHelper.updateParent({"deliver_to":"editor","action":"invalidate","vbid":currentPageId});
	});
	XPRSHelper.POST("/update_html_src", {content_id:newContentId,content:contentToSave,"element_id":clickedElement.attr("id")}, function(){
		setTimeout(function(){
			stripe.find("iframe.html-frame").attr("src","/html_src/" + newContentId + "?center_content=" + centerContent);
			stripe.find("iframe.html-frame").css("visibility","");
			stripe.removeClass("src-edit");
			setTimeout(function(){
				htmlEditorHolder.remove();
			},100);
		},200);
	});
};




EditorHelper.startCropMode = function(clickedElement){
	clickedElement.addClass("crop-mode");
	$(".forced-fill").removeClass("forced-fill");
	var relevantDiv = clickedElement;
	var previewPrefix = "";
	if (!clickedElement.hasClass("background-div") && !clickedElement.hasClass("inner-pic") && !clickedElement.hasClass("background-image-div") && !clickedElement.hasClass("stripe-background")){
		relevantDiv = clickedElement.find(".background-div");
	}
	if (clickedElement.hasClass("preview-element")){
		previewPrefix = "PREVIEW_";
	}
	
	
	if (clickedElement.parent().data('ui-draggable')){
		clickedElement.parent().draggable("disable");
		clickedElement.closest(".preview-content-holder").draggable("disable");
	}
	var currentSize = relevantDiv.css("background-size");
	var originBGPosArr = relevantDiv.css('background-position').split(" ");
	var origin_bg_pos_x = parseInt(originBGPosArr[0]);
	var origin_bg_pos_y = parseInt(originBGPosArr[1]);
    var pointerX = 0;
    var pointerY = 0;
    
    clickedElement.unbind("mousedown").bind("mousedown",function(e){
    	if ($(e.relatedTarget).hasClass("scale-handle")){
    		return false;
    	}
	   	$(this).addClass("mouse-is-down");
	   	pointerX = e.pageX;
	   	pointerY = e.pageY;
    });
    
    clickedElement.unbind("mousemove").bind("mousemove",function(e){
    	 if ( !( $(this).hasClass("mouse-is-down")) ) return;
         var deltaX = e.pageX - pointerX ;
         var deltaY = e.pageY - pointerY ;
         var inverse = -1;
         if (relevantDiv.css("background-size") == "contain" || parseInt(relevantDiv.css("background-size")) < 100 ){
        	 inverse = 1; 
         }
         var deltaInPercentX = deltaX / clickedElement.width() * 100*inverse;
         var deltaInPercentY =  deltaY / clickedElement.height() * 100*inverse;
         var calculatedX = deltaInPercentX*2 + origin_bg_pos_x;
         var calculatedY = deltaInPercentY*2 + origin_bg_pos_y;
         calculatedX = Math.min(calculatedX,100); 
         calculatedY = Math.min(calculatedY,100); 
         calculatedX = Math.max(calculatedX,0); 
         calculatedY = Math.max(calculatedY,0); 
         relevantDiv.css("background-position",calculatedX + "% " + calculatedY + "%");
    });
   
    clickedElement.unbind("mouseup").bind("mouseup",function(e){
    	 $(this).removeClass("mouse-is-down");
    	 if( e.button == 2 ) { 
    		 EditorHelper.stopCropMode();
    	 }
     	var newPos = relevantDiv.css("background-position");
     	if (clickedElement.is(".inner-pic")){
	     	var styleid = clickedElement.closest(".master.item-box").attr("data-styleid");
	    	if (typeof styleid == "undefined"){
	    		styleid = clickedElement.closest(".master.item-box").attr("data-preview-styleid");
	    	}
	    	EditorHelper.updateMultipleStyleKeys({"styleid":styleid,"vbid":clickedElement.attr("id"),"props":"PREVIEW_IMAGE_POSITION","values":newPos,"modules":"PREVIEW_INLINE_IMAGE"},function(){
				 XPRSHelper.updateParent({"deliver_to":"parent","action":"saved"});
			});
	     }else{
	     		EditorHelper.updateStripeData({"vbid":clickedElement.attr("id"),"parent_vbid":EditorHelper.getPageId(),"updated_key":"IMAGE_POSITION","updated_value":newPos,"module_name":previewPrefix + "IMAGE_SPECIFIC"});
	     }
    });
    
    
    
    var cropPanelHolder = $("<div/>").addClass("crop-panel-holder");
    cropPanelHolder.unbind("click").bind("click",function(e){e.stopPropagation();});
    var scaleWrapper = $("<div/>").addClass("scale-wrapper");
    var scaleLabel = $("<span/>").addClass("scale-label toggle-btn t-t").text("scale:");
    var scaleRail = $("<div/>").addClass("scale-rail");
    var scaleRailBenet = $("<div/>").addClass("scale-rail-benet");
    var scaleHandle = $("<div/>").addClass("scale-handle").css("position","absolute");
    var originalSizeBtn = $("<span />").addClass("original-size toggle-btn btn ").text("1:1");
    var containedBtn = $("<span />").addClass("contain-size toggle-btn btn t-t").text("contain");
    var coverSizeBtn = $("<span />").addClass("cover-size toggle-btn btn t-t").text("cover");
    var doneBtn = $("<span />").addClass("done btn t-t").text("DONE");
    
    originalSizeBtn.unbind("click").bind("click",function(e){
    	e.stopPropagation();
    	var dataparent = relevantDiv.closest(".item-content");
    	var origHeight = dataparent.attr("data-orig-thumb-height");
    	var origWidth = dataparent.attr("data-orig-thumb-width");
    	if (typeof origHeight == "undefined"){
    		origHeight = relevantDiv.attr("data-orig-height");
        	origWidth = relevantDiv.attr("data-orig-width");
    	}
    		
    	var newSize = origWidth +"px " + origHeight +"px";
    	EditorHelper.setCropType(cropPanelHolder,clickedElement,relevantDiv,"original",newSize,true,previewPrefix);
    });
    
    containedBtn.unbind("click").bind("click",function(e){
    	e.stopPropagation();
    	EditorHelper.setCropType(cropPanelHolder,clickedElement,relevantDiv,"contain","contain",true,previewPrefix);
    });//.unbind("mousedown").bind("mousedown",function(e){e.stopPropagation();});
    
    coverSizeBtn.unbind("click").bind("click",function(e){
    	e.stopPropagation();
    	EditorHelper.setCropType(cropPanelHolder,clickedElement,relevantDiv,"cover","cover",true,previewPrefix);
    });//.unbind("mousedown").bind("mousedown",function(e){e.stopPropagation();});
    
    doneBtn.unbind("click").bind("click",function(e){
    	e.stopPropagation();
    	EditorHelper.stopCropMode();
    });//.unbind("mousedown").bind("mousedown",function(e){e.stopPropagation();});
    
    scaleRail.append(scaleHandle);
    var initialSize = "100%";//parseInt(relevantDiv.css("background-size"));
    
    scaleHandle.unbind("click").bind("click",function(e){e.stopPropagation();});
    
    scaleHandle.draggable({ containment: "parent", "axis":"x" ,
		start: function( event, ui ) {
			event.stopPropagation();
			clickedElement.removeClass("mouse-is-down");
			cropPanelHolder.find(".toggle-btn").removeClass("selected");
			scaleLabel.addClass("selected");
			initialSize = relevantDiv.css("background-size");
			initialSize = parseInt(initialSize.replace("auto","").replace("%",""));
			if (isNaN(parseInt(initialSize))){
		    	initialSize = "100%";
		    }
		 },
		drag: function( event, ui ) {
			event.stopPropagation();
	    	var newSize = 0;
			var delta = $(this).position().left + 25;
			newSize =  delta;
			newSize = newSize + "%";
			//newSize += " auto";
		    relevantDiv.css("background-size",newSize);
		},
		 stop:function(event,ui){
			 	event.stopPropagation();
		    	var newSize = relevantDiv.css("background-size");
		    	
		     	if (clickedElement.is(".inner-pic")){
			     	var styleid = clickedElement.closest(".master.item-box").attr("data-styleid");
			    	if (typeof styleid == "undefined"){
			    		styleid = clickedElement.closest(".master.item-box").attr("data-preview-styleid");
			    	}
			    	EditorHelper.updateMultipleStyleKeys({"styleid":styleid,"vbid":clickedElement.attr("id"),"props":"PREVIEW_IMAGE_SIZE","values":newSize,"modules":"PREVIEW_INLINE_IMAGE"},function(){
						 XPRSHelper.updateParent({"deliver_to":"parent","action":"saved"});
					});
			     }else{
			     	EditorHelper.updateStripeData({"vbid":clickedElement.attr("id"),"parent_vbid":EditorHelper.getPageId(),"updated_key":"IMAGE_SIZE","updated_value":newSize,"module_name":previewPrefix + "IMAGE_SPECIFIC"});
			     }
		    	
		    	 
		 }
    });
    scaleWrapper.append(scaleRailBenet).append(scaleRail);
    cropPanelHolder.append(scaleLabel).append(scaleWrapper).append(originalSizeBtn).append(containedBtn).append(coverSizeBtn).append(doneBtn);
    var currentSize = relevantDiv.css("background-size");
    if (currentSize.indexOf("px") != -1){
    	EditorHelper.setCropType(cropPanelHolder,clickedElement,relevantDiv,"original",currentSize,false,previewPrefix);
    }else if (currentSize.indexOf("%") != -1){
    	var sizeAsInt = parseInt(currentSize.replace("auto","").replace("%",""));
    	var sizeAsHandlePosition = sizeAsInt - 25;
    	scaleHandle.css("left",sizeAsHandlePosition);
    	scaleLabel.addClass("selected");
    }else{
    	EditorHelper.setCropType(cropPanelHolder,clickedElement,relevantDiv,currentSize,currentSize,false,previewPrefix);
    }
    
    XPRSTranslator.translateDom(cropPanelHolder);
    $("#xprs").append(cropPanelHolder);
    
    //crop menu does not fit in the relevant element
    	var elementTopPos = clickedElement.position().top;
    	var itemTopPos = 0;
    	var item = EditorHelper.getHolderParent(clickedElement);
    	
    	if (item.hasClass("master container")){
    		item = clickedElement.closest(".master.item-box");
    	}
     
        //style menu does not fit in the relevant element parent
        if (item.hasClass("sub item-box")){
        	itemTopPos = item.position().top;
        	item = item.closest(".master.item-box");
        }
    	
    	item.append(cropPanelHolder);
    	var delta =  cropPanelHolder.outerWidth(true) - clickedElement.outerWidth(true);
    	var leftPos = clickedElement.offset().left - delta/2;
    	leftPos = Math.max(0,leftPos);
    	cropPanelHolder.css("left",leftPos);
    	
		var topPos =  itemTopPos + elementTopPos + clickedElement.height();
		var posOffset = 1 
		if (clickedElement.height() > 400){
			posOffset = 3;
		}
		topPos -= (cropPanelHolder.height() * posOffset);
    	cropPanelHolder.css("top",topPos);
    	
    	var topmostComponent = Math.min(cropPanelHolder.offset().top,clickedElement.offset().top);
		var scrollto = topmostComponent - $('.main-page').offset().top + $('.main-page').scrollTop();
		
	    var offset = cropPanelHolder.offset().top;
	    var visibleAreaStart = $(window).scrollTop();
	    var visibleAreaEnd = visibleAreaStart + window.innerHeight;
	    if(offset < visibleAreaStart || offset > visibleAreaEnd){
	         // Not in view so scroll to it
	    	$('body,html').animate({scrollTop:scrollto},2000,'easeOutQuart');
	    }
    
};

EditorHelper.setCropType = function(cropPanelHolder,clickedElement,relevantDiv,cropType,newSize,save,previewPrefix){
	cropPanelHolder.find(".toggle-btn").removeClass("selected");
	cropPanelHolder.find(".toggle-btn." + cropType +"-size").addClass("selected");
	if (save){
		relevantDiv.css("background-position","50% 50%");
		cropPanelHolder.find(".scale-handle").css("left",75);
		relevantDiv.css("background-size",newSize);
		
		if (clickedElement.is(".inner-pic")){
	     	var styleid = clickedElement.closest(".master.item-box").attr("data-styleid");
	    	if (typeof styleid == "undefined"){
	    		styleid = clickedElement.closest(".master.item-box").attr("data-preview-styleid");
	    	}
	    	EditorHelper.updateMultipleStyleKeys({"styleid":styleid,"vbid":clickedElement.attr("id"),"props":"PREVIEW_IMAGE_SIZE","values":newSize,"modules":"PREVIEW_INLINE_IMAGE","reset_arr":"PREVIEW_IMAGE_POSITION"},function(){
				 XPRSHelper.updateParent({"deliver_to":"parent","action":"saved"});
			});
	     }else{
	     	EditorHelper.updateStripeData({"vbid":clickedElement.attr("id"),"parent_vbid":EditorHelper.getPageId(),"updated_key":"IMAGE_SIZE","updated_value":newSize,"module_name":previewPrefix + "IMAGE_SPECIFIC","and_reset":"IMAGE_POSITION"});
	     }
		
		
	}
};


EditorHelper.stopCropMode = function(){
	var clickedElement = $(".crop-mode");
	clickedElement.removeClass("crop-mode");
	clickedElement.unbind("mousedown").unbind("mousemove").unbind("mouseup");
	$(".crop-panel-holder").remove();
	if (clickedElement.parent().data('ui-draggable')){
		clickedElement.parent().draggable("enable");
		clickedElement.closest(".preview-content-holder").draggable("enable");
	}
};


EditorHelper.createMultiToggleBtn = function(clickedElement, fieldType, addToTab){
	var fieldHTML =  $("<div />").addClass("small-toggle-selector multi-selector clickable part-of-menu t-t");
	fieldHTML.attr("data-value",fieldType.toLowerCase()).text(XPRSTranslator.translateText(fieldType));
	if (clickedElement.hasClass("field-" + fieldType.toLowerCase()) || (clickedElement.hasClass("field-mandatory") && fieldType.toLowerCase() == "text")){
		fieldHTML.addClass("selected");
		addToTab.addClass("visible");
	}
	fieldHTML.unbind("click").bind("click",function(){
		// clickedElement = $("#" + parentVbid + " #" + clickedElementId);
		var allButtons = fieldHTML.siblings(".multi-selector").andSelf();
		allButtons.removeClass("selected");
		$(this).addClass("selected");
	});
	addToTab.append(fieldHTML);
	return fieldHTML;
};


EditorHelper.initToggleBtn = function(btn,clickedElement,attrName,parentVbid,elementType){
	btn.unbind("click").bind("click",function(){
		var newState = true;
		if ($(this).hasClass("selected")){
			newState = false;
			if (attrName == "mute"){
				SpimeEngine.sendVideoCommand(clickedElement.attr("id"),"unmute");
			}
			if (attrName == "cover"){
				SpimeEngine.unfitVideo(clickedElement);
			}
		}else{
			if (attrName == "mute"){
				SpimeEngine.sendVideoCommand(clickedElement.attr("id"),"mute");
			}
			if (attrName == "cover"){
				SpimeEngine.fitVideo(clickedElement);
			}
		}
		$(this).toggleClass("selected");
		clickedElement.toggleClass(elementType + "-" + attrName);
		var stripeId = clickedElement.closest(".master.item-box").attr("id");
		//EditorHelper.updateParent({"deliver_to":"editor","action":"set-element-attr","vbid":clickedElement.attr("id"),"parent_vbid":parentVbid,"attr_name":elementType + "_"+attrName,"value":newState});
		XPRSHelper.SAFEPOST("/update_specific_child_key",{"vbid":parentVbid,"child_vbid":clickedElement.attr("id"),"updated_key":"VID_" + attrName.toUpperCase(),"updated_value":newState,"stripe_id":stripeId},EditorHelper.getHolderParent(clickedElement).attr("id"),"UPDATE-CHILD",function() {
			
		});
	});
};


EditorHelper.updateToggleButtonsState = function(clickedElement, elementStack){
	elementStack.find(".item-type-btn-wrapper").each(function(){
		var currentToggleBtn = $(this);
		currentToggleBtn.removeClass("disabled:not([data-elementtype='RAW'])");
		var btnElementType = currentToggleBtn.attr("data-viewer-name");
		var item = EditorHelper.getHolderParent(clickedElement);
		var selectedType = currentToggleBtn.data('elementtype');
		var itemParent = EditorHelper.getParent(clickedElement);
		var presetType = itemParent.attr("data-preset-type-id");
		var whitelabelAllowEcommerce = true;
		if (LABEL_CONFIG && "SETTINGS" in LABEL_CONFIG && LABEL_CONFIG.SETTINGS.ALLOW_ECOMMERCE == "disallow" && SpimeEngine.ecommerceSolution == "DISABLED"){
			whitelabelAllowEcommerce = false;
		}
		if (presetType == "UNRESOLVED" || typeof presetType == "undefined"){
			 var itemGrandParent = EditorHelper.getParent(itemParent);
			presetType = itemGrandParent.attr("data-preset-type-id");
		}
		if(presetType !="FOOTERS" && presetType !="PROMO" && presetType !="MAPS"){
			if(selectedType == "SOCIAL"){
				currentToggleBtn.addClass("disabled");
			}
		}
		
		if(presetType != "FORM"){
			if(selectedType == "FIELD"){
				currentToggleBtn.addClass("disabled");
			}
		}
		if(selectedType == "PRICE"){
			if (!whitelabelAllowEcommerce || XPRSHelper.presetTypes[presetType]["GROUP"] != "GALLERIES" && XPRSHelper.presetTypes[presetType]["GROUP"] != "FEATURES"){
				currentToggleBtn.addClass("disabled");
			}
		}
		
		if(presetType != "MENUS"){
			if(selectedType == "CART"){
				currentToggleBtn.addClass("disabled");
			}
		}else{
			if(selectedType == "CART"){
				if (item.find(".sr-basket-widget").length > 0 || !whitelabelAllowEcommerce){
					currentToggleBtn.addClass("disabled");
				}
			}
			if (selectedType == "DIVIDER"){
				currentToggleBtn.addClass("disabled");
			}
		}
		
		if(presetType=="MENUS" || presetType=="FOOTERS"){
			if(selectedType == "BODY" || selectedType == "PIC" || selectedType == "VIDEO" || selectedType == "MAP"  || selectedType == "FIELD" || selectedType == "RAW" || selectedType == "INLINE_RAW"){
				currentToggleBtn.addClass("disabled");
			}
		}
		
		
		if (item.find(".blocks_layout").length > 0){
			currentToggleBtn.removeClass("disabled");
			if(selectedType == "VIDEO" || selectedType == "MAP"  || selectedType == "FIELD" || selectedType == "CART" || selectedType == "PRICE" || selectedType == "SOCIAL" || selectedType == "RAW"){
				currentToggleBtn.addClass("disabled");
			}
		}
		
		if (item.find(".helper-div.middle-center").length == 0 || item.closest(".flex").length == 0){
			if (selectedType == "DRAGGABLE_PIC"){
				currentToggleBtn.addClass("disabled");
			}
		}
		

		var parentType = EditorHelper.getTypeOf(itemParent);
		var relevantElement = item.find("[data-menu-name='"+btnElementType+"']").last();
		
		if (selectedType == "RAW" && relevantElement.length == 0 && item.find("[data-menu-name='PREVIEW_INLINE_RAW']").last().length > 0){
			currentToggleBtn.removeClass("disabled");
		}

		if (relevantElement.length > 0 &&  selectedType != "LINK" && selectedType != "DRAGGABLE_PIC" && selectedType != "FIELD" && selectedType != "PIC" && item.find(".blocks_layout").length == 0){
				currentToggleBtn.addClass("disabled");
		}else{
			if (selectedType == "PIC"  && item.find(".blocks_layout").length == 0){
				var currentBg = relevantElement.css("background-image");
				if (currentBg != "none"){
					currentToggleBtn.addClass("disabled");
					return;
				}
			}
			
			currentToggleBtn.unbind("click").bind("click",function(e){
				e.stopPropagation();
				if (!item.is(".stripe-header")){
					if ((XPRSHelper.inPresetGroup(presetType,"GALLERIES") || XPRSHelper.inPresetGroup(presetType,"FEATURES")) && ((selectedType == "ICON") || (selectedType == "DIVIDER") ||  (selectedType == "TITLE") || (selectedType == "SUBTITLE")|| (selectedType == "BODY"))){
						var message = "Add element to all of the items in the current section";
						XPRSHelper.xprsAlert(message,{title: "Add to all items?", showCancelButton: true,confirmButtonText:"Yes please",cancelButtonText:"No, this item only","callbackfunc":function(isConfirm){
							if(isConfirm){
								EditorHelper.addElementToMultipleItems(selectedType,btnElementType,item.closest(".master.item-box"));
							}else{
								EditorHelper.adddEl(selectedType,btnElementType,item,itemParent);
							}
							
						}});
					}else{
						if (selectedType == "LINK" && presetType=="MENUS"){
							EditorHelper.handleAddLinkToMenu({"vbid":EditorHelper.checkIfMenuExists(),"link_name":EditorHelper.defaultElementValues["LINK"]["LABEL"]});
						}else{
							EditorHelper.adddEl(selectedType,btnElementType,item,itemParent);
						}
					}
				}else{
					EditorHelper.adddEl(selectedType,btnElementType,item,itemParent);
				}
				EditorHelper.closeLeftClickMenu();
			});
		}
		if (btnElementType == "QUOTE"){
			currentToggleBtn.addClass("disabled");
		}
	});
};


EditorHelper.getElementPlaceholder = function(selectedType,item,afterId){
	var elementPlaceHolder = item.find(".element-placeholder[data-elementtype='"+selectedType+"']");
	if (typeof afterId == "undefined"){
		afterId = "last";
	}
	if( elementPlaceHolder.length == 0){
		
		var elementDefaultPosition = {"ICON":0,"TITLE":1,"SUBTITLE":2,"DIVIDER":3,"BODY":4,"FIELD":5,"LINK":6,"SOCIAL":7};
		elementPlaceHolder = $("<div class='element-placeholder' data-elementtype='"+selectedType+"' style='display:none;'></div>");
		if (afterId != "last" && selectedType != "VIDEO" && selectedType != "MAP"){
			var prevSibling = item.find("#" + afterId);
			if (prevSibling.length > 0){
				var placeAfter = $();
				if (prevSibling.closest(".order-handle").length > 0){
					placeAfter = prevSibling.closest(".order-handle");
					if (placeAfter.next(".lower-line-break").length > 0){
	    				placeAfter = placeAfter.next(".lower-line-break");
	    			}
	    			placeAfter.after(elementPlaceHolder);
					elementPlaceHolder.attr("data-after-id",afterId);
					return elementPlaceHolder;
				}
			}
		}
		if (item.find(".blocks_layout").length > 0){
			var placeAfter = $();
			var locateAddBtn = item.find(".inline-add-element-btn-wrapper");
			if (locateAddBtn.closest(".order-handle").length > 0){
				placeAfter = locateAddBtn.closest(".order-handle");
				afterId = placeAfter.find(".magic-circle-holder").attr("id")
				if (placeAfter.next(".lower-line-break").length > 0){
    				placeAfter = placeAfter.next(".lower-line-break");
    			}
				placeAfter.after(elementPlaceHolder);
				locateAddBtn.removeClass("inline-add-element-btn-wrapper");
			}else{
				var elementsSelectors = [".blocks-preview-icon-holder",".blocks-preview-title-holder",".blocks-preview-subtitle-holder",".blocks-preview-body-holder"];
				if (selectedType in elementDefaultPosition){
					var testElement = item.find(".blocks-preview-content-holder .order-handle" + elementsSelectors[elementDefaultPosition[selectedType]]);
					//this kind is already present
					if (testElement.length > 0){
						//console.log("found another " + selectedType + " adding at the end")
						item.find(".blocks-preview-content-holder").append(elementPlaceHolder);
			    		afterId = "last";
					}else{
						//first time adding this kind
						//console.log("this is the first  " + selectedType)
						if(elementDefaultPosition[selectedType] == 0) {
							//console.log("the postion is 0 adding at the beginning")
					    	item.find(".blocks-preview-content-holder").prepend(elementPlaceHolder);
					    	afterId = "first";
					    }else{
					    	//console.log("searching for the correct position")
					    	var j = elementDefaultPosition[selectedType] -1;
					    	while(j >= 0){
					    		testElement = item.find(".blocks-preview-content-holder .order-handle" + elementsSelectors[j])
					    		if (testElement.length > 0){
					    			placeAfter = testElement;
					    			j = 0;
					    		}
					    		j--;
					    	}
					    
							if (placeAfter.length > 0){
				    			afterId = placeAfter.find(".magic-circle-holder").attr("id")
				    			//console.log("found the element to place after " + afterId)
				    			if (placeAfter.next(".lower-line-break").length > 0){
				    				placeAfter = placeAfter.next(".lower-line-break");
				    			}
				    			placeAfter.after(elementPlaceHolder);
				    			
					    	}else{
					    		//console.log("did not found where to place... placing last")
					    		item.find(".blocks-preview-content-holder").append(elementPlaceHolder);
					    		afterId = "last";
					    	}
					    }
						
					}
				}else{
					//console.log("the selected type has no specific order. adding last")
					item.find(".blocks-preview-content-holder").append(elementPlaceHolder);
		    		afterId = "last";
				}
			}
		}else{
			
			//UPADTE NATIVE ORDER IF ELEMENT TYPE NOT THERE!!!
			if (selectedType == "DIVIDER"){
				if (item.find(".multi_layout").length > 0 && item.closest(".matrix").length > 0){
					XPRSHelper.POST("/update_native_order_if_needed", {"parent_id":EditorHelper.getParent(item).attr("id"),"selected_type":"PREVIEW_DIVIDER"}, function(){
	    			
					});
				}
			}
			
			if (selectedType != "VIDEO" && selectedType != "MAP"){
				//Adding according to default place
				var elementsSelectors = [".preview-icon-holder",".preview-title-holder",".preview-subtitle-holder",".preview-body-holder"];
				if (selectedType in elementDefaultPosition){
				    if(elementDefaultPosition[selectedType] == 0) {
				    	item.find(".preview-content-holder").prepend(elementPlaceHolder);
				    	afterId = "first";
				    }else{
				    	var j = elementDefaultPosition[selectedType] -1;
				    	var placeAfter = $();
				    	while(j >= 0){
				    		var testElement = item.find(".preview-content-holder .order-handle" + elementsSelectors[j])
				    		if (testElement.length > 0){
				    			placeAfter = testElement;
				    			j = 0;
				    		}
				    		j--;
				    	}
				    	//var placeAfter = item.find(".preview-content-holder .order-handle").eq(elementDefaultPosition[selectedType] - 1);
			    		if (placeAfter.length > 0){
			    			afterId = placeAfter.find(".magic-circle-holder").attr("id")
			    			//console.log("need to place after " + afterId)
			    			if (placeAfter.next(".lower-line-break").length > 0){
			    				placeAfter = placeAfter.next(".lower-line-break");
			    				//console.log("there are br")
			    			}
			    			//console.log("this is after length " + placeAfter.length)
			    			placeAfter.after(elementPlaceHolder);
			    			
				    	}else{
				    		afterId = "first";
				    		item.find(".preview-content-holder").prepend(elementPlaceHolder);
				    	}
				    }
				}else{
					item.find(".preview-content-holder").append(elementPlaceHolder);
					afterId = "last";
				}
			}else{
				item.find(".inner-pic.preview-element").append(elementPlaceHolder);
				afterId = "last";
			}
		}
	}else{
		var elementBefore = elementPlaceHolder.prevAll(".order-handle").first();
		var presetType = item.closest(".master.item-box").attr("data-preset-type-id");
		if (elementBefore.length > 0){
			afterId = elementBefore.find(".magic-circle-holder").attr("id");
			if (!afterId){
				afterId = "last";
			}
		}else if (presetType == "MENUS" && selectedType == "LINK"){
			elementBefore = elementPlaceHolder.prevAll(".removable-parent").first();
			afterId = elementBefore.find(".magic-circle-holder").attr("id");
			if (!afterId){
				afterId = "last";
			}
		}else{
			afterId = "first"
		}
	}
	
	elementPlaceHolder.attr("data-after-id",afterId);
	return elementPlaceHolder;
};


EditorHelper.adddEl = function(selectedType,btnElementType,item,itemParent, callbackFunc){
	var templateSrc = "xprs/preview/";
	var parentType = EditorHelper.getTypeOf(itemParent);
	
	var elementPlaceHolder = EditorHelper.getElementPlaceholder(selectedType,item);
	var afterId = elementPlaceHolder.attr("data-after-id");

	
	if (selectedType == "DRAGGABLE_PIC"){
		EditorHelper.addDraggableImage(item);
		return;
	}
	
	if (selectedType == "PRICE"){
		EditorHelper.editProduct(item,"add");
		return;
	}
	if (item.find(".multi_layout").length > 0 ){
		templateSrc = "xprs/ordered/";
	}	
	
	
	var elementData = {};
	elementData["PREVIEW"] = {};
	elementData["PREVIEW"][selectedType] = EditorHelper.defaultElementValues[selectedType];
	
	if (selectedType == "ICON"){
		if (EditorHelper.shortcodesJson){
			for(i in EditorHelper.shortcodesJson["CHILDREN"]){
				var child = Object.getOwnPropertyNames(EditorHelper.shortcodesJson["CHILDREN"][i]);
				if (child == "ICON"){
					elementData["PREVIEW"][selectedType]["URL"] = EditorHelper.shortcodesJson["CHILDREN"][i]["ICON"]["URL"];
				}
			}
		}
	}
	
	elementData["PREVIEW"][selectedType]["VBID"] = EditorHelper.shortUuid();
	elementData["PREVIEW"][selectedType]["CONTEXT"] = "PREVIEW";
	
	if (selectedType=="RAW" || selectedType=="INLINE_RAW"){
		elementData["PREVIEW"][selectedType]["URL"] = "/html_src/" + EditorHelper.shortUuid("static");
	}
	
	
	if (selectedType=="PIC" && item.find(".blocks_layout").length == 0){
		var imageHolder = item.find("[data-menu-name='PREVIEW_IMAGE']").last();
		imageHolder.css("background-image","url("+ elementData["PREVIEW"][selectedType]["URL"] +"=s1600)");
		imageHolder.closest("#no-image").attr("id",elementData["PREVIEW"][selectedType]["VBID"]);
	}else{
		var getTemplateParams = {element_type:btnElementType,element_data:JSON.stringify(elementData),template_src:templateSrc}
		if (item.find(".blocks_layout").length > 0){
			getTemplateParams["item_layout"] = "blocks";
			getTemplateParams["template_src"] = "xprs/blocks/";
		}
		
		getTemplateParams["parent_vbid"] = item.attr("id");
		getTemplateParams["vbid"] = elementData["PREVIEW"][selectedType]["VBID"];
		getTemplateParams["after_id"] = afterId
		getTemplateParams["stripe_id"] = item.closest(".master.item-box").attr("id");
		XPRSHelper.SAFEPOST("/add_element", getTemplateParams ,item.attr("id"),{"action_name":"ADD-CHILD","pretty_name":"Added " + btnElementType.toLowerCase().replace("preview_","")},function(resp){
			var dataDiv = $(resp["element_html"]);
			EditorHelper.overrideLinks(dataDiv);
			EditorHelper.addLeftClickMenu(dataDiv);
			dataDiv.hide();
			elementPlaceHolder.first().replaceWith(dataDiv);
			
			if (selectedType=="LINK" && itemParent.attr("data-preset-type-id")=="MENUS"){
				var newPageBtn = itemParent.find("#new-page-btn");
				btnPlaceHolder = item.find(".element-placeholder[data-elementtype='"+selectedType+"']");
				btnPlaceHolder.before(newPageBtn);
				dataDiv.addClass("custom");
				dataDiv.wrap("<li class='removable-parent' />");
				
			}
			
			
			setTimeout(function(){
				dataDiv.fadeIn();
				if (parentType == "stripe"){
					SpimeEngine.InitHolder(itemParent);
				}
				if (parentType == "item-preview"){
						var itemGrandParent = EditorHelper.getParent(itemParent);
						SpimeEngine.ArrangeHolder(itemGrandParent);
				}
				
				if (selectedType=="VIDEO"){
					SpimeEngine.sendVideoCommand(elementData["PREVIEW"][selectedType]["VBID"],"play");
					EditorHelper.removeMapForVideo(itemParent);
				}
				
				if (selectedType=="INLINE_RAW" || selectedType=="RAW"){
					var rawEle = dataDiv.find('#'+getTemplateParams["vbid"]);
					SpimeEngine.initRawHTML(dataDiv.find(".preview-raw-container"),true);
					EditorHelper.showDraggableTabbedPanel("inline-raw-edit",rawEle,{"selected-tab":"raw-other-apps"});
				}
				
				if (selectedType=="MAP"){
					SpimeEngine.initMap(dataDiv.find(".map-frame"));
				}
				if (selectedType=="FIELD"){
					SpimeEngine.setPlaceholderFunc(dataDiv.find("input"));
				}
				itemParent.find(".preview-content-holder").removeClass("empty-holder");
				if (typeof callbackFunc != "undefined"){
					callbackFunc(dataDiv.find(".magic-circle-holder"));
				}
			},300)
		});
	}
	//EditorHelper.updateParent({"deliver_to":"editor","action":"add-element-click","after_id":afterId,"parent_id":item.attr("id"),"vbid":elementData["PREVIEW"][selectedType]["VBID"],"element_data":JSON.stringify(elementData["PREVIEW"]),"selectedType":selectedType});

};


EditorHelper.appendElementToItem = function(item,elementHtml,elementId,elementPlaceHolder,elementType,itemParent){
	var elementDom = $(elementHtml);
	var parentType = EditorHelper.getTypeOf(itemParent);
	//var dataDiv = $(resp["element_html"]);
	EditorHelper.overrideLinks(elementDom);
	EditorHelper.addLeftClickMenu(elementDom);
	elementDom.hide();
	elementPlaceHolder.first().replaceWith(elementDom);
	
	if (elementType=="LINK" && itemParent.attr("data-preset-type-id")=="MENUS"){
		var newPageBtn = itemParent.find("#new-page-btn");
		btnPlaceHolder = item.find(".element-placeholder[data-elementtype='"+selectedType+"']");
		btnPlaceHolder.before(newPageBtn);
	}
	
	
	setTimeout(function(){
		elementDom.fadeIn();
		//if (parentType == "stripe"){
		SpimeEngine.InitHolder(item.closest(".master.item-box"));
		//}
		if (parentType == "item-preview"){
				var itemGrandParent = EditorHelper.getParent(itemParent);
				SpimeEngine.ArrangeHolder(itemGrandParent);
		}
		
		if (elementType=="VIDEO"){
			SpimeEngine.sendVideoCommand(elementId,"play");
			EditorHelper.removeMapForVideo(itemParent);
		}
		
		if (elementType=="INLINE_RAW" || elementType=="RAW"){
			var rawEle = elementDom.find('#'+elementId)
			SpimeEngine.initRawHTML(elementDom.find(".preview-raw-container"),true);
			EditorHelper.showDraggableTabbedPanel("inline-raw-edit",rawEle);
		}
		
		if (elementType=="MAP"){
			SpimeEngine.initMap(elementDom.find(".map-frame"));
		}
		if (elementType=="FIELD"){
			SpimeEngine.setPlaceholderFunc(elementDom.find("input"));
		}
		itemParent.find(".preview-content-holder").removeClass("empty-holder");
	},300)
};



EditorHelper.addDraggableImage = function(item,elementData){
	if (elementData === undefined){
		elementData = {};
		elementData["PREVIEW"] = {};
		elementData["PREVIEW"]["DRAGGABLE_PIC"] = EditorHelper.defaultElementValues["DRAGGABLE_PIC"];
		elementData["PREVIEW"]["DRAGGABLE_PIC"]["VBID"] = EditorHelper.shortUuid();
		elementData["PREVIEW"]["DRAGGABLE_PIC"]["CONTEXT"] = "PREVIEW";	
	}
	
	var getTemplateParams = {element_type:"PREVIEW_DRAGGABLE_PIC",element_data:JSON.stringify(elementData),"template_src":"xprs/preview/"}
	
	getTemplateParams["parent_vbid"] = item.attr("id");
	getTemplateParams["vbid"] = elementData["PREVIEW"]["DRAGGABLE_PIC"]["VBID"] 
	getTemplateParams["after_id"] = "last";
	getTemplateParams["stripe_id"] = item.closest(".master.item-box").attr("id");
	
	XPRSHelper.POST("/add_element", getTemplateParams ,function(resp){
		var dataDiv = $(resp["element_html"]);
		EditorHelper.overrideLinks(dataDiv);
		EditorHelper.addLeftClickMenu(dataDiv); 
		item.find(".item-details.preview-content-wrapper .draggable-div-holder").append(dataDiv);
		EditorHelper.fitDragBoxToImage(dataDiv,item);
		dataDiv.hide();
		dataDiv.fadeIn();
		EditorHelper.startDraggableMode(dataDiv.find(".magic-circle-holder"));
	},"json");
};

EditorHelper.removeMapForVideo = function(itemParent){
	var mapElement = itemParent.find(".preview-map-holder");
	if(mapElement.length > 0){
		var vbid = mapElement.find(".magic-circle-holder").attr("id");
		var parentId = EditorHelper.getHolderId(itemParent);
		EditorHelper.handleDelete({"vbid":vbid});
		var stripeId = mapElement.closest(".master.item-box").attr("id");
		XPRSHelper.SAFEPOST("/remove_child",{"parent":parentId , "child": vbid,"stripe_id":stripeId},parentId,"REMOVE-CHILD-NO-UNDO",function() {
			//EditorHelper.updateParent({"deliver_to":"editor","action":"delete-holder","vbid":vbid,"parent_vbid":parentId});
		});
	}
};

EditorHelper.getPageName = function(pageId){
	if (pageId in EditorHelper.pagesDetails){
		if (typeof EditorHelper.pagesDetails[pageId].NAME != "undefined"){
			return EditorHelper.pagesDetails[pageId].NAME;
		}else{
			return "untitled";
		}
	}else{
		return "untitled";
	}
};

EditorHelper.updatePageName = function(params){
	if (! (params.vbid in EditorHelper.pagesDetails)){
		EditorHelper.pagesDetails[params.vbid] = {};
	}
	EditorHelper.pagesDetails[params.vbid].NAME = params.new_name;
};


EditorHelper.initSocialImageUploader = function(rootId){
	$("#social-image-uploader").remove();
	var socialImageUploader = $("<div id='social-image-uploader' />").css("display","none");
	btn = $("#settings-module #social-image-btn");
	$("body").append(socialImageUploader);
	var extraBtns = [];
	
	extraBtns.push({
			element : btn
	});
	socialImageUploader.fineUploader({
		request : {
			endpoint : '/upload_pic',
			params :{root_id:rootId,page_id:EditorHelper.getPageId(),social_preview:true}
		},
		 cors: {
		        expected: true
		    },
		multiple : false,
		paramsInBody : true,
		validation : {
			allowedExtensions : ['jpeg', 'jpg', 'png'],
			sizeLimit : 200000
		},
		extraButtons : extraBtns
	}).on('submit', function (event, id, filename, uploadedBytes, totalBytes) {

	}).on('error', function(event, id, name, reason) {
	}).on('complete',function(event, id, fileName, responseJSON) {
		if (responseJSON.success) {
			$("#settings-module #social-image-btn").css("background-image","url("+ decodeURIComponent(responseJSON.url)+")");
		}else{
			XPRSHelper.xprsAlert("Ooops , probably no element id",{"report_error":true});
		}
	});
};

EditorHelper.initFaviconUploader = function(rootId){
	$("#favicon-uploader").remove();
	var faviconUploader = $("<div id='favicon-uploader' />").css("display","none");
	btn = $("#settings-module #favicon-btn");
	$("body").append(faviconUploader);
	var extraBtns = [];
	
	extraBtns.push({
			element : btn
	});
	faviconUploader.fineUploader({
		request : {
			endpoint : '/upload_pic',
			params :{root_id:rootId,page_id:EditorHelper.getPageId()}
		},
		 cors: {
		        expected: true
		    },
		multiple : false,
		paramsInBody : true,
		validation : {
			allowedExtensions :  ['gif','jpeg', 'jpg', 'png'],
			sizeLimit : 200000
		},
		extraButtons : extraBtns
	}).on('submit', function (event, id, filename, uploadedBytes, totalBytes) {

	}).on('error', function(event, id, name, reason) {
	}).on('complete',function(event, id, fileName, responseJSON) {
		if (responseJSON.success) {
			$("#settings-module #favicon-btn").css("background-image","url("+ decodeURIComponent(responseJSON.url)+")");
			XPRSHelper.xprsAlert("Don't worry, Favicon will be visible in the live site only",{title: "Favicon not visible?"});
		}else{
			XPRSHelper.xprsAlert("Ooops , probably no element id",{"report_error":true});
		}
	});
};

EditorHelper.disabelMediaCenterColorButtons = function(shouldDisable) {
	
	var media_center_panel = $(".draggable-tabbed-panel-wrapper.media-center.shown");
	
	if(!media_center_panel.hasClass("not-icons")){
	
		if(shouldDisable){
			media_center_panel.find(".quick-action").css("display","none");
			EditorHelper.changeMediaCenterIconColor(media_center_panel,"black");
		} else {
			media_center_panel.find(".quick-action").css("display","inline-block"); 
		}
	}
}

EditorHelper.replaceImageFromMediaCenter = function(picURL, picWidth, picHeight) {
	var extraParams = EditorHelper.mediaCenterExtraParams;
		
	extraParams = extraParams.split("||").join(",");
	extraParams = extraParams.split("'").join("\"");
	extraParams = "{"+extraParams+"}";
	
	var extraParamsObj = jQuery.parseJSON(extraParams);
	
	if (picURL.indexOf("youtube") > -1 || picURL.indexOf("vimeo") > -1) { //video

		videoId = picURL.substring(picURL.lastIndexOf("/")+1,picURL.length);
		var newSource;
		if (picURL.indexOf("youtube") > -1) {
			newSource = "youtube";
		} else if (picURL.indexOf("vimeo") > -1) {
			newSource = "vimeo";
		}
		
		
		var videoElement = $("#" + extraParamsObj.element_id + ".magic-circle-holder");
		if (videoElement.length > 0){
			var oldId = videoElement.attr("data-spimevideo_id");
			var videoIframe= videoElement.find("iframe");

			var oldIframeSrc = videoIframe.attr("src");
			var newIframeSrc = oldIframeSrc.replace(oldId,videoId);
			
			if (videoIframe.is(".vimplayer") && newSource == "youtube"){
				newIframeSrc =  "https://www.youtube.com/embed/" + videoId + "?controls=0&html5=1&showinfo=0&modestbranding=1&enablejsapi=1&rel=0&playerapiid=" + extraParamsObj.element_id + "-vidframe";
				videoIframe.removeClass("vimplayer").addClass("ytplayer");
			}else if (videoIframe.is(".ytplayer") && newSource == "vimeo"){
				newIframeSrc = "https://player.vimeo.com/video/" + videoId + "?api=1&player_id=" + extraParamsObj.element_id + "-vidframe&autoplay=1";
				videoIframe.removeClass("ytplayer").addClass("vimplayer");
			}
		
			videoIframe.attr("src",newIframeSrc);
			videoElement.attr("data-spimevideo_id", videoId);
			videoElement.attr("data-spimesource",newSource);
			
			
			var vidID = extraParamsObj.element_id
			setTimeout(function(){
				SpimeEngine.sendVideoCommand(vidID,"play");
			},1500)
			
			var stripeId = videoElement.closest(".master.item-box").attr("id");
			XPRSHelper.SAFEPOST("/update_multiple_child_keys",{"vbid":extraParamsObj.parent_id,"child_vbid":extraParamsObj.element_id,"updated_keys":"SOURCE|VIDEO_ID","updated_values":newSource+"|"+videoId,"stripe_id":stripeId},extraParamsObj.parent_id,"UPDATE-CHILD",function() {	
			});
		}
		
		
	} else { //image or icon
		EditorHelper.handleReplacePic({	
			"update_editor":true,
			"parent_id":extraParamsObj.parent_id,
			"url" : picURL,
			"origwidth" : picWidth,
			"origheight" :picHeight,
			"id" : extraParamsObj.element_id,
			"is_stripe_bg":extraParamsObj.is_stripe_bg,
			"is_inline_pic":extraParamsObj.is_inline_pic,
			"is_blocks":extraParamsObj.is_blocks,
			"is_draggable_pic":extraParamsObj.is_draggable_pic,
			"is_bg_pic":extraParamsObj.is_bg_pic,
			"is_body":extraParamsObj.is_body,
			"is_menufied_preview_links":extraParamsObj.is_menufied_preview_links
		});
		
		var media_center_panel = $(".draggable-tabbed-panel-wrapper.media-center.shown");
		
		var iconFilterColor = "";
		
		if(media_center_panel.hasClass("icon-black")) {
			iconFilterColor = "black";
		} else if (media_center_panel.hasClass("icon-white")) {
			iconFilterColor = "white";
		} else if (media_center_panel.hasClass("icon-gray")) {
			iconFilterColor = "gray";
		}
		
		if (iconFilterColor != "") {
					
			styleid = $("#"+extraParamsObj.parent_id).closest(".master.item-box").attr("data-styleid");
			moduleName = "PREVIEW_ICON_HOLDER";
			//vbid = "";
				
			var styleChangeParams = {};
			styleChangeParams["target"] = styleid;
			styleChangeParams["css_chunk"] = "ICON_EFFECTS",
			styleChangeParams["class_name"]=".preview-icon-holder",
			styleChangeParams["value"]= iconFilterColor;
			styleChangeParams["module"] = moduleName;
			//styleChangeParams["vbid"] = vbid;
			
			EditorHelper.handleStyleChange(styleChangeParams);
			
			var timerKey = moduleName + "_ICON_EFFECTS" + styleid;
			EditorHelper.debounceSave(timerKey,function(){
				EditorHelper.updateMultipleStyleKeys({"styleid":styleid,"props":"ICON_EFFECTS","values":iconFilterColor,"modules":moduleName},function(){
					XPRSHelper.updateParent({"deliver_to":"parent","action":"saved"});
				});
			});
			
		}
		var extraClass = ".inner-pic";
		if (extraParamsObj.is_stripe_bg){
			extraParamsObj["element_role"] = "STRIPE_BACKGROUND";
			extraClass = ".stripe-background";
		}
		if (extraParamsObj.is_bg_pic){
			extraParamsObj["element_role"] = "BACKGROUND_IMAGE";
		}
		if (extraParamsObj.is_draggable_pic){
			extraParamsObj["element_role"] = "DRAGGABLE_PIC";
			extraClass = "";
		}
		
		if(extraParamsObj.element_id  == "no-image"){
			imageIdPrefix = "-please-create";
			newID = EditorHelper.shortUuid();
			extraParamsObj.element_id  =  newID + imageIdPrefix;
			EditorHelper.mediaCenterExtraParams = EditorHelper.mediaCenterExtraParams.replace('no-image',newID);
			$("#"+extraParamsObj.parent_id).find("#no-image" + extraClass).attr("id",newID);
		}

		if (!extraParamsObj.is_body && !extraParamsObj.is_menufied_preview_links){
			propName = ""
			var stripeId = $("#"+extraParamsObj.parent_id).closest(".master.item-box").attr("id");
			XPRSHelper.SAFEPOST("/update_element_content",{element_id :extraParamsObj.element_id ,parent_id:extraParamsObj.parent_id,prop_name:"URL|ORIG_WIDTH|ORIG_HEIGHT|ROLE",prop_value:picURL + "|||" + picWidth + "|||" + picHeight + "|||" + extraParamsObj.element_role,"stripe_id":stripeId},extraParamsObj.parent_id,"UPDATE-CHILD");
		}else{
			styleId = $("body").attr("data-root-style-id")
			var module = "WEBSITE_PAGE"
			if (!is_body){
				styleId = $("#"+extraParamsObj.parent_id).closest(".master.item-box").attr("data-styleid");
				module = "MENUFIED_PREVIEW_LINKS_HOLDER"
			}
			EditorHelper.updateMultipleStyleKeys({"styleid":styleId,"props":"BACKGROUND_IMAGE","values":"url('" + picURL + "=s1600')","modules":module},function(){
				XPRSHelper.updateParent({"deliver_to":"parent","action":"saved"});
			});
		}

	}
}



EditorHelper.openMediaCenter = function(holder) {
		elementId = holder.attr('id');
		elementType = holder.attr('data-menu-name');
		parentId = EditorHelper.getHolderId(EditorHelper.getHolderParent(holder));

		is_stripe_bg = holder.is(".stripe-background");
		is_inline_pic = holder.is(".inner-pic");
		is_blocks = holder.is(".blocks-inner-pic");
		is_draggable_pic = holder.is(".draggable-pic");
		is_bg_pic = holder.attr("data-menu-name") == "BACKGROUND_IMAGE";
		is_body = holder.is("body");
		is_menufied_preview_links = holder.is(".preview-item-links")
		
		
		extraParams =  "'element_id':'"+elementId+"'||'parent_id':'"+parentId+"'||'is_stripe_bg':"+is_stripe_bg+"||'is_inline_pic':"+is_inline_pic+"||'is_blocks':"+is_blocks+"||'is_draggable_pic':"+is_draggable_pic+"||'is_bg_pic':"+is_bg_pic +"||'is_body':"+is_body + "||'is_menufied_preview_links':"+is_menufied_preview_links;
	
		EditorHelper.mediaCenterExtraParams = extraParams;
		
		//console.log(elementType);
		
		var media_center_panel = $(".draggable-tabbed-panel-wrapper.media-center").not(".template");
		media_center_panel.removeClass("ui-draggable");
		var media_center = media_center_panel.find("#xprs-class-selector-holder");


		var mediaTypeVBID = "vbid-media-center";
		
		if (typeof elementType != "undefined"){
			if(elementType.indexOf("ICON") > -1) {
				mediaTypeVBID = "vbid-icon-media-center";

			}else {
				media_center_panel.addClass("not-icons");
				media_center_panel.find(".quick-action").css("display","none"); 
			}
			
			if(elementType.indexOf("VIDEO") > -1) {
				mediaTypeVBID = "vbid-video-media-center";
			}
		} else {
			media_center_panel.addClass("not-icons");
			media_center_panel.find(".quick-action").css("display","none"); 
		}

		if (mediaTypeVBID == "vbid-media-center"){

			var search_html = "<div id='search_bar'><input type='text' id='media-search-box' placeholder='Search'><div id='media-search-btn' class='clickable'></div></div>";
			media_center.append("<div id='media_center'>"+search_html+"<div class='media_container'></div></div>");
			
			$('#media-search-btn').unbind("click").bind("click",function(){
				searchClicked();
			});

			$('#media-search-box').keypress(function (e) {
				if (e.keyCode == 13) {
					e.preventDefault();
					searchClicked();
				}
			});

			function searchClicked() {
				var searchWord = $('#media-search-box').val();
				searchWord = searchWord.replace(/ /g,"|");

				XPRSHelper.GET("/media_with_search",{"search_word": searchWord} ,function(data){

					if (data.indexOf("found 0 results") == -1){
						media_center.find('.media_container').html(data);
					} else {
						media_center.find('.media_container').html('<div><div id="search-close-btn" class="clickable">x</div><br><br><br>No results found for '+searchWord+'</div>');
					}

					$('#search-close-btn').unbind("click").bind("click",function(){
						XPRSHelper.GET("/media_center?vbid="+mediaTypeVBID,{} ,function(data){
							
							media_center.find('.media_container').html(data);
							$('#media-search-box').val('');

						});
					});
				});
			}

			$('#media-search-box').unbind("click").bind("click",function(){
				$(this).focus();
			});
		} else {
			media_center.append("<div id='media_center'><div class='media_container'></div></div>");
		}

		// media_center_panel.draggable({
		// 	cancel: '#media-search-box, .scrollbar'
		// });
		
		var media_center_html = media_center.html();
		media_center.find(".media_container").html(FWDS3DCovUtils.loadPreloader);
		
		
		
		//get media center data
		XPRSHelper.GET("/media_center?vbid="+mediaTypeVBID,{} ,function(data){
			
			
			media_center.find('.media_container').append( data );
			
			if (typeof elementType != "undefined"){
				if(elementType.indexOf("ICON") > -1) {
					var iconFilter = holder.parent().css("-webkit-filter");
					var color = "black";
					if (iconFilter == "invert(1)") {
						color = "white";
					}
					if (iconFilter == "invert(0.5)") {
						color = "gray";
					}
					EditorHelper.changeMediaCenterIconColor(media_center_panel, color);
				}
			}
		});

}



EditorHelper.initFileUpload = function(btn, callbackFunc){
	var fileUploader = $("<div />").css("display","none").attr("id",btn.attr("id") + "-uploader");
	$("body").append(fileUploader);
	var extraBtns = [];
	extraBtns.push({
			element : btn
	});
	fileUploader.fineUploader({
		request : {
			endpoint : '/upload_file',
			params :{"root_id":EditorHelper.getRootId()}
		},
		 cors: {
		        expected: true
		    },
		multiple : false,
		paramsInBody : true,
		validation : {
			allowedExtensions : ['pdf', 'zip', 'doc' ,'docx', 'xls', 'xlsx', 'ppt', 'pptx', 'txt'],
			sizeLimit : 5000000
		},
		extraButtons : extraBtns
	}).on('submit', function (event, id, filename, uploadedBytes, totalBytes) {
		btn.addClass("loading-state");
		btn.append("<div class='file-loader' />");
	}).on('error', function(event, id, name, reason) {
	}).on('progress', function (event, id, filename, uploadedBytes, totalBytes) {
		var percent = parseInt((uploadedBytes / totalBytes) * 100) + "%"
		btn.find('.file-loader').css("width", percent);
	}).on('complete',function(event, id, fileName, responseJSON) {
		if (responseJSON.success) {
			callbackFunc(decodeURIComponent(responseJSON.url));
			btn.removeClass("loading-state");
		}
	});
};


EditorHelper.simpleUpload = function(btn){
	
	var imageUploader = $("<div />").css("display","none").attr("id",btn.attr("id") + "-uploader");
	$("body").append(imageUploader);
	var extraBtns = [];
	extraBtns.push({
			element : btn
	});
	imageUploader.fineUploader({
		request : {
			endpoint : '/upload_pic',
			params :{"no_id":true}
		},
		 cors: {
		        expected: true
		    },
		multiple : false,
		paramsInBody : true,
		validation : {
			allowedExtensions : ['jpeg', 'jpg', 'png' ,'gif'],
			sizeLimit : 5000000
		},
		extraButtons : extraBtns
	}).on('submit', function (event, id, filename, uploadedBytes, totalBytes) {

	}).on('error', function(event, id, name, reason) {
	}).on('progress', function (event, id, filename, uploadedBytes, totalBytes) {
	}).on('complete',function(event, id, fileName, responseJSON) {
		if (responseJSON.success) {
			btn.css("background-image","url("+decodeURIComponent(responseJSON.url)+")")
		}
	});
};

EditorHelper.initReplacePicUploader = function(btn,holder,callbackFunc) {
	btn.click(function(e) {
		e.stopPropagation();
	});

	var requestParams = {};
	requestParams["root_id"] = EditorHelper.getRootId();
	requestParams["page_id"] = EditorHelper.getPageId();

	var holderParentId = EditorHelper.getHolderId(EditorHelper.getHolderParent(holder));
	var imageIdPrefix = "";
	var holderId = holder.attr('id');
	if (typeof holderId == "undefined"){
		if (holder.is("body")){
			requestParams["style_id"] = $("body").attr("data-root-style-id");
			requestParams["module"] = "WEBSITE_PAGE";
			requestParams["prop"] = "BACKGROUND_IMAGE";
			holderId = "";
		}else if(holder.is(".preview-item-links")){
			requestParams["style_id"] = holder.closest(".master.item-box").attr("data-preview-styleid");
			requestParams["module"] = "MENUFIED_PREVIEW_LINKS_HOLDER";
			requestParams["prop"] = "BACKGROUND_IMAGE";
			holderId = "";
		}else{
			holder = holder.parent();
			holderId = holder.attr('id');
		}
	}else if(holderId == "no-image"){
		holder.removeAttr("data-title");
		imageIdPrefix = "-please-create";
		holderId = EditorHelper.shortUuid();
		if (holder.is(".stripe-background")){
			requestParams["element_role"] = "STRIPE_BACKGROUND";
		}
		if (holder.attr("data-menu-name") == "BACKGROUND_IMAGE"){
			requestParams["element_role"] = "BACKGROUND_IMAGE";
		}
		if (holder.is(".draggable-pic")){
			requestParams["element_role"] = "DRAGGABLE_PIC";
		}
	}
	var replaceUploder = $("<div id='uploader-" + holderId +"' />").css("display","none");
	$("body").append(replaceUploder);

	var extraBtns = [];
	
	extraBtns.push({
		element : btn
	});
	
	requestParams["element_id"] = holderId + imageIdPrefix;
	requestParams["parent_id"] = holderParentId;
	var stripeId = holder.closest(".master.item-box").attr("id");
	requestParams["stripe_id"] = stripeId

	var uploaderUrl = '/upload_pic';
	
	//WHEN WE NEED TO UPLOAD IMAGES TO SERVER
	

	replaceUploder.fineUploader({
		request : {
			endpoint : uploaderUrl,
			params :requestParams
		},
		 cors: {
		        expected: true
		    },
		multiple : false,
		paramsInBody : true,
		validation : {
			allowedExtensions : [ 'jpeg', 'jpg', 'png', 'gif' ],
			sizeLimit : 15000000
		// 50 kB = 50 * 1024 bytes
		},
		extraButtons : extraBtns
	}).on('submit', function (event, id, filename, uploadedBytes, totalBytes) {
		XPRSHelper.updateParent({"deliver_to":"parent","action":"change_navigation_confirmation_msg","msg":"IMAGE UPLOAD IN PROGRESS PLEASE WAIT"});
		EditorHelper.closeLeftClickMenu();
		if (holder.attr("id") == "no-image"){
			holder.attr("id",holderId);
		}
		var canvason = $("<img />");
		var drawPromise = $(this).fineUploader("drawThumbnail", id,canvason, 800,false);
		drawPromise.then(function() {
			if (holder.is(".inner-pic")){
				$("#" + holderParentId + " #" + holder.attr('id') + ".magic-circle-holder.inner-pic").css("background-image", "url(" +canvason.attr("src") + ")").hide().fadeIn(400);
			}else if (holder.is(".draggable-pic")){
				$("#" + holderParentId + " #" + holder.attr('id') + ".magic-circle-holder.draggable-pic").css("background-image", "url(" +canvason.attr("src") + ")").hide().fadeIn(400);
			}else if(holder.is(".stripe-background")){
				holder.css("background-image","url(" + canvason.attr("src") + ")").hide().fadeIn(400); 
			}else if(holder.is(".background-image-div")){
				holder.css("background-image","url(" + canvason.attr("src") + ")").hide().fadeIn(400); 
			}else if(holder.is(".blocks-inner-pic")){
				holder.attr("src",canvason.attr("src")).hide().fadeIn(400);
			}else if (holder.is("body") || holder.is(".preview-item-links")){
				holder.css("background-image","url(" + canvason.attr("src") + ")"); 
			}else{
				if ($("#" + holderParentId + " #" + holder.attr('id') + " .magic-circle-holder").length > 0){
					$("#" + holderParentId + " #" + holder.attr('id') + " .magic-circle-holder.background-div").css("background-image","url(" + canvason.attr("src") + ")").hide().fadeIn(400); 
				}else{
					$("#" + holderParentId + " #" + holder.attr('id') + ".magic-circle-holder.background-div").css("background-image","url(" + canvason.attr("src") + ")").hide().fadeIn(400); 
				}
				//For icons
				//$("#" + holderParentId + " #" + holder.attr('id') + ".magic-circle-holder.icon-source").css("background-image","url(" + canvason.attr("src") + ")").hide().fadeIn(400);
				$("#" + holderParentId + " #" + holder.attr('id') + ".magic-circle-holder.icon-source").attr("src",canvason.attr("src")).hide().fadeIn(400);
			}
		});
		XPRSHelper.updateParent({"deliver_to":"parent","action":"preview"});
		
	}).on('progress', function (event, id, filename, uploadedBytes, totalBytes) {
	}).on('error', function(event, id, name, reason) {
	}).on('complete',function(event, id, fileName, responseJSON) {
		XPRSHelper.updateParent({"deliver_to":"parent","action":"change_navigation_confirmation_msg","msg":""});
		if (responseJSON.success) {
			$(".mark-area").removeClass("mark-area");
			EditorHelper.handleReplacePic({	
				"update_editor":true,
				"parent_id":EditorHelper.getHolderId(EditorHelper.getHolderParent(holder)),
				"url" : decodeURIComponent(responseJSON.url),
				"origwidth" : decodeURIComponent(responseJSON.origWidth),
				"origheight" : decodeURIComponent(responseJSON.origHeight),
				"id" : holder.attr('id'),
				"is_stripe_bg":holder.is(".stripe-background"),
				"is_inline_pic":holder.is(".inner-pic"),
				"is_blocks":holder.is(".blocks-inner-pic"),
				"is_draggable_pic":holder.is(".draggable-pic"),
				"is_bg_pic":(holder.attr("data-menu-name") == "BACKGROUND_IMAGE"),
				"is_body":(holder.is("body")),
				"is_menufied_preview_links":(holder.is(".preview-item-links"))
			});
			
			if (typeof callbackFunc != "undefined"){
				callbackFunc();
			}
		}else{
			//XPRSHelper.xprsAlert("Ooops , probably no element id",{"report_error":true});
			XPRSHelper.xprsAlert("There seems to be a problem with the server... please try again later or contact our support team",{title: "Failed to upload image",confirmButtonText:"OK"});
		}
	});
};


EditorHelper.getWrappingLink = function(clickedElement){
	var wrappingLink = clickedElement.parent("a");
	if (wrappingLink.length == 0){
		wrappingLink = clickedElement.prev(".image-link");
	}
	if (wrappingLink.length == 0 && (clickedElement.is(".preview-video-source") || clickedElement.is(".inner-pic")) ){
		wrappingLink = clickedElement.parent().prev(".image-link");
	}
	
	return wrappingLink;
};

EditorHelper.initSetLinkBtn = function(clickedElement,item,btn,mode){
	btn.unbind("click").bind("click",function(e){
		e.stopPropagation();
		var behaviorType = $(this).attr("data-behavior-type");
		var wrappingLink = EditorHelper.getWrappingLink(clickedElement)
		var linkBehavior = "NONE";
		var itemHref = "";
		if (wrappingLink.length > 0 ){
			linkBehavior = wrappingLink.attr("data-link-type");
			itemHref =  wrappingLink.attr("data-href");
		}
		switch(behaviorType){
			case "NOTHING":
				//EditorHelper.updateParent({"deliver_to":"editor","action":"remove-element-link","vbid":clickedElement.attr("id"),"parent_vbid":item.attr("id"),"mode":mode});
				EditorCore.setElementLink(clickedElement.attr("id"), item.attr("id"), "NOTHING");
				var wrappingLink = EditorHelper.getWrappingLink(clickedElement);
				if (wrappingLink.length > 0){
					if (clickedElement.hasClass("middle-layout-image")){
						wrappingLink.remove();
					}else{
						if ((!clickedElement.is(".preview-video-source") && !clickedElement.is(".inner-pic"))){
							clickedElement.unwrap();
						}else{
							wrappingLink.remove();
						}
					}
				}
				EditorHelper.closeLeftClickMenu();
				break;
			case "EXISTING":
				if (typeof VueEditor == "undefined"){
					EditorHelper.showAddPageMenu("select-page",{"initiating_element":clickedElement,"initiating_parent":item});
				}else{
					VueEditor._router.push("/website/link_page?elementId=" + clickedElement.attr("id"));
				}
				EditorHelper.closeLeftClickMenu();

				break;
			case "ANCHOR":
				EditorHelper.startAnchorSelectionMode(clickedElement,item);
				EditorHelper.closeLeftClickMenu();
				break;
			case "POST":
				var generatedUrl = "";
				var urlForLink = "/" + EditorHelper.getRootId() + "/" + item.attr("id") + "-POST";
				EditorCore.setElementLink(clickedElement.attr("id"), item.attr("id"), "POST",generatedUrl);
				XPRSHelper.POST("/create_post", {"vbid":item.attr("id"),"root_id":EditorHelper.getRootId()}, function(){});
				EditorHelper.wrapElementWithLink(clickedElement,urlForLink,"POST");
				EditorHelper.closeLeftClickMenu();
				break;
			case "EXTERNAL":
				EditorHelper.initExternalUrl(btn,clickedElement,item,"",mode);
				break;
			case "SUBMIT":
				EditorHelper.initSubmitFormBtn(btn,clickedElement,item,"");
				break;
			case "HOME":
				EditorCore.setElementLink(clickedElement.attr("id"), item.attr("id"), "HOME","/" + EditorHelper.getRootId());
				EditorHelper.closeLeftClickMenu();
				break;
			case "LIGHTBOX":
				EditorCore.setElementLink(clickedElement.attr("id"), item.attr("id"), "LIGHTBOX","#");
				EditorHelper.wrapElementWithLink(clickedElement,"#","LIGHTBOX");
				$(".color-picker").spectrum("hide");
				btn.closest(".left-click-menu-holder").remove();
				break;
			case "BUY":
				EditorCore.setElementLink(clickedElement.attr("id"), item.attr("id"), "BUY","#");
				EditorHelper.wrapElementWithLink(clickedElement,"#","BUY");
				EditorHelper.closeLeftClickMenu();
				break;
		}
		if (linkBehavior == "FILE"){
			var message = "This link is connected to a file you previously uploaded. Do you wish to remove the file?"
			XPRSHelper.xprsAlert(message,{title: "Remove uploaded file?", showCancelButton: true,confirmButtonText:"Yes",cancelButtonText:"No","callbackfunc":function(isConfirm){
				if(isConfirm){
					XPRSHelper.POST("/remove_file", {"url":itemHref}, function(){
						    			
					});
				}else{
				}
			}});

		}
	});
};


EditorHelper.linkEntireItemIfNeeded = function(clickedElement,href,type,text){
	var stripe = EditorHelper.getStripeParent(clickedElement);
	var stripePreset = stripe.attr("data-preset-type-id");
	if (XPRSHelper.inPresetGroup(stripePreset,"GALLERIES") || XPRSHelper.inPresetGroup(stripePreset,"FEATURES")){
		if (type != "SUBMIT" && type != "NOTHING" ){
			var message = "Sometimes users try to interact with other parts of the item..."
			XPRSHelper.xprsAlert(message,{title: "Add link to entire item?", showCancelButton: true,confirmButtonText:"Yes please",cancelButtonText:"No, Element only","callbackfunc":function(isConfirm){
				if(isConfirm){
					var item = EditorHelper.getHolderParent(clickedElement);
					var stripeId = item.closest(".master.item-box").attr("id");
					XPRSHelper.SAFEPOST("/wrap_all_item", {"vbid":item.attr("id"),"url":href,"type":type,"stripe_id":stripeId},item.attr("id"),"WRAP-ITEM",function() {
					});
					item.find(".preview-element").each(function(){
						var currentElement = $(this);
						if (currentElement.attr("id") != clickedElement.attr("id")){
							EditorHelper.wrapElementWithLink(currentElement,href,type,text,"from_self");
						}
					});
					
				}else{
				}
			 }});
		}
	}
};




EditorHelper.initSubmitFormBtn= function(btn,clickedElement,item,oldValue){
	//$("body").enableSelection();
	var oldThankYouText = clickedElement.closest("a").attr("data-text");
	var submitHolder = $("<div />").addClass("submit-holder part-of-menu");
	if (oldValue == ""){
		oldValue = XPRSHelper.getXprsCookie("xprs_email");
	}
	var submitMailBtnInput = $("<input class='part-of-menu' type='text' placeholder='Email' style='display:block;' />").attr("placeholder",XPRSTranslator.translateText("Email")).val(oldValue);
	var thankYouText = $("<textarea class='part-of-menu' type='text' />").attr("placeholder",XPRSTranslator.translateText("Thank You message (After submission)")).val(oldThankYouText);
	var saveBtn = $("<div class='part-of-menu save-from' />").text(XPRSTranslator.translateText("SAVE"));
	
	var advanced = $("<div class='part-of-menu advanced' />").text(XPRSTranslator.translateText("Mailing List"));
	var advancedHolder = $("<div class='part-of-menu advanced-holder' />").append(advanced);
	
	var listSelect;
	//if ($("body").attr("data-osid")){
		var chooseActionSelect = $("<select />").addClass("part-of-menu").css({"display":"block","max-width": "170px","background-color":"#666","color":"white"})
		var listOp = $("<option />").addClass("part-of-menu t-t").attr("value","send").text("send the form to email");
		var listOp2 = $("<option />").addClass("part-of-menu t-t").attr("value","list").text("add user to a mailing list");
		chooseActionSelect.append(listOp)
		if ($("body").attr("data-osid")){
			chooseActionSelect.append(listOp2);
		}
		chooseActionSelect.unbind("change").bind("change",function(e){
			e.stopPropagation();
			if ($(this).val() == "send"){
				submitMailBtnInput.show();
				advancedHolder.hide();
			}else{
				submitMailBtnInput.hide();
				advancedHolder.show()
				advanced.addClass("loading-state");
				EditorHelper.loadMailingListOptions(clickedElement,advanced,listSelect);
			}
		});

		if (clickedElement.closest("a").attr("data-mailing-list")){
			submitMailBtnInput.hide();
			advancedHolder.show();
			if (advancedHolder.find(".advanced").length > 0 ){
				EditorHelper.loadMailingListOptions(clickedElement,advanced,listSelect);
			}
			chooseActionSelect.val("list");
		}else{
			submitMailBtnInput.show();
			advancedHolder.hide();
			chooseActionSelect.val("send");
		}

		submitHolder.prepend(chooseActionSelect);
		submitHolder.append(submitMailBtnInput);
		submitHolder.append(advancedHolder);
	//}
	submitHolder.append(thankYouText);
	submitHolder.append(saveBtn);
	btn.append(submitHolder);
	btn.removeClass("t-t");
	saveBtn.unbind("click").bind("click",function(e){
		var listSelector = saveBtn.closest(".submit-holder").find(".maillist-select");
		var target,nofollow;
		var mailingList;
		if (listSelector.length > 0 && listSelector.is(":visible")){
			if (listSelector.is(".only-mail")){
				mailingList = "imosmail"; 
			}else if(listSelector.val()){
				mailingList = listSelector.val(); 
			}
		}
		
		
		EditorCore.setElementLink(clickedElement.attr("id"), item.attr("id"), "SUBMIT",submitMailBtnInput.val(),target,nofollow,thankYouText.val(),mailingList);
		EditorHelper.closeLeftClickMenu();
		EditorHelper.wrapElementWithLink(clickedElement,submitMailBtnInput.val(),"SUBMIT",thankYouText.val());
		if (mailingList){
			clickedElement.closest("a").attr("data-mailing-list",mailingList);
		}
	});
	btn.unbind("click");
};


EditorHelper.loadMailingListOptions = function(clickedElement,btn,listSelect,callbackFunc){
	btn.addClass("loading-state");
	var imosServer = $("body").attr("data-imos-server");
	listSelect = $("<select />").addClass("part-of-menu advanced maillist-select").css({"display":"block","max-width": "170px","background-color":"#666","color":"white"})
	XPRSHelper.GET(imosServer + "/os/data/newsletter_integration/"+$("body").attr("data-osid")+"/all",{},function(settings){
		var openCommunicationBtn = $("<span />").text("Configure").addClass("part-of-menu open-communication").click(function(e){
			e.stopPropagation();
			EditorHelper.openImosDashboard("communication");
		});
		if (typeof settings.sections.newsletter_integration.lists == "undefined" || settings.sections.newsletter_integration.lists.length == 0){
			if (settings.sections.newsletter_integration &&  settings.sections.newsletter_integration.PROVIDER && settings.sections.newsletter_integration.PROVIDER == "IMOS"){
				listSelect = $("<div />").addClass("part-of-menu only-mail").text("IMOS email").css("padding","10px 0px");
			}else{
				listSelect = $("<div />").addClass("part-of-menu t-t").text("No mailing lists").css("padding","10px 0px");
			}
			
			listSelect.append(openCommunicationBtn);
			btn.replaceWith(listSelect)
		}else{
			var allMailingLists = settings.sections.newsletter_integration.lists;
			var selectedMailingList = ""
			if (clickedElement.closest("[data-mailing-list]").length > 0 ){
					selectedMailingList = clickedElement.closest("[data-mailing-list]").attr("data-mailing-list");
			}
			for( l in allMailingLists){
				var listOp = $("<option />").addClass("part-of-menu").attr("value",allMailingLists[l].id).text(allMailingLists[l].name);
				listSelect.append(listOp);
			}
			listSelect.val(selectedMailingList);
			btn.replaceWith(listSelect)
			listSelect.after(openCommunicationBtn);
		}
		
	},"json");
};


EditorHelper.initExternalUrl = function(btn,clickedElement,item,oldValue,mode){
	//$("body").enableSelection();

	if (!oldValue){
		btn.closest(".left-click-menu-holder").unbind("mouseout");
		btn.siblings("li").remove();
	}else{
		if(oldValue.startsWith("mailto:")){
			btn.attr("data-prefix","mailto:");
			oldValue = oldValue.replace("mailto:","");
			btn.text("Mail");
		}else if(oldValue.startsWith("tel:")){
			btn.attr("data-prefix","tel:");
			oldValue = oldValue.replace("tel:","");
			btn.text("Telephone");
		}
	}

	var hasSubtype = btn.attr("data-prefix");
	var placeholder = btn.attr("data-placeholder");

	var inputText = $("<input class='part-of-menu' type='text' />").val(oldValue).attr("placeholder",placeholder);
	var saveBtn  = $("<input class='part-of-menu' type='button' value='"+XPRSTranslator.translateText("SAVE")+"' />");
	btn.append(inputText);
	btn.addClass("extra-edit");

	
	btn.append(saveBtn);
	saveBtn.unbind("click").bind("click",function(e){
		var newLink = inputText.val();
		if (hasSubtype){
			if (!newLink.startsWith(hasSubtype)){
				newLink = hasSubtype + newLink;
			}
		}
		//if (!/^https?:\/\//i.test(newLink)) {
		if (newLink){
			if (newLink.toLowerCase().indexOf("mailto:") == -1 && newLink.toLowerCase().indexOf("skype:") == -1 && newLink.toLowerCase().indexOf("ftp:") == -1 && newLink.toLowerCase().indexOf("tel:") == -1){
				if (newLink.indexOf("https://") == 0 || newLink.indexOf("http://") == 0 || newLink.indexOf("register://") == 0 || newLink.indexOf("registers://") == 0){
					
				}else{
					newLink = 'http://' + newLink;
				}
			}
		}
		//}
		var target = "_self"
		var nofollow;
		if (btn.find("#in-new-window.selected").length > 0){
			target = "_blank";
		}
		if (btn.find("#nofollow.selected").length > 0){
			nofollow = true;
		}
		
		//EditorHelper.updateParent(setElementParams);
		EditorCore.setElementLink(clickedElement.attr("id"), item.attr("id"), "EXTERNAL",newLink,target,nofollow);
		
		
		//$(".color-picker").spectrum("hide");
		//btn.closest(".left-click-menu-holder").remove();
		EditorHelper.closeLeftClickMenu();
		//$("body").disableSelection();
		EditorHelper.wrapElementWithLink(clickedElement,newLink,"EXTERNAL");
		var existingLink = EditorHelper.getWrappingLink(clickedElement);
		if (existingLink.length > 0){
			if (btn.find("#in-new-window.selected").length > 0){
				existingLink.attr("data-target","_blank")
			}else{
				existingLink.attr("data-target","_self")
			}
			if (btn.find("#nofollow.selected").length > 0){
				existingLink.attr("rel","nofollow")
			}
		}
	});
	inputText.unbind("keypress").bind("keypress",function(event) {
        if (event.keyCode == 13) {
        	saveBtn.click(); 
        }
    });
	
	
	btn.append($("<br/>"));
	var newWindow = $("<div />").addClass("small-toggle-selector clickable part-of-menu").text(XPRSTranslator.translateText("In new window")).css({"padding-left":" 0px"}).attr("id","in-new-window");
	var nofollow = $("<div />").addClass("small-toggle-selector clickable part-of-menu").text("nofollow").attr("id","nofollow");
	var existingLink = EditorHelper.getWrappingLink(clickedElement);
	if (existingLink.length > 0){
		if (existingLink.attr("rel") == "nofollow"){
			nofollow.addClass("selected");
		}
		if (existingLink.attr("data-target") == "_blank"){
			newWindow.addClass("selected");
		}
	}else{
		newWindow.addClass("selected");
	}
	if (!hasSubtype){
		btn.append(newWindow).append(nofollow);
	}
	newWindow.add(nofollow).unbind("click").bind("click",function(e){
		e.stopPropagation();
		$(this).toggleClass("selected")
	});
	//EditorHelper.initToggleBtn(newWindow,clickedElement,"newWindow",parentVbid,"vid");
	btn.unbind("click");
	EditorHelper.repositionLeftClickMenu(btn);
};

EditorHelper.repositionLeftClickMenu = function(menu){
	if ((menu.width() + menu.offset().left) >  $(window).width()){
		var leftClickMenu = menu.closest(".left-click-menu-holder")
		leftClickMenu.css("left",($(window).width() - leftClickMenu.outerWidth()) + "px").removeClass("flipped-horizontal");
	}
}

EditorHelper.getAbsoluteUrl = function(){
	return $(".master.container").attr("data-absolute-path");
};

EditorHelper.wrapElementWithLink = function(clickedElement,href,type,text,fromSelf){
	
	var absoluteUrl = "";
	if (type != "EXTERNAL" && type != "SUBMIT" && type != "ANCHOR" && type != "BUY"  && type != "FILE"){
		absoluteUrl = EditorHelper.getAbsoluteUrl();
	}
	var existingLink = EditorHelper.getWrappingLink(clickedElement);
	if (existingLink.length > 0){
		if (clickedElement.hasClass("middle-layout-image") || existingLink.is(".not-wrapping")){
			existingLink.remove();
		}else{
			clickedElement.unwrap();	
		}
		
	}
	wrappingLink = $("<a />").addClass("removable-parent");
	if (clickedElement.is(".load-high-res")){
		wrappingLink.addClass("image-link not-wrapping");
	}
	if (typeof text != "undefined"){
		wrappingLink.attr("data-text",text);
	}
	if (clickedElement.hasClass("image-source") || clickedElement.is(".preview-video-source") || clickedElement.is(".inner-pic")){
		//image link should sometimes get different css properties
		wrappingLink.addClass("image-link not-wrapping").css("pointer-events","none");
	}
	

	wrappingLink.attr("href","#").attr("data-href",absoluteUrl + href).attr("data-link-type",type);
	if (clickedElement.hasClass("middle-layout-image")){
		clickedElement.before(wrappingLink);
	}else if ((clickedElement.is(".preview-video-source") || clickedElement.is(".inner-pic")) ){
		clickedElement.parent().before(wrappingLink);
	}else{
		clickedElement.wrap(wrappingLink);
	}
	if (typeof fromSelf == "undefined"){
		EditorHelper.linkEntireItemIfNeeded(clickedElement,href,type,text);
	}
	return absoluteUrl + href;
};



EditorHelper.updateHandlersPosition = function(controlsHolder){
	var maxWidthFromHolder = parseInt(controlsHolder.find(".item-wrapper").css("max-width"));
	if (typeof maxWidthFromHolder != "undefined" && !(isNaN(maxWidthFromHolder))){
		resizeHandle = controlsHolder.next(".control-handle");
		resizeHandle.width(maxWidthFromHolder);
	}
};



EditorHelper.addMaxWidthControls = function(controlsHolder){
	//Create the max width handles
	var relevantControlHandle = controlsHolder.next(".control-handle");
	if (relevantControlHandle.find("#left-handle").length == 0){
		var leftMaxWidthHandle =  $('<div id="left-handle" class="max-width-handle pro-feature fast-animated-opacity" />');
		var rightMaxWidthHandle = $('<div id="right-handle" class="max-width-handle pro-feature fast-animated-opacity" />');
		var MIN_STRIPE_WIDTH = 320;
		var BOXED_STRIPE_WIDTH = 1000;
		var MAX_STRIPE_WIDTH = controlsHolder.width();
		relevantControlHandle.append(leftMaxWidthHandle);
		relevantControlHandle.append(rightMaxWidthHandle);
		
		//Bind double click to stretch
		relevantControlHandle.find(".max-width-handle").unbind("click").bind("click",function(e){e.stopPropagation();});
		relevantControlHandle.find(".max-width-handle").unbind("dblclick").bind("dblclick",function(e){
			e.stopPropagation();
			EditorHelper.removeUnusedUi();
			var relevantControlsHolder = controlsHolder;
			//TEST MAX WIDTH
			if (relevantControlHandle.hasClass("facing-down")){
				relevantControlsHolder = relevantControlHandle.next();
			}
			EditorHelper.ChangeStripeMaxWidth(relevantControlsHolder,"none");
			relevantControlsHolder.attr("data-width-resize","true");
			SpimeEngine.ArrangeHolder(relevantControlsHolder);
			var vbid =  EditorHelper.getHolderId(relevantControlsHolder);
			var parentVbid = EditorHelper.getHolderId(EditorHelper.getParent(relevantControlsHolder));
			var holderType = SpimeEngine.getHolderType(relevantControlsHolder);
			var elementType = relevantControlsHolder.attr("data-child-type");
			if (holderType=="element" && elementType != "PIC" && elementType != "VIDEO"  && elementType != "MAP" && elementType != "RAW"){
				var holderStyleId = relevantControlsHolder.attr("data-styleid");
				EditorHelper.updateStyleData({"vbid":vbid,"parent_vbid":parentVbid,"updated_key":"MAX_WIDTH","updated_value":"none","module_name":elementType+"_WRAPPER","style_id":holderStyleId});
				//EditorHelper.updateStripeData({"vbid":vbid,"parent_vbid":parentVbid,"updated_key":"MAX_WIDTH","updated_value":"none","module_name":elementType+"_WRAPPER"});
			}else{
				EditorHelper.updateStripeData({"vbid":vbid,"parent_vbid":parentVbid,"updated_key":"MAX_WIDTH","updated_value":"none","module_name":"WRAPPER"});
			}
			EditorHelper.unmarkSpacing(relevantControlsHolder);
			relevantControlsHolder.removeAttr("data-width-resize");
			var newItemsMinWidth = relevantControlsHolder.attr("data-items-min-width");
			if (typeof newItemsMinWidth != "undefined"){
				var holderStyleId = relevantControlsHolder.attr("data-styleid");
				EditorHelper.updateStyleData({"vbid":vbid,"parent_vbid":parentVbid,"updated_key":"ARRANGER_ITEM_MIN_WIDTH","updated_value":newItemsMinWidth,"module_name":"GALLERY_PREVIEW","style_id":holderStyleId,"stripe_id":relevantControlsHolder.attr("id")});
				//EditorHelper.updateParent({"deliver_to":"editor","action":"realtime-settings-update","vbid":relevantControlsHolder.attr("id"),"updated_key":"ARRANGER_ITEM_MIN_WIDTH","updated_value":newItemsMinWidth});
			}
			if (elementType == "PIC"){
				SpimeEngine.fixZoomedImages(relevantControlsHolder);
			}
			
			if (elementType == "VIDEO"){
	       	 SpimeEngine.fitVideo(relevantControlsHolder.find(".vid-cover"));
	        }
			if (elementType == "MAP"){
				SpimeEngine.sendMapCommand(relevantControlsHolder,"center",{});
		    }
		});
		
		
		
		relevantControlHandle.find(".max-width-handle").draggable({
			"axis":"x",
			cursor: "w-resize",
			start: function(e,ui){
				// ui.helper.bind("click.prevent",function(event) { event.preventDefault(); });
				//TEST MAX WIDTH
				var relevantControlsHolder = controlsHolder;
				//relevantControlsHolder.find("iframe").css("pointer-events","none");
				if (relevantControlHandle.hasClass("facing-down")){
					relevantControlsHolder = relevantControlHandle.next(".master.item-box");
				}else{
					relevantControlsHolder.prev(".control-handle").addClass("facing-down")
				}
				relevantControlsHolder.prev().addClass("dragged");
				relevantControlsHolder.next().addClass("dragged");
				EditorHelper.removeUnusedUi();
				EditorHelper.deactivateStripeHoverControls();
				//This is a stripe in show more mode , we do not allow changing the width in this mode
				if (relevantControlsHolder.attr("data-more-clicked")){
					SpimeEngine.showLessInHolder(relevantControlsHolder);
					EditorHelper.scrollToItem({vbid:relevantControlsHolder.attr("id")});
					return false;
				}
				EditorHelper.markSpacing(relevantControlsHolder);
				MAX_STRIPE_WIDTH = relevantControlsHolder.width();
				if (relevantControlsHolder.find(".item-wrapper").first().css("max-width") == "none"){
					relevantControlsHolder.find(".item-wrapper").first().attr("data-orig-width",MAX_STRIPE_WIDTH);
				}else{
					relevantControlsHolder.find(".item-wrapper").first().attr("data-orig-width",relevantControlsHolder.find(".item-wrapper").first().css("max-width"));
				}
				
				relevantControlsHolder.find(".item-wrapper").first().css({"max-width":"","min-width":MIN_STRIPE_WIDTH});
				relevantControlsHolder.attr("data-width-resize","true");
				var otherHandle = relevantControlHandle.find("#right-handle");
				if ($(ui.helper).attr("id")=="right-handle"){
					otherHandle = relevantControlHandle.find("#left-handle");
				}
				otherHandle.css("left","");
				$(ui.helper).attr("data-initialPos", ui.position.left);
				otherHandle.attr("data-initialPos", parseInt(otherHandle.position().left));
			},
			drag: function(e, ui) {
				//TEST MAX WIDTH
				var relevantControlsHolder = controlsHolder;
				if (relevantControlHandle.hasClass("facing-down")){
					relevantControlsHolder = relevantControlHandle.next();
				}
				var delta = $(ui.helper).attr("data-initialPos") - ui.position.left;
				var finalSize;
				
				if ($(ui.helper).attr("id")=="right-handle"){
					finalSize = parseInt(relevantControlsHolder.find(".item-wrapper").first().attr("data-orig-width")) - (delta*2);
					if (finalSize >= MIN_STRIPE_WIDTH){
						$(ui.helper).css("opacity","");
						ui.position.left = finalSize - 14;
					}else{
						$(ui.helper).css("opacity","0.3");
						ui.position.left = ui.position.left -MIN_STRIPE_WIDTH -14;
					}
				}else{
					finalSize = parseInt(relevantControlsHolder.find(".item-wrapper").first().attr("data-orig-width")) + (delta*2);
					if (finalSize >= MIN_STRIPE_WIDTH){
						$(ui.helper).css("opacity","");
						ui.position.left = 0;
					}else{
						$(ui.helper).css("opacity","0.3");
					}
				}
				
				
				//in the snap zone
				if (finalSize > BOXED_STRIPE_WIDTH - 50 && finalSize < BOXED_STRIPE_WIDTH + 50){
					finalSize = 1000;
					if ($(ui.helper).attr("id")=="right-handle"){
						ui.position.left = finalSize - 14;
					}
				}
				
				
				
					finalSize = Math.max(finalSize,MIN_STRIPE_WIDTH);
					
					$(ui.helper).attr("data-delta" , delta);
					$(ui.helper).attr("data-final-size" , finalSize);
					EditorHelper.ChangeStripeMaxWidth(relevantControlsHolder,finalSize);
					if (relevantControlsHolder.find(".sub.container.matrix").length > 0){
						relevantControlsHolder.find("*").css("min-height","");
						relevantControlsHolder.find(".item-details").css("height","");
					}
					SpimeEngine.ArrangeHolder(relevantControlsHolder);
					
					var elementType = relevantControlsHolder.attr("data-child-type");
					if (elementType == "PIC"){
						SpimeEngine.fixZoomedImages(relevantControlsHolder);
					}
					if (elementType == "VIDEO"){
						SpimeEngine.fitVideo(relevantControlsHolder.find(".vid-cover"));
		            }
					if (elementType == "MAP"){
						SpimeEngine.sendMapCommand(relevantControlsHolder,"center",{});
				    }
				
		

				
	        },
			stop: function(e,ui){
				var relevantControlsHolder = controlsHolder;
				if (relevantControlHandle.hasClass("facing-down")){
					relevantControlsHolder = relevantControlHandle.next();
				}
				var holderType = SpimeEngine.getHolderType(relevantControlsHolder);
				var vbid =  EditorHelper.getHolderId(relevantControlsHolder);
				var parentVbid = EditorHelper.getHolderId(EditorHelper.getParent(relevantControlsHolder));
				var elementType = relevantControlsHolder.attr("data-child-type");
				if (holderType=="element" && elementType != "PIC" && elementType != "VIDEO" && elementType != "MAP" && elementType != "RAW"){
					EditorHelper.updateStripeData({"vbid":vbid,"parent_vbid":parentVbid,"updated_key":"MAX_WIDTH","updated_value":$(ui.helper).attr("data-final-size"),"module_name":elementType+"_WRAPPER"});
				}else{
					EditorHelper.updateStripeData({"vbid":vbid,"parent_vbid":parentVbid,"updated_key":"MAX_WIDTH","updated_value":$(ui.helper).attr("data-final-size"),"module_name":"WRAPPER"});
				}
				EditorHelper.unmarkSpacing(relevantControlsHolder);
				relevantControlsHolder.removeAttr("data-width-resize");
				var newItemsMinWidth = relevantControlsHolder.attr("data-items-min-width");
				if (typeof newItemsMinWidth != "undefined"){
					var holderStyleId = relevantControlsHolder.attr("data-styleid");
					EditorHelper.updateStyleData({"vbid":vbid,"parent_vbid":parentVbid,"updated_key":"ARRANGER_ITEM_MIN_WIDTH","updated_value":newItemsMinWidth,"module_name":"GALLERY_PREVIEW","style_id":holderStyleId,"stripe_id":relevantControlsHolder.attr("id")});
					//EditorHelper.updateParent({"deliver_to":"editor","action":"realtime-settings-update","vbid":relevantControlsHolder.attr("id"),"updated_key":"ARRANGER_ITEM_MIN_WIDTH","updated_value":newItemsMinWidth});
				}
				$(ui.helper).removeAttr("data-initialPos");
				$(ui.helper).removeAttr("data-final-size");
				$(ui.helper).removeAttr("data-delta");
				$(ui.helper).css("left","");	
				relevantControlsHolder.find(".item-wrapper").first().removeAttr("data-orig-width");
				var otherHandle = relevantControlHandle.find("#right-handle");
				if ($(ui.helper).attr("id")=="right-handle"){
					otherHandle = relevantControlHandle.find("#left-handle");
				}
				$(ui.helper).removeClass("on-the-move");
				otherHandle.removeAttr("data-initialPos");
				EditorHelper.reactivateStripeHoverControls();
				setTimeout(function(){
					relevantControlsHolder.prev().removeClass("dragged");
					relevantControlsHolder.next().removeClass("dragged");
				},300);
			}
		});
	}
};

EditorHelper.ChangeStripeMaxWidth = function(holder,newValue){
	var relevantItemWrapper = holder.find(".item-wrapper").first();
	var relevantHolders = holder;
	var holderType = SpimeEngine.getHolderType(holder);
	var elementType = holder.attr("data-child-type");
	if (holderType=="element" && elementType != "PIC" && elementType != "VIDEO" && elementType != "MAP" && elementType != "RAW"){
		var wrapperClass = "." + elementType.toLowerCase() + "-wrapper";
		relevantItemWrapper = $(wrapperClass + ".element-wrapper");
		relevantHolders = relevantItemWrapper.closest(".element-box");
	}
	relevantItemWrapper.css({"max-width":newValue});
	relevantHolders.next().width(newValue);
	//TEST MAX WIDTH
	relevantHolders.prev(".control-handle").width(newValue);
};

EditorHelper.markSpacing = function(controlsHolder,bgHeight){
	controlsHolder.css({"background-image":"url(/images/textures/stripe.png)"});
};

EditorHelper.unmarkSpacing = function(controlsHolder){
	controlsHolder.css({"background-image":""});
};




EditorHelper.holderMouseEnter = function(hoveredHolder,skipUpdate,event){
	//$(".stripe-controls").removeClass("shown");
	
	if ($(".left-click-menu-holder").length > 0){
		return;
	}
	
	if (EditorHelper.mode != "preview" && $(".dragged").length == 0){
		if (hoveredHolder.hasClass("master") && !hoveredHolder.hasClass("marked-delete")){
			if (typeof event != "undefined"){
				 var x = event.pageX - hoveredHolder.offset().left;
			     var y = event.pageY - hoveredHolder.offset().top;
			   //  console.log("(" + x + "," + y +")")
			     var bottom = hoveredHolder.height() - y; 
			     if (x < 1400 && bottom < 1200){
			    	 hoveredHolder.find(".vertical-spacing-menu.bottom").addClass("shown");
			     }else{
			    	 hoveredHolder.find(".vertical-spacing-menu.bottom").removeClass("shown");
			     }
			     
			     if (x < 1400 && y < parseInt(hoveredHolder.css("padding-top")) +1200){
			    	 hoveredHolder.find(".vertical-spacing-menu.top").addClass("shown");
			     }else{
			    	 hoveredHolder.find(".vertical-spacing-menu.top").removeClass(" shown");
			     }
			     
			     
			     if (bottom < 1400 ){
			        // hoveredHolder.next().find(".max-width-handle").addClass("shown");
			    	 hoveredHolder.next(".control-handle").addClass("shown");
			     }else{
			    	 //hoveredHolder.next().find(".max-width-handle").removeClass("shown");
			    	 hoveredHolder.next(".control-handle").removeClass("shown");
			     }
			     
			     if (bottom < 1050 ){
			    	 hoveredHolder.next().find(".max-width-handle").addClass("shown");
			     }else{
			    	 hoveredHolder.next().find(".max-width-handle").removeClass("shown");
			     }
			     
			     if (y < 10150){
			    	//TEST MAX WIDTH
					hoveredHolder.prev(".control-handle").addClass("facing-down shown");
			     }else{
			    	 hoveredHolder.prev(".control-handle").removeClass("facing-down shown");
			     }
			     
			     if (y < 1050){
				    	//TEST MAX WIDTH
			   	     hoveredHolder.prev().find(".max-width-handle").addClass("shown");
				 }else{
				     hoveredHolder.prev().find(".max-width-handle").removeClass("shown");
				 }
			     
			}

			if (!hoveredHolder.find(".stripe-controls").not(".inner").hasClass("shown")){
				hoveredHolder.find(".stripe-controls").not(".inner").addClass("shown");
			}
			var hoveredHolderHeight =  hoveredHolder.height();
			if(hoveredHolderHeight > $(window).height()){
				var stripeSettingsMenu = hoveredHolder.find(".stripe-magic-circle");
				if (stripeSettingsMenu.length > 0){
					var windowScrollTop = $(window).scrollTop();
					var menuTop = stripeSettingsMenu.offset().top;
					var menuBottom = menuTop + stripeSettingsMenu.height();
					if (windowScrollTop + $(window).height() < menuTop){
						stripeSettingsMenu.addClass("adjusted-up")
						stripeSettingsMenu.removeClass("adjusted-down")
						stripeSettingsMenu.css("top",y + 50)
					}else if (menuBottom < windowScrollTop ){
						stripeSettingsMenu.removeClass("adjusted-up");
						stripeSettingsMenu.addClass("adjusted-down")
						stripeSettingsMenu.css("top",y - 50);
						if (y + 150 > hoveredHolderHeight){
							stripeSettingsMenu.css("top",hoveredHolderHeight - 100);
						}
					}else{
						if (!stripeSettingsMenu.hasClass("adjusted-up") && !stripeSettingsMenu.hasClass("adjusted-down")){
							stripeSettingsMenu.css("top","");
						}
					}
				}
			}else{
				var stripeSettingsMenu = hoveredHolder.find(".stripe-magic-circle");
				if (stripeSettingsMenu.length > 0){
					stripeSettingsMenu.removeClass("adjusted-up adjusted-down").css("top","");
				}
			}

			if (hoveredHolder.height() < 200){
				stripeSettingsMenu.css({"top":0,"margin-top":0})
			}
			
			var maxWidthFromHolder = parseInt(hoveredHolder.find(".item-wrapper").css("max-width"));
			if (typeof maxWidthFromHolder != "undefined" && !isNaN(maxWidthFromHolder)){
				hoveredHolder.next(".control-handle").width(maxWidthFromHolder);
				hoveredHolder.prev(".control-handle").width(maxWidthFromHolder);
			}else{
				hoveredHolder.next(".control-handle").css("width","");
				hoveredHolder.prev(".control-handle").css("width","");
			}
		}
	}
};

EditorHelper.holderMouseOut = function(hoveredHolder,skipUpdate){
	if (EditorHelper.mode != "preview" && $(".dragged").length == 0){
		if (hoveredHolder.hasClass("master")){
			hoveredHolder.find(".stripe-controls").removeClass("shown");
			hoveredHolder.next(".control-handle").removeClass("shown");
			hoveredHolder.prev(".control-handle").removeClass("facing-down shown");
			hoveredHolder.next().find(".stripe-controls").removeClass("shown");
			hoveredHolder.find(".vertical-spacing-menu").removeClass("shown");
			hoveredHolder.next().find(".max-width-handle").removeClass("shown");
			hoveredHolder.prev().css({"border-bottom":""});
			
		}
	}
};

EditorHelper.getCurrentUser = function(){
	var userFromCookie = decodeURIComponent(XPRSHelper.getXprsCookie("xprs_user"));
	var sessionFromCookie = XPRSHelper.getXprsCookie("xprs_session");
	if (typeof userFromCookie == "undefined" || typeof sessionFromCookie == "undefined"){
		return "guest";
	}else{
		if (sessionFromCookie != "invalid"){
			return userFromCookie;
		}
	}
	return "guest";
};

EditorHelper.getCurrentUserRoot = function(){
	var userRootFromCookie = XPRSHelper.getXprsCookie("xprs_root");
	if (typeof  userRootFromCookie == "undefined"){
		return "none";
	}else{
		if (userRootFromCookie.indexOf("user-") != 0){
			userRootFromCookie = "user-" + userRootFromCookie;
		}
		return userRootFromCookie;
	}
};


EditorHelper.getHolderById = function(vbid){
	return $("#" + vbid);
};

EditorHelper.getHolderId = function(holder){
	return holder.attr("id");//.substring("vbid-".length);
};

EditorHelper.getHolderParent = function(holder){
	var holderParent = holder.parent().closest(".item-box");
	if(holderParent.hasClass("element-box")){
		holderParent = holderParent.parent().closest(".item-box");
	}
	if (holderParent.length == 0){
		holderParent = $(".master.container");
	}
	return holderParent;
};

EditorHelper.getStripeParent = function(clickedElement){
	var firstParent = EditorHelper.getHolderParent(clickedElement);
	if (firstParent.hasClass("master")){
		return firstParent;
	}else{
		return EditorHelper.getHolderParent(firstParent);
	}
};

EditorHelper.getParentsList = function(holder){
	var result = [];
	var currentHolder = EditorHelper.getHolderParent(holder);
	while( !(currentHolder.is(".master.container")) ){
		result.unshift(EditorHelper.getHolderId(currentHolder));
		currentHolder = EditorHelper.getHolderParent(currentHolder);
	}
	result.unshift(EditorHelper.getHolderId(currentHolder));
	return result;
};

EditorHelper.getMasterId = function(){
	return EditorHelper.getHolderId($(".master.container"));
};



EditorHelper.initStripeSettingsBtn = function(holder,btn,menuName){
	btn.unbind("click").bind("click",function(event){
		event.stopPropagation();
		var vbid = EditorHelper.getHolderId(holder);
		var holderParent = EditorHelper.getHolderParent(holder);
		var parentVbid = EditorHelper.getHolderId(holderParent);
		var holderType = SpimeEngine.getHolderType(holder);
		var holderPresetId = holder.attr("data-preset-type-id");
		if (typeof menuName == "undefined"){
			menuName = holderType.toUpperCase() + "_STRIPE";
		}
	});
};



EditorHelper.startElementEditMode = function(elementToEdit){
	if (elementToEdit.hasClass("edit-on")){
		return;
	}

	if (typeof XPRSUndo != "undefined"){
		var parent = EditorHelper.getHolderParent(elementToEdit);
		var undoKey = parent.attr("id") + "-" + elementToEdit.attr("id");
		var propName = "TEXT";
		if (elementToEdit.attr("data-menu-name").indexOf("LINK")!= -1){
			propName = "LABEL";
		}
		if (elementToEdit.is(".quote-author")){
			propName = "AUTHOR";
			elementId = elementId.replace("_author","");
		}
		var saveValue = elementToEdit.html();
		if (elementToEdit.is(".submenu-title")){
			var saveValue = elementToEdit.clone().children().remove().end().text();
		}
		if (elementToEdit.is(".cke_editable")){
			saveValue = elementToEdit.find("p").contents().each(function() {
		        if(this.nodeType == 8) {
		            $(this).remove()
		        }
		    });
			saveValue = elementToEdit.html();
		}
		var strippedContent = strip_tags(saveValue, '<br><br/>'); 
		if (!elementToEdit.hasClass("preview-body") && !elementToEdit.hasClass("Body") && !elementToEdit.is(".blocks-preview-body")){
			saveValue = strippedContent;
		}else{
			saveValue = strippedContent + "|||" + elementToEdit.html().replace(/&nbsp;/gi, ' ');
			propName += "|HTML";
		}
		XPRSUndo.originalValues[undoKey] = {};
		XPRSUndo.originalValues[undoKey]["propName"] = propName
		XPRSUndo.originalValues[undoKey]["prop_value"] = saveValue
	}
	
	//$("body").enableSelection();
	if (elementToEdit.hasClass("text-element")){
		var elementHolder = EditorHelper.getHolderParent(elementToEdit);
		elementHolder.find(".item-content").css("z-index",2)
		EditorHelper.showQuickStyleMenu(elementToEdit);
		if (elementToEdit.is(".preview-body") || elementToEdit.is(".Body") || elementToEdit.is(".blocks-preview-body")){
			elementToEdit.ckeditor(function(){
				var inlineEditor = $("#cke_"+elementToEdit.attr("id"));
				inlineEditor.css({"display":"none"});
			});
			elementToEdit.unbind("mouseup").bind("mouseup", function(e) {
				var inlineEditor = $("#cke_"+elementToEdit.attr("id"));
				if(EditorHelper.isTextSelected()){
					$("#quick-style-menu").hide();
					inlineEditor.css({"opacity":1,"display":"","z-index":"123456789"});
				}
			});
			
		}
		elementToEdit.attr('contenteditable','true').focus().addClass("edit-on");
		if (elementToEdit.text().length > 0){
			setCursorToEnd(elementToEdit.get(0));
		}
		//var parentId = EditorHelper.getHolderId(EditorHelper.getHolderParent(elementToEdit));
		elementToEdit.unbind("keyup").bind("keyup", function(e) {
			if (elementHolder.hasClass("sub")){
				SpimeEngine.ArrangeHolder(EditorHelper.getHolderParent(elementHolder));
			}else{
				SpimeEngine.ArrangeHolder(elementHolder);
			}
		});
		elementToEdit.unbind("paste").bind("paste", function(e) {
	        if (!elementToEdit.is(".preview-body") && !elementToEdit.is(".Body") && !elementToEdit.is(".blocks-preview-body")){
				setTimeout(function() {
	                asd = strip_tags( elementToEdit.html(), '<br><br/>');
	                elementToEdit.html( asd );
				},20);
	        }else{
				e.preventDefault();
				var text = (event.originalEvent || event).clipboardData.getData('text/plain');
    			document.execCommand("insertHTML", false, text);
			}
		});
	}
};





EditorHelper.initQuickStyleMenu = function(){
	var appversion = $("body").attr("data-app-version");
	XPRSHelper.GET("/settings/settings.json?v="+appversion,{},function(settings){
		EditorHelper.StyleSettings = settings;
		//var quickStyleMenuHolderTemplate = $("#quick-style-menu");
	},"json");

		
};

EditorHelper.formatText = function(element,formatCmd,value){
	//var formatResult = document.execCommand(formatCmd, false, value);
	//if (formatCmd == "fontSize"){
	//	$("font[size]").removeAttr("size").css("font-size", value + "px");
	//}
	//return (formatResult && EditorHelper.isTextSelected());
	return false;
};


EditorHelper.showDividerQuickStyleMenu = function(clickedElement){
	var stripe = clickedElement.closest(".master.item-box");
	var holderParent = EditorHelper.getHolderParent(clickedElement);
	//if (stripe.is(".element-box")){
		stripe.find(".stripe-magic-circle , .top-lightning").addClass("disabled");
	//}
	//var currentPreset = stripe.attr("data-preset-type-id");
	var oldMenu = $("#quick-style-menu.cloned");
	if (oldMenu.length > 0){
		oldMenu.find(".color-picker").spectrum("destroy");
		$(".fontSelectUl").remove();
		oldMenu.remove();
		$(".master.container.narrow-site").css("overflow","");
	}
	
	var quickStyleMenuHolderTemplate = $("#quick-style-menu");
	var quickStyleMenuHolder = quickStyleMenuHolderTemplate.clone(true);
	quickStyleMenuHolder.addClass("cloned");
	
	//catch clicks
	quickStyleMenuHolder.unbind("click").bind("click",function(e){
		e.stopPropagation();
	});
	var moduleName = clickedElement.attr("data-menu-name");
	var itemToHoldMenu = EditorHelper.getHolderParent(clickedElement);
	
    //var elementTopPos = clickedElement.position().top;
    //var itemTopPos = 0;
    if (itemToHoldMenu.hasClass("master container")){
    	//elementTopPos = clickedElement.offset().top;
    	itemToHoldMenu = clickedElement.closest(".master.item-box");
	}
 
    //style menu does not fit in the relevant element parent
    if (itemToHoldMenu.hasClass("sub item-box")){
    	itemTopPos = itemToHoldMenu.position().top;
		itemToHoldMenu = itemToHoldMenu.closest(".master.item-box");
    }
    
    quickStyleMenuHolder.find(".font-selector").hide();
    quickStyleMenuHolder.find(".spacing-selector").hide();
    
    quickStyleMenuHolder.find(".text-style-option").remove();
    var styleOptionsUL = quickStyleMenuHolder.find(".text-style-selector ul");
    styleOptionsUL.empty();
    var solidDiv = $("<div />").css({"border":"solid 2px white","width":"30px","border-top-width":"0px","top":"50%","position":"relative","margin-left":"2px"});
    var dashedDiv = $("<div />").css({"border":"dashed 2px white","width":"30px","border-top-width":"0px","top":"50%","position":"relative","margin-left":"2px"});
    var dottedDiv = $("<div />").css({"border":"dotted 2px white","width":"30px","border-top-width":"0px","top":"50%","position":"relative","margin-left":"2px"});
    var doubleDiv = $("<div />").css({"border":"double 1px white","width":"30px","top":"50%","position":"relative","margin-left":"2px","height":"1px"});
    var grooveDiv = $("<div />").css({"border":"groove 2px white","width":"30px","border-top-width":"0px","top":"50%","position":"relative","margin-left":"2px"}); 
    var solidBorder = $("<li />").addClass("clickable text-style-option").attr("data-value","solid").append(solidDiv)
    var dashedBorder = $("<li />").addClass("clickable text-style-option").attr("data-value","dashed").append(dashedDiv)
    var dottedBorder = $("<li />").addClass("clickable text-style-option").attr("data-value","dotted").append(dottedDiv)
    var doubleBorder = $("<li />").addClass("clickable text-style-option").attr("data-value","double").append(doubleDiv)
    var grooveBorder = $("<li />").addClass("clickable text-style-option").attr("data-value","groove").append(grooveDiv)
    styleOptionsUL.append(solidBorder).append(dashedBorder).append(dottedBorder).append(doubleBorder).append(grooveBorder);
    solidBorder.add(dashedBorder).add(dottedBorder).add(doubleBorder).add(grooveBorder).unbind("click").bind("click",function(e){
    	e.stopPropagation();
    	var sizeFieldType = "BORDER_STYLE";
    	var borderType = $(this).attr("data-value");
		var timerKey = sizeFieldType + styleid;
		var params = {};
		params["css_name"] = EditorHelper.StyleSettings["PROPERTIES"][sizeFieldType].css_name;
		params["class_name"] =  EditorHelper.StyleSettings["MODULES"][moduleName].CSS_CLASS;
		params["units"] = EditorHelper.StyleSettings["PROPERTIES"][sizeFieldType].units;
		params["value"] = borderType;
		params["target"] = styleid;
		params["module"] = moduleName;
		EditorHelper.handleStyleChange(params);
		
		EditorHelper.debounceSave(timerKey,function(){
			EditorHelper.updateMultipleStyleKeys({"styleid":styleid,"props":sizeFieldType,"values":borderType,"modules":moduleName},function(){
				 XPRSHelper.updateParent({"deliver_to":"parent","action":"saved"});
			});
		});
    });
    
    
	quickStyleMenuHolder.find(".align-selector").unbind("click").bind("click",function(e){
		e.stopPropagation();
		EditorHelper.alignSwitcherClick($(this),stripe,clickedElement);
	});
	
	var sizeHolder = quickStyleMenuHolder.find(".size-selector");
	var sizeFieldType = "PERCENT_WIDTH";
	var sizeObj = EditorHelper.StyleSettings["PROPERTIES"][sizeFieldType];
	var styleid = clickedElement.closest(".master.item-box").attr("data-styleid");
	if (typeof styleid == "undefined"){
		styleid = clickedElement.closest(".master.item-box").attr("data-preview-styleid");
	}
	//sizeHolder.find("span").text(parseInt(clickedElement.css(sizeObj.css_name)));
	var width = Math.ceil(( 100 * parseFloat(clickedElement.css('width')) / parseFloat(clickedElement.parent().css('width')) ));
	width = width - (width%5);
	width += "%"
	sizeHolder.find("span").text(width);
	
	
	quickStyleMenuHolder.find(".size-option").unbind("click").bind("click",function(e){
		e.stopPropagation();
		var currentSize = parseInt(sizeHolder.find("span").text());
		if ($(this).hasClass("increase")){
			currentSize +=5;
		}else{
			currentSize -=5;
		}
		if(currentSize > 5 && currentSize <= 100){
			sizeHolder.find("span").text(parseInt(currentSize) + "%");
			var timerKey = sizeFieldType + styleid;
			var params = {};
			params["css_name"] = EditorHelper.StyleSettings["PROPERTIES"][sizeFieldType].css_name;
			params["class_name"] =  EditorHelper.StyleSettings["MODULES"][moduleName].CSS_CLASS;
			params["units"] = EditorHelper.StyleSettings["PROPERTIES"][sizeFieldType].units;
			params["value"] = currentSize;
			params["module"] = moduleName;
			params["target"] = styleid;
			EditorHelper.handleStyleChange(params);
			
			EditorHelper.debounceSave(timerKey,function(){
				EditorHelper.updateMultipleStyleKeys({"styleid":styleid,"props":sizeFieldType,"values":parseInt(currentSize)+"-INT","modules":moduleName},function(){
					 XPRSHelper.updateParent({"deliver_to":"parent","action":"saved"});
				});
			});
		}
	});
	
	var heightFieldType = "BORDER_BOTTOM_WIDTH";
	quickStyleMenuHolder.find(".line-height-option").unbind("click").bind("click",function(e){
		e.stopPropagation();
		var currentSize = parseInt(clickedElement.css(EditorHelper.StyleSettings["PROPERTIES"][heightFieldType].css_name));
		if ($(this).hasClass("increase")){
			currentSize +=1;
		}else{
			currentSize -=1;
		}
		if(currentSize > 0 && currentSize <= 100){
			var timerKey = heightFieldType + styleid;
			var params = {};
			params["css_name"] = EditorHelper.StyleSettings["PROPERTIES"][heightFieldType].css_name;
			params["class_name"] =  EditorHelper.StyleSettings["MODULES"][moduleName].CSS_CLASS;
			params["units"] = EditorHelper.StyleSettings["PROPERTIES"][heightFieldType].units;
			params["value"] = currentSize;
			params["target"] = styleid;
			params["module"] = moduleName;
			EditorHelper.handleStyleChange(params);
			
			EditorHelper.debounceSave(timerKey,function(){
				EditorHelper.updateMultipleStyleKeys({"styleid":styleid,"props":heightFieldType,"values":parseInt(currentSize)+"-INT","modules":moduleName},function(){
					 XPRSHelper.updateParent({"deliver_to":"parent","action":"saved"});
				});
			});
		}
	});
	

	
	var relevantColors = new Array(100);
	if ("PALETTES" in EditorHelper.SiteConfig){
		if ("COLORS_PALETTE" in EditorHelper.SiteConfig["PALETTES"]){
			relevantColors = EditorHelper.SiteConfig["PALETTES"]["COLORS_PALETTE"].slice();
		}
	}
	
	if (typeof relevantColors == "undefined" || relevantColors.length == 0){
		relevantColors = ["rgb(0,0,0)","rgb(255,255,255)","rgb(51,204,102)"];
	}else{
		relevantColors.unshift("rgb(0,0,0)");
		relevantColors.unshift("rgb(255,255,255)");
	}
	
	var colorProp = "BORDER_COLOR"
	var colorsList = quickStyleMenuHolder.find(".color-selector .colors-div ul");
	colorsList.empty();
	for (i in relevantColors){
		var color = relevantColors[i];
		var colorOp = $("<li />").addClass("clickable").css("background-color",color).addClass("color-option clickable");
		colorOp.bind("click",function(e){
			e.stopPropagation();
			var currentColor = $(this).css("background-color");
			
			var params = {};
			params["css_name"] = EditorHelper.StyleSettings["PROPERTIES"][colorProp].css_name;
			params["class_name"] =  EditorHelper.StyleSettings["MODULES"][moduleName].CSS_CLASS;
			params["value"] = currentColor;
			params["target"] = styleid;
			params["module"] = moduleName;
			EditorHelper.handleStyleChange(params);
			var timerKey = colorProp + styleid;
			EditorHelper.debounceSave(timerKey,function(){
				EditorHelper.updateMultipleStyleKeys({"styleid":styleid,"props":colorProp,"values":currentColor,"modules":moduleName},function(){
					 XPRSHelper.updateParent({"deliver_to":"parent","action":"saved"});
				});
			});
		});
		colorsList.append(colorOp);
		
		
		
	}
	var moreColors = $("<li />").addClass("clickable more color-picker t-t").text("MORE");
	moreColors.bind("click",function(e){
		e.stopPropagation();
	});
	colorsList.append(moreColors);
	quickStyleMenuHolder.find(".color-picker").each(function(){
		var inputField = $(this);
		var prop = "BORDER_COLOR";
		var inputObj = EditorHelper.StyleSettings["PROPERTIES"][prop];
		var relevantClass = EditorHelper.StyleSettings["MODULES"][moduleName].CSS_CLASS;
		var colorPickerOptions = {
			color:$("."+ styleid + " " +relevantClass).css(inputObj.css_name),
			preferredFormat: "rgb",
			className: 'spectrum-custom',
		    showAlpha: true,
		    showButtons: false,
		    //allowEmpty: true,
		    showInput:true,
		    clickoutFiresChange: true,
		    move: function(color) {
		    	if (color != null){
		    		var changedParams = {};
		    		changedParams["css_name"] = EditorHelper.StyleSettings["PROPERTIES"][prop].css_name;
		    		changedParams["class_name"] =  EditorHelper.StyleSettings["MODULES"][moduleName].CSS_CLASS;
		    		changedParams["top_class"] =  EditorHelper.StyleSettings["MODULES"][moduleName].TOP_CSS_CLASS;
		    		changedParams["value"] = color.toRgbString();
		    		changedParams["target"] = styleid;
		    		changedParams["module"] = moduleName;
					EditorHelper.handleStyleChange(changedParams);
		    		//$("."+ styleid + " " +relevantClass).css(inputObj.css_name,color.toRgbString());
		    	}
		    },
		    change: function(color) {
		    	
		    },
		    beforeShow: function(color) {
		    	//set the alpha to 1 if selected color is transparent (in rgba)
		    	if (color!=null){
		    		var alphaVal = color.getAlpha();
		    		if (alphaVal==0){
		    			color.setAlpha(1);
		    			$(this).spectrum("set", color.toRgbString());
		    		}
		    	}
		    },
		    hide: function(color){
		    	var newColor = "";
	    		if (color == null){
	    			newColor = "rgba(0, 0, 0, 0)";
	    		}else{
	    			newColor = color.toRgbString();
	    		}
		    	EditorHelper.updateMultipleStyleKeys({"styleid":styleid,"props":prop,"values":newColor,"modules":moduleName},function(){
	    			XPRSHelper.updateParent({"deliver_to" : "parent","action" : "saved"});
	    		});
		    }
		};
	    inputField.spectrum(colorPickerOptions);
	});
    
	//itemToHoldMenu.append(quickStyleMenuHolder);
    $(".master.container").append(quickStyleMenuHolder);
    EditorHelper.repositionQuickStyleBar(quickStyleMenuHolder,clickedElement);
	
    if (clickedElement.closest(".multi_layout").length > 0 || clickedElement.closest(".blocks_layout").length > 0){
		var sideBar = $("<div />").addClass("text-edit-sidebar");
		var currentMarginTop = parseInt(clickedElement.css("margin-top"));
		var currentMarginBottom = parseInt(clickedElement.css("margin-bottom"));
		var topMarginDisplay = $("<div />").addClass("top-margin-display margin-display").append($("<span />").text(currentMarginTop).addClass("value-display"));
		var topMarginDisplayControl = $("<div />").addClass("top-margin-display-control margin-display-control");
		topMarginDisplay.append(topMarginDisplayControl);
		var topMarginPlus = $("<img />").addClass("margin-btn margin-top-btn margin-plus-btn").attr("src","/images/ui_icons/margin_plus_ico.png");
		var topMarginMinus =  $("<img />").addClass("margin-btn margin-top-btn margin-minus-btn").attr("src","/images/ui_icons/margin_minus_ico.png");
		topMarginDisplayControl.append(topMarginPlus).append(topMarginMinus)
		var bottomMarginDisplay = $("<div />").addClass("bottom-margin-display margin-display").append($("<span />").text(currentMarginBottom).addClass("value-display"));
		var bottomMarginDisplayControl = $("<div />").addClass("bottom-margin-display-control margin-display-control");
		bottomMarginDisplay.append(bottomMarginDisplayControl);
		var bottomMarginPlus = $("<img />").addClass("margin-btn margin-bottom-btn margin-plus-btn").attr("src","/images/ui_icons/margin_plus_ico.png");
		var bottomMarginMinus =  $("<img />").addClass("margin-btn margin-bottom-btn margin-minus-btn").attr("src","/images/ui_icons/margin_minus_ico.png");
		bottomMarginDisplayControl.append(bottomMarginPlus).append(bottomMarginMinus)
		var verticalAligner = $("<div />").addClass("sidebar-vertical-aligner");
		var moveArrowsHolder = $("<div />").addClass("move-arrows-holder");
		verticalAligner.append(moveArrowsHolder);

		
		topMarginPlus.add(topMarginMinus).add(bottomMarginPlus).add(bottomMarginMinus).unbind("click").bind("click",function(e){
			e.stopPropagation();
			var currentMargin = parseInt($(this).closest(".margin-display").find(".value-display").text());
			if ($(this).is(".margin-plus-btn") || ($(this).is(".margin-minus-btn") && currentMargin > 0)){
				var prop = "MARGIN_BOTTOM"
				if ($(this).is(".margin-top-btn")){
					 prop = "MARGIN_TOP"
				}	
				if ($(this).is(".margin-plus-btn")){
					currentMargin += 5;
				}else{
					currentMargin -= 5;
				}
				var params = {};
				params["css_name"] = EditorHelper.StyleSettings["PROPERTIES"][prop].css_name;
				params["class_name"] =  EditorHelper.StyleSettings["MODULES"][moduleName].CSS_CLASS;
				params["top_class"] =  EditorHelper.StyleSettings["MODULES"][moduleName].TOP_CSS_CLASS;
				params["value"] = currentMargin;
				params["target"] = styleid;
				params["units"] = "px";
				params["module"] = moduleName;
				EditorHelper.handleStyleChange(params);
				$(this).closest(".margin-display").find(".value-display").text(currentMargin);
				var timerKey = prop + "_" + styleid;
				EditorHelper.debounceSave(timerKey,function(){
					EditorHelper.updateMultipleStyleKeys({"styleid":styleid,"props":prop,"values":currentMargin +"-INT","modules":moduleName},function(){
						 XPRSHelper.updateParent({"deliver_to":"parent","action":"saved"});
					});
				});
			}
			EditorHelper.repositionQuickStyleBar(quickStyleMenuHolder,clickedElement);
			
		});
		sideBar.append(topMarginDisplay).append(verticalAligner).append(bottomMarginDisplay);
		clickedElement.parent().addClass("text-sidebar-container").prepend(sideBar);
    }
    EditorHelper.closeLeftClickMenu()
    quickStyleMenuHolder.show();
};

EditorHelper.showSocialQuickStyleMenu = function(clickedElement){
	var stripe = clickedElement.closest(".master.item-box");
	var holderParent = EditorHelper.getHolderParent(clickedElement);
	var moduleName = "PREVIEW_SOCIAL_ICON_HOLDER";
	var styleid = clickedElement.closest(".master.item-box").attr("data-styleid");
	if (typeof styleid == "undefined"){
		styleid = clickedElement.closest(".master.item-box").attr("data-preview-styleid");
	}
    if (clickedElement.closest(".multi_layout").length > 0 || clickedElement.closest(".blocks_layout").length > 0){
		var sideBar = $("<div />").addClass("text-edit-sidebar");
		var currentMarginTop = parseInt(clickedElement.css("margin-top"));
		var currentMarginBottom = parseInt(clickedElement.css("margin-bottom"));
		var topMarginDisplay = $("<div />").addClass("top-margin-display margin-display").append($("<span />").text(currentMarginTop).addClass("value-display"));
		var topMarginDisplayControl = $("<div />").addClass("top-margin-display-control margin-display-control");
		topMarginDisplay.append(topMarginDisplayControl);
		var topMarginPlus = $("<img />").addClass("margin-btn margin-top-btn margin-plus-btn").attr("src","/images/ui_icons/margin_plus_ico.png");
		var topMarginMinus =  $("<img />").addClass("margin-btn margin-top-btn margin-minus-btn").attr("src","/images/ui_icons/margin_minus_ico.png");
		topMarginDisplayControl.append(topMarginPlus).append(topMarginMinus)
		var bottomMarginDisplay = $("<div />").addClass("bottom-margin-display margin-display").append($("<span />").text(currentMarginBottom).addClass("value-display"));
		var bottomMarginDisplayControl = $("<div />").addClass("bottom-margin-display-control margin-display-control");
		bottomMarginDisplay.append(bottomMarginDisplayControl);
		var bottomMarginPlus = $("<img />").addClass("margin-btn margin-bottom-btn margin-plus-btn").attr("src","/images/ui_icons/margin_plus_ico.png");
		var bottomMarginMinus =  $("<img />").addClass("margin-btn margin-bottom-btn margin-minus-btn").attr("src","/images/ui_icons/margin_minus_ico.png");
		bottomMarginDisplayControl.append(bottomMarginPlus).append(bottomMarginMinus)
		var verticalAligner = $("<div />").addClass("sidebar-vertical-aligner");
		var moveArrowsHolder = $("<div />").addClass("move-arrows-holder");
		verticalAligner.append(moveArrowsHolder);
		
		topMarginPlus.add(topMarginMinus).add(bottomMarginPlus).add(bottomMarginMinus).unbind("click").bind("click",function(e){
			e.stopPropagation();
			var currentMargin = parseInt($(this).closest(".margin-display").find(".value-display").text());
			if ($(this).is(".margin-plus-btn") || ($(this).is(".margin-minus-btn") && currentMargin > 0)){
				var prop = "MARGIN_BOTTOM"
				if ($(this).is(".margin-top-btn")){
					 prop = "MARGIN_TOP"
				}	
				if ($(this).is(".margin-plus-btn")){
					currentMargin += 5;
				}else{
					currentMargin -= 5;
				}
				var params = {};
				params["css_name"] = EditorHelper.StyleSettings["PROPERTIES"][prop].css_name;
				params["class_name"] =  EditorHelper.StyleSettings["MODULES"][moduleName].CSS_CLASS;
				params["top_class"] =  EditorHelper.StyleSettings["MODULES"][moduleName].TOP_CSS_CLASS;
				params["value"] = currentMargin;
				params["target"] = styleid;
				params["units"] = "px";
				params["module"] = moduleName;
				EditorHelper.handleStyleChange(params);
				$(this).closest(".margin-display").find(".value-display").text(currentMargin);
				var timerKey = prop + "_" + styleid;
				EditorHelper.debounceSave(timerKey,function(){
					EditorHelper.updateMultipleStyleKeys({"styleid":styleid,"props":prop,"values":currentMargin +"-INT","modules":moduleName},function(){
						 XPRSHelper.updateParent({"deliver_to":"parent","action":"saved"});
					});
				});
			}
			
		});
		sideBar.append(topMarginDisplay).append(verticalAligner).append(bottomMarginDisplay);
		clickedElement.parent().addClass("text-sidebar-container").prepend(sideBar);
    }
    //quickStyleMenuHolder.show();
};


EditorHelper.websiteStyleBtnClick = function(clickedOption,clickedElement,stripe){
	var masterContainer = $(".master.container");
	var updatedValue = clickedOption.attr("id");
	if (clickedOption.attr("id") != "custom"){
		clickedElement.removeClass("custom");
		var stripeId = clickedElement.closest(".master.item-box").attr("id");;
		if (stripe.is(".custom")){
			stripe.removeClass("custom");
			XPRSHelper.SAFEPOST("/update_css_class", {"vbid":stripeId,"updated_key":"STYLE_CLASS","delete_key":"True","stripe_id":stripeId}, stripeId, "CSS_CLASS");
		}
		if (!masterContainer.is(".website-style")){
			masterContainer.addClass("website-style");
			XPRSHelper.SAFEPOST("/update_css_class", {"vbid":EditorHelper.getRootId(),"updated_key":"STYLE_CLASS","updated_value":"website-style","stripe_id":stripeId}, EditorHelper.getRootId(), "CSS_CLASS");
		}
		selectedValue = "website-style";
		
		updatedValue = "false";
	}else{
		selectedValue = "custom";
		clickedElement.addClass("custom");
		moduleName = clickedElement.attr("data-menu-name");
		var styleid = clickedElement.closest(".master.item-box").attr("data-styleid");
		if (typeof styleid == "undefined"){
			styleid = clickedElement.closest(".master.item-box").attr("data-preview-styleid");
		}
		updatedValue = "custom";
	}
	var presetType = stripe.attr("data-preset-type-id");
	if ((XPRSHelper.inPresetGroup(presetType,"GALLERIES") || XPRSHelper.inPresetGroup(presetType,"FEATURES")) && !clickedElement.closest(".stripe-header-wrapper").length > 0){
		var message = "Change style type for all of the items in the current section";
		XPRSHelper.xprsAlert(message,{title: "Change in all items?", showCancelButton: true,confirmButtonText:"Yes please",cancelButtonText:"No, this item only","callbackfunc":function(isConfirm){
			if(isConfirm){
				if (clickedOption.attr("id") != "custom"){
					stripe.find("[data-menu-name='"+ clickedElement.attr("data-menu-name") +"']").removeClass("custom");
				}else{
					stripe.find("[data-menu-name='"+ clickedElement.attr("data-menu-name") +"']").addClass(clickedOption.attr("id"));
				}
				XPRSHelper.SAFEPOST("/update_specific_children_key",{"vbid":stripe.attr("id"),"element_type":clickedElement.attr("data-menu-name").replace("PREVIEW_",""),"updated_key":"STYLE_CLASS","updated_value":updatedValue},EditorHelper.getHolderParent(clickedElement).attr("id"),"UPDATE-CHILD",function() {
				});
			}else{
				var stripeId = clickedElement.closest(".master.item-box").attr("id");
				XPRSHelper.SAFEPOST("/update_specific_child_key",{"vbid":EditorHelper.getHolderParent(clickedElement).attr("id"),"child_vbid":clickedElement.attr("id"),"updated_key":"STYLE_CLASS","updated_value":updatedValue,"stripe_id":stripeId},EditorHelper.getHolderParent(clickedElement).attr("id"),"UPDATE-CHILD",function() {
				});
			}
		}});
	}else{
		var stripeId = clickedElement.closest(".master.item-box").attr("id");
		XPRSHelper.SAFEPOST("/update_specific_child_key",{"vbid":EditorHelper.getHolderParent(clickedElement).attr("id"),"child_vbid":clickedElement.attr("id"),"updated_key":"STYLE_CLASS","updated_value":updatedValue,"stripe_id":stripeId},EditorHelper.getHolderParent(clickedElement).attr("id"),"UPDATE-CHILD",function() {
		});
	}		
	return selectedValue;
};

EditorHelper.showQuickStyleMenu = function(clickedElement){
	var stripe = clickedElement.closest(".master.item-box");
	var holderParent = EditorHelper.getHolderParent(clickedElement);
	var oldMenu = $("#quick-style-menu.cloned");
	
	if (oldMenu.length > 0){
		oldMenu.find(".color-picker").spectrum("destroy");
		$(".fontSelectUl").remove();
		oldMenu.remove();
		$(".master.container.narrow-site").css("overflow","");
	}
	
	var quickStyleMenuHolderTemplate = $("#quick-style-menu");
	var quickStyleMenuHolder = quickStyleMenuHolderTemplate.clone(true);
	quickStyleMenuHolder.addClass("cloned");
	
	//catch clicks
	quickStyleMenuHolder.unbind("click").bind("click",function(e){
		e.stopPropagation();
	});
	
	var moduleName = clickedElement.attr("data-menu-name");
	var sizeHolder = quickStyleMenuHolder.find(".size-selector");
	var sizeFieldType = sizeHolder.attr("data-field-type");
	var sizeObj = EditorHelper.StyleSettings["PROPERTIES"][sizeFieldType];
	var styleid = clickedElement.closest(".master.item-box").attr("data-styleid");
	if (typeof styleid == "undefined"){
		styleid = clickedElement.closest(".master.item-box").attr("data-preview-styleid");
	}

	
	sizeHolder.find("span").text(parseInt(clickedElement.css(sizeObj.css_name)));
	var styleClassSelector = quickStyleMenuHolder.find(".style-class-selector");
	
	
		var masterContainer = $(".master.container");
		if (masterContainer.is(".website-style") && !stripe.is(".custom") && !clickedElement.is(".custom") && moduleName != "PREVIEW_PRICE" && !clickedElement.is(".element")){
			styleClassSelector.find(".selected-option").text(styleClassSelector.find("#website-style").text())
			quickStyleMenuHolder.attr("data-module-name", "WEBSITE_" + moduleName.replace("BLOCKS_",""));
			quickStyleMenuHolder.attr("data-original-module-name", moduleName);
			quickStyleMenuHolder.attr("data-styleid",$("body").attr("data-root-style-id"))
			quickStyleMenuHolder.attr("data-original-styleid",styleid);
		}else{
			quickStyleMenuHolder.attr("data-module-name",moduleName);
			quickStyleMenuHolder.attr("data-original-module-name", moduleName);
			quickStyleMenuHolder.attr("data-styleid",styleid);
			quickStyleMenuHolder.attr("data-original-styleid",styleid);
		}
		
		if ((stripe.attr("data-preset-type-id") == "MENUS" && clickedElement.attr("data-menu-name")=="PREVIEW_LINK") || clickedElement.attr("data-menu-name") == "PREVIEW_PRICE" || clickedElement.attr("data-menu-name").indexOf("PREVIEW") == -1){
			styleClassSelector.hide();
		}else{
			styleClassSelector.find("li").unbind("click").bind("click",function(e){
				e.stopPropagation();
				var clickedOption = $(this);
				var selectedValue = EditorHelper.websiteStyleBtnClick(clickedOption,clickedElement,stripe);
				if(selectedValue == "website-style"){
					quickStyleMenuHolder.attr("data-styleid",$("body").attr("data-root-style-id"));
					quickStyleMenuHolder.attr("data-module-name","WEBSITE_" + moduleName.replace("BLOCKS_",""));
				}else{
					quickStyleMenuHolder.attr("data-styleid",styleid);
					quickStyleMenuHolder.attr("data-module-name",moduleName);
				}
				
				var fontToUpdate = clickedElement.css("font-family");
				quickStyleMenuHolder.find(".font-selector .fonts-div li").removeClass("selected");
				var currentFontOp = quickStyleMenuHolder.find(".font-selector .fonts-div li[data-font='"+ fontToUpdate.replace("'","").replace("'","") +"']")
				if (currentFontOp.length > 0){
					currentFontOp.addClass("selected")
				}
				styleClassSelector.find(".selected-option").text(clickedOption.text())
			});
		}
		
		
		var textDirectionSelector = quickStyleMenuHolder.find(".text-direction-selector");
		
		
		var masterContainer = $(".master.container");
		if (clickedElement.css("direction") == "ltr"){
			textDirectionSelector.find(".selected-option img").attr("src",textDirectionSelector.find("#ltr img").attr("src"));
		}else{
			textDirectionSelector.find(".selected-option img").attr("src",textDirectionSelector.find("#ltr img").attr("src"));
		}
		
		
			textDirectionSelector.find("li").unbind("click").bind("click",function(e){
				e.stopPropagation();
				var clickedOption = $(this);
				styleid = quickStyleMenuHolder.attr("data-styleid")
				moduleName = quickStyleMenuHolder.attr("data-module-name");
				//textDirectionSelector.find("ul").hide();
				textDirectionSelector.find(".selected-option img").attr("src",clickedOption.find("img").attr("src"));
				var timerKey = "TEXT_DIRECTION" + styleid;
				var params = {};
				params["css_name"] = EditorHelper.StyleSettings["PROPERTIES"]["TEXT_DIRECTION"].css_name;
				params["class_name"] =  EditorHelper.StyleSettings["MODULES"][moduleName].CSS_CLASS;
				params["units"] = EditorHelper.StyleSettings["PROPERTIES"]["TEXT_DIRECTION"].units;
				params["value"] = clickedOption.attr("id");
				params["target"] = styleid;
				params["module"] = moduleName;
				EditorHelper.handleStyleChange(params);
				
				EditorHelper.debounceSave(timerKey,function(){
					EditorHelper.updateMultipleStyleKeys({"styleid":styleid,"props":"TEXT_DIRECTION","values": clickedOption.attr("id"),"modules":moduleName},function(){
						 XPRSHelper.updateParent({"deliver_to":"parent","action":"saved"});
					});
				});
			});
	
	quickStyleMenuHolder.find(".size-option").unbind("click").bind("click",function(e){
		e.stopPropagation();
		//not in website stlye
		styleid = quickStyleMenuHolder.attr("data-original-styleid")
		moduleName = quickStyleMenuHolder.attr("data-original-module-name");
		var currentSize = parseInt(sizeHolder.find("span").text());
		if ($(this).hasClass("increase")){
			currentSize +=1;
		}else{
			currentSize -=1;
		}
		if(currentSize > 8 && currentSize <= 150){
			sizeHolder.find("span").text(parseInt(currentSize));
			var timerKey = "FONT_SIZE" + styleid;
			var params = {};
			params["css_name"] = EditorHelper.StyleSettings["PROPERTIES"][sizeFieldType].css_name;
			params["class_name"] =  EditorHelper.StyleSettings["MODULES"][moduleName].CSS_CLASS;
			params["units"] = EditorHelper.StyleSettings["PROPERTIES"][sizeFieldType].units;
			params["value"] = currentSize;
			params["target"] = styleid;
			params["module"] = moduleName;
			EditorHelper.handleStyleChange(params);
			
			EditorHelper.debounceSave(timerKey,function(){
				EditorHelper.updateMultipleStyleKeys({"styleid":styleid,"props":"FONT_SIZE","values":parseInt(currentSize)+"-INT","modules":moduleName},function(){
					 XPRSHelper.updateParent({"deliver_to":"parent","action":"saved"});
				});
			});
		}
	});
	
	var styleOptionsHolder = quickStyleMenuHolder.find(".text-style-selector");
	quickStyleMenuHolder.find(".text-style-option").not(".reset-all").each(function(){
		var op = $(this);
		var opMenuName = op.attr("data-field-type");
		var opCss = EditorHelper.StyleSettings["PROPERTIES"][opMenuName].css_name;
		if (clickedElement.css(opCss) != op.attr("data-reset")){
			styleOptionsHolder.css("background-image",op.css("background-image"));
			return false;
		}
		
	});

	quickStyleMenuHolder.find(".text-style-option").unbind("click").bind("click",function(e){
		e.stopPropagation();
		//styleid = quickStyleMenuHolder.attr("data-styleid")
		//moduleName = quickStyleMenuHolder.attr("data-module-name");
		//not in website stlye
		styleid = quickStyleMenuHolder.attr("data-original-styleid")
		moduleName = quickStyleMenuHolder.attr("data-original-module-name");
		var clickedOption = $(this);
		var newValue = clickedOption.attr("data-value");
		if (clickedElement.is(".preview-body")){
			var formatResult = EditorHelper.formatText(clickedElement,newValue,null);
			if (formatResult){
				return
			}
		}
		var menuName = clickedOption.attr("data-field-type");
		styleOptionsHolder.css("background-image",clickedOption.css("background-image"));
		var resetArr = "";
		quickStyleMenuHolder.find(".text-style-option").not(".reset-all").each(function(){
			var op = $(this);
			var resetParams = {};
			var resetMenuName = op.attr("data-field-type");
			resetParams["css_name"] = EditorHelper.StyleSettings["PROPERTIES"][resetMenuName].css_name;
			resetParams["class_name"] = EditorHelper.StyleSettings["MODULES"][moduleName].CSS_CLASS;
			resetParams["module"] = moduleName;
			if (resetMenuName != menuName){
				resetArr += resetMenuName + "|";
			}
			resetParams["value"] = op.attr("data-reset");
			resetParams["target"] = styleid;
			if (op.attr("data-field-type") != menuName){
				EditorHelper.handleStyleChange(resetParams);
			}
		});
		resetArr = resetArr.slice(0,-1);
		if (clickedOption.is(".reset-all")){
			EditorHelper.deleteMultipleStyleKeys({"styleid":styleid,"props":resetArr,"module":moduleName},function(){
				 XPRSHelper.updateParent({"deliver_to":"parent","action":"saved"});
			});
		}else{
			var params = {};
			params["css_name"] = EditorHelper.StyleSettings["PROPERTIES"][menuName].css_name;
			params["class_name"] =  EditorHelper.StyleSettings["MODULES"][moduleName].CSS_CLASS;
			params["value"] = newValue;
			params["target"] = styleid;
			params["module"] = moduleName;
			EditorHelper.handleStyleChange(params);
			EditorHelper.updateMultipleStyleKeys({"styleid":styleid,"props":menuName,"values":newValue,"modules":moduleName,"reset_arr":resetArr},function(){
				 XPRSHelper.updateParent({"deliver_to":"parent","action":"saved"});
			});
		}
	});
	
	
	quickStyleMenuHolder.find(".align-selector").unbind("click").bind("click",function(e){
		e.stopPropagation();
		EditorHelper.alignSwitcherClick($(this),stripe,clickedElement);
	});
	
	
	quickStyleMenuHolder.find(".spacing-option").unbind("click").bind("click",function(e){
		e.stopPropagation();
		styleid = quickStyleMenuHolder.attr("data-styleid")
		moduleName = quickStyleMenuHolder.attr("data-module-name");
		var currentSize = px(parseFloat(clickedElement.css(EditorHelper.StyleSettings["PROPERTIES"]["LETTER_SPACING"].css_name)),clickedElement);
		if ($(this).hasClass("increase")){
			currentSize = parseFloat(currentSize) +  parseFloat(EditorHelper.StyleSettings["PROPERTIES"]["LETTER_SPACING"].step);
		}else{
			currentSize = parseFloat(currentSize) - parseFloat(EditorHelper.StyleSettings["PROPERTIES"]["LETTER_SPACING"].step);
		}
		currentSize = parseFloat(currentSize).toFixed(2)
		if(currentSize > - 0.5 && currentSize <= 3){
			var timerKey = "LETTER_SPACING" + styleid;
			var params = {};
			params["css_name"] = EditorHelper.StyleSettings["PROPERTIES"]["LETTER_SPACING"].css_name;
			params["class_name"] =  EditorHelper.StyleSettings["MODULES"][moduleName].CSS_CLASS;
			params["units"] = EditorHelper.StyleSettings["PROPERTIES"]["LETTER_SPACING"].units;
			params["value"] = currentSize;
			params["target"] = styleid;
			params["module"] = moduleName;
			EditorHelper.handleStyleChange(params);
			EditorHelper.debounceSave(timerKey,function(){
				EditorHelper.updateMultipleStyleKeys({"styleid":styleid,"props":"LETTER_SPACING","values":currentSize+"-FLOAT","modules":moduleName},function(){
					 XPRSHelper.updateParent({"deliver_to":"parent","action":"saved"});
				});
			});
		}
	});
	
	quickStyleMenuHolder.find(".line-height-option").unbind("click").bind("click",function(e){
		e.stopPropagation();
		styleid = quickStyleMenuHolder.attr("data-styleid");
		moduleName = quickStyleMenuHolder.attr("data-module-name");
		var currentSize = px(parseFloat(clickedElement.css(EditorHelper.StyleSettings["PROPERTIES"]["LINE_HEIGHT"].css_name)),clickedElement);
		if ($(this).hasClass("increase")){
			currentSize = parseFloat(currentSize) +  parseFloat(EditorHelper.StyleSettings["PROPERTIES"]["LINE_HEIGHT"].step);
		}else{
			currentSize = parseFloat(currentSize) - parseFloat(EditorHelper.StyleSettings["PROPERTIES"]["LINE_HEIGHT"].step);
		}
		currentSize = parseFloat(currentSize).toFixed(2)
		if(currentSize > 0 && currentSize <= 6){
			var timerKey = "LINE_HEIGHT" + styleid;
			var params = {};
			params["css_name"] = EditorHelper.StyleSettings["PROPERTIES"]["LINE_HEIGHT"].css_name;
			params["class_name"] =  EditorHelper.StyleSettings["MODULES"][moduleName].CSS_CLASS;
			params["units"] = EditorHelper.StyleSettings["PROPERTIES"]["LINE_HEIGHT"].units;
			params["value"] = currentSize;
			params["target"] = styleid;
			params["module"] = moduleName;
			EditorHelper.handleStyleChange(params);
			EditorHelper.debounceSave(timerKey,function(){
				EditorHelper.updateMultipleStyleKeys({"styleid":styleid,"props":"LINE_HEIGHT","values":currentSize+"-FLOAT","modules":moduleName},function(){
					 XPRSHelper.updateParent({"deliver_to":"parent","action":"saved"});
				});
			});
		}
	});
	

	var relevantFonts = new Array(100);
	var relevantColors = new Array(100);
	if ("PALETTES" in EditorHelper.SiteConfig){
		if ("COLORS_PALETTE" in EditorHelper.SiteConfig["PALETTES"]){
			relevantColors = EditorHelper.SiteConfig["PALETTES"]["COLORS_PALETTE"].slice();
		}
		if ("FONTS_PALETTE" in EditorHelper.SiteConfig["PALETTES"]){
			relevantFonts = EditorHelper.SiteConfig["PALETTES"]["FONTS_PALETTE"][moduleName];
		}
	}
	
	if (typeof relevantColors == "undefined" || relevantColors.length == 0){
		relevantColors = ["rgb(0,0,0)","rgb(255,255,255)","rgb(51,204,102)"];
	}else{
		relevantColors.unshift("rgb(0,0,0)");
		relevantColors.unshift("rgb(255,255,255)");
	}
	if (typeof relevantFonts == "undefined" || relevantFonts.length == 0){
		relevantFonts = ["Arial","Times New Roman","HelveNueThinNormal","Montserrat"];
	}
	var fontList = quickStyleMenuHolder.find(".font-selector .fonts-div ul");
	fontList.empty();
	var currentFont  = clickedElement.css(EditorHelper.StyleSettings["PROPERTIES"]["FONT"].css_name).replace("'","").replace("'","");
	var selectedFontOp = $();
	for (i in relevantFonts){
		var font = relevantFonts[i];
		var fontOp = $("<li />").addClass("clickable").css("font-family",font).text(font.replace("'","").replace("'","")).attr("data-font",font.replace("'","").replace("'",""));
		if (font.replace("'","").replace("'","") == currentFont){
			fontOp.addClass("selected");
			selectedFontOp = fontOp;
		}
		fontOp.bind("click",function(e){
			e.stopPropagation();
			styleid = quickStyleMenuHolder.attr("data-styleid")
			moduleName = quickStyleMenuHolder.attr("data-module-name");
			EditorHelper.fontOptionClick($(this),clickedElement,moduleName,quickStyleMenuHolder.attr("data-styleid"));
		});
		fontList.append(fontOp);
	}
	if (selectedFontOp.length > 0){
		fontList.prepend(selectedFontOp);
	}else{
		var selectedFontOp = $("<li />").addClass("clickable selected").css("font-family",currentFont).text(currentFont.replace("'","").replace("'",""));
		selectedFontOp.bind("click",function(e){
			e.stopPropagation();
			styleid = quickStyleMenuHolder.attr("data-styleid")
			moduleName = quickStyleMenuHolder.attr("data-module-name");
			EditorHelper.fontOptionClick($(this),clickedElement,moduleName,quickStyleMenuHolder.attr("data-styleid"));
		});
		fontList.prepend(selectedFontOp);
	}
	var moreFonts = $("<li />").addClass("clickable more t-t").text("MORE");
	moreFonts.bind("click",function(e){
		e.stopPropagation();
		styleid = quickStyleMenuHolder.attr("data-styleid")
		moduleName = quickStyleMenuHolder.attr("data-module-name");
		var moreFontsList = EditorHelper.StyleSettings["PROPERTIES"]["FONT"].values;
		$(this).remove();
		for (i in moreFontsList){
			var font = moreFontsList[i];
			var fontOp = $("<li />").addClass("clickable").css("font-family",font).text(font.replace("'","").replace("'",""));
			fontOp.bind("click",function(e){
				e.stopPropagation();
				EditorHelper.fontOptionClick($(this),clickedElement,moduleName,styleid);
			});
			fontList.append(fontOp);
		}

		
	});
	fontList.append(moreFonts);
	
	
	var colorsList = quickStyleMenuHolder.find(".color-selector .colors-div ul");
	colorsList.empty();
	for (i in relevantColors){
		var color = relevantColors[i];
		var colorOp = $("<li />").addClass("clickable").css("background-color",color).addClass("color-option clickable");
		colorOp.bind("click",function(e){
			e.stopPropagation();
			var currentColor = $(this).css("background-color");
			if (clickedElement.is(".preview-body")){
				var formatResult = EditorHelper.formatText(clickedElement,"foreColor",currentColor);
				if (formatResult){
					return;
				}
			}
			
			styleid = quickStyleMenuHolder.attr("data-original-styleid")
			moduleName = quickStyleMenuHolder.attr("data-original-module-name");
			var params = {};
			params["css_name"] = EditorHelper.StyleSettings["PROPERTIES"]["COLOR"].css_name;
			params["class_name"] =  EditorHelper.StyleSettings["MODULES"][moduleName].CSS_CLASS;
			params["value"] = currentColor;
			params["target"] = styleid;
			params["module"] = moduleName;
			EditorHelper.handleStyleChange(params);
			var timerKey = "COLOR" + styleid;
			EditorHelper.debounceSave(timerKey,function(){
				EditorHelper.updateMultipleStyleKeys({"styleid":styleid,"props":"COLOR","values":currentColor,"modules":moduleName},function(){
					 XPRSHelper.updateParent({"deliver_to":"parent","action":"saved"});
				});
			});
		});
		colorsList.append(colorOp);
	}
	var moreColors = $("<li />").addClass("clickable more color-picker t-t").text("MORE");
	moreColors.bind("click",function(e){
		e.stopPropagation();
	});
	colorsList.append(moreColors);
	
	
	
	quickStyleMenuHolder.find(".color-picker").each(function(){
		styleid = quickStyleMenuHolder.attr("data-original-styleid")
		moduleName = quickStyleMenuHolder.attr("data-original-module-name");
		var inputField = $(this);
		var prop = "COLOR";
		var inputObj = EditorHelper.StyleSettings["PROPERTIES"][prop];
		var relevantClass = EditorHelper.StyleSettings["MODULES"][moduleName].CSS_CLASS;
		var colorPickerOptions = {
			color:$("."+ styleid + " " +relevantClass).css(inputObj.css_name),
			preferredFormat: "rgb",
			className: 'spectrum-custom',
		    showAlpha: true,
		    showButtons: false,
		    //allowEmpty: true,
		    showInput:true,
		    clickoutFiresChange: true,
		    move: function(color) {
				styleid = quickStyleMenuHolder.attr("data-original-styleid")
				moduleName = quickStyleMenuHolder.attr("data-original-module-name");
		    	if (color != null){
		    		if (clickedElement.is(".preview-body")){
						var formatResult = EditorHelper.formatText(clickedElement,"foreColor",color.toRgbString());
						if (formatResult){
							return;
						}
					}
		    		
		    		var changedParams = {};
		    		changedParams["css_name"] = EditorHelper.StyleSettings["PROPERTIES"][prop].css_name;
		    		changedParams["class_name"] =  EditorHelper.StyleSettings["MODULES"][moduleName].CSS_CLASS;
		    		changedParams["top_class"] =  EditorHelper.StyleSettings["MODULES"][moduleName].TOP_CSS_CLASS;
		    		changedParams["value"] = color.toRgbString();
		    		changedParams["target"] = styleid;
		    		changedParams["module"] = moduleName;
					EditorHelper.handleStyleChange(changedParams);
		    		
		    		
		    		//$("."+ styleid + " " +relevantClass).css(inputObj.css_name,color.toRgbString());
		    	}
		    },
		    change: function(color) {
				styleid = quickStyleMenuHolder.attr("data-original-styleid")
				moduleName = quickStyleMenuHolder.attr("data-original-module-name");
		    	if (color != null){
		    		if (clickedElement.is(".preview-body")){
						var formatResult = EditorHelper.formatText(clickedElement,"foreColor",color.toRgbString());
						if (formatResult){
							return;
						}
					}
		    		var changedParams = {};
		    		changedParams["css_name"] = EditorHelper.StyleSettings["PROPERTIES"][prop].css_name;
		    		changedParams["class_name"] =  EditorHelper.StyleSettings["MODULES"][moduleName].CSS_CLASS;
		    		changedParams["top_class"] =  EditorHelper.StyleSettings["MODULES"][moduleName].TOP_CSS_CLASS;
		    		changedParams["value"] = color.toRgbString();
		    		changedParams["target"] = styleid;
		    		changedParams["module"] = moduleName;
					EditorHelper.handleStyleChange(changedParams);
		    	}
		    },
		    beforeShow: function(color) {
		    	//set the alpha to 1 if selected color is transparent (in rgba)
		    	if (color!=null){
		    		var alphaVal = color.getAlpha();
		    		if (alphaVal==0){
		    			color.setAlpha(1);
		    			$(this).spectrum("set", color.toRgbString());
		    		}
		    	}
		    },
		    hide: function(color) {
					styleid = quickStyleMenuHolder.attr("data-original-styleid")
					moduleName = quickStyleMenuHolder.attr("data-original-module-name");
		    		var newColor = "";
		    		if (color == null){
		    			newColor = "rgba(0, 0, 0, 0)";
		    		}else{
		    			newColor = color.toRgbString();
		    		}
		    		if (clickedElement.is(".preview-body")){
						var formatResult = EditorHelper.formatText(clickedElement,"foreColor",color.toRgbString());
						if (formatResult){
							return;
						}
					}
		    		
		    		
		    		var minDiff = 1000;
		    		var similarColor = newColor;
		    		if ("PALETTES" in  EditorHelper.SiteConfig && "COLORS_PALETTE" in EditorHelper.SiteConfig["PALETTES"]){
						for (var i = 0 ; i < EditorHelper.SiteConfig["PALETTES"]["COLORS_PALETTE"].length; i++){
							var currentDiff = ColorDiff.diff(newColor,EditorHelper.SiteConfig["PALETTES"]["COLORS_PALETTE"][i]);
							if (currentDiff < minDiff){
								minDiff = currentDiff;
								similarColor = EditorHelper.SiteConfig["PALETTES"]["COLORS_PALETTE"][i]
							}
						}
		    		}
					if (minDiff < 10){
						var message = "The color you have selected is very similar to another color you already have in your website palette. Which color do you want to use?"
						XPRSHelper.xprsAlert(message,{title: "A similar color already exists on your website", showCancelButton: true,confirmButtonText:"The one from my palette",cancelButtonText:"The new color","callbackfunc":function(isConfirm){
							   if(isConfirm){
								   newColor = similarColor;
								   var changedParams = {};
						    		changedParams["css_name"] = EditorHelper.StyleSettings["PROPERTIES"][prop].css_name;
						    		changedParams["class_name"] =  EditorHelper.StyleSettings["MODULES"][moduleName].CSS_CLASS;
						    		changedParams["top_class"] =  EditorHelper.StyleSettings["MODULES"][moduleName].TOP_CSS_CLASS;
						    		changedParams["value"] = newColor;
						    		changedParams["target"] = styleid;
						    		changedParams["module"] = moduleName;
									EditorHelper.handleStyleChange(changedParams);
							   }else{
								   if (!("PALETTES" in EditorHelper.SiteConfig)){
						    			EditorHelper.SiteConfig["PALETTES"] = {}
						    		}
						    		if (!("COLORS_PALETTE" in EditorHelper.SiteConfig["PALETTES"])){
						    			EditorHelper.SiteConfig["PALETTES"]["COLORS_PALETTE"] = [];
						    		}else{
						    			if (EditorHelper.SiteConfig["PALETTES"]["COLORS_PALETTE"].length > 5){
						    				EditorHelper.SiteConfig["PALETTES"]["COLORS_PALETTE"].shift();
						    			}
						    		}
						    		EditorHelper.SiteConfig["PALETTES"]["COLORS_PALETTE"].push(newColor);
						    		XPRSHelper.POST("/update_specific_key", {vbid:EditorHelper.getRootId(),section:"CONFIG",updated_key:"PALETTES",updated_value:JSON.stringify(EditorHelper.SiteConfig["PALETTES"]),"type":"json"}, function(){
						    			
						    		});
						    		EditorHelper.updateMultipleStyleKeys({"styleid":styleid,"props":prop,"values":newColor,"modules":moduleName},function(){
						    			XPRSHelper.updateParent({"deliver_to" : "parent","action" : "saved"});
						    		});
							   }
						}});
					}else{
						if (!("PALETTES" in EditorHelper.SiteConfig)){
			    			EditorHelper.SiteConfig["PALETTES"] = {}
			    		}
			    		if (!("COLORS_PALETTE" in EditorHelper.SiteConfig["PALETTES"])){
			    			EditorHelper.SiteConfig["PALETTES"]["COLORS_PALETTE"] = [];
			    		}else{
			    			if (EditorHelper.SiteConfig["PALETTES"]["COLORS_PALETTE"].length > 5){
			    				EditorHelper.SiteConfig["PALETTES"]["COLORS_PALETTE"].shift();
			    			}
			    		}
			    		EditorHelper.SiteConfig["PALETTES"]["COLORS_PALETTE"].push(newColor);
			    		XPRSHelper.POST("/update_specific_key", {vbid:EditorHelper.getRootId(),section:"CONFIG",updated_key:"PALETTES",updated_value:JSON.stringify(EditorHelper.SiteConfig["PALETTES"]),"type":"json"}, function(){
			    			
			    		});
			    		//styleid = quickStyleMenuHolder.attr("data-styleid")
			    		EditorHelper.updateMultipleStyleKeys({"styleid":styleid,"props":prop,"values":newColor,"modules":moduleName},function(){
			    			XPRSHelper.updateParent({"deliver_to" : "parent","action" : "saved"});
			    		});
					}
		    		
		    		
		    		
		    		
		    		
		    }
		};
	    inputField.spectrum(colorPickerOptions);
	});
	var itemToHoldMenu = EditorHelper.getHolderParent(clickedElement);

	if (clickedElement.is(".preview-element.Link") && holderParent.attr("data-preset-type-id") != "MENUS"){
		var styleButton = $("<div class='button-style-panel'>style</div>");
		styleButton.unbind("click").bind("click",function(e){
			EditorHelper.showDraggableTabbedPanel("buttons-style-wrapper", clickedElement);
		});
		quickStyleMenuHolder.append(styleButton);
	}
	
	
	//style menu does not fit in the relevant element

	
	
    //var elementTopPos = clickedElement.position().top;
    //var itemTopPos = 0;
    if (itemToHoldMenu.hasClass("master container")){
    	//elementTopPos = clickedElement.offset().top;
    	itemToHoldMenu = clickedElement.closest(".master.item-box");
	}
 
    //style menu does not fit in the relevant element parent
    if (itemToHoldMenu.hasClass("sub item-box")){
    	itemTopPos = itemToHoldMenu.position().top;
		itemToHoldMenu = itemToHoldMenu.closest(".master.item-box");
    }
	//itemToHoldMenu.append(quickStyleMenuHolder);
    $(".master.container").append(quickStyleMenuHolder);
    EditorHelper.repositionQuickStyleBar(quickStyleMenuHolder,clickedElement);
	
    if (clickedElement.closest(".multi_layout").length > 0 || clickedElement.closest(".blocks_layout").length > 0){
		var sideBar = $("<div />").addClass("text-edit-sidebar");
		var currentMarginTop = parseInt(clickedElement.css("margin-top"));
		var currentMarginBottom = parseInt(clickedElement.css("margin-bottom"));
		var topMarginDisplay = $("<div />").addClass("top-margin-display margin-display").append($("<span />").text(currentMarginTop).addClass("value-display"));
		var topMarginDisplayControl = $("<div />").addClass("top-margin-display-control margin-display-control");
		topMarginDisplay.append(topMarginDisplayControl);
		var topMarginPlus = $("<img />").addClass("margin-btn margin-top-btn margin-plus-btn").attr("src","/images/ui_icons/margin_plus_ico.png");
		var topMarginMinus =  $("<img />").addClass("margin-btn margin-top-btn margin-minus-btn").attr("src","/images/ui_icons/margin_minus_ico.png");
		topMarginDisplayControl.append(topMarginPlus).append(topMarginMinus)
		var bottomMarginDisplay = $("<div />").addClass("bottom-margin-display margin-display").append($("<span />").text(currentMarginBottom).addClass("value-display"));
		var bottomMarginDisplayControl = $("<div />").addClass("bottom-margin-display-control margin-display-control");
		bottomMarginDisplay.append(bottomMarginDisplayControl);
		var bottomMarginPlus = $("<img />").addClass("margin-btn margin-bottom-btn margin-plus-btn").attr("src","/images/ui_icons/margin_plus_ico.png");
		var bottomMarginMinus =  $("<img />").addClass("margin-btn margin-bottom-btn margin-minus-btn").attr("src","/images/ui_icons/margin_minus_ico.png");
		bottomMarginDisplayControl.append(bottomMarginPlus).append(bottomMarginMinus)
		var verticalAligner = $("<div />").addClass("sidebar-vertical-aligner");
		var moveArrowsHolder = $("<div />").addClass("move-arrows-holder");
		verticalAligner.append(moveArrowsHolder);

		
		topMarginPlus.add(topMarginMinus).add(bottomMarginPlus).add(bottomMarginMinus).unbind("click").bind("click",function(e){
			e.stopPropagation();
			styleid = quickStyleMenuHolder.attr("data-original-styleid")
			moduleName = quickStyleMenuHolder.attr("data-original-module-name");
			var currentMargin = parseInt($(this).closest(".margin-display").find(".value-display").text());
			if ($(this).is(".margin-plus-btn") || ($(this).is(".margin-minus-btn") && currentMargin > 0)){
				var prop = "MARGIN_BOTTOM"
				if ($(this).is(".margin-top-btn")){
					 prop = "MARGIN_TOP"
				}	
				if ($(this).is(".margin-plus-btn")){
					currentMargin += 5;
				}else{
					currentMargin -= 5;
				}
				var params = {};
				params["css_name"] = EditorHelper.StyleSettings["PROPERTIES"][prop].css_name;
				params["class_name"] =  EditorHelper.StyleSettings["MODULES"][moduleName].CSS_CLASS;
				params["top_class"] =  EditorHelper.StyleSettings["MODULES"][moduleName].TOP_CSS_CLASS;
				params["value"] = currentMargin;
				params["target"] = styleid;
				params["units"] = "px";
				params["module"] = moduleName;
				EditorHelper.handleStyleChange(params);
				$(this).closest(".margin-display").find(".value-display").text(currentMargin);
				var timerKey = prop + "_" + styleid;
				EditorHelper.debounceSave(timerKey,function(){
					EditorHelper.updateMultipleStyleKeys({"styleid":styleid,"props":prop,"values":currentMargin +"-INT","modules":moduleName},function(){
						 XPRSHelper.updateParent({"deliver_to":"parent","action":"saved"});
					});
				});
			}
			EditorHelper.repositionQuickStyleBar(quickStyleMenuHolder,clickedElement);
			
		});
		sideBar.append(topMarginDisplay).append(verticalAligner).append(bottomMarginDisplay);
		clickedElement.parent().addClass("text-sidebar-container").prepend(sideBar);
    }
    EditorHelper.closeLeftClickMenu();
    quickStyleMenuHolder.show();
	
};


EditorHelper.fontOptionClick = function(currentOp,clickedElement,moduleName,styleid){
	currentOp.siblings().removeClass("selected");
	currentOp.addClass("selected");
	var currentFont = currentOp.css("font-family");
	if (clickedElement.is(".preview-body")){
		var formatResult = EditorHelper.formatText(clickedElement,"fontName",currentFont);
		if (formatResult){
			return
		}
	}
	
	
	var params = {};
	params["css_name"] = EditorHelper.StyleSettings["PROPERTIES"]["FONT"].css_name;
	params["class_name"] =  EditorHelper.StyleSettings["MODULES"][moduleName].CSS_CLASS;
	params["value"] = currentFont;
	params["target"] = styleid;
	params["module"] = moduleName;
	EditorHelper.handleStyleChange(params);
	
	var timerKey = "FONT" + styleid;
	EditorHelper.debounceSave(timerKey,function(){
		EditorHelper.updateMultipleStyleKeys({"styleid":styleid,"props":"FONT","values":currentFont,"modules":moduleName},function(){
			 EditorHelper.updateFontPalette(moduleName,currentFont);
			 XPRSHelper.updateParent({"deliver_to":"parent","action":"saved"});
		});
	});
};


EditorHelper.updateFontPalette = function(moduleName,newFont){
	if (!("PALETTES" in EditorHelper.SiteConfig)){
		EditorHelper.SiteConfig["PALETTES"] = {}
	}
	if (!("FONTS_PALETTE" in EditorHelper.SiteConfig["PALETTES"])){
		EditorHelper.SiteConfig["PALETTES"]["FONTS_PALETTE"] = {};
	}
	if (!(moduleName in EditorHelper.SiteConfig["PALETTES"]["FONTS_PALETTE"])){
		EditorHelper.SiteConfig["PALETTES"]["FONTS_PALETTE"][moduleName] = [];
	}else{
		if (EditorHelper.SiteConfig["PALETTES"]["FONTS_PALETTE"][moduleName].length > 5){
			EditorHelper.SiteConfig["PALETTES"]["FONTS_PALETTE"][moduleName].shift();
		}
	}
	var alreadyExists = false;
	for (i in EditorHelper.SiteConfig["PALETTES"]["FONTS_PALETTE"][moduleName] ){
		if (EditorHelper.SiteConfig["PALETTES"]["FONTS_PALETTE"][moduleName][i] == newFont){
			alreadyExists = true;
			break;
		}
	}
	if (!alreadyExists){
		EditorHelper.SiteConfig["PALETTES"]["FONTS_PALETTE"][moduleName].push(newFont);
		XPRSHelper.POST("/update_specific_key", {vbid:EditorHelper.getRootId(),section:"CONFIG",updated_key:"PALETTES",updated_value:JSON.stringify(EditorHelper.SiteConfig["PALETTES"]),"type":"json"}, function(){
			
		});
	}
};


EditorHelper.handleNativeOrderChange = function(parent,nativeChildrenOrder){
	for (i in nativeChildrenOrder){
		var elementType = nativeChildrenOrder[i];
		var relevantElements = parent.find($("[data-menu-name='"+ elementType +"'], .element-placeholder[data-elementtype='"+ elementType.replace("PREVIEW_","").replace("BLOCKS_","") +"']"));
		if (relevantElements.length == 0){
			if (elementType == "PREVIEW_FORM"){
				relevantElements = parent.find(".preview-form")
			}
			if (elementType == "PREVIEW_LINKS"){
				relevantElements = parent.find(".preview-item-links")
			}
		}
		relevantElements.each(function(){
			var currentElement = $(this)
			var contentHolder = currentElement.closest(".preview-content-holder");
			var structureToMove = currentElement.closest(".order-handle");
			if (structureToMove.length == 0){
				structureToMove = currentElement;
			}else{
				structureToMove = structureToMove.add(structureToMove.next(".lower-line-break")).add(structureToMove.prev(".upper-line-break"));
			}
			contentHolder.append(structureToMove);
		});
	}
	parent.find(".inline-add-element-btn-wrapper").each(function(){
		var currentElement = $(this)
		var contentHolder = currentElement.closest(".preview-content-holder");
		contentHolder.append(currentElement);
	});
};


EditorHelper.repositionQuickStyleBar = function(quickStyleMenuHolder,clickedElement){
	var leftPos = clickedElement.offset().left; //- delta/2;
	leftPos = Math.max(0,leftPos);
	leftPos +=  clickedElement.width()/2 - quickStyleMenuHolder.width()/2;
	var topPos =   parseInt(clickedElement.offset().top) - parseInt(clickedElement.css("padding-top")) - parseInt(clickedElement.css("margin-top")); // itemTopPos + elementTopPos;
	topPos -= quickStyleMenuHolder.height()*1.5 + 50; 
	if (topPos < 50){
		topPos = 50;
		leftPos -= quickStyleMenuHolder.width();
	}
	if (leftPos < 0){
		leftPos = clickedElement.offset().left + clickedElement.width() + 20;
	}
	var masterContainerLeft = $(".master.container").offset().left;
	quickStyleMenuHolder.css("left",leftPos - masterContainerLeft);
	quickStyleMenuHolder.css("top",topPos) ;
	$(".master.container.narrow-site").css("overflow","visible");
};


function em(input,clickedElement) {
    var emSize = parseFloat(clickedElement.css("font-size"));
    return (emSize * input);
}

function px(input,clickedElement) {
    var emSize = parseFloat(clickedElement.css("font-size"));
    return (input / emSize);
}

//Function to convert hex format to a rgb color
function rgb2hex(rgb){
 rgb = rgb.match(/^rgba?[\s+]?\([\s+]?(\d+)[\s+]?,[\s+]?(\d+)[\s+]?,[\s+]?(\d+)[\s+]?/i);
 return (rgb && rgb.length === 4) ? "#" +
  ("0" + parseInt(rgb[1],10).toString(16)).slice(-2) +
  ("0" + parseInt(rgb[2],10).toString(16)).slice(-2) +
  ("0" + parseInt(rgb[3],10).toString(16)).slice(-2) : '';
}

function hex2rgba(hex,opacity){
    hex = hex.replace('#','');
    r = parseInt(hex.substring(0,2), 16);
    g = parseInt(hex.substring(2,4), 16);
    b = parseInt(hex.substring(4,6), 16);

    result = 'rgba('+r+','+g+','+b+','+opacity+')';
    return result;
}

function strip_tags (input, allowed) {
    /* http://kevin.vanzonneveld.net*/

    if ( input == undefined ) { return ''; }

    allowed = (((allowed || "") + "").toLowerCase().match(/<[a-z][a-z0-9]*>/g) || []).join(''); // making sure the allowed arg is a string containing only tags in lowercase (<a><b><c>)
    var tags = /<\/?([a-z][a-z0-9]*)\b[^>]*>/gi;
    var commentsAndPhpTags = /<!--[\s\S]*?-->|<\?(?:php)?[\s\S]*?\?>/gi;
    var spaces = /&nbsp;/gi;
    return input.replace(commentsAndPhpTags, '').replace(spaces, ' ').replace(tags, function (a, b) {
        return allowed.indexOf('<' + b.toLowerCase() + '>') > -1 ? a : '';
    });
}

EditorHelper.stopElementEditMode = function(elementToEdit){
	if (elementToEdit.length == 0){
		return;
	}
	if (!(elementToEdit.hasClass("force-stay"))){
		if (!elementToEdit.text() && !(elementToEdit.is(".quote-author")) && !(elementToEdit.is(".blocks-preview-divider")) && !(elementToEdit.is(".preview-divider"))){
			var message = "Looks like you deleted all the text in the element... Do you wish to remove it?";
			XPRSHelper.xprsAlert(message,{title: " No text?", showCancelButton: true,confirmButtonText:"Yes please",cancelButtonText:"No, back to editing","callbackfunc":function(isConfirm){
				   if(isConfirm){
					    var vbid = elementToEdit.attr("id");
						var parentId = EditorHelper.getHolderParent(elementToEdit).attr("id");
						EditorHelper.handleDelete({"vbid":vbid});
						var stripeId = elementToEdit.closest(".master.item-box").attr("id");
						XPRSHelper.SAFEPOST("/remove_child",{"parent":parentId , "child": vbid,"stripe_id":stripeId},parentId,{"action_name":"REMOVE-CHILD","pretty_name":"Remove " + elementToEdit.attr("data-menu-name").toLowerCase()},function() {
							//EditorHelper.updateParent({"deliver_to":"editor","action":"delete-holder","vbid":vbid,"parent_vbid":parentId});
						});
				   }else{
					  elementToEdit.focus();
					  EditorHelper.startElementEditMode(elementToEdit);
					  return;
				   }
			 }});
		}
		//$("body").disableSelection();
		var stripe = elementToEdit.closest(".master.item-box");
		stripe.find(".stripe-magic-circle, .top-lightning ").removeClass("disabled");

		elementToEdit.removeAttr('contenteditable').removeClass("edit-on");
		var elementId = elementToEdit.attr("id")
		EditorHelper.getHolderParent(elementToEdit).find(".item-content").css("z-index","")
		var parentId = EditorHelper.getHolderId(EditorHelper.getHolderParent(elementToEdit));
		var propName = "TEXT";
		if (elementToEdit.attr("data-menu-name").indexOf("LINK")!= -1){
			propName = "LABEL";
		}
		if (elementToEdit.is(".quote-author")){
			propName = "AUTHOR";
			elementId = elementId.replace("_author","");
		}
		
		var saveValue = elementToEdit.html();

		if (elementToEdit.is(".submenu-title")){
			var saveValue = elementToEdit.clone().children().remove().end().text();
		}
		
		//remove {cke_protect} remarks
		if (elementToEdit.is(".cke_editable")){
			saveValue = elementToEdit.find("p").contents().each(function() {
		        if(this.nodeType == 8) {
		            $(this).remove()
		        }
		    });
			saveValue = elementToEdit.html();
		}
		
		
		
		
		var strippedContent = strip_tags(saveValue, '<br><br/>'); 
		if (!elementToEdit.hasClass("preview-body") && !elementToEdit.hasClass("Body") && !elementToEdit.is(".blocks-preview-body")){
			saveValue = strippedContent;
		}else{
			saveValue = strippedContent + "|||" + elementToEdit.html().replace(/&nbsp;/gi, ' ');
			propName += "|HTML";
		}
		
		//var editor = CKEDITOR.instances[elementToEdit.attr("id")]
		//console.log(" ggg " + editor)
		
		if (elementToEdit.is(".cke_editable")){
			elementToEdit.ckeditorGet().destroy();
			elementToEdit.unbind("mouseup");
		}
		
		var stripeId = stripe.attr("id");
		var textChangeParams = {element_id :elementId ,parent_id:parentId,prop_name:propName,prop_value:saveValue,"stripe_id":stripeId};
		var undoKey = parentId + "-" + elementId;
		if (undoKey in XPRSUndo.originalValues){
			textChangeParams["old_prop_name"] = XPRSUndo.originalValues[undoKey]["propName"]
			textChangeParams["old_prop_value"] = XPRSUndo.originalValues[undoKey]["prop_value"]
		}
		
		XPRSHelper.SAFEPOST("/update_element_content", textChangeParams, parentId, "CHANGE-TEXT");

	}
	
};

function setCursorToEnd(ele) {
	var range = document.createRange();
	var sel = window.getSelection();
	range.setStart(ele, 1);
	range.collapse(true);
	sel.removeAllRanges();
	sel.addRange(range);
	ele.focus();
	
}

EditorHelper.initEditBtn = function(holder, btn){
	var holderType = SpimeEngine.getHolderType(holder);
	var holderParent = EditorHelper.getHolderParent(holder);
	if (holderParent.hasClass("element-box")){
		holderParent = EditorHelper.getHolderParent(holderParent);
	}
	var parentsList = EditorHelper.getParentsList(holder);
	parentsList = parentsList.slice(0,parentsList.length - 1);
	btn.unbind("click").bind("click",function(event){
		event.stopPropagation();
		if ($(this).hasClass("disabled")){return false};
		switch(holderType){
			case "gallery":
			case "item":
				EditorHelper.showStripeSettings(holder);
				break;
			case "element":
				if (holder.find(".raw-container").length > 0){
					EditorHelper.showDraggableTabbedPanel("raw-edit",holder.find(".magic-circle-holder"));
				}
				break;
		}
	});
};

EditorHelper.handleMoveChild = function(holder,direction){
	var holderParent = EditorHelper.getHolderParent(holder);
	var holderType = EditorHelper.getTypeOf(holder);
	var needToReplaceWith = holder.prevAll(".item-box").first();
	if (direction == "down"){
		needToReplaceWith = holder.nextAll(".item-box").first();
	}
	
	if (holderType == "stripe"){
		var handleToMove = holder.next(".control-handle");
		//down
		if (direction == "down"){
			holder.insertAfter(needToReplaceWith.next(".control-handle"));
			handleToMove.insertAfter(holder);
		}else{
			holder.insertBefore(needToReplaceWith);
			handleToMove.insertAfter(holder);
		}
		//if (holder.is(".fill-height")){
			//SpimeEngine.ArrangeHolder(holder);
		//}
	}else{
		var itemParentType = holderParent.attr("data-preset-type-id");
		if (direction == "down"){
			holder.insertAfter(needToReplaceWith);
		}else{
			holder.insertBefore(needToReplaceWith);
		}
		if (typeof itemParentType != "undefined"){
			if (XPRSHelper.inPresetGroup(itemParentType,"SLIDESHOWS")){
				// var currentSlideNum = holder.attr("data-page-num");
				// holder.closest(".sub.container").attr("start-with-slide",currentSlideNum);
				SpimeEngine.InitHolder(holderParent);
				flex_arranger.slide($(),((direction =="down")? "left" : "right") ,holder.closest(".container").find("#items-holder").children(),holder.closest(".container"))
			}
			if (XPRSHelper.inPresetGroup(itemParentType,"GALLERIES") || XPRSHelper.inPresetGroup(itemParentType,"FEATURES")){
				needToReplaceWith.addClass("do-not-highlight");
				holder.addClass("highlight");
				needToReplaceWith.one("mouseout",function(){
					needToReplaceWith.removeClass("do-not-highlight");
					holder.removeClass("highlight");
				});
				if (holderParent.is(".mazonite")){
					SpimeEngine.ArrangeHolder(holderParent);
				}
			}
		}
	}
};

EditorHelper.initMoveUpBtn = function(holder,btn,callbackFunc){
	var stripe = holder.closest(".master.item-box");
	var vbid = EditorHelper.getHolderId(holder);
	var holderParent = EditorHelper.getHolderParent(holder);
	var parentId = holderParent.attr("id");
	var holderType = EditorHelper.getTypeOf(holder);
	btn.unbind("click").bind("click",function(event){
		event.stopPropagation();
		if (!stripe.is(".disable-actions")){
			EditorHelper.handleMoveChild(holder,"up");
			var actionName = "MOVE-ITEM";
			if (holderType == "stripe"){
				actionName = "MOVE-STRIPE"
			}
			EditorHelper.closeLeftClickMenu();
			var stripeId = stripe.attr("id");
			XPRSHelper.SAFEPOST("/move_child",{"parent":parentId , "vbid": vbid,"direction":"up","stripe_id":stripeId},parentId,actionName,function(){
				if (typeof callbackFunc != "undefined"){
					callbackFunc();
				}
			});
		}
	});
};

EditorHelper.initMoveDownBtn = function(holder,btn,callbackFunc){
	var stripe = holder.closest(".master.item-box");
	var vbid = EditorHelper.getHolderId(holder);
	var holderParent = EditorHelper.getHolderParent(holder);
    var parentId = holderParent.attr("id");
	var holderType = EditorHelper.getTypeOf(holder);
	btn.unbind("click").bind("click",function(event){
		event.stopPropagation();
		if (!stripe.is(".disable-actions")){
			EditorHelper.handleMoveChild(holder,"down");
			var actionName = "MOVE-ITEM";
			if (holderType == "stripe"){
				actionName = "MOVE-STRIPE"
			}
			EditorHelper.closeLeftClickMenu();
			var stripeId = stripe.attr("id");
			XPRSHelper.SAFEPOST("/move_child",{"parent":parentId , "vbid": vbid,"direction":"down","stripe_id":stripeId},parentId,actionName,function(){
				if (typeof callbackFunc != "undefined"){
						callbackFunc();
				}
			});
		}
	});
};

EditorHelper.initDeleteBtn = function(holder,btn,callbackFunc){
	var vbid = EditorHelper.getHolderId(holder);
	var parentId = EditorHelper.getHolderParent(holder).attr("id");
	btn.unbind("click").bind("click",function(event){
		event.stopPropagation();
		if (vbid == "no-child"){
			vbid = holder.attr("data-vbid");
			var message = "This stripe contains an error or is not ready yet.\n in most cases waiting a few seconds and reloading the page will fix the problem.";
			XPRSHelper.xprsAlert(message,{title: " Remove Erred Stripe?", showCancelButton: true,confirmButtonText:"Remove anyway",cancelButtonText:"No, I'll wait","callbackfunc":function(isConfirm){
				if(isConfirm){
					
					var handleToDelete = holder.next(".control-handle");
					handleToDelete.remove();
					holder.remove();
					SpimeEngine.ArrangeMaster();
					//EditorHelper.updateParent({"deliver_to":"editor","action":"delete-holder","vbid":vbid,"parent_vbid":parentId});
					var stripeId = holder.closest(".master.item-box").attr("id");
					XPRSHelper.SAFEPOST("/remove_child",{"parent":parentId , "child": vbid,"stripe_id":stripeId},parentId,"REMOVE-CHILD-NO-UNDO",function(){
						if (typeof callbackFunc != "undefined"){
							callbackFunc();
						}
					});
				}
			 }});
			return
		}
		if (holder.is(".master.item-box")){
			if ($(".master.item-box").length == 1){
				XPRSHelper.xprsAlert("Deleting the last section is not possible",{title: " Last Section"});
				return;
			}
		}
		var btnClicked = $(this);
		//if (btnClicked.hasClass("user-sure")){
			var message = "You are about to delete a section";
			XPRSHelper.xprsAlert(message,{title: "Are you sure?", showCancelButton: true,confirmButtonText:"Delete Section",cancelButtonText:"Cancel","callbackfunc":function(isConfirm){
				if(isConfirm){
					EditorHelper.deleteSection(holder, callbackFunc);
				}
			}});
	});
	
	
	btn.hover(
		function(e){
			holder.addClass("marked-delete");
			$(".control-handle").removeClass("shown")}
		,function(e){
			holder.removeClass("marked-delete");
	});
};

EditorHelper.deleteSection = function(holder, callbackFunc){
	var vbid = EditorHelper.getHolderId(holder);
	var parentId = EditorHelper.getHolderParent(holder).attr("id");
	//changed the order, first delete
	var handleToDelete = holder.next(".control-handle");
	handleToDelete.remove();
	holder.remove();
	SpimeEngine.ArrangeMaster();
	var stripeId = holder.closest(".master.item-box").attr("id");
	XPRSHelper.SAFEPOST("/remove_child",{"parent":parentId , "child": vbid,"stripe_id":stripeId},parentId,{"action_name":"REMOVE-CHILD","pretty_name":"Remove Section"},function(){
		if (typeof callbackFunc != "undefined"){
			callbackFunc();
		}
	});
	SpimeEngine.handleScrollEffects();
}


EditorHelper.initAddBtn = function(holder,btn,btnHolder){
	
	//We will add an empty stripe after the resize handle
	var releventHandler = holder.next();
	btn.addClass("animated");
	btnHolder.find("img").attr("opened", "no");
	$("#empty-stripe").removeClass("opened")
	btnHolder.unbind("click").bind("click",function(e){
		e.stopPropagation();
		if (!EditorHelper.allowLeftClickMenu($(this),e.target)){
			return;
		}
		
		if(typeof EditorHelper.ShortcodeStyles["PROMO"] == "undefined"){
			btnHolder.addClass("loading-state");
			EditorHelper.generateThumbsIfNeeded("PROMO");
			setTimeout(function(){
				btnHolder.click();
				setTimeout(function(){
					btnHolder.removeClass("loading-state");
				},1500);
			},1000);
			return;
		}
		
		var btnClicked = $(this).find("img");
		//toggle button to x or plus	
		btnClicked.toggleClass("rotated-45");
		
		//Hide previously open menues
		if (btnClicked.attr("opened") == "no" && btnClicked.hasClass("rotated-45")){
			btnClicked.closest(".control-handle").css("z-index","123456789");
			//keyboard control
			$("body").unbind("keydown").keydown(function(e) {
				  if(e.keyCode == 37) { // left
					  $(".prev-page-btn").first().click(); //mimicks the next stripe click
				  }
				  else if(e.keyCode == 39) { // right
					  $(".next-page-btn").first().click(); //mimicks the prev stripe click
					  
				  }
			});
			
			
			btnClicked.attr("opened", "yes");

			var offset = $(this).offset().top
			
			if ($(".main-page").css("transform") != "none"){
				offset = ($(this).offset().top - $(".main-page").offset().top) * 1.8;
			}
			
			var scrollToPos = offset - ($( window ).height() - 900)/2
			if ($("#xprs").is(".adding-stripes-mode")){
				scrollToPos /= 3;
			}
			
			if ($( window ).height() < 900){
				var menuOffset = SpimeEngine.calculateScrollOffset();
				scrollToPos = $(this).offset().top - menuOffset;
			}
			 $("html, body").animate({
	             scrollTop: scrollToPos
	         }, 1000);
			
			
			$("#empty-stripe").remove();
			//$("#empty-stripe").next().remove();
			
			$("#add-menu-wrapper.cloned").remove();
			$("#add-stripe.rotated-45").not(btnClicked).removeClass("rotated-45");
			if ($("#add-menu-wrapper #add-stripe-menu").attr("data-page") == "collection" || $("#add-menu-wrapper #add-stripe-menu").attr("data-page") == "page1"){
				$("#add-menu-wrapper #add-stripe-menu").attr("data-page","page1");
				$("#add-stripe-menu .item-type-btn-wrapper").not(".page1").hide();
				$("#add-stripe-menu .page1.item-type-btn-wrapper").css("display","inline-block");
			}
			
			
			var menuWrapper = $("#add-menu-wrapper").clone(true,true);
			
			menuWrapper.css({"display":"block"});//.addClass("animated-opacity");
			menuWrapper.addClass("cloned");
			var emptyStripe = $("<div />").addClass("master item-box animated-height").attr("id","empty-stripe");
			emptyStripe.addClass("opened")
			//catch the click
			emptyStripe.unbind("click").bind("click",function(e){
				e.stopPropagation();
			});
			emptyStripe.append(menuWrapper);
			
			releventHandler.after(emptyStripe);
			//emptyStripe.height(170);

			
			
			//menuWrapper.css("opacity",1);
			
			//PASTE
			var clipboardPaste = XPRSHelper.getXprsCookie("xprs-clipboard");
			if (typeof clipboardPaste != "undefined"){
				//var menuIndex = $("#empty-stripe").index();
				//var realIndex = Math.ceil(menuIndex / 2 ) - 1;
			
				
				var clipboardCookieData = JSON.parse(clipboardPaste);
				//var pasteBtn = menuWrapper.find(".item-type-btn-wrapper").first().clone();
				var pasteBtn = $("<li />").addClass("preset-tab clickable t-t").text("[PASTE]");
				
				
				
				var currentPageId = EditorHelper.getMasterId();
				var originalparentVbid = clipboardCookieData.parent_id;
				pasteBtn.unbind("click").bind("click",function(){
					//If the user is pasting the section into the same page we do not allow pasting as refrence
					if (currentPageId != originalparentVbid){
						var message = "If you choose to paste a reference, all the changes you will make in the original section will apply to the new section as well"
						XPRSHelper.xprsAlert(message,{title: "How would you like to paste the section?", showCancelButton: true,confirmButtonText:"Clone it",cancelButtonText:"Just a reference","callbackfunc":function(confirm){
						if (!confirm){
							EditorHelper.handleStripePaste(holder,clipboardCookieData,true);
						}else{
							EditorHelper.handleStripePaste(holder,clipboardCookieData,false);
						}
						}});
					}else{
						EditorHelper.handleStripePaste(holder,clipboardCookieData,false);
					}
				});
				menuWrapper.find(".preset-tab-holder").append(pasteBtn);
			}
			
			EditorHelper.adjustUI();
			var activeTab = $("#add-menu-wrapper.cloned").find("li.preset-tab.selected");
			XPRSTranslator.translateDom(emptyStripe)
			var isReady = EditorHelper.showPresetCollection(activeTab.attr("id"));
			
		}else{
			btnClicked.closest(".control-handle").css("z-index","");
			$("body").unbind("keydown");
			btnClicked.attr("opened", "no");
			$("#empty-stripe").removeClass("opened")
			EditorHelper.closeAddStripeMenu();
			var offset = $(this).offset();
			 $("html, body").animate({
	             scrollTop: offset.top - ($( window ).height())/2
	         }, 1000);
		}
		$(".floating-plus").removeClass("open").addClass("hidden");
	});
};


EditorHelper.handleStripePaste = function(holder,clipboardCookieData,asReference){
	var addedHolder = $("#empty-stripe");
	var holderId = "first";
	if (holder.length != 0 ){
		if (!(holder.hasClass("injected"))){
			holderId = holder.attr("id");
		}
	}
	var currentPageId = EditorHelper.getMasterId();
	var presetType = clipboardCookieData.preset_type;
	var clonedId = clipboardCookieData.clone_id;
	var originalparentVbid = clipboardCookieData.parent_id;
	var originalStripeId = clipboardCookieData.original_id;

	if (asReference){
		clonedId = originalStripeId;
	}
			
	var loaderGif = $("<div id='loading-icon' style='background-image:url(/images/x_loader.gif);display:table-cell;vertical-align:middle;width: 100%;background-repeat: no-repeat;background-position: center;' />");
	$(".rotated-45").removeClass("rotated-45");
	$(".add-stripe-img").attr("opened", "no");
	$("#add-stripe-menu").removeClass("shown");
	XPRSHelper.onCssTransitionFinish($("#add-stripe-menu"),function() {
		var loaderGifWrapper = $("<div style='display:table;height:100%;width:100%;' />");
		loaderGifWrapper.append(loaderGif);
		$("#add-menu-wrapper").prepend(loaderGifWrapper);
		$("#menu-pagination-wrapper").hide();
		
		XPRSHelper.POST("/duplicate_specific_stripe_data", {
			duplicate_to : currentPageId,
			orig_item_id : originalStripeId ,
			new_item_id : clonedId,
			original_parent:originalparentVbid
		}, function() {
			XPRSHelper.SAFEPOST("/add_child", {"vbid":clonedId,"parent_vbid":currentPageId, "preset_type": presetType,"child_context":"PAGE","stripe_id":"empty-stripe", "clone_after_id":holderId},currentPageId,"ADD-CHILD",function(result) {
				var cloneId = result.new_id;
				addedHolder.attr("id",cloneId).css("background-color","black");//.css("height","");
				addedHolder.attr("data-preset-type-id",presetType);
				addedHolder.removeClass("showing-collection")
				var params = {};
				params["vbid"] = cloneId;
				params["parent_vbid"] = currentPageId;
				var parentsList = EditorHelper.getParentsList(addedHolder);
				parentsList.push(cloneId);
				EditorHelper.reloadPart(params,function(){
						if (typeof callbackFunc != "undefined"){
							callbackFunc();
						}
				});
			});
		});
	});
	XPRSHelper.removeXprsCookie("xprs-clipboard");
};



EditorHelper.closeAddStripeMenu = function(){
	var currentPage = $("#add-menu-wrapper.cloned #add-stripe-menu").attr("data-page");
	$("#add-menu-wrapper #add-stripe-menu").attr("data-page",currentPage);
	$("#add-stripe.rotated-45").removeClass("rotated-45").attr("opened","no");
	$("#empty-stripe").height(0);
	$("#empty-stripe").removeClass("opened");
	$("#add-menu-wrapper.cloned").removeClass("shown");
	setTimeout(function(){
		SpimeEngine.handleScrollEffects();
	},500);
	$("#history-queue").hide();
	$(".floating-plus").removeClass("hidden");
	//XPRSHelper.onCssTransitionFinish($("#add-menu-wrapper.cloned"),function(){
	//	$("#empty-stripe").remove();
	//});
};

EditorHelper.initSnapShotBtn = function(controlsHolder,btn){
	btn.unbind("click").bind("click",function(event){
		event.stopPropagation();
		controlsHolder.addClass("flash");
		XPRSHelper.GET("/snap_stripe", {"page_id":EditorHelper.getPageId(),"stripe_id":controlsHolder.attr("id"),"stripe_height":parseInt(controlsHolder.outerHeight(true))}, function(){
			console.log("snap")
		});
	});
};




EditorHelper.addStripeHeader = function(btn,stripe,relevantItem){
	var itemParent = EditorHelper.getHolderParent(relevantItem);
	XPRSHelper.SAFEPOST("/create_stripe_header", {vbid:stripe.attr("id"),item_type:"STRIPE_HEADER"},stripe.attr("id"),"ADD_STRIPE_HEADER", function(res){
		if (res.new_vbid){
			var stripeHeaderWrapper = $("<div />").addClass("stripe-header-wrapper")
			var clonedItem = relevantItem.clone();
			stripeHeaderWrapper.append(clonedItem)
			clonedItem.attr("id",res.new_vbid).addClass("stripe-header");
			clonedItem.attr("class","stripe-header sub item-box page-box " + stripe.attr("data-preview-styleid"))
			clonedItem.removeAttr('style');
			btn.addClass("loading-state");
			setTimeout(function(){
				clonedItem.load("/get_part",{"vbid":res.new_vbid,"root_id":EditorHelper.getRootId(),"no_blocking_div":true,"item_layout":"blocks"},function(data, status, xhr){
					clonedItem.find(".layout-settings").attr("data-type","blocks");
					stripe.find("#children").first().prepend(stripeHeaderWrapper);	
					EditorHelper.initStripeAfterReload(clonedItem);
					EditorHelper.initBackgroundColorSelector(clonedItem);
					btn.removeClass("loading-state");
					btn.text("Remove Header").attr("data-action","remove");
				});
			},1000);
		}
	});
};

EditorHelper.addStripeFooter = function(btn,stripe,relevantItem){
	var itemParent = EditorHelper.getHolderParent(relevantItem);
	XPRSHelper.SAFEPOST("/create_stripe_header", {vbid:stripe.attr("id"),item_type:"STRIPE_FOOTER"},stripe.attr("id"),"ADD_STRIPE_FOOTER", function(res){
		if (res.new_vbid){
			var stripeFooterWrapper = $("<div />").addClass("stripe-footer-wrapper")
			var clonedItem = relevantItem.clone();
			stripeFooterWrapper.append(clonedItem)
			clonedItem.attr("id",res.new_vbid).addClass("stripe-footer");
			clonedItem.attr("class","stripe-footer sub item-box page-box " + stripe.attr("data-preview-styleid"))
			clonedItem.removeAttr('style');
			//clonedItem.find(".item-content").css("background-color","");
			btn.addClass("loading-state");
			setTimeout(function(){
				clonedItem.load("/get_part",{"vbid":res.new_vbid,"root_id":EditorHelper.getRootId(),"no_blocking_div":true,"item_layout":"blocks"},function(data, status, xhr){
					//itemParent.attr("data-forced-arrange",true);
					clonedItem.find(".layout-settings").attr("data-type","blocks");
					stripe.find("#children").first().append(stripeFooterWrapper);	
					EditorHelper.initStripeAfterReload(clonedItem);
					EditorHelper.initBackgroundColorSelector(clonedItem);
					//clonedItem.find(".item-content").css("background-color",relevantItem.find(".item-content").css("background-color"));
					//EditorHelper.updateParent({"deliver_to":"editor","action":"invalidate","vbid":stripe.attr("id")});
					btn.removeClass("loading-state");
					btn.text("Remove Footer").attr("data-action","remove");
				});
			},500);
		}
	});
};




EditorHelper.cloneItemFromManage = function(relevantItem, insertFirst){
	var itemParent = EditorHelper.getHolderParent(relevantItem);
	var clonedItem = relevantItem.clone();
	var loadingCover = $("<div>").addClass("item-loading-cover");
	clonedItem.append(loadingCover);
	clonedItem.attr("id","temp");
	if(insertFirst){
		clonedItem.insertBefore(relevantItem);
	} else {
		clonedItem.insertAfter(relevantItem);
	}
	var originalBackground = relevantItem.attr("data-old-item-bg");
	clonedItem.find(".item-content").css("background-color",relevantItem.css("background-color"));
	var itemParentType = itemParent.attr("data-preset-type-id");
	var alreadyArranged = false;
	if (typeof itemParentType != "undefined"){
		 if (XPRSHelper.inPresetGroup(itemParentType,"FEATURES") || XPRSHelper.inPresetGroup(itemParentType,"GALLERIES")){
			 var arrangerSettings = itemParent.find(".arranger-settings");
			 if (parseInt(arrangerSettings.attr("data-arranger_cols")) + 1  == itemParent.find(".sub.item-box").not(".stripe-header").length ) {
				 var newCols = itemParent.find(".sub.item-box").not(".stripe-header").length ;
				 arrangerSettings.attr("data-arranger_cols", newCols)
				 itemParent.attr("data-forced-arrange",true);
				 SpimeEngine.ArrangeHolder(itemParent,{},function(){
						var newItemsMinWidth = itemParent.attr("data-items-min-width");
						if (typeof newItemsMinWidth != "undefined"){
							var holderStyleId = itemParent.attr("data-styleid");
							
							EditorHelper.updateMultipleStyleKeys({"styleid":holderStyleId,"props":"ARRANGER_ITEM_MIN_WIDTH|ARRANGER_COLS","values":newItemsMinWidth+"-FLOAT|"  + newCols + "-INT","modules":"GALLERY_PREVIEW|GALLERY_PREVIEW","stripe_id":itemParent.attr("id")},function(){
							});
														
						}
					});
				 alreadyArranged = true;
			 }
		 }
	}
	if (!alreadyArranged){
		SpimeEngine.InitHolder(itemParent);
	}
	
	if (typeof itemParentType != "undefined"){
		 if (XPRSHelper.inPresetGroup(itemParentType,"SLIDESHOWS")){
			 var currentSlideNum = clonedItem.attr("data-page-num");
			 relevantItem.closest(".sub.container").attr("start-with-slide",currentSlideNum);
			 SpimeEngine.showItem(itemParent,"temp");
		 }
	}
	
	
	
	var safeCloneParams = {
			vbid : relevantItem.attr("id"),
			original_parent_id : itemParent.attr("id"),
			clone_after_id:(insertFirst ? "first" : relevantItem.attr("id")),
			clone_into:itemParent.attr("id"),
			//stripe_data_in_page : true,
			page_id : EditorHelper.getPageId(),
			keep_style : true,
			keep_preview_style:true,
			update_unique_style:true,
			from_template:true
		}
	
	XPRSHelper.POST("/safe_clone", safeCloneParams, function(result) {
		var cloneId = result.clone_id;
		clonedItem.attr("id",cloneId);
		//invalidate css
		var stripeStyleId = clonedItem.attr("data-styleid");
		var prevStyleLink = $("#" + stripeStyleId);
		$('head').append( $('<link rel="stylesheet" type="text/css" />').attr('href', '/stripe_dynamic_css?style_id='+stripeStyleId+'&viewer=xprs&parent_style=' + stripeStyleId) );
		setTimeout(function(){
			prevStyleLink.remove();
			var getPartParams = {"vbid":cloneId,"root_id":EditorHelper.getRootId(),"no_blocking_div":true,"inline-style":true}
			if (itemParent && itemParent.find(".sub.container.matrix").length > 0){
				if (clonedItem.find(".multi_layout").length > 0){
					getPartParams["order_holder_id"] = itemParent.attr("id");
				}
			}
			clonedItem.load("/get_part",getPartParams,function(data, status, xhr){
			//itemParent.attr("data-forced-arrange",true);
			EditorHelper.initStripeAfterReload(clonedItem);
			EditorHelper.initBackgroundColorSelector(clonedItem);
			clonedItem.attr("data-old-item-bg",originalBackground);
			clonedItem.one("click", function() {
			});
		});
		},500);
	});
	
	XPRSHelper.POST("/invalidate_stripe_cache", {stripe_id:itemParent.attr("id"),"type":"json"}, function(){
	});	
};

EditorHelper.hideStripesSeperators = function(){
	$(".control-handle").hide();
};

EditorHelper.showStripesSeperators = function(){
	$(".control-handle").show();
};


EditorHelper.blockAllButHolder = function(holder,callbackFunc){
	var otherHolders = holder.prevAll(".master.item-box").add(holder.nextAll(".master.item-box"));
	otherHolders.append($("<div class='manage-blocker' />").unbind("click").bind("click",function(){
		if (typeof callbackFunc == "undefined"){
		}else{
			callbackFunc();
		}
	}));
	otherHolders.addClass("is-blocked");
};



EditorHelper.removeAllBlocks = function(){
	$(".manage-blocker").remove();
	$(".is-blocked").removeClass("is-blocked");
};



EditorHelper.addResizeHandlers = function(holder){
		var resizeHandle = $("<div />").addClass("control-handle");
		var visibleStretch = $("<div class='visible-stretch fast-animated-bg' />");
		resizeHandle.prepend(visibleStretch);
		var originalY = 0;
		var resizedHolderOrigHeight = 0;
		var resizedHolder ="";
		var maxWidthFromHolder = parseInt(holder.find(".item-wrapper").css("max-width"));
		if (typeof maxWidthFromHolder != "undefined"){
			resizeHandle.width(maxWidthFromHolder);
		}
		var MIN_STRIPE_HEIGHT = 50;
		var holderType = SpimeEngine.getHolderType(holder);
		var holderPreset = holder.attr("data-preset-type-id");
		var inShortcodes = $("#xprs").hasClass("in-shortcodes");
		if ((holderType != "element" && !XPRSHelper.inPresetGroup(holderPreset,"GALLERIES") && holder.find(".sub.container.matrix").length == 0) || holder.attr("data-child-type") == "PIC" || holder.attr("data-child-type") == "VIDEO" || holder.attr("data-child-type") == "HTML" || holder.attr("data-child-type") == "MAP" || holder.attr("data-child-type") == "RAW"){
			var lastPos = 0;
			visibleStretch.draggable({ 
				axis: "y",
				scroll: false,
				start: function(event, ui){
					EditorHelper.removeUnusedUi();
					$(".draggable-div-holder .ui-draggable").resizable("destroy").draggable("destroy");
					$(".resizing-dragging").removeClass("resizing-dragging");
					EditorHelper.closeDraggableTabbedPanel();
					$("#children .control-handle:last-child").css("margin-bottom","1000px");
					$(this).parent().addClass("dragged");
					resizedHolder = $(ui.helper).closest(".control-handle").prev();
	
					if (resizedHolder.is(".fill-height")){
						resizedHolder.removeClass("fill-height");
						resizedHolder.attr("data-was-fill-height",true);
					}
	
					holder.attr("data-height-resize","true");
					EditorHelper.markSpacing(holder);
					EditorHelper.deactivateStripeHoverControls();
	
					originalY = ui.offset.top;
					resizedHolderOrigHeight = $(ui.helper).closest(".control-handle").prev().height();

					
					resizedHolder.css({"min-height":"initial","overflow":"hidden"});
					//Change min stripe hight for none picture element
					
					var relevantDiv = resizedHolder.find(".item-wrapper").first()
		             if (XPRSHelper.inPresetGroup(holderPreset,"SLIDESHOWS") || XPRSHelper.inPresetGroup(holderPreset,"ITEMS") || (XPRSHelper.inPresetGroup(holderPreset,"FEATURES") && resizedHolder.find(".multi_layout").length > 0 )){
		            	 relevantDiv = resizedHolder.find("#items-holder").find(".item-preview , .preview-image-holder:not(.draggable-pic-holder) , .vertical-aligner, .inner-pic:not(.circlize)")//.not(".inner-pic-holder")//.first();
					 }
					 if (XPRSHelper.inPresetGroup(holderPreset,"SLIDESHOWS")){
		            	 relevantDiv = relevantDiv.add(resizedHolder.find("#items-holder, #items-holder-wrapper"))
		             }
					 if (holder.attr("data-child-type") == "PIC"){
						 relevantDiv = resizedHolder.find(".image-source");
					 }
					 if (holderPreset == "MENUS"){
						 relevantDiv = resizedHolder.find(".preview-content-wrapper");
					 }
					 if (resizedHolder.find(".item_layout").length > 0){
						relevantDiv = $();
					 }
					relevantDiv.find(".sub.container").css("min-height","0px")
					relevantDiv.css("min-height","0px");
					resizedHolder.find(".circlize").css("height","");
				},
				drag: function( event, ui ) {
					 var offsetTop = ui.offset.top;
		             var direction = (offsetTop > originalY) ? 'down' : 'up';
		             var delta = Math.abs(offsetTop - originalY);
					 if (delta - Math.abs(lastPos) > 50){
						delta = Math.abs(lastPos) + 1;
					 }
					 lastPos = delta;
		             var relevantDiv = resizedHolder.find(".item-wrapper").first();
		             var footerSize = 0;
		             if (XPRSHelper.inPresetGroup(holderPreset,"SLIDESHOWS")|| XPRSHelper.inPresetGroup(holderPreset,"ITEMS") || (XPRSHelper.inPresetGroup(holderPreset,"FEATURES") && resizedHolder.find(".multi_layout").length > 0 )){
							relevantDiv = resizedHolder.find("#items-holder").find(".item-preview ,.preview-image-holder:not(.draggable-pic-holder),  .vertical-aligner, .inner-pic:not(.circlize)")//.not(".inner-pic-holder")
					 }
		             if (XPRSHelper.inPresetGroup(holderPreset,"SLIDESHOWS")){
		            	 relevantDiv = relevantDiv.add(resizedHolder.find("#items-holder, #items-holder-wrapper"))
		            	 footerSize = resizedHolder.find(".stripe-header-wrapper").height() + resizedHolder.find(".stripe-footer-wrapper").height();
		             }
		             if (holderPreset == "MENUS"){
		            	 relevantDiv = resizedHolder.find(".preview-content-wrapper");
		            	 relevantDiv.css("min-height","0px");
					 }
		             var relevantMarginDiv = resizedHolder.find(".item-wrapper").first();
		             var extraPadding = 0;
		             if (resizedHolder.attr("data-child-type")=="PIC"){
		            	 extraPadding = parseInt(resizedHolder.find(".page-image-cover").css("padding-top")) + parseInt(resizedHolder.find(".page-image-cover").css("padding-bottom"));
		            	 relevantDiv = resizedHolder.find(".image-source");
		             }
					 resizedHolder.next().addClass("shown");
					 resizedHolder.prev().addClass("shown");
					 var minStripeHeightFromArranger = resizedHolder.attr("data-min-stripe-height");
					 if (typeof minStripeHeightFromArranger != "undefined"){
						 minStripeHeightFromArranger = parseInt(minStripeHeightFromArranger);
					 }else{
						 minStripeHeightFromArranger = MIN_STRIPE_HEIGHT; 
					 }
					 if (resizedHolder.find(".item_layout").length > 0){
						relevantDiv = $();
					 }
		             if (direction == "up"){
		            	 if (resizedHolderOrigHeight - delta > minStripeHeightFromArranger){ //need to calculate the content height
		            		 resizedHolder.height(resizedHolderOrigHeight - delta);
		            		 relevantDiv.height(resizedHolderOrigHeight - delta - parseInt(relevantMarginDiv.css("margin-top")) - extraPadding - footerSize);
		            	 }else{
		            	 }
		             }else{
		            	 resizedHolder.height(resizedHolderOrigHeight + delta);
		            	 relevantDiv.height(resizedHolderOrigHeight + delta - parseInt(relevantMarginDiv.css("margin-top")) - extraPadding - footerSize);
		             }

		             if (holderPreset == "MENUS" && !resizedHolder.hasClass("center-aligned-menu")){
		            	var innerMargin = 0;
						var previewContent = resizedHolder.find(".preview-content-holder");
						innerMargin = parseInt(previewContent.css("margin-top")) + parseInt(previewContent.css("margin-bottom"));
						if (isNaN(innerMargin)){
							innerMargin = 0;
						}
						 relevantDiv.css("height",relevantDiv.height() - innerMargin);
		            	 relevantDiv.css("min-height",relevantDiv.height() );
					 }

		             resizedHolder.find(".circlize").css("height","");
		             SpimeEngine.ArrangeHolder(resizedHolder);
		             holder.attr("data-orig-stripe-height",resizedHolderOrigHeight + delta);
		             ui.position.top = 0;
		             var elementType = holder.attr("data-child-type");
		             if (elementType == "PIC"){
		     			SpimeEngine.fixZoomedImages(holder);
		     		 }
		             
		             if (elementType == "VIDEO"){
		            	 SpimeEngine.fitVideo(holder.find(".vid-cover"));
		             }
		             if (elementType == "MAP"){
		     			SpimeEngine.sendMapCommand(holder,"center",{});
		     	    }

				},
				stop: function(event, ui){
					 var footerSize = 0;
					
					$("#children .control-handle:last-child").css("margin-bottom","");
					$(this).parent().removeClass("dragged");
					EditorHelper.unmarkSpacing(holder);
					var parentVbid = EditorHelper.getHolderId(EditorHelper.getParent(resizedHolder));
						var prevId = resizedHolder.attr("id");//.substring(("vbid-").length);
						var innerMargin = 0;
						if (holderPreset == "MENUS" && !resizedHolder.hasClass("center-aligned-menu")){
							var previewContent = resizedHolder.find(".preview-content-holder");
							innerMargin = parseInt(previewContent.css("margin-top")) + parseInt(previewContent.css("margin-bottom"));
							if (isNaN(innerMargin)){
								innerMargin = 0;
							}
						}
						var resizedHolderHeight = resizedHolder.height() - innerMargin;
						
						
						resizedHolder.css({"min-height":resizedHolderHeight,"height":"auto","overflow":""});
						var relevantDiv = resizedHolder.find(".item-wrapper").first();
						if (XPRSHelper.inPresetGroup(holderPreset,"SLIDESHOWS") || XPRSHelper.inPresetGroup(holderPreset,"ITEMS") || (XPRSHelper.inPresetGroup(holderPreset,"FEATURES") && resizedHolder.find(".multi_layout").length > 0 )){
							relevantDiv = resizedHolder.find("#items-holder").find(".item-preview ,.preview-image-holder:not(.draggable-pic-holder),  .vertical-aligner , .inner-pic:not(.circlize)")//.not(".inner-pic-holder")
						}
						if (XPRSHelper.inPresetGroup(holderPreset,"SLIDESHOWS")){
			            	 relevantDiv = relevantDiv.add(resizedHolder.find("#items-holder, #items-holder-wrapper"))
			            	 footerSize = resizedHolder.find(".stripe-header-wrapper").height() + resizedHolder.find(".stripe-footer-wrapper").height();
			            }
						if (holder.attr("data-child-type") == "PIC"){
							relevantDiv = resizedHolder.find(".image-source")
						}
						if (holderPreset == "MENUS"){
							 relevantDiv = resizedHolder.find(".preview-content-wrapper");
						 }
						
						 if (resizedHolder.find(".item_layout").length > 0){
							relevantDiv = $();
						 }
					    
					    relevantDivHeight = parseInt(relevantDiv.height());
						relevantDiv.css("min-height",resizedHolderHeight - footerSize);
						relevantDiv.not(".bottom-center .inner-pic,.top-center .inner-pic , .inner-pic:not(.circlize)").css("height","100%");
						relevantDiv.find(".sub.container").css("min-height",resizedHolderHeight);
						EditorHelper.reactivateStripeHoverControls();
						
						var newRatio = resizedHolder.attr("data-item-ratio");
						if (typeof newRatio != "undefined"){
							var holderStyleId = resizedHolder.attr("data-styleid");
							EditorHelper.updateStyleData({"vbid":prevId,"parent_vbid":parentVbid,"updated_key":"ARRANGER_ITEM_RATIO","updated_value":newRatio +"-FLOAT","module_name":"GALLERY_PREVIEW","style_id":holderStyleId,"stripe_id":resizedHolder.attr("id")});
						}
						EditorHelper.updateStripeData({"vbid":prevId,"parent_vbid":parentVbid,"updated_key":"HEIGHT","updated_value":resizedHolderHeight,"module_name":"STRIPE"});
						holder.removeAttr("data-height-resize");
						holder.attr("data-orig-stripe-height",resizedHolderHeight);
						if (resizedHolder.attr("data-was-fill-height")){
							resizedHolder.removeAttr("data-was-fill-height");
							XPRSHelper.SAFEPOST("/update_css_class", {"vbid":prevId,"updated_key":"STRIPE_HEIGHT","delete_key":"True","stripe_id":prevId}, prevId, "CSS_CLASS");
						}

						holder.find(".sub.container, .item-content").css("max-height","inherit")
						setTimeout(function(){
							holder.find(".sub.container, .item-content").css("max-height","");
							if (resizedHolder.is(".header-box")){
								EditorHelper.calcFillHeight();
							 }
						},10);
						var draggablesHolder = holder.find(".draggable-div-holder");
						draggablesHolder.find(".magic-circle-holder").each(function(){
							var currentDraggablePic = $(this);
							EditorHelper.fitDragBoxToImage(currentDraggablePic);
						});
				}
			});
		}else{
			resizeHandle.draggable({disabled:true}).css("cursor","default").addClass("for-element");
		}
		holder.after(resizeHandle);
};


EditorHelper.deactivateStripeHoverControls = function(){
	$(".stripe-controls").not(".control-handle").removeClass("shown");
	$(".stripe-controls").not(".control-handle").addClass("deactivated");
	$("#new-page-btn").addClass("deactivated");
};

EditorHelper.reactivateStripeHoverControls = function(){
	$(".stripe-controls").not(".control-handle").removeClass("deactivated");
	$("#new-page-btn").removeClass("deactivated");
};




EditorHelper.handleDelete = function(params){
	var itemToRemove = $("#" + params.vbid);
	var itemType = EditorHelper.getTypeOf(itemToRemove);
	var itemParent = EditorHelper.getParent(itemToRemove);
	var parentType = EditorHelper.getTypeOf(itemParent);

	var currentSubmenu = $();
	var lastSubmenuItem = false;
	//last submenu Link
	if (itemToRemove.is(".submenu-link")){
		currentSubmenu = itemToRemove.closest(".submenu");
		if (currentSubmenu.children().length == 1){
			lastSubmenuItem = true;
		}
	}

	if (itemToRemove.is(".preview-video-source") || itemToRemove.is(".preview-video-source") ){
		EditorHelper.closeDraggableTabbedPanel();
	}
	//remove handlers for stripes..
	if (itemType == "stripe"){
		itemToRemove.next().remove();
		itemToRemove.remove();
	}
	if (itemType == "element-preview"){
		if (itemToRemove.hasClass("image-source")){
			itemToRemove.css("background-image","");
			itemToRemove.children().css("background-image","");
			itemToRemove.attr("id","no-image");
			itemToRemove.attr("data-title","click to add");
			return;
		}
		
		if (itemToRemove.hasClass("inner-pic")){
			itemToRemove.removeAttr("src");
			itemToRemove.css("background-image","");
			itemToRemove.attr("id","no-image");
			itemToRemove.find(".delete-marker").remove();
			itemToRemove.removeAttr("title");
			return;
		}
	}
	
	itemToRemove.fadeOut(300, function() {
		var removableParents = itemToRemove.parents(".removable-parent");
		itemToRemove.closest(".order-handle").prev(".upper-line-break").remove();
		itemToRemove.closest(".order-handle").next(".lower-line-break").remove();
		if (itemType == "element-preview"){
			var elementType = itemToRemove.attr("data-menu-name").replace("PREVIEW_","").replace("BLOCKS_","");
			var elementPlaceholder = $("<div class='element-placeholder' data-elementtype='"+elementType+"' style='display:none;'></div>");
			if (removableParents.length == 0){
				itemToRemove.replaceWith(elementPlaceholder);
			}else{
				//sometimes we have DOM structures that need removal
				var brSiblings = removableParents.last().next("br");
				brSiblings.remove();
				removableParents.last().replaceWith(elementPlaceholder);
			}
			//remove redundant placeholders and put placeholder at the end
			if (elementType == "LINK"){
				elementPlaceholder.siblings(".element-placeholder[data-elementtype='"+elementType+"']").remove();
				elementPlaceholder.hide();
				if (elementPlaceholder.siblings("#sr-basket-widget").length == 0){
					elementPlaceholder.parent().append(elementPlaceholder);
				}else{
					elementPlaceholder.siblings("#sr-basket-widget").before(elementPlaceholder);
				}
			}
			if (itemParent.find(".preview-content-holder").width() == 30){
				itemParent.find(".preview-content-holder").addClass("empty-holder");
			}
			
		}else{
			itemToRemove.remove(); 
		}

		//last submenu Link
		if (lastSubmenuItem){
			currentSubmenu.prev(".submenu-title").closest("li").addClass("removable-parent");
			currentSubmenu.prev(".submenu-title").removeClass("submenu-title");
			currentSubmenu.remove();
		}
		if (parentType == "stripe"){
			var itemParentType = itemParent.attr("data-preset-type-id");
			var alreadyArranged = false;
			if (typeof itemParentType != "undefined"){
				 if (XPRSHelper.inPresetGroup(itemParentType,"FEATURES")){
					 itemParent.attr("data-forced-arrange",true);
					 SpimeEngine.ArrangeHolder(itemParent,{},function(){
							var newItemsMinWidth = itemParent.attr("data-items-min-width");
							if (typeof newItemsMinWidth != "undefined"){
								var holderStyleId = itemParent.attr("data-styleid");
								EditorHelper.updateStyleData({"vbid":itemParent.attr("id"),"updated_key":"ARRANGER_ITEM_MIN_WIDTH","updated_value":newItemsMinWidth,"module_name":"GALLERY_PREVIEW","style_id":holderStyleId,"stripe_id":itemParent.attr("id")});
							}
						});
					 alreadyArranged = true;
				 }
			}
			if (!alreadyArranged){
				SpimeEngine.InitHolder(itemParent);
			}
		}
		if (parentType == "item-preview"){
			var itemGrandParent = EditorHelper.getParent(itemParent);
			SpimeEngine.ArrangeHolder(itemGrandParent);
		}
	});

};


EditorHelper.reloadPart = function(params,callbackFunc){
	var waitingTime = 10;
	if (typeof params["waiting_time"] != "undefined"){
		waitingTime = parseInt(params["waiting_time"]);
	}
	params["inline-style"] = true;
	var itemToReload = "";
	if (params.vbid){
		itemToReload = $("#" + params.vbid);
	}else{
		itemToReload = $("." + params.style_id).closest(".master.item-box");
		params.vbid = itemToReload.attr("id");
	}
	
	if (itemToReload.length == 0){
		if (typeof callbackFunc != "undefined"){
			callbackFunc();
		}
	}
	
	if (!params["parent_vbid"] && itemToReload.hasClass("item-box")){
		var itemParent =  EditorHelper.getHolderParent(itemToReload);
		if(itemParent.hasClass("master container")){
			params["parent_vbid"] = itemParent.attr("id");
		}else{
			var itemParentType = itemParent.attr("data-preset-type-id");
			if (itemParentType && XPRSHelper.inPresetGroup(itemParentType,"FEATURES")){
				params["forced_arrange"] = true;
			}
		}
	}
	
	setTimeout(function(){
		if (itemToReload.attr("data-child-type") == "SLIDE"){
			var currentSlideNum = itemToReload.attr("data-page-num");
			itemToReload.closest(".sub.container").attr("start-with-slide",currentSlideNum);
		}
		itemToReload.addClass("animated-height");
		if (itemToReload.hasClass("sub")){
			params["no_blocking_div"] = true;
		}
		params["root_id"] = EditorHelper.getRootId();
		itemToReload.load("/get_part",params,function(data, status, xhr){
			if ( status == "error" ) {
			    var msg = "Sorry but there was an error please reload: ";
			    XPRSHelper.xprsAlert( msg + " " + status  ,{"report_error":true,"ajax_url":"/get_part"});
			}
			var loadedItem = $("#" + params.vbid);
			var currentClassArr = loadedItem.attr("class").split(" ");
			var newClass = "";
			for (var i = 0 ; i < currentClassArr.length ; i++){
				if (currentClassArr[i].indexOf("style-") == -1){
					newClass += currentClassArr[i] + " ";
				}
			}
			loadedItem.attr("class",newClass);
			//invalidate old css
			loadedItem.find("link").each(function(){
				if (!(typeof $(this).attr("data-styleid") == "undefined")){
					if (!(loadedItem.hasClass($(this).attr("data-preview-styleid")))){
						loadedItem.addClass($(this).attr("data-styleid"));
						loadedItem.attr("data-preview-styleid",$(this).attr("data-styleid"));
						loadedItem.attr("data-styleid",$(this).attr("data-styleid"));
					}
					var linkToRemove = $("#" + $(this).attr("data-styleid"));
					linkToRemove.remove();
				}
			});
			var styleSheet = loadedItem.find("link");
			var numOfStyleSheets = styleSheet.length;
			var loadedStyleSheets = 0;
			styleSheet.load(function(){
				loadedStyleSheets++;
				if (loadedStyleSheets == numOfStyleSheets){
					var loadedItemContainer = loadedItem.find(".container");
					if (loadedItemContainer.length > 0){
						
						var styleFromContainer = loadedItemContainer.attr("data-itemstyleid");
						var styleFromStripe = loadedItem.attr("data-styleid");
						if (styleFromContainer != styleFromStripe){
							loadedItem.attr("data-styleid",styleFromContainer);
						}
						
						loadedItem.attr("data-holder-type","gallery");
						loadedItem.addClass("gallery-box");
					}else if(loadedItem.find(".item-content").length > 0){
						loadedItem.attr("data-holder-type","page");
					}else{
						loadedItem.attr("data-holder-type","element");
					}
					if (params.forced_arrange){
						loadedItem.attr("data-forced-arrange",true);
					}
					if (typeof params.start_with_slide != "undefined"){
						loadedItem.find(".sub.container").attr("start-with-slide",params.start_with_slide);
					}
					EditorHelper.initStripeAfterReload(loadedItem,callbackFunc);
				}
			});
			$("head link").last().after(styleSheet);	
		});
	},waitingTime);
	
};


EditorHelper.LoadSettingsJson = function(callbackFunc){
	XPRSHelper.GET("/get_shortcodes_json",{"root_id":EditorHelper.getRootId(),"include_alternate":true},function(shortcodesJson){
		EditorHelper.shortcodesJson = shortcodesJson;
		if ("CONFIG" in EditorHelper.shortcodesJson){
			EditorHelper.ShortcodeConfig = EditorHelper.shortcodesJson["CONFIG"];
		}
		XPRSHelper.GET("/settings/elements_default_values.json",{},function(elementsDefaults){
			EditorHelper.defaultElementValues = elementsDefaults;
			if (typeof callbackFunc != "undefined"){
				callbackFunc();
			}
		},"json");
	},"json");
};

EditorHelper.getPagesJson = function(callbackFunc){
	XPRSHelper.GET("/get_pages",{"root_id":EditorHelper.getRootId()},function(pages){
		EditorHelper.pagesDetails = pages;
		if (typeof callbackFunc != "undefined"){
			callbackFunc();
		}
	},"json");
};


EditorHelper.getSiteConfig = function(){
	XPRSHelper.GET("/get_specific_key",{"vbid":EditorHelper.getRootId(),"section":"CONFIG"},function(resp){
		EditorHelper.SiteConfig = resp.result;
	},"json");
};


EditorHelper.getParent =  function(item){
	if (item.hasClass("master")){
		return $(".master.container");
	}else{
		return item.parent().closest(".item-box");
	}
};

EditorHelper.initStripeAfterReload = function(loadedItem,callbackFunc){
	if (loadedItem.is(".error-stripe")){
		loadedItem.bind("mousemove",function(e){
			if(!($(e.relatedTarget).hasClass("menu-options"))  &&  !($(e.relatedTarget).hasClass("max-width-handle"))){
				var hoveredHolder = $(this);
				EditorHelper.holderMouseEnter(hoveredHolder,false,e);
			}
		});
		loadedItem.bind("mouseleave",function(e){
			if(!($(e.relatedTarget).hasClass("menu-options")) &&  !($(e.relatedTarget).hasClass("max-width-handle"))){
				var hoveredHolder = $(this);
				EditorHelper.holderMouseOut(hoveredHolder);	
			}
		});
		//prevent page color click on error stripe
		loadedItem.unbind("click").bind("click",function(e){e.stopPropagation();});
		return;
	}
	
	if (loadedItem.find(".item-wrapper").attr("data-effect-classes")){
		loadedItem.addClass(loadedItem.find(".item-wrapper").attr("data-effect-classes"));
	}
	loadedItem.css("background-color","");
	
	SpimeEngine.ArrangeMaster();
	setTimeout(function(){
		if (loadedItem.hasClass("sub")){
			var parentStripe = EditorHelper.getHolderParent(loadedItem);
			SpimeEngine.InitHolder(parentStripe);
		}else{
			SpimeEngine.InitHolder(loadedItem);
		}
		if (loadedItem.hasClass("master")){
			if(!(loadedItem.next().hasClass('control-handle'))){
				EditorHelper.addResizeHandlers(loadedItem);
			}
			EditorHelper.initStripeLeftClick(loadedItem);
		}
		
		EditorHelper.addHoverControls(loadedItem);
		EditorHelper.overrideLinks(loadedItem);
		if (loadedItem.find(".map-frame").length > 0){
			SpimeEngine.initMap(loadedItem.find(".map-frame"));
		}
		//Update resize handler width
		var maxWidthFromHolder = parseInt(loadedItem.find(".item-wrapper").css("max-width"));
		if (typeof maxWidthFromHolder != "undefined" && loadedItem.is(".master")){
			loadedItem.next().width(maxWidthFromHolder);
		}
		loadedItem.find(".load-high-res").each(function(){
			var currentImg = $(this);
			SpimeEngine.loadHighResImage(currentImg);
		});
		
	
		var itemBlockingDiv = loadedItem.find("#blocking-div");
		itemBlockingDiv.fadeOut(500, function() { 
			$(this).remove(); 
			loadedItem.removeClass("animated-height");
			SpimeEngine.handleScrollEffects();
		});
		
		if (typeof callbackFunc != "undefined"){
			callbackFunc();
		}
	},10);
};



EditorHelper.getCssSelector = function(styleid,moduleName){
	var topClass =     (typeof EditorHelper.StyleSettings["MODULES"][moduleName].TOP_CSS_CLASS != "undefined") ? EditorHelper.StyleSettings["MODULES"][moduleName].TOP_CSS_CLASS : "";
	var cssClass =     (typeof EditorHelper.StyleSettings["MODULES"][moduleName].CSS_CLASS != "undefined")? EditorHelper.StyleSettings["MODULES"][moduleName].CSS_CLASS : "";
	var parentCssClass =  (typeof EditorHelper.StyleSettings["MODULES"][moduleName].PARENT_CSS_CLASS != "undefined")? EditorHelper.StyleSettings["MODULES"][moduleName].PARENT_CSS_CLASS : "";
	var cssSelector = "." + styleid + topClass;
	if (parentCssClass != ""){
		cssSelector = parentCssClass + cssSelector;
	}
	
	if (cssClass instanceof Array){
		var finalSelector = "";
		for(c in cssClass){
			finalSelector = finalSelector + cssSelector + " " + cssClass[c] + ",";
		}
		cssSelector = finalSelector.substring(0, finalSelector.length - 1);
	}else{
		if (parentCssClass == ""){
			cssSelector = cssSelector + " " + cssClass;
		}
	}
	return cssSelector;
}

EditorHelper.handleStyleChange = function(params){
	var module = params.module;
	var correctUnits = (typeof params.units != "undefined")     ? params.units : "";
	var topClass =     (typeof params.top_class != "undefined") ? params.top_class : "";
	var cssClass =     (typeof params.class_name != "undefined")? params.class_name : "";
	var parentCssClass = EditorHelper.StyleSettings["MODULES"][params.module].PARENT_CSS_CLASS;
	parentCssClass =  (typeof parentCssClass != "undefined")? parentCssClass : "";
	var deviceClass = (typeof params.device_class != "undefined")? params.device_class : "";
	
	var cssSelector = "." + params.target + topClass;
	if(module.indexOf("WEBSITE") != -1){
		params.target = $("body").attr("data-root-style-id");
		cssSelector = parentCssClass + " " + EditorHelper.StyleSettings["MODULES"][params.module].TOP_CSS_CLASS;
		if (parentCssClass == "body"){
			cssSelector = "body"
		}
	}else if (parentCssClass != ""){
		cssSelector = "."+params.target + parentCssClass// + cssSelector;	
	}
	module += "-" + params.target;
	if (cssClass instanceof Array){
		var finalSelector = "";
		for(c in cssClass){
			finalSelector = finalSelector + cssSelector + " " + cssClass[c] + ",";
		}
		cssSelector = finalSelector.substring(0, finalSelector.length - 1);
	}else{
		if (typeof params.vbid != "undefined"){
			cssClass = "#" + params.vbid + cssClass;
			module += params.vbid;
		}
		if (parentCssClass != "body"){
			cssSelector = cssSelector + " " + cssClass;
		}
	}
	
	if (!(module in EditorHelper.realTimeStyle)){
		EditorHelper.realTimeStyle[module] = {};
		EditorHelper.realTimeStyle[module]["props"] = {};
		EditorHelper.realTimeStyle[module]["css_selector"] = cssSelector;
	}
	
	if (deviceClass){
		EditorHelper.realTimeStyle[module]["device_class"] = deviceClass;
	}
	
	if (params.css_name instanceof Array){
		for(i in params.css_name){
			$(cssSelector).attr("data-orig-"+params.css_name[i],params.value);
			EditorHelper.realTimeStyle[module]["props"][params.css_name[i]] = params.value + correctUnits;
		}
	}else if (typeof params.css_name == "string" ){
		$(cssSelector).attr("data-orig-"+params.css_name,params.value);
		EditorHelper.realTimeStyle[module]["props"][params.css_name] = params.value + correctUnits;
	}else if (params.css_chunk){
		EditorHelper.realTimeStyle[module]["props"][params.css_chunk +"-css_chunk"] = EditorHelper.StyleSettings["CSS_CHUNKS"][params.css_chunk][params.value.toLowerCase()]
	}
	
	
	
	EditorHelper.generateRealTimeStyle();
	
	var affectedContainers = $("." + params.target);
	SpimeEngine.ArrangeHolder(EditorHelper.getHolderParent(affectedContainers.first()));
	SpimeEngine.ArrangeHolder(affectedContainers);
};


EditorHelper.generateRealTimeStyle = function(){
	var exsitingStyleTag = $("#real-time-style");
	var masterStyle = $(".master.container").attr("data-preview-style");
	var styleContent = "";
	if (exsitingStyleTag.length == 0){
		exsitingStyleTag = $("<style/>").attr("id","real-time-style");
	}
	for (module in EditorHelper.realTimeStyle){
		var cssSelector = EditorHelper.realTimeStyle[module]["css_selector"]
		var updatedSelector = ""
		if (cssSelector.indexOf(masterStyle) == -1 && cssSelector != "body"){
			updatedSelector = ".master." + masterStyle + " " + cssSelector;
			updatedSelector = updatedSelector.replace(",", ", .master." + masterStyle + " ")
		}else{
			if (cssSelector.indexOf(".master.container") == -1 && cssSelector != "body"){
				updatedSelector = ".master " + cssSelector
				updatedSelector = updatedSelector.replace(",", ", .master ")
			}else{
				updatedSelector = cssSelector;
			}
		}
		
		if (module.indexOf("WEBSITE") != -1){
			updatedSelector = cssSelector;
		}
		
		var deviceClass= "";
		if ("device_class" in EditorHelper.realTimeStyle[module]){
			deviceClass = EditorHelper.realTimeStyle[module]["device_class"];
		}
		
		if (updatedSelector != "body" && module.indexOf("WEBSITE") == -1){
			updatedSelector = "#xprs" + deviceClass + " " + updatedSelector;
			updatedSelector = updatedSelector.replace(/,/g, ",#xprs" + deviceClass + " " );
		}
		
		styleContent += updatedSelector + " { \n";
		for (cssProp in EditorHelper.realTimeStyle[module]["props"]){
			if (cssProp.indexOf("css_chunk") == -1){
				styleContent += cssProp + " : " + EditorHelper.realTimeStyle[module]["props"][cssProp] + ";\n";
			}else{
				styleContent += EditorHelper.realTimeStyle[module]["props"][cssProp]
			}
		}
		styleContent +=  " } \n\n";
	}
	exsitingStyleTag.text(styleContent);
	$("head").append(exsitingStyleTag);
};


EditorHelper.handleTextChange = function(params){
	var updatedElement=$(".magic-circle-holder#" + params.id);
	if (updatedElement.is("input")){
		updatedElement.attr("placeholder",params.new_value);
	}else{
		updatedElement.html(params.new_value);
		var elementHolder = EditorHelper.getHolderParent(updatedElement);
		SpimeEngine.ArrangeHolder(elementHolder);
	}
};


EditorHelper.handleReplacePic = function(params){
	var imageHolder;
	
	if (params.is_body == true){
		$("body").css("background-image","url(" +  params.url + "=s1600)");
		return;
	}
	if (params.is_menufied_preview_links == true){
		$(".master.item-box.header-box .preview-item-links").css("background-image","");
		EditorHelper.UpdateRealTimeStyle($("#" + params.parent_id).attr("data-preview-styleid"),"MENUFIED_PREVIEW_LINKS_HOLDER","BACKGROUND_IMAGE","url(" +  params.url + "=s1600)");
		return;
	}
	
	if (params.is_stripe_bg == true){
		$("#" + params.parent_id + " #" + params.id + ".stripe-background").css("background-image","url(" + params.url + "=s1600)");
		if (params.update_id_to){
			$("#" + params.parent_id + " #" + params.id + ".stripe-background").attr("id",params.update_id_to)
		}
		return;
	}
	if (params.is_inline_pic == true){
		
		imageHolder = $("#" + params.parent_id + " #" + params.id + ".magic-circle-holder.inner-pic");
		imageHolder.css("background-image","url(" +  params.url + "=s1600)");
		imageHolder.attr("data-orig-width",params.origwidth);
		imageHolder.attr("data-orig-height",params.origheight);
		if (params.update_id_to){
			imageHolder.attr("id",params.update_id_to)
		}
		if (imageHolder.closest(".mazonite").length > 0){
			SpimeEngine.ArrangeHolder(imageHolder.closest(".master.item-box"))
		}
		return;
	}
	
	if (params.is_draggable_pic == true){
		imageHolder = $("#" + params.parent_id + " #" + params.id + ".magic-circle-holder.draggable-pic");
		imageHolder.css("background-image","url(" +  params.url + "=s1600)");
		imageHolder.attr("data-orig-width",params.origwidth);
		imageHolder.attr("data-orig-height",params.origheight);
		if (imageHolder.css("background-size") == "contain"){
			EditorHelper.fitDragBoxToImage(imageHolder);
		}
		return
	}
	if (params.is_blocks == true){
		imageHolder =  $("#" + params.parent_id + " #" + params.id + ".magic-circle-holder.blocks-inner-pic");
		imageHolder.attr("src",params.url + "=s1600");
		imageHolder.attr("data-orig-width",params.origwidth);
		imageHolder.attr("data-orig-height",params.origheight);
		return;
	}
	
	
	if (params.is_bg_pic == true){
		imageHolder = $("#" + params.parent_id + " #" + params.id + ".magic-circle-holder.background-image-div");
		imageHolder.css("background-image","url(" +  params.url + "=s1600)");
		imageHolder.attr("data-orig-width",params.origwidth);
		imageHolder.attr("data-orig-height",params.origheight);
		if (params.update_id_to){
			imageHolder.attr("id",params.update_id_to)
		}
		return;
	}
	
	imageHolder = $("#" + params.parent_id + " #" +  params.id + " .magic-circle-holder");
	if (imageHolder.length > 0){
		imageHolder = $("#" + params.parent_id + " #" +  params.id + " .magic-circle-holder.background-div");//.css("background-image","url(" + canvason.attr("src") + ")").hide().fadeIn(400);
	}else{
		imageHolder = $("#" + params.parent_id + " #" +  params.id + ".magic-circle-holder.background-div");//.css("background-image","url(" + canvason.attr("src") + ")").hide().fadeIn(400);
		if (imageHolder.length == 0){
			imageHolder = $("#" + params.parent_id + " #" +  params.id + ".magic-circle-holder.inner-pic");
		}
	}

	if (params.update_id_to){
			imageHolder.attr("id",params.update_id_to)
		}
	//For icons
	$("#" + params.parent_id + " #" + params.id + ".magic-circle-holder.icon-source").attr("src",params.url + "=s1600");//.css("background-image","url(" + canvason.attr("src") + ")").hide().fadeIn(400);
	//only for images
	if (imageHolder.length > 0){
		imageHolder.css("background-image","url(" + params.url + "=s1600)");
		imageHolder.attr("data-orig-width",params.origwidth);
		imageHolder.attr("data-orig-height",params.origheight);
		var previewPrefix = "";
		if (imageHolder.hasClass("preview-element")){
			var imageItemContent = imageHolder.closest(".item-content");
			imageItemContent.attr("data-bgimg",params.url + "=s1600");
			imageItemContent.attr("data-orig-thumb-height",params.origheight);
			imageItemContent.attr("data-orig-thumb-width",params.origwidth);
			previewPrefix = "PREVIEW_";
		}
	
		var imageCropOriginalMode = (imageHolder.css("background-size").indexOf("px")!=-1);
		if (imageCropOriginalMode){
			var newSize = params.origwidth + "px " + params.origheight + "px";
			imageHolder.css("background-size",newSize);
			EditorHelper.updateStripeData({"vbid":params.id,"parent_vbid":EditorHelper.getPageId(),"updated_key":"IMAGE_SIZE","updated_value":newSize,"module_name":previewPrefix + "IMAGE_SPECIFIC"});
		}
	}
	
};



EditorHelper.handleSettings = function(params){
	EditorHelper.updateParent({"deliver_to":"parent","action":"preview"});
	EditorHelper.initSettingsModule(params.vbid);	
};


EditorHelper.handleProSettings = function(params){
	EditorHelper.updateParent({"deliver_to":"parent","action":"preview"});
	EditorHelper.initProSettingsModule(params.vbid);	
};

EditorHelper.handleQrCode = function(params){
	EditorHelper.updateParent({"deliver_to":"parent","action":"preview"});
	EditorHelper.initQrCodeModule();	
};


EditorHelper.initQrCodeModule = function(){
	var hashCode = $(".module#qr-module #qrcode").attr('data-qr-code')
	if ($(".module#qr-module #qrcode canvas").length == 0){
	var qrcode = new QRCode(document.getElementById("qrcode"), {
			    text: hashCode,
			    width: 150,
			    height: 150,
			    colorDark : "#000000",
			    colorLight : "#ffffff"
				});
	}
	EditorHelper.showModule("qr");
	EditorHelper.showModuleStep("qr", 0);
};



EditorHelper.preparePaymentForm = function(clickedBtn, offer, formClass){
	clickedBtn.addClass("loading-state");
	EditorHelper.bindPaymentForm(function(){
		$(".coupon-text").removeClass("domain-purchase").addClass(formClass);
		XPRSHelper.trackEvent('Select plan',"General",offer.attr("data-offer-name"));
		var billingType = $("#publish-module").attr("data-billing-type");
		var offerId = offer.attr("data-offer-id");
		if (billingType.indexOf("abtest") != -1 && formClass != "domain-purchase"){
			offerId = clickedBtn.attr("data-offer-id");
			$("#publish-module #payment-form #selected-offer-id").val(offerId);
		}
		if (billingType.indexOf("abtest") != -1){
			$("#publish-module #my-offer").text(clickedBtn.attr("data-offer-name"));	
		}
		$("#publish-module #selected-offer").attr("data-offer-id",offerId);
		XPRSHelper.GET("https://impayment.herokuapp.com/get_total_price/" +  offerId ,{},function(result){
			if (!(result.error)){
				$("#publish-module #user-country").val(result.country);
				$("#publish-module #user-country").trigger("change",["forced"]);
				if (result.state != "n/a"){
					$("#publish-module #user-state").val(result.state);
				}
				$("#publish-module #user-country").css({"visibility":"hidden","position":"absolute"});
				$("#publish-module #user-state").css({"visibility":"hidden","position":"absolute"});
				$("#publish-module .total-price").attr("data-tax-rate",result.tax_rate);
				if (formClass != "domain-purchase"){
					if (billingType == "standard" || billingType.indexOf("abtest") != -1){
						if (billingType.indexOf("abtest") != -1){
							EditorHelper.updatePaymentPrice(clickedBtn.attr("data-amount"));
						}else{
							EditorHelper.updatePaymentPrice(offer.attr("data-amount"));
						}
						if (billingType.indexOf("abtest") != -1){
							if (billingType == "abtest"){
								$("#publish-module #cancel-btn").attr("data-return-to","14")
							}else{
								$("#publish-module #cancel-btn").attr("data-return-to","15")
							}
						}
					} else {
						EditorHelper.populateOffer(clickedBtn);
						if (billingType == "Custom"){
							$("#publish-module #cancel-btn").attr("data-return-to","13")
						}
					}
				}else{
					EditorHelper.populateOffer(offer);
					$("#publish-module #cancel-btn").attr("data-return-to","2")
				}
				
				EditorHelper.offersDetails[result.id] = result;
				EditorHelper.showModuleStep("publish",3);
				$("#card-holder-first-name").focus();
				clickedBtn.removeClass("loading-state");
			}else{
				EditorHelper.failSafePayment();
				XPRSHelper.POST("/log", {"log_info":"had to show the country state fields " + JSON.stringify(result),"log_type":"payment_reject"});
				clickedBtn.removeClass("loading-state");
			}
		},"json");
		var initialTemplate = XPRSHelper.getXprsCookie("xprs-initial-template");
		if (initialTemplate != null){
			XPRSHelper.trackEvent(initialTemplate +'-Select plan',"General",initialTemplate);
		}
		if(!$("#publish-module #payment-form #user-email").val()){
			$("#publish-module #payment-form #user-email").val(XPRSHelper.getXprsCookie("xprs_email"));
		}
		XPRSHelper.POST("/log", {"log_info":"somebody chose a plan :" + offer.attr("data-offer-name") ,"log_type":"plan_tracing"});
	});
};


EditorHelper.initPublishModule = function(){
	var exprFromCookie = XPRSHelper.getXprsCookie("xprs_exp");
	$("#publish-module").removeClass("payment-standard payment-free payment-manual")
	if (exprFromCookie == "1"){
		$("#publish-module").addClass("payment-standard")
	}else if (exprFromCookie == "2"){
		$("#publish-module").addClass("payment-free")
	}else if  (exprFromCookie == "3"){
		$("#publish-module").addClass("payment-manual")
	}
	
	
	EditorHelper.bindCouponForm();
	
	// EditorHelper.bindPaymentForm("publish");
	
	$("#publish-module .skip-btn").unbind("click").bind("click",function(){
		EditorHelper.closeModule("publish");
	});
	
	$("#publish-module .step-btn").unbind("click").bind("click",function(){
		if($(this).is(".buy-domain-btn") && LABEL_CONFIG && "DOMAIN_BILLING" in LABEL_CONFIG && LABEL_CONFIG.DOMAIN_BILLING.BILLING_TYPE == "Paypal"){
			XPRSHelper.updateParent({"deliver_to":"parent","action":"remove_navigation_confirmation"});
		}
		if ($(this).is(".buy-domain-btn") && LABEL_CONFIG && "DOMAIN_BILLING" in LABEL_CONFIG && LABEL_CONFIG.DOMAIN_BILLING.BILLING_TYPE == "external"){
			XPRSHelper.updateParent({"deliver_to":"parent","action":"remove_navigation_confirmation"});
			 window.top.location.href = "/navigate_to_external_checkout?vbid="+EditorHelper.getRootId() + "&domain_billing=true";
		}else{
			var stepNum = $(this).attr("data-goto-step");
			EditorHelper.showModuleStep("publish",stepNum);
		}
	});
	
	populateCountries("user-country", "user-state");
	EditorHelper.bindOfferSelector("publish");
	$("#publish-module .free-subscription-btn").unbind("click").bind("click",function(){
		var clickedBtn = $(this);
		if (!clickedBtn.hasClass("loading-state")){
			EditorHelper.showModuleStep("publish",41);
			XPRSHelper.POST("/subscription",{"subscription_id":"free","vbid":EditorHelper.getRootId(),"offer_id":"free","offer_name":"free"},function(result){
				XPRSHelper.updateParent({"deliver_to":"parent","action":"premium"});
				XPRSHelper.trackEvent("Free","General","Free");
				setTimeout(function(){
					if (clickedBtn.attr("id") == "existing-domain-btn"){
						EditorHelper.showModuleStep("publish",2);
					}else{
						if (LABEL_CONFIG && "DOMAIN_BILLING" in LABEL_CONFIG && LABEL_CONFIG.DOMAIN_BILLING.BILLING_TYPE == "external"){
							XPRSHelper.updateParent({"deliver_to":"parent","action":"remove_navigation_confirmation"});
							window.top.location.href = "/navigate_to_external_checkout?vbid="+EditorHelper.getRootId() + "&domain_billing=true";
						}else{
							EditorHelper.showModuleStep("publish",21);	
						}
					}
				},2000);
			});
		}
	});
	$("#publish-module #add-to-cart-btn").unbind("click").bind("click",function(){
		var clickedBtn = $(this);
		if (!clickedBtn.hasClass("loading-state")){
			$("#publish-module #step3 .publish-title").text("Purchase a license");
			var productName = $("#publish-module").attr("data-label-product-name")
			$("#publish-module .fourteen-days").show();
			$("#publish-module #step3 .publish-title").next(".publish-text").text(productName + " Premium Membership");
			var offer = $("#publish-module #selected-offer");
			EditorHelper.preparePaymentForm(clickedBtn,offer,"")
		}
	});
	$("#publish-module #connect-existing-domain-btn").unbind("click").bind("click",function(){
		EditorHelper.showModuleStep("publish",22);
		var chosenDomain = $("#publish-module #existing-domain-field").val();
		chosenDomain = chosenDomain.toLowerCase().replace("www.","").replace("http://","").replace("https://","");
		
		EditorHelper.updateLicenseDomain(chosenDomain,false,function(){
			EditorHelper.showModuleStep("publish",23);
	    	setTimeout(function(){
	    		EditorHelper.closeModule("publish");
			},2000);
	    	XPRSHelper.trackEvent('Domaining',"General",chosenDomain);
		});

	});
	
	$("#connect-new-domain-btn").unbind("click").bind("click",function(){
		var clickedBtn = $(this);
		var sld = $("#publish-module #sld").val().toLowerCase().replace("www.","").replace("http://","").replace("https://","");
		var tld = $("#publish-module #tld").val().toLowerCase();
		var supportedTLDs = {"com":true,"net":true,"org":true,"co":true,"uk":true,"it":true,"de":true,"us":true,"co.uk":true,"xyz":true,"art":true};
		if (!(tld in supportedTLDs)){
			XPRSHelper.xprsAlert("We currently do not support " + tld,{title: "Domain Availability"});
		}else{
			clickedBtn.addClass("loading-state");
			XPRSHelper.GET("/check_domain",{"sld":sld,"tld":tld},function(result){
				clickedBtn.removeClass("loading-state");
				if (result.Error){
					XPRSHelper.xprsAlert(result.Error,{title: "Domain Availability"});
				}else{
					if (!clickedBtn.hasClass("loading-state")){
						var newDomainName = sld + "." + tld;
						$("#publish-module #step3 .publish-title").text("Purchase a new domain");
						$("#publish-module #step3 .publish-title").next(".publish-text").text(newDomainName);
						$("#publish-module .fourteen-days").hide();
						
						
						var availableOffers = $("#publish-module .available-offers");
						var domainOffer = availableOffers.find(".domain-offer");
						
						//custom domain price
						if(LABEL_CONFIG && "DOMAIN_BILLING" in LABEL_CONFIG && LABEL_CONFIG.DOMAIN_BILLING.BILLING_TYPE == "Custom"){
							domainOffer.attr("data-amount", LABEL_CONFIG.DOMAIN_BILLING.CUSTOM_PRICE)
							domainOffer.attr("data-offer-name", LABEL_CONFIG.DOMAIN_BILLING.CUSTOM_EXPLAINED) 
							clickedBtn.addClass("custom_payment")
						}
						EditorHelper.preparePaymentForm(clickedBtn,domainOffer,"domain-purchase")
					}
				}
			},"json");
		}
	});
};


EditorHelper.updateLicenseDomain = function(domain,transferDomain,callbackFunc){
	var updateParams = {"vbid":EditorHelper.getRootId(),"domain":domain};
	if (transferDomain){
		updateParams["transfer_domain"] = true;
	}
	XPRSHelper.POST("/update_license_domain",updateParams,function(result){
		if (!result.error){
			XPRSHelper.updateParent({"deliver_to":"parent","action":"update_domain","domain":domain});
			if (typeof callbackFunc != "undefined"){
				callbackFunc();
			}
		}else{
			if (result.error == "SAME_USER_DIFFERENT_SITE"){
				var message = "This domain is already connected to another site you own, would you like to transfer the domain?";
				XPRSHelper.xprsAlert(message,{title: "Domain Availability", showCancelButton: true,confirmButtonText:"Yes, transfer domain",cancelButtonText:"Cancel","callbackfunc":function(isConfirm){
					if(isConfirm){
						EditorHelper.updateLicenseDomain(domain,true,callbackFunc);
					}else{
						EditorHelper.showModuleStep("publish",2);
					}
				}});
			}else{
				XPRSHelper.xprsAlert("This domain is already connected to another site",{title: "Domain Availability","callbackfunc":function(){
					EditorHelper.showModuleStep("publish",2);
				}});
				
			}
		}
	},"json");
};


EditorHelper.handlePublish = function(params){
	EditorHelper.stopElementEditMode($(".edit-on"));
	XPRSHelper.GET("/get_site_license",{"vbid":params.vbid},function(license){
		EditorHelper.loadedLicense = license;
		if (LABEL_CONFIG && "META" in LABEL_CONFIG && LABEL_CONFIG.META.NAME == "aabaco"){
			EditorHelper.asyncPublish(license, params.action_type);
			XPRSHelper.GET("/backup_box",{"vbid":EditorHelper.getRootId(),"backup_type":"S3_AUTOBACKUP_BUCKET"},function(){
				console.log("auto backup called")
			});
		}else if (LABEL_CONFIG && "META" in LABEL_CONFIG && LABEL_CONFIG.META.NAME == "bricksite"){
			EditorHelper.asyncPublishAuto(license, params.action_type);
		}else{
			EditorHelper.updateParent({"deliver_to":"parent","action":"preview"});
			$("#publish-module #free-url-placeholder").html("Please wait, creating url...");
			$("#publish-module #external-billing-link").attr("href" , $("#publish-module #external-billing-link").attr("href") + "&btn=" + params.btn_type )
			EditorHelper.showPublishModule(license,params.action_type,params.first_step);
		}
	},"json");
};


EditorHelper.handleSaveAs = function(params){
		EditorHelper.updateParent({"deliver_to":"parent","action":"preview"});
		if (params.action_type=="save-as"){
			EditorHelper.initSaveAsModule(params.vbid,false,params);
		}else{
			EditorHelper.initSaveAsModule(params.vbid,true,params);
		}
};

EditorHelper.handleBackup = function(params){
	XPRSHelper.GET("/get_site_license",{"vbid":params.vbid},function(license){
		EditorHelper.loadedLicense = license;
		if (typeof license.vbid == "undefined"){// no license
			EditorHelper.handlePublish(params);
		}else{
			EditorHelper.updateParent({"deliver_to":"parent","action":"backup"});
		}
	},"json");
	
};


EditorHelper.handleSave = function(params){
	EditorHelper.updateParent({"deliver_to":"parent","action":"preview"});
	EditorHelper.initSaveAsModule(params.vbid,true,params);
};


EditorHelper.saveAsClick = function(params){
	EditorHelper.showModuleStep("saveas",1);
	var newSiteName = $("#saveas-module #new-site-name").val().replace(/ /g,"_");
	EditorHelper.verifySiteName(newSiteName,function(){
		XPRSHelper.GET("/safe_clone_from_template",{"template_vbid":EditorHelper.getRootId(),"creator":"ff","prefix":XPRSHelper.clonePrefix(),"site_name":newSiteName},function(vbid){
				if (typeof params != "undefined" && "no_reload" in  params){
					XPRSHelper.updateParent({"deliver_to":"parent","action":"saveas-complete"});
				}else{
					setTimeout(function(){
						XPRSHelper.updateParent({"deliver_to":"parent","action":"remove_navigation_confirmation"});
						XPRSHelper.getParentWindow().location.href = "/edit/" + vbid;
					},500);
				}
			//}
		});
	},function(reason){
		EditorHelper.showModuleStep("saveas",0);
		$("#saveas-module #new-site-name").css("background-color","red").val("").attr("placeholder",XPRSTranslator.translateText(reason));
		setTimeout(function(){
			$("#saveas-module #new-site-name").css("background-color","");
		},2000);
	});
};

EditorHelper.verifySiteName = function(siteName,approvedCallback,disapproveCallback){
	if (siteName.length == 0){
		disapproveCallback("Field is empty");
		return;
	}
	var letterNumber = /^[a-zA-Z0-9-_]+$/;
 	if(!siteName.match(letterNumber)){
		disapproveCallback("alphanumeric only");
		return;
	 }


	var userRoot = EditorHelper.getCurrentUserRoot();
	if (userRoot == "none"){
		approvedCallback();
		return;
	}
	if (EditorHelper.userSitesList == null){
		XPRSHelper.GET("/fetch_user_sites", {"vbid":userRoot}, function(sites){
			EditorHelper.userSitesList = sites;
			for (i in EditorHelper.userSitesList){
				if (EditorHelper.userSitesList[i]["META"]["NAME"] == siteName){
					disapproveCallback("Name already exists");
					return;
				}
			}
			approvedCallback();
		}, "json");
	}else{
		for (i in EditorHelper.userSitesList){
			if (EditorHelper.userSitesList[i]["META"]["NAME"] == siteName){
				disapproveCallback("Name already exists");
				return;
			}
		}
		approvedCallback();
	}
	
};

EditorHelper.saveClick = function(){
	EditorHelper.showModuleStep("saveas",1);
	var newSiteName = $("#saveas-module #new-site-name").val().replace(/ /g,"_");
	EditorHelper.verifySiteName(newSiteName,function(){
		XPRSHelper.POST("/add_site_to_user",{"site_name":newSiteName,"vbid":EditorHelper.getRootId()},function(){
			XPRSHelper.removeXprsCookie("xprs-temp-site");
			XPRSHelper.removeXprsCookie("xprs-temp-creator");
			EditorHelper.showModuleStep("saveas",2);
			XPRSHelper.updateParent({"deliver_to":"parent","action":"save-complete", "site_name":newSiteName});
			setTimeout(function(){
				EditorHelper.closeModule("saveas");
			},3000);
		});
	},function(reason){
		EditorHelper.showModuleStep("saveas",0);
		$("#saveas-module #new-site-name").css("background-color","red").val("").attr("placeholder",XPRSTranslator.translateText(reason));
		setTimeout(function(){
			$("#saveas-module #new-site-name").css("background-color","");
		},2000);
	});
};

EditorHelper.initSaveAsModule = function(vbid,skipDuplicate,params){
	XPRSHelper.updateParent({"deliver_to":"parent","action":"hide-control-panel"});
	$("#xprs").removeClass("cellphone-preview tablet-preview desktop-preview")//.css({"left":"0px","top":"0px"});
	$("body").css("background-color","black");
	

	if (!skipDuplicate){
		$("#saveas-module").addClass("show-saveas").removeClass("show-save");
		$("#saveas-module .main-btn").unbind("click").bind("click",EditorHelper.saveAsClick);
		$(document).unbind("keypress").bind("keypress",function(e){
		    if (e.which == 13){
		    	EditorHelper.saveAsClick(params);
		    }
		});
	}else{
		$("#saveas-module").addClass("show-save").removeClass("show-saveas");
		$("#saveas-module .main-btn").unbind("click").bind("click",EditorHelper.saveClick);
		$(document).unbind("keypress").bind("keypress",function(e){
		    if (e.which == 13){
		    	EditorHelper.saveClick();
		    }
		});
	}
	EditorHelper.showModuleStep("saveas",0);
	EditorHelper.showModule("saveas");
	
};




EditorHelper.initProSettingsModule = function(vbid){
	var rootId = EditorHelper.getRootId();
	var pageId = EditorHelper.getPageId();
	$(".module#pro-module .save-settings-btn").unbind("click").bind("click",function(){
		var proForm = $("#pro-module #pro-form");
		proForm.unbind("submit").bind("submit",function(event) {
		    // Deactivate submit button to avoid further clicks
			$("#pro-module .save-settings-btn").attr("disabled", "disabled");
			var formParams =  $( this ).serialize();
			formParams = formParams + "&page_id="+rootId+"&root_id="+rootId;
			EditorHelper.showModuleStep("pro", 1);
			XPRSHelper.POST("/pro_settings",formParams,function(result){
				EditorHelper.showModuleStep("pro", 2);
				setTimeout(function(){
		    		EditorHelper.closeModule("pro");
		    		$("#pro-module .save-settings-btn").removeAttr("disabled");
				},2000);
			});
		    return false;
		  });		
	});
	
	XPRSHelper.GET("/pro_settings",{"vbid":rootId,"root_id":rootId},function(result){
		var proForm = $("#pro-module #pro-form");
		if (!$.isEmptyObject(result)){
			if (typeof result["HEAD_CODE"] != "undefined"){
				proForm.find("#head-code").val(result["HEAD_CODE"]);
			}
		}
		
	},"json");
	EditorHelper.showModule("pro");
	EditorHelper.showModuleStep("pro", 0);
};


EditorHelper.initSettingsModule = function(vbid){
	var rootId = EditorHelper.getRootId();
	var pageId = EditorHelper.getPageId();
	var seoForm = $("#settings-module #seo-form");
	if (rootId != pageId){
		var pageName = EditorHelper.getPageName(pageId);
		seoForm.find("#slug").show().attr("placeholder",XPRSHelper.slugify(pageName));
	}else{
		seoForm.find("#slug , .slug-slash").hide()
	}
	
	
	$(".module#settings-module #save-settings-btn").unbind("click").bind("click",function(){
		
		seoForm.unbind("submit").bind("submit",function(event) {
		    // Deactivate submit button to avoid further clicks
			$("#settings-module #save-settings-btn").attr("disabled", "disabled");
			var formParams =  $( this ).serialize();
			formParams = formParams + "&page_id="+pageId+"&root_id="+rootId;
			EditorHelper.showModuleStep("settings", 1);
			XPRSHelper.POST("/seo_settings",formParams,function(result){
				EditorHelper.showModuleStep("settings", 2);
				setTimeout(function(){
		    		EditorHelper.closeModule("settings");
		    		$("#settings-module #save-settings-btn").removeAttr("disabled");
				},2000);
			});
		    return false;
		  });		
	});
	
	EditorHelper.initFaviconUploader(rootId);
	EditorHelper.initSocialImageUploader(rootId);
	
	XPRSHelper.GET("/seo_settings",{"vbid":pageId,"root_id":rootId},function(result){
		var seoForm = $("#settings-module #seo-form");
		if (!$.isEmptyObject(result)){
			if (typeof result["ANALYTICS_CODE"] != "undefined"){
				seoForm.find("#analytics-code").val(result["ANALYTICS_CODE"]);
			}
			if (typeof result["FACEBOOK_CODE"] != "undefined"){
				seoForm.find("#facebook-code").val(result["FACEBOOK_CODE"]);
			}
			if (typeof result["TITLE"] != "undefined"){
				seoForm.find("#page-title").val(result["TITLE"]);
			}
			if (typeof result["KEYWORDS"] != "undefined"){
				seoForm.find("#page-keywords").val(result["KEYWORDS"]);
			}
			if (typeof result["NO_INDEX"] != "undefined"){
				seoForm.find("#page-visibility option").eq(1).prop('selected', true);
			}
			if (typeof result["DESC"] != "undefined"){
				seoForm.find("#page-desc").val(result["DESC"]);
			}
			if (typeof result["FAVICON"] != "undefined"){
				$("#settings-module #favicon-btn").css("background-image","url("+ result["FAVICON"]+")");
			}
			if (typeof result["SOCIAL_IMAGE_PREVIEW"] != "undefined"){
				$("#settings-module #social-image-btn").css("background-image","url("+ result["SOCIAL_IMAGE_PREVIEW"]+")");
			}
			if (typeof result["IMOS_PROP_ID"] != "undefined"){
				$("#settings-module #imos-prop-id").val(result["IMOS_PROP_ID"]);
			}
			
			if (typeof result["ALTERNATE_SLUG"] != "undefined"){
				seoForm.find("#slug").attr("placeholder",result["ALTERNATE_SLUG"]);
			}
			
		}
		EditorHelper.showModule("settings");
		EditorHelper.showModuleStep("settings", 0);
	},"json");
};

EditorHelper.showModule = function(moduleName){
	$(".floating-plus").removeClass("open").addClass("hidden");
		XPRSHelper.handleDevicePreview({"device_type":"desktop"},function(){
			$("#empty-stripe").remove();
			XPRSHelper.updateParent({"deliver_to":"parent","action":"hide-control-panel"});
			$("#xprs").removeClass("cellphone-preview tablet-preview desktop-preview shadowed")//.css({"left":"0px","top":"0px"});
			$("body").css({"background-color":"black","overflow":"hidden"});
			$("#xprs").addClass("site-thumb animated")//.css("height",$(window).height());
			
			$("#xprs").unbind("click").bind("click",function(event){
				EditorHelper.closeModule(moduleName);
			});
			$("."+moduleName+"-ui .back-btn").unbind("click").bind("click",function(){
				if ($(this).attr("data-return-to")){
					EditorHelper.showModuleStep("publish",parseInt($(this).attr("data-return-to")));
					$(this).removeAttr("data-return-to");
				}else{
					EditorHelper.closeModule(moduleName);
				}
			});
			$(document).scrollTop(0);
			$("body").addClass("showing-module");
			EditorHelper.closeDraggableTabbedPanel();
			$("#history-queue").hide();
			
			XPRSTranslator.translateDom($("#" + moduleName + "-module"));
			
	});
};






EditorHelper.showSaveIfNeeded = function(actionType,callbackFunc){
	if (actionType == "just_publish"){
		callbackFunc();
		return;
	}
	if (actionType == "save-and-publish"){
		if (!$("body").hasClass("showing-module")){
			EditorHelper.showModule("publish");
		}
		$("#publish-module #step5 .add-site-btn").unbind("click").bind("click",function(){
			EditorHelper.showModuleStep("publish",6);
			var newSiteName = $("#publish-module #step5 .new-site-name").val().replace(/ /g,"_");
			EditorHelper.verifySiteName(newSiteName,function(){
				XPRSHelper.POST("/add_site_to_user",{"site_name":newSiteName},function(){
					XPRSHelper.removeXprsCookie("xprs-temp-site");
					XPRSHelper.removeXprsCookie("xprs-temp-creator");
					XPRSHelper.updateParent({"deliver_to":"parent","action":"save-complete", "site_name":newSiteName});
					if (typeof callbackFunc != "undefined"){
						callbackFunc();
					}
				});
			},function(reason){
				EditorHelper.showModuleStep("publish",5);
				$("#publish-module #step5 .new-site-name").css("background-color","red").val("").attr("placeholder",reason);
				setTimeout(function(){
					$("#publish-module #step5 .new-site-name").css("background-color","");
				},2000);
			});
		});
		$("#publish-module #step5 .new-site-name").unbind("keypress").bind("keypress",function(event) {
	        if (event.keyCode == 13) {
	        	$("#publish-module #step5 .add-site-btn").click(); 
	        }
	    });
		//show the save step
		EditorHelper.showModuleStep("publish",5);
	}else{
		callbackFunc();
	}
};

EditorHelper.publishSite = function(){
    XPRSHelper.updateParent({"deliver_to":"parent","action":"publish"});
	var freeUrlDomain = window.location.host;
	if (LABEL_CONFIG && "META" in LABEL_CONFIG && LABEL_CONFIG.META.NAME == "xprs"){
		freeUrlDomain = "www.im-creator.com";
	}
	XPRSHelper.GET("/get_free_url",{"vbid":EditorHelper.getRootId()},function(result){
		XPRSHelper.trackEvent('Successful Publish',"General",EditorHelper.getRootId());
		$("#publish-module #free-url-placeholder").html("<a href='http://"+ freeUrlDomain + result.free_url+"' target='_blank'>"+ freeUrlDomain + result.free_url +"</a>");
        EditorHelper.updateWindowTop({"deliver_to":"cPanel","action":"site-published"});
	},"json");
};


EditorHelper.createImosSiteIfNeeded = function(callbackFunc){
	if (!$("body").attr("data-osid")){
		var imosServer = $("body").attr("data-imos-server");
		var userEmail = XPRSHelper.getXprsCookie("xprs_email");
		if (!userEmail){
			userEmail = $("body").attr("data-root-id") + "@tempuser";
		}
		
		XPRSHelper.POST(imosServer + "/api/create_site", {"owner_email":userEmail} , function(osid){
			$("body").attr("data-osid",osid);
			$(".imos-menu").attr("data-osid",osid);
			XPRSHelper.SAFEPOST("/update_specific_key",{"vbid":EditorHelper.getRootId() , "section": "META","updated_key":"OSID","updated_value":osid},EditorHelper.getRootId(),"OSID",function() {
				if (typeof callbackFunc != "undefined"){
					callbackFunc();
				}
			});
		}).error(function(){
			callbackFunc();
		});
	}else{
		callbackFunc();
	}
};


EditorHelper.handleRequestedDomain = function(requestedDomain){
	EditorHelper.showModuleStep("publish",0);
	$("#publish-module #step0 .special-remark").html("<br>First publish to a domain may take up to 60 min to become live")
	XPRSHelper.POST("/register_free_domain",{"domain":requestedDomain},function(result){
		XPRSHelper.POST("/subscription",{"subscription_id":"free","vbid":EditorHelper.getRootId(),"offer_id":"free","offer_name":"free","requested_domain":requestedDomain},function(result){
				XPRSHelper.updateParent({"deliver_to":"parent","action":"premium"});
				$("#publish-module #domain-url-placeholder").html("<a href='http://www."+requestedDomain+"' target='_blank'>http://www."+ requestedDomain +"</a>");
		});
	},"json");
};


EditorHelper.asyncPublish = function(license, actionType){
	EditorHelper.showSaveIfNeeded(actionType,function(){
		$.get("/api/v1/users/" + license.owner + "/sites/" + license.lbid + "/publish_async",function(result){
			XPRSHelper.updateParent({"deliver_to":"parent","action":"publish"});
			if (typeof YSBApp != "undefined"){
				YSBApp.send({"action": "publish", "appid": "ywebsite"});
			}
		},"json");
	});
};

EditorHelper.asyncPublishAuto = function(license, actionType){
	EditorHelper.showModule("publish");
	EditorHelper.showSaveIfNeeded(actionType,function(){
		EditorHelper.showModuleStep("publish",30);
		if (typeof license.vbid == "undefined"){// no license
			$.get("/publish/" + EditorHelper.getCurrentUser() + "/" + EditorHelper.getRootId() + "?vbid=" + EditorHelper.getRootId() ,function(res){
				if (res){
					license.owner = EditorHelper.getCurrentUser();
					license.lbid = res.lbid;
				}
				EditorHelper.whenPublishedFinished(license, 0, function(){
					EditorHelper.whenZipReady(license, 0, function(zipSize, zipUrl){
						var siteSlug = $("#xprs").attr("data-slug");
						$.post("https://admin.bricksite.net/endpoints/publishzip.php",{"zip_url":zipUrl,"nickname":license.owner,"slug":siteSlug,"vbid":EditorHelper.getRootId()},function(result){
							if ("REDIRECT" in result){
								XPRSHelper.updateParent({"deliver_to":"parent","action":"remove_navigation_confirmation"});
								if (typeof VueEditor != "undefined"){
									VueEditor._self.$store.commit("SET_DATA", {section: "volatile",entry: "preventNavigation",value: false});
								}
								window.top.location.href = result['REDIRECT'];
							}else{
								EditorHelper.showModuleStep("publish",32);
								var freeUrl = "https://web.bricksite.net/" + license.owner +"/" + siteSlug;
								$("#publish-module #domain-url-placeholder").html("<a href='" + freeUrl + "' target='_blank'>" + freeUrl + "</a>");
							}
						},"json");
						
					});
            	});
			},"json");
			
		}else{// This site is licensed
			$.get("/publish/" + license.owner + "/" + license.lbid + "?vbid=" + EditorHelper.getRootId() ,function(){
				EditorHelper.whenPublishedFinished(license, 0, function(){
					EditorHelper.whenZipReady(license, 0, function(zipSize, zipUrl){
						console.log(zipUrl)
						var siteSlug = $("#xprs").attr("data-slug");
						$.post("https://admin.bricksite.net/endpoints/publishzip.php",{"zip_url":zipUrl,"nickname":license.owner,"slug":siteSlug,"vbid":EditorHelper.getRootId()},function(result){
							console.log("got result", result);
							if ("REDIRECT" in result){
								XPRSHelper.updateParent({"deliver_to":"parent","action":"remove_navigation_confirmation"});
								if (typeof VueEditor != "undefined"){
									VueEditor._self.$store.commit("SET_DATA", {section: "volatile",entry: "preventNavigation",value: false});
								}
								window.top.location.href = result['REDIRECT'];
							}else{
								EditorHelper.showModuleStep("publish",32);
								if(license.status=="FOR_PUBLISH"){
									var freeUrl = "https://web.bricksite.net/" + license.owner +"/" + siteSlug;
									$("#publish-module #domain-url-placeholder").html("<a href='" + freeUrl + "' target='_blank'>" + freeUrl + "</a>");
								}else{
									$("#publish-module #domain-url-placeholder").html("<a href='https://"+license.domain+"' target='_blank'>"+ license.domain +"</a>");
								}
							}
						},"json");
						
					});
            	});
			});
		}
	});
};


EditorHelper.whenPublishedFinished = function(license, polling_retries, callbackFunc){
    setTimeout(function(){
        $.get("/publish_status/" + license.owner + "/" + license.lbid + "?vbid=" + EditorHelper.getRootId() ,function(res){
            if (res["PUBLISH_STATUS"]["status"] == "ZIP_IN_PROGRESS"){
                callbackFunc();
            }else{
                if ("ready_pages" in res){
                    var pageList = $("<ol />");
                    for(var i = 0; i < res["ready_pages"].length ; i++){
                       console.log("<li>" + res["ready_pages"][i] + "</li>")
                    }
                }
                if (polling_retries > 200){
                    EditorHelper.showModuleStep("publish",33);
					return
                }
                polling_retries++;
                EditorHelper.whenPublishedFinished(license, polling_retries, callbackFunc);
            }
        },"json");
    },500);
};


EditorHelper.whenZipReady = function(license, polling_retries, callbackFunc){
    setTimeout(function(){
        $.get("/publish_status/" + license.owner + "/" + license.lbid + "?vbid=" + EditorHelper.getRootId(),function(res){
            if (res["PUBLISH_STATUS"]["status"] == "READY"){
                callbackFunc(res["PUBLISH_STATUS"]["zip_size"], res["PUBLISH_STATUS"]["zip_url"]);
            }else{
                if (polling_retries > 200){
                   EditorHelper.showModuleStep("publish",33);
				   return;
                }
                polling_retries++;
                EditorHelper.whenZipReady(license, polling_retries, callbackFunc);
            }
        },"json");
    },500);
};




EditorHelper.showPublishModule = function(license, actionType, firstStep){
	var exprFromCookie = XPRSHelper.getXprsCookie("xprs_exp");
	var requestedDomain = XPRSHelper.getXprsCookie("requested_domain");
	
	$("#publish-module").removeClass("payment-standard payment-free payment-manual");
	if (exprFromCookie == "1"){
		$("#publish-module").addClass("payment-standard")
	}else if (exprFromCookie == "2"){
		$("#publish-module").addClass("payment-free")
	}else if  (exprFromCookie == "3"){
		$("#publish-module").addClass("payment-manual")
	}
	if (LABEL_CONFIG && "BILLING" in LABEL_CONFIG && "EXTERNAL_SKIP_PUBLISH_PAGE" in LABEL_CONFIG.BILLING && LABEL_CONFIG.BILLING.EXTERNAL_SKIP_PUBLISH_PAGE == "on" && LABEL_CONFIG.BILLING.BILLING_TYPE == "external"){
		
	}else{
		EditorHelper.showModule("publish");
	}
	EditorHelper.createImosSiteIfNeeded(function(){
		EditorHelper.showSaveIfNeeded(actionType,function(){
			if (typeof license.vbid == "undefined"){// no license
				EditorHelper.publishSite();
				if (exprFromCookie == "2" || exprFromCookie =="3"){//free user
					if (requestedDomain){
						EditorHelper.handleRequestedDomain(requestedDomain);
					}else if(LABEL_CONFIG && "BILLING" in LABEL_CONFIG && ((LABEL_CONFIG.BILLING.BILLING_TYPE.indexOf("abtest") != -1) || (LABEL_CONFIG.BILLING.BILLING_TYPE.indexOf("columns") != -1 ))){
						EditorHelper.initLargeOfferButtons();
						if (LABEL_CONFIG.BILLING.BILLING_TYPE == "abtest"){
							EditorHelper.showModuleStep("publish",14);
						}else if (LABEL_CONFIG.BILLING.BILLING_TYPE == "columns"){
							EditorHelper.initColumnsOfferButtons();
							EditorHelper.showModuleStep("publish",16);
						}else{
							EditorHelper.showModuleStep("publish",15);
						}
					}else{
							EditorHelper.showModuleStep("publish",1);
						}
				}else{//$
					if (LABEL_CONFIG && "BILLING" in LABEL_CONFIG && "BUY_NOW_URL" in LABEL_CONFIG.BILLING && LABEL_CONFIG.BILLING.BUY_NOW_URL != "none" && LABEL_CONFIG.BILLING.BILLING_TYPE == "external"){
						XPRSHelper.updateParent({"deliver_to":"parent","action":"remove_navigation_confirmation"});
						if ("EXTERNAL_SKIP_PUBLISH_PAGE" in LABEL_CONFIG.BILLING && LABEL_CONFIG.BILLING.EXTERNAL_SKIP_PUBLISH_PAGE == "on"){
							window.top.location.href = "/navigate_to_external_checkout?vbid=" + EditorHelper.getRootId();
						}else{
							EditorHelper.showModuleStep("publish",13);
						}
					}else if(LABEL_CONFIG && "BILLING" in LABEL_CONFIG && "BUY_NOW_URL" in LABEL_CONFIG.BILLING && LABEL_CONFIG.BILLING.BILLING_TYPE == "Paypal"){
						XPRSHelper.updateParent({"deliver_to":"parent","action":"remove_navigation_confirmation"});
						EditorHelper.showModuleStep("publish",13);
					}else if(LABEL_CONFIG && "BILLING" in LABEL_CONFIG && "BUY_NOW_URL" in LABEL_CONFIG.BILLING && LABEL_CONFIG.BILLING.BILLING_TYPE == "Custom"){
						XPRSHelper.updateParent({"deliver_to":"parent","action":"remove_navigation_confirmation"});
						EditorHelper.showModuleStep("publish",13);
					}else if(LABEL_CONFIG && "BILLING" in LABEL_CONFIG && (LABEL_CONFIG.BILLING.BILLING_TYPE.indexOf("abtest") != -1 || LABEL_CONFIG.BILLING.BILLING_TYPE.indexOf("columns") != -1) || (exprFromCookie == "6" && !LABEL_CONFIG)){
						EditorHelper.initLargeOfferButtons();
						if (LABEL_CONFIG.BILLING.BILLING_TYPE == "abtest"){
							EditorHelper.showModuleStep("publish",14);
						}else if (LABEL_CONFIG.BILLING.BILLING_TYPE == "columns"){
							EditorHelper.initColumnsOfferButtons();
							EditorHelper.showModuleStep("publish",16);
						}else{
							EditorHelper.showModuleStep("publish",15);
						}
						
					}else{
							EditorHelper.showModuleStep("publish",12);
						}
				}
			}else{// This site is licensed
				EditorHelper.publishSite();
				XPRSHelper.GET("/backup_box",{"vbid":EditorHelper.getRootId(),"backup_type":"S3_AUTOBACKUP_BUCKET"},function(){
					console.log("auto backup called")
				});
				if (license.offer == "non-commercial"){
					EditorHelper.initLargeOfferButtons(license);
					EditorHelper.showModuleStep("publish",14);
				}else{
					if (license.domain != null){
						$("#publish-module #domain-url-placeholder").html("<a href='http://www."+license.domain+"' target='_blank'>http://www."+ license.domain +"</a>");
					}else{
						$("#publish-module #domain-url-placeholder").html("No domain selected");
					}
					if (typeof firstStep == "undefined"){
						EditorHelper.showModuleStep("publish",0);
					}else{
						EditorHelper.showModuleStep("publish",firstStep);
					}
				}
			}
		});
	});
	$("#publish-module #cancel-btn").unbind("click").bind("click",function(){
		$("#publish-module").find("[data-bluesnap='ccn']").css("background-image", "");
		if (typeof license.vbid == "undefined"){
			if (actionType == "new-domain" || actionType == "existing-domain"){
				EditorHelper.closeModule("publish");
				return
			}
			
		}
		if ($(this).attr("data-return-to")){
			EditorHelper.showModuleStep("publish",parseInt($(this).attr("data-return-to")));
			$(".publish-ui .back-btn").removeAttr("data-return-to");
		}else{
			if (typeof firstStep == "undefined"){
				if (exprFromCookie == "2" || exprFromCookie == "3"){
					EditorHelper.showModuleStep("publish",1);
				}else{
					EditorHelper.showModuleStep("publish",12);
				}
			}else{
				EditorHelper.showModuleStep("publish",firstStep);
			}
		}
	});
};


EditorHelper.initColumnsOfferButtons = function(license){
	$("#publish-module #cancel-btn").attr("data-return-to","16");
	$("#step16 .period-option").unbind("click").bind("click",function(e){
		e.stopPropagation();
		if ($(".column-offer.loading-state").length == 0 && !$(this).is(".selected")){
			$("#step16 .period-option").toggleClass("selected");
			$("#step16 .column-offers").attr("data-show", $(this).attr("data-toshow"));
		}
	});
	$(".column-offer").unbind("click").bind("click",function(e){
		e.stopPropagation();
		$(".publish-ui .back-btn").attr("data-return-to","16");
		var clickedBtn = $(this);
		if (!clickedBtn.hasClass("loading-state") && $(".column-offer.loading-state").length ==0){
			$("#step3 .column-offers").empty();
			var selectedOffer = $(this).clone();
			selectedOffer.addClass("highlighted-offer");
			$("#step3 .column-offers").append(selectedOffer);
			$("#publish-module #step3 .publish-title").text("Purchase a license");
			var productName = clickedBtn.attr("data-label-product-name")
			$("#publish-module #step3 .publish-title").next(".publish-text").text(productName + " Premium Membership");
			EditorHelper.preparePaymentForm(clickedBtn, $(this), "");
		}
	});
}


EditorHelper.initLargeOfferButtons = function(license){
	$("#publish-module #cancel-btn").attr("data-return-to","14")
	$(".large-offer").unbind("click").bind("click",function(e){
		e.stopPropagation();
		var clickedBtn = $(this);
		if (clickedBtn.is("#free-large-offer")){
			XPRSHelper.xprsAlert("Please mail free-license@imxprs.com to get your free license. Thank you, the XPRS team." ,{title: "Apply for a free license"});
		}else{
			if (!clickedBtn.hasClass("loading-state")){
				$("#publish-module #step3 .publish-title").text("Purchase a license");
				var productName = clickedBtn.attr("data-label-product-name")
				$("#publish-module #step3 .publish-title").next(".publish-text").text(productName + " Premium Membership");
				var offer = $("#publish-module #selected-offer");
				EditorHelper.preparePaymentForm(clickedBtn,offer,"");
			}
		}
	});
};

EditorHelper.failSafePayment = function(){
	$("#publish-module #user-country").css({"visibility":"visible","position":"relative"});
	$("#publish-module #user-state").css({"visibility":"visible","position":"relative"});
	EditorHelper.showModuleStep("publish",3);
	if (!$("#publish-module #user-country").attr("data-binded")){
		$("#publish-module #user-country").attr("data-binded",true);
		$("#publish-module #user-country").bind("change",function(e,forced){
			if (typeof forced == "undefined"){
				if ($("#publish-module #user-country").val() != "us" && $("#publish-module #user-country").val() != "ca"  ){
					$("#publish-module .total-price").html("<img id='load-state' src='/images/x_loader.gif' style='width:20px;' />");
					$("#publish-module #checkout-btn").addClass("loading-state");
					$("#publish-module #checkout-btn").attr("disabled", "disabled");
					var offer = $("#publish-module #selected-offer");
					var offerId = offer.attr("data-offer-id");
					XPRSHelper.GET("https://impayment.herokuapp.com/get_total_price_by_country/" +  offerId,{"country":$("#publish-module #user-country").val()},function(result){
						if (!(result.error)){
							$("#publish-module .total-price").attr("data-tax-rate",result.tax_rate);
							var billingType = $("#publish-module").attr("data-billing-type");
							if (billingType == "standard" || billingType.indexOf("abtest") != -1){
								EditorHelper.updatePaymentPrice(result.total_price,true,true);
							} else {
								EditorHelper.updatePaymentPrice($("#card-amount-int").val());
							}
							$("#publish-module #checkout-btn").removeClass("loading-state");
							$("#publish-module #checkout-btn").removeAttr("disabled");
							EditorHelper.offersDetails[result.id] = result;
						}else{
							var fakeCountryField = $("<input type='hidden' name='user-country' id='user-country' value='us'>");
							var fakeStateField = $("<input type='hidden' name='user-state' id='user-state' value='FL'>");
							$("#publish-module #user-country").remove();
							$("#publish-module #user-state").remove();
							$("#publish-module #payment-form").append(fakeCountryField).append(fakeStateField);
							$("#publish-module #checkout-btn").removeClass("loading-state");
							$("#publish-module #checkout-btn").removeAttr("disabled");
							EditorHelper.updatePaymentPrice($("#publish-module .initial-price").text().replace("$",""));
							XPRSHelper.POST("/log", {"log_info":"faked country and state","log_type":"payment_reject"});
						}
					},"json");
				}else{
					$("#publish-module #user-state").bind("change",function(){
						var offer = $("#publish-module #selected-offer");
						var offerId = offer.attr("data-offer-id");
						$("#publish-module .total-price").html("<img id='load-state' src='/images/x_loader.gif' style='width:20px;' />");
						$("#publish-module #checkout-btn").addClass("loading-state");
						$("#publish-module #checkout-btn").attr("disabled", "disabled");
						XPRSHelper.GET("https://impayment.herokuapp.com/get_total_price_by_country/" +  offerId,{"country":$("#publish-module #user-country").val(),"state":$("#publish-module #user-state").val()},function(result){
							if (!(result.error)){
								$("#publish-module .total-price").attr("data-tax-rate",result.tax_rate);
								var billingType = $("#publish-module").attr("data-billing-type");
								if (billingType == "standard" || billingType.indexOf("abtest") != -1){
									EditorHelper.updatePaymentPrice(result.total_price,true,true);
								} else {
									EditorHelper.updatePaymentPrice($("#card-amount-int").val());
								}
								$("#publish-module #checkout-btn").removeClass("loading-state");
								$("#publish-module #checkout-btn").removeAttr("disabled");
								EditorHelper.offersDetails[result.id] = result;
							}else{
								var fakeCountryField = $("<input type='hidden' name='user-country' id='user-country' value='us'>");
								var fakeStateField = $("<input type='hidden' name='user-state' id='user-state' value='FL'>");
								$("#publish-module #user-country").remove();
								$("#publish-module #user-state").remove();
								$("#publish-module #payment-form").append(fakeCountryField).append(fakeStateField);
								$("#publish-module #checkout-btn").removeClass("loading-state");
								$("#publish-module #checkout-btn").removeAttr("disabled");
								EditorHelper.updatePaymentPrice($("#publish-module .initial-price").text().replace("$",""));
								XPRSHelper.POST("/log", {"log_info":"faked country and state","log_type":"payment_reject"});
							}
						},"json");
					});
				}
			}
		});
	}

};


EditorHelper.closeModule = function(moduleName){
	XPRSHelper.updateParent({"deliver_to":"parent","action":"restore_navigation_confirmation"});
	//$("body").disableSelection();
	setTimeout(function(){
		$("#xprs").removeClass("site-thumb no-site").addClass("desktop-preview");
	},300);
	$("." + moduleName + "-ui").fadeOut();
	$("#"+moduleName+"-module ."+moduleName+"-step").fadeOut();
	$("#control-panel").fadeIn();
	XPRSHelper.updateParent({"deliver_to":"parent","action":"show-control-panel"});
	$(document).unbind("keypress");
	$("#xprs").unbind("click");
	setTimeout(function(){
		$("body").css({"background-color":"","overflow":""});
		$("#xprs").css("height","");
		$("#xprs").removeClass("animated");
		SpimeEngine.ArrangeAll();
	},1500);
	$("body").removeClass("showing-module");
	$(".floating-plus").removeClass("hidden");
	$(".plus-mark").removeClass("plus-mark");
	if (typeof VueEditor != "undefined"){
		VueEditor._router.push("/");
	}
};

EditorHelper.showModuleStep = function(moduleName,stepNum){
	//$("body").enableSelection();
	$("#"+moduleName+"-module ."+moduleName+"-step").css("display", "flex").hide();
	$("." + moduleName + "-ui").fadeIn();
	$("#"+moduleName+"-module #step" + stepNum).fadeIn();
	if ($("#"+moduleName+"-module #step" + stepNum).attr("data-focus-element")){
		$("#"+moduleName+"-module #step" + stepNum + " #" + $("#"+moduleName+"-module #step" + stepNum).attr("data-focus-element")).focus();
	}
};


EditorHelper.bindOfferSelector = function(moduleName){
	var offersSelector = $("#publish-module #selected-offer");
	var availableOffers = $("#publish-module .available-offers");
	EditorHelper.populateOffer(availableOffers.find(".default-offer"));
	offersSelector.unbind("click").bind("click",function(e){
		e.stopPropagation();
		availableOffers.addClass("shown");
	});
	availableOffers.find("li").unbind("click").bind("click",function(e){
		e.stopPropagation();
		availableOffers.removeClass("shown");
		EditorHelper.populateOffer($(this));
	});
	
};


EditorHelper.populateOffer = function(offerLi){
	var selectedOffer = $("#publish-module #selected-offer");
	var calculatedAmount = offerLi.attr("data-amount");
	var calculatedCurrency = "USD"
	if (offerLi.attr("data-currency")){
		////// THIS PLACE SHOULD WORK, AFTER WE'LL CHANGE THE SERVICE AT HEROKU
		calculatedCurrency = offerLi.attr("data-currency");
	}
	var initialOfferId = offerLi.attr("data-offer-id");
	var offerName = offerLi.attr("data-offer-name");
	//update the ui
	selectedOffer.attr("data-offer-id",offerLi.attr("data-offer-id"));
	selectedOffer.attr("data-amount",offerLi.attr("data-amount"));
	selectedOffer.attr("data-currency",offerLi.attr("data-currency"));
	selectedOffer.attr("data-offer-name",offerLi.attr("data-offer-name"));
	selectedOffer.find(".offer-name-holder").text(XPRSTranslator.translateText(offerLi.find(".offer-name-holder").first().text()));
	selectedOffer.find(".offer-price-holder").text(offerLi.find(".offer-price-holder").first().text());
	selectedOffer.find(".offer-info").text(XPRSTranslator.translateText(offerLi.find(".offer-info").first().text()));
	selectedOffer.find(".offer-info-highlight").text(XPRSTranslator.translateText(offerLi.find(".offer-info-highlight").first().text()));
	//update the form
	if (offerLi.is(".custom_payment")){
		$("#publish-module #my-offer").text(offerLi.find(".large-offer-desc").text());
		$("#publish-module #offer-form-title").text(offerName);	
	}else{
		$("#publish-module #my-offer").text(offerName);	
	}
	
	var initialTotalPrice  = calculatedAmount;
	$("#publish-module .initial-price").text(EditorHelper.allSymbols[calculatedCurrency] + parseInt(calculatedAmount).toFixed(2));
	EditorHelper.updatePaymentPrice(initialTotalPrice);
	$("#publish-module #payment-form #card-currency").val(calculatedCurrency)
	$("#publish-module #payment-form #selected-offer-id").val(initialOfferId);
	if(!$("#publish-module #payment-form #user-email").val()){
		$("#publish-module #payment-form #user-email").val(XPRSHelper.getXprsCookie("xprs_email"));
	}
	
};

EditorHelper.bindCouponForm = function(){
	$(".coupon-text span").unbind("click").bind("click",function(e){
		e.stopPropagation();
		$(".coupon-text span").text("Please enter you coupon code:")
		$("#coupon-form").addClass("visible");
		$(".coupon-text span").unbind("click")
		XPRSTranslator.translateDom($(".coupon-text"))
	});
	$("#coupon-btn-cancel").unbind("click").bind("click",function(e){
		e.preventDefault()
		e.stopPropagation();
		$(".coupon-text span").text("Got a coupon? Click here")
		$("#coupon-form").removeClass("visible");
		
		$(".coupon-text span").unbind("click").bind("click",function(e){
			e.stopPropagation();
			$(".coupon-text span").text("Please enter you coupon code:")
			$("#coupon-form").addClass("visible");
			$(".coupon-text span").unbind("click")
			XPRSTranslator.translateDom($(".coupon-text"))
		});
	});
	$("#coupon-form").submit(function(e) {
	    var url = "/get_coupon"; // the script where you handle the form input.
	    var currentForm = $(this);
	    var couponVal = currentForm.find("#coupon-code").val()
	    if (couponVal){
	    $.ajax({
	           type: "POST",
	           url: url,
	           data: $("#coupon-form").serialize(), // serializes the form's elements.
	           success: function(data){
	        	   initialPrice = $("#card-amount-int").attr("value");
	        	   initialPaypal = 0;
	        	   $(".paypal-button").find("input:hidden[name='amount']").each(function(){ 
	        		   initialPaypal = $(this).val();
	        	   });
	        	   initialCustom = $(".large-offer-price").html().replace("$","").replace("", "");
	        	   initialCustom = initialCustom.split(" ");
	        	   initialCustomCurrency = initialCustom[1];
	        	   initialCustom = initialCustom[0];
	        	   if (data.indexOf(" ") > -1 ){
	        		   XPRSHelper.setXprsCookie("xprs_coupon",couponVal);
	        		   discountedPrice = data.replace("$","")
	        		   pricee = discountedPrice.split(" ");
	        		   discountedPrice = pricee[0];
	        		   discountedCurrency = pricee[1];
	        		   $("#card-currency").attr("value", discountedCurrency)
	        		   EditorHelper.updatePaymentPrice(discountedPrice);
	        		   discountedPaypal = discountedPrice
	        		   discountedCustom = discountedPrice
	        		   $("#my-offer").append("<div id='discount' class='publish-text greyed'>"+$("#coupon-code").val()+" Discount coupon"+"</div>")
	        		   $("#publish-module #payment-form #coupon-used").val(String($("#coupon-code").val()));
	        		   //on paypal
        			   $(".paypal-button").find("input:hidden[name='amount']").each(function(){ 
        				   $(this).val(discountedPaypal);
        			   })
        			   $(".paypal-button").find("input:hidden[name='a3']").each(function(){ 
        				   $(this).val(discountedPaypal);
        			   })
        			   $(".paypal-button").find("input:hidden[name='currency_code']").each(function(){ 
        				   $(this).val(discountedCurrency);
        			   })
        			   //on custom
        			   $(".custom_payment .large-offer-price").text(discountedCustom+" "+discountedCurrency)
	        		   $(".coupon-text").remove();
	        		   XPRSHelper.xprsAlert("successfully added coupon" ,{title: "Coupon Applied"});
	        		   //free website
	        		   if (discountedPrice == 0){
        				   window.top.location.href = "/navigate_to_external_checkout_and_come_back?vbid="+EditorHelper.getRootId();
        			   }
	        	   } else {
	        		   
	        		   if (data.indexOf("%") > -1 ){
	        			   XPRSHelper.setXprsCookie("xprs_coupon",couponVal);
	        			   pricee = data.split("%");
	        			   discount_precentage = pricee[0];
		        		   discountedCurrency = pricee[1];
	        			   discountt = parseFloat(discount_precentage)/100;
	        			   discountedPrice = parseFloat(initialPrice) - parseFloat(initialPrice) * discountt;
	        			   discountedPaypal = parseFloat(initialPaypal) - parseFloat(initialPaypal) * discountt;
	        			   discountedCustom = parseFloat(initialCustom) - parseFloat(initialCustom) * discountt;
	        			   EditorHelper.updatePaymentPrice(discountedPrice);
	        			   $("#my-offer").append("<div id='discount' class='publish-text greyed'>"+$("#coupon-code").val()+" Discount coupon"+"</div>")
	        			   $("#publish-module #payment-form #coupon-used").val(String($("#coupon-code").val()));
	        			   $(".coupon-text").remove();
	        			   XPRSHelper.xprsAlert("successfully added coupon" ,{title: "Coupon Applied"});
	        			   //on paypal
	        			   $(".paypal-button").find("input:hidden[name='amount']").each(function(){ 
	        				   $(this).val(discountedPaypal);
	        			   })
	        			   $(".paypal-button").find("input:hidden[name='a3']").each(function(){ 
	        				   $(this).val(discountedPaypal);
	        			   })
	        			   //no need to upadte currency, as it's only precentage
	        			   //on custom
	        			   $(".custom_payment .large-offer-price").text(discountedCustom+" "+initialCustomCurrency)
	        			   //free website
	        			   if (discountedPrice == 0){
	        			   	   window.top.location.href = "/navigate_to_external_checkout_and_come_back?vbid="+EditorHelper.getRootId();
	        			   }
	        		   } else {
		        		   XPRSHelper.xprsAlert("Not a valid coupon code" ,{title: "Can't apply coupon"});
	        		   }
	        	   }
	           }
	         });
	    }
	    e.preventDefault(); // avoid to execute the actual submit of the form.
	    return false
	});
}

EditorHelper.allSymbols = {"USD":"$","EUR":"","AUD":"AU$", "GBP":"","RUB":"","JPY":"","DKK":"kr","HKD":"HK$","ILS":"","BRL":"R$","CAD":"CAD$","PLN":"z","ZAR":"R","INR":"","NGN":"","NZD":"NZ$","TRY":"","CHF":"CHF","NOK":"kr","VND":"","NPR":"Re.","RON":"lei","MYR":"RM","SGD":"S$","AED":".","PKR":"","THB":"","IDR":"Rp","SEK":"kr","MXN":"Mex$","TWD":"NT$", "GHS":"GH", "PHP":"", "HUF":"Ft"};

EditorHelper.updatePaymentPrice = function(newPrice,excludeTax,keepOriginal){
	var currencySymbol = "$";
	newPrice = parseFloat(parseFloat(newPrice).toFixed(2));
	var currencyCode = $("#publish-module").attr("data-custom-currency");
	
	if ($("#publish-module").attr("data-billing-type") != "standard" && ($("#publish-module").attr("data-billing-type").indexOf("abtest") == -1 && $("#publish-module").attr("data-billing-type").indexOf("columns") == -1)){
		currencySymbol = EditorHelper.allSymbols[currencyCode];
		if (currencyCode !="USD"){
			$("#payment-form #override-currency").val(currencyCode);
		} 
	}

	if ($("#publish-module .domain-purchase").length > 0){
		
		if(LABEL_CONFIG && "DOMAIN_BILLING" in LABEL_CONFIG && LABEL_CONFIG.DOMAIN_BILLING.BILLING_TYPE == "Custom"){
			$("#payment-form #override-currency").val(LABEL_CONFIG.DOMAIN_BILLING.CUSTOM_CURRENCY);
			currencySymbol = EditorHelper.allSymbols[LABEL_CONFIG.DOMAIN_BILLING.CUSTOM_CURRENCY];
		}else{
			currencySymbol = "$";
			$("#payment-form #override-currency").val("USD");
		}
	}
	
	var taxRate = parseFloat($("#publish-module .total-price").attr("data-tax-rate")).toFixed(2);
	if (!isNaN(taxRate) && !excludeTax){
		priceWithTax = parseFloat(newPrice + (newPrice*(taxRate/100.0))).toFixed(2);
	}else{
		priceWithTax = newPrice
	}
	if (typeof keepOriginal == "undefined"){
		$("#payment-form #card-amount-int").val(newPrice);
	}
	$("#payment-form #card-amount-tax-int").val(priceWithTax);
	$(".total-price").html(currencySymbol + priceWithTax);
};

EditorHelper.loadHostedFields = function(callbackfunc){
	var paymentForm = $("#publish-module #payment-form");
	XPRSHelper.GET("https://impayment.herokuapp.com/hosted_fields_token",{}, function(res){
		paymentForm.find("#card-pf").val(res.token);
		var bsObj = {
			onFieldEventHandler: {
				// tagId returns: "ccn", "cvv", "exp" 
				onFocus: function(tagId) {}, // Handle focus
				onBlur: function(tagId) {}, // Handle blur 
				onError: function(tagId, errorCode /*, errorDescription*/) {}, 									
				onType: function(tagId, cardType  /*, cardData*/) {
				/* cardType will give card type, and only applies to ccn: CarteBleue, Visa, MasterCard, AmericanExpress, Discover, DinersClub, JCB, Solo, MaestroUK, ChinaUnionPay */
				if (null != cardType) {
					paymentForm.find("[data-bluesnap='ccn']").css("background-image","url(/images/payment/" + cardType.toLowerCase().replace(" ","-") +".png)");
					/* cardData is an optional parameter which will provide ccType, last4Digits, issuingCountry, isRegulatedCard, cardSubType, binCategory and ccBin details (only applies to ccn) in a JsonObject */
					// console.log(cardType); 
				}
				}, 
				onValid: function(tagId) {}, // Handle a change in validation
			}, 
			style: {
				":focus": {
					//style for all input elements on focus event
					"color": "white"
				},
				"input": {
					//style for all input elements 
					"color": "white",
					"font-size": "25px",
					// "left": "10px",
					"font-family": "Helvetica Neue,Helvetica,Arial,sans-serif"
				},
				"#year":{
					"width": "40px!important",
					"left": "60px!important"
				},
				"span":{
					"left":"52px",
					"top": "10px",
					"font-size": "25px",
					"width": "10px"
				},
				".invalid": {
					//style for all input elements when invalid
					"background-color": "#CC3333"
				}
			},
			ccnPlaceHolder: "1234 5678 9012 3456", //for example
			cvvPlaceHolder: "CVV", //for example
			expPlaceHolder: "MM/YY", //for example
			expDropDownSelector: false //set to true for exp. date dropdown
		};
					
		//Run the following command after Document Object Model (DOM) is fully loaded 
		bluesnap.hostedPaymentFieldsCreation(res.token, bsObj);
		if (typeof callbackfunc != "undefined"){
			callbackfunc();
		}
	}, "json");
}




EditorHelper.bindPaymentForm = function(callbackfunc){
	EditorHelper.loadHostedFields(function(){

	
	if (!EditorHelper.paymentBinded){
		EditorHelper.paymentBinded = true;
		var paymentForm = $("#publish-module #payment-form");
		var cardHolderName = paymentForm.find("#card-holdername");
		cardHolderName.unbind("change").bind("change",function(){
			$(this).removeClass("invalid");
		});
			paymentForm.submit(function(event) {
				// Deactivate submit button to avoid further clicks
				$("#publish-module #checkout-btn").attr("disabled", "disabled").addClass("loading-state");
				var formIsValid = EditorHelper.validatePaymentForm($(this));
				var offer = $("#publish-module #selected-offer");
				XPRSHelper.trackEvent('Pay',"General",offer.attr("data-offer-name"));
				var initialTemplate = XPRSHelper.getXprsCookie("xprs-initial-template");
				if (initialTemplate != null){
					XPRSHelper.trackEvent(initialTemplate +'-Pay',"General",initialTemplate);
				}
				XPRSHelper.POST("/log", {"log_info":"somebody clicked submit with the following: " + JSON.stringify(paymentForm.serialize()) ,"log_type":"payment_tracing"});
				if (formIsValid){
					
					var billingServer = "https://impayment.herokuapp.com/buypf";
					if (LABEL_CONFIG && "SETTINGS" in LABEL_CONFIG && LABEL_CONFIG.SETTINGS.BILLING_SERVER != ""){
						billingServer = LABEL_CONFIG.SETTINGS.BILLING_SERVER;
						paymentForm.find("#card-number").attr("name","card-number");
						paymentForm.find("#card-cvc").attr("name","card-cvc");
					}else{
						paymentForm.find("#card-number").attr("disabled","disabled");
						paymentForm.find("#card-cvc").attr("disabled","disabled");
					}
					var formFields = paymentForm.serialize();
	
					bluesnap.submitCredentials( function(callback){
						if (null != callback.cardData) {
						// 	console.log('card type: ' + callback.cardData.ccType +
						// 	', last 4 digits: ' + callback.cardData.last4Digits +
						// 	', exp: ' + callback.cardData.exp + 
						// 	', issuing Country: ' + callback.cardData.issuingCountry + 
						// 	', isRegulatedCard: ' + callback.cardData.isRegulatedCard + 
						// 	', cardSubType: ' + callback.cardData.cardSubType + 
						// 	', binCategory: ' + callback.cardData.binCategory + 
						// 	' and ccBin: ' + callback.cardData.ccBin + 
						//    ', after that I can call final submit');
							// submit the form
							EditorHelper.showModuleStep("publish",4);
							XPRSHelper.POST(billingServer,formFields,function(result){
								//console.log(JSON.stringify(result))
								if (typeof result["xml"] != "undefined" ){
			
									var subStart = result["xml"].indexOf("subscriptions") + "subscriptions".length + 1;
									var subEnd = result["xml"].indexOf("</url>",subStart);
									var subscriptionId = result["xml"].substring(subStart,subEnd);
									
									var offer = $("#publish-module #selected-offer");
									if (offer.attr("data-offer-id") != "3268196"){
										var subscriptionParams = formFields + "&subscription_id=" + subscriptionId + "&vbid=" + EditorHelper.getRootId() + "&offer_id=" +  offer.attr("data-offer-id") + "&offer_name=" + offer.attr("data-offer-name")
										XPRSHelper.POST("/subscription",subscriptionParams,function(result){
											 
										});
										EditorHelper.showModuleStep("publish",42);
										XPRSHelper.trackEvent('Combined_Premium',"General", $("#publish-module #my-offer").text(), paymentForm.find("#card-amount-int").val());
										if (offer.attr("data-offer-id") == "3288938"){
											XPRSHelper.trackEvent('Whitelabel Premium',"General", offer.attr("data-offer-id"), paymentForm.find("#card-amount-int").val());
										}else{
											XPRSHelper.trackEvent('Premium',"General", offer.attr("data-offer-id"), paymentForm.find("#card-amount-int").val());
										}
										
										try{
											if (typeof IMOS != "undefined"){
												IMOS.trackGoal("Premium",{"offer_name":offer.attr("data-offer-name"),"amount":paymentForm.find("#card-amount-int").val(),"subscription_id":subscriptionId,"site_id":"osid--imcreator"});
											}
											if (typeof imosSdk != "undefined"){
												imosSdk.addPurchase(offer.attr("data-offer-name"), paymentForm.find("#card-amount-int").val());
											}
										}catch(err){}
										XPRSHelper.updateParent({"deliver_to":"parent","action":"premium"});
										setTimeout(function(){
											EditorHelper.showModuleStep("publish",2);
											
											//deduct the coupon used
											XPRSHelper.GET("/deduct_coupon",{},function(result){
												
											});
										},2000);
									}else{
										var sld = $("#publish-module #sld").val().toLowerCase().replace("www.","").replace("http://","").replace("https://","");
										var tld = $("#publish-module #tld").val();
										var newDomainName = sld + "." + tld;
										$("#publish-module #existing-domain-field").val(newDomainName);
										XPRSHelper.updateParent({"deliver_to":"parent","action":"update_domain","domain":newDomainName});
										XPRSHelper.trackEvent('New Domain',"General",newDomainName);
										XPRSHelper.POST("/update_license_domain",{"vbid":EditorHelper.getRootId(),"domain":newDomainName,"email_buy_domain":true,"subscription_id":subscriptionId},function(result){
											EditorHelper.showModuleStep("publish",8);
												setTimeout(function(){
													EditorHelper.closeModule("publish");
												},3000);
											XPRSHelper.trackEvent('Combined_Premium',"General", "domain", paymentForm.find("#card-amount-int").val());
											XPRSHelper.trackEvent('Domaining',"General",newDomainName);
										},"json");
									}
								//Payment Validation failed
								}else{
									var validationError = "";
									if ("content" in result){
										console.log("this is the full error "+result["content"])
										var errStart = result["content"].indexOf("<description>") + "<description>".length;
										var errEnd = result["content"].indexOf("</description>",errStart);
										validationError = result["content"].substring(errStart,errEnd);
									}else{
										validationError = result["error"];
									}
									XPRSHelper.xprsAlert("We apologize for the inconvenience, please contact the support team to complete the payment",{title: "Payment Error","report_error":true});
									EditorHelper.showModuleStep("publish",3);
									var offer = $("#publish-module #selected-offer");
									XPRSHelper.trackEvent('Disapproved Payment',"General",offer.attr("data-offer-name"));
									XPRSHelper.POST("/log", {"log_info":JSON.stringify(result),"log_type":"payment_reject"});
									$("#publish-module #checkout-btn").removeAttr("disabled").removeClass("loading-state");
									paymentForm.find("#card-number").removeAttr("disabled");
									paymentForm.find("#card-cvc").removeAttr("disabled");
									EditorHelper.failSafePayment();
								}
							},"json").error(function(xhr, textStatus, errorThrown){
								XPRSHelper.xprsAlert("We apologize for the inconvenience, please contact the support team to complete the payment",{title: "Payment Error","report_error":false});
								XPRSHelper.trackEvent('impayment failed',"General", offer.attr("data-offer-name"));
								$("#publish-module #checkout-btn").removeAttr("disabled").removeClass("loading-state");
								EditorHelper.showModuleStep("publish",3);
							});
						} else {
							var errorArray = callback.error;
							// for (i in errorArray) {
							// 	console.log("Received error: tagId= " +
							// 	errorArray[i].tagId + ", errorCode= " +
							// 	errorArray[i].errorCode + ", errorDescription= " +
							// 	errorArray[i].errorDescription);
							// }
							$("#publish-module #checkout-btn").removeAttr("disabled").removeClass("loading-state");
						}
					});
	
					
					
	
					
					
				}else{
					var offer = $("#publish-module #selected-offer");
					XPRSHelper.trackEvent('Disapproved Payment',"General",offer.attr("data-offer-name"));
					$("#publish-module #checkout-btn").removeAttr("disabled").removeClass("loading-state");;
				}
				
				return false;
			  });
	}
		if (typeof callbackfunc != "undefined"){
			callbackfunc();
		}
	});
};



EditorHelper.validatePaymentForm = function(paymentForm){
	// var cardNumber = paymentForm.find("#card-number");
	// if (!cardNumber.val()){
	// 	cardNumber.addClass("invalid");
	// 	cardNumber.attr("alt","Invalid card number");
	// }
	// var cardCvc = paymentForm.find("#card-cvc");
	// if (!cardCvc.val()){
	// 	cardCvc.addClass("invalid");
	// 	cardCvc.attr("alt","Invalid cvc number");
	// }
	// var cardYear = paymentForm.find("#card-expiry-year");
	// if (cardYear.val().length == 2){
	// 	cardYear.val("20" + cardYear.val());
	// }
	// var cardMonth = paymentForm.find("#card-expiry-month");
	// if (cardMonth.val().length == 1){
	// 	cardMonth.val("0" + cardMonth.val());
	// }
	// var expiryIsValid =  paymill.validateExpiry(cardMonth.val(),cardYear.val());
	// if (expiryIsValid){
	// 	cardMonth.removeClass("invalid");
	// 	cardYear.removeClass("invalid");
	// }else{
	// 	cardYear.addClass("invalid");
	// 	cardMonth.addClass("invalid");
	// }
	
	var countryField = paymentForm.find("#user-country");
	var stateField = paymentForm.find("#user-state");
	if (countryField.val() == "-1"){
		countryField.addClass("invalid");
	}
	if (countryField.val() == "us" && stateField.val() == "-1"){
		stateField.addClass("invalid");
	}
	
	var firstName = paymentForm.find("#card-holder-first-name");
	var lastName = paymentForm.find("#card-holder-last-name");
	var zipcode = paymentForm.find("#zipcode");
	if (!firstName.val()){
		firstName.addClass("invalid");
	}else{
		firstName.removeClass("invalid");
	}
	if (!lastName.val()){
		lastName.addClass("invalid");
	}else{
		lastName.removeClass("invalid");
	}
	if (!zipcode.val()){
		zipcode.addClass("invalid");
	}else{
		zipcode.removeClass("invalid");
	}
	
	
	var invalidFields = paymentForm.find(".invalid");
	if (invalidFields.length > 0){
		return false;
	}else{
		return true;
	}
};



EditorHelper.handleDevicePreview = function(params, callbackFunc){
	EditorHelper.mode = "preview";
	if (params.device_type == "desktop"){
		EditorHelper.reactivateStripeHoverControls();
		EditorHelper.mode = "guest";
	}else{
		EditorHelper.closeDraggableTabbedPanel();
		EditorHelper.deactivateStripeHoverControls();
	}
	$("body").removeClass("cellphone-preview tablet-preview desktop-preview");
	$("body").addClass(params.device_type + "-preview");
	$("#empty-stripe").remove();
	$(".force-show").removeClass("force-show");
	EditorHelper.removeUnusedUi();
	setTimeout(function(){
		SpimeEngine.UpdateDeviceClass();
		EditorHelper.adjustUI();
		LightBox.arrange();
		$(".master.item-box").each(function(index) {
			SpimeEngine.ArrangeHolder($(this))
		});
		if (callbackFunc !== undefined){
			callbackFunc();
		}
	},0);
};


EditorHelper.stripeDataChange = function(params){
		var skipUpdate = typeof params.skip_update != "undefined";
		var targetHolder = $("#" + params.target);
		var newValue = params.new_value;
		if (params.prop.indexOf("padding")!= -1){
			var topOrBottom = params.prop.substring(params.prop.indexOf("-") + 1);
			EditorHelper.changeStripePadding(targetHolder,topOrBottom,newValue,skipUpdate);
			return;
		}
		if (params.prop == "max-width"){
			EditorHelper.ChangeStripeMaxWidth(targetHolder,newValue);
			SpimeEngine.ArrangeHolder(targetHolder);
			return;
		}
		if (params.prop == "height"){
			targetHolder.css(params.prop,newValue);
			SpimeEngine.ArrangeHolder(targetHolder);
			return;
		}
		if (params.prop == "content-width"){
			EditorHelper.updateDomStripeData(params);
			SpimeEngine.ArrangeHolder(targetHolder);
			return;
		}
		if (params.prop == "content-padding"){
			EditorHelper.updateDomStripeData(params);
			SpimeEngine.ArrangeHolder(targetHolder);
			return;
		}
		
		targetHolder.find(params.class_name).css(params.prop,newValue);
};

EditorHelper.updateDomStripeData = function(params){
	var targetHolder = $("#" + params.target);
	targetHolder.find(".stripe-data").attr("data-" + params.prop,params.new_value);
};


EditorHelper.scrollToItem = function(params,callbackFunc){
	var topPadding = 0;
	if (typeof params.top_padding != "undefined"){
		topPadding = params.top_padding
	}
	var elementToEdit = $("#" + params.vbid);
	var menuOffset = SpimeEngine.calculateScrollOffset();
	
	var middleOffset = 0;
	if (typeof params.to_top != "undefined"){
		if (elementToEdit.hasClass("master")){
			var stripeHeight = elementToEdit.height();
			var xprsHeight = $("body").height();
			if (stripeHeight < xprsHeight){
				 middleOffset = (xprsHeight/2) -  (stripeHeight/2);
			}
		}
	}
	if (elementToEdit.length > 0){
		if (typeof params.if_not_in_view != "undefined"){
			if (EditorHelper.elementInView(elementToEdit)){
				if (typeof callbackFunc != "undefined"){
					callbackFunc();
				}
				return;
			}
		}
		var scrollSpeed = 2000;
		
		if (typeof params.scroll_speed != "undefined"){
			scrollSpeed = params.scroll_speed;
		}
		
		
		var scrollto = elementToEdit.offset().top -  middleOffset - topPadding;
		if (params.item_top){
			scrollto = elementToEdit.offset().top -topPadding;
		}
		if (scrollto != $("body").scrollTop()){
			$("body").animate({scrollTop:scrollto},scrollSpeed,'easeOutQuart',callbackFunc);
		}else{
			if (typeof callbackFunc != "undefined"){
				callbackFunc();
			}
		}
		
	}
	
};




EditorHelper.elementInView = function(element, fullyInView){
    var pageTop = $(window).scrollTop();
    var pageBottom = pageTop + $(window).height();
    var elementTop = $(element).offset().top;
    var elementBottom = elementTop + $(element).height();

    if (fullyInView === true) {
        return ((pageTop < elementTop) && (pageBottom > elementBottom));
    } else {
        return ((elementBottom <= pageBottom) && (elementTop >= pageTop));
    }
}


EditorHelper.addPageToMenu = function(params){
	var menuId = EditorHelper.checkIfMenuExists();
	var homePath = "/" + EditorHelper.getRootId();
	var itemHref = homePath + "/" + params.page_id;
	if (menuId){
		if (EditorHelper.getHolderById(menuId).css("display") == "none"){
			EditorHelper.resetMenuLayout(menuId);
		}
		EditorHelper.handleAddLinkToMenu({"vbid":menuId,"link_name":params.page_name,"link_href":itemHref,"new_vbid":params.page_id,"initiated_from_editor":false});
	}else{
		var message = "Whould you like us to create one for you?"
			XPRSHelper.xprsAlert(message,{title: "This website does not have a menu", showCancelButton: true,confirmButtonText:"Yes, Thank you",cancelButtonText:"No, never mind...","callbackfunc":function(isConfirm){
				if(isConfirm){
					EditorHelper.showManagePagesLoader();
					EditorHelper.createNewMenu(function(){
						EditorHelper.handleAddLinkToMenu({"vbid":menuId,"link_name":params.page_name,"link_href":itemHref,"new_vbid":params.page_id,"initiated_from_editor":false});
						EditorHelper.removeManagePagesLoader();
					});
				}
		}});
	}
};



EditorHelper.showManageMenu = function(params){
	var menuId = EditorHelper.checkIfMenuExists();
	if (menuId){
		if (EditorHelper.getHolderById(menuId).css("display") == "none"){
			EditorHelper.resetMenuLayout(menuId);
		}
		var menuStripe = EditorHelper.getHolderById(menuId);
		EditorHelper.showDraggableTabbedPanel("menu-edit",menuStripe);
	}else{
		var message = "Whould you like us to create one for you?"
		XPRSHelper.xprsAlert(message,{title: "This website does not have a menu", showCancelButton: true,confirmButtonText:"Yes, Thank you",cancelButtonText:"No, never mind...","callbackfunc":function(isConfirm){
			if(isConfirm){
				EditorHelper.createNewMenu(EditorHelper.showManageMenu);
			}
		}});
	}
};

EditorHelper.createNewMenu = function(callbackFunc){
	XPRSHelper.POST("/safe_clone", {
		vbid : "MENU_TEMPLATE",
		original_parent_id:"MASTER_TEMPLATE",
		clone_into:EditorHelper.getRootId(),
		page_id : EditorHelper.getPageId(),
		clone_after_id:"first",
		child_type:"MENUS",
		child_context:"PAGE"
	}, function(result) {
		if ("limit_reached" in result){
			if (LABEL_CONFIG && "META" in LABEL_CONFIG && LABEL_CONFIG.META.NAME == "aabaco"){
				if (typeof YSBApp != "undefined"){
					YSBApp.send({"action": "restricted-upsell", "appid": "ywebsite"});
				}
			}else{
				XPRSHelper.xprsAlert("Please upgrade your license in order to create more stripes",{title: "Section Limit Reached", showCancelButton: false,confirmButtonText:"OK","callbackfunc":function(isConfirm){
				}});
			}
			return;
		}
		var cloneId = result.clone_id;
		//XPRSHelper.SAFEPOST("/add_child", {"vbid":clonedId,"parent_vbid":EditorHelper.getRootId(), "preset_type": "MENUS","child_context":"PAGE", "clone_after_id":"first"},EditorHelper.getRootId(),"ADD-CHILD",function(result) {
			//var cloneId = result.new_id;
			$("#empty-stripe").remove()
			var addedHolder = $("<div />").addClass("master item-box animated-height").attr("id","empty-stripe");
			$(".master.container > #children").prepend(addedHolder);
			addedHolder.attr("id",cloneId).css("background-color","black");
			addedHolder.attr("data-preset-type-id","MENUS");
			var params = {};
			params["vbid"] = cloneId;
			params["parent_vbid"] = EditorHelper.getRootId();
			var parentsList = EditorHelper.getParentsList(addedHolder);
			parentsList.push(cloneId);
			EditorHelper.reloadPart(params,function(){
				//EditorHelper.updateParent({"deliver_to":"editor","action":"invalidate","vbid":EditorHelper.getRootId()});
				if (typeof callbackFunc != "undefined"){
					setTimeout(function(){
						callbackFunc();	
					},500);
					
				}
			});
		//});
	});
};


EditorHelper.checkIfMenuExists = function(){
	var selectedMenu = $(".master.item-box[data-preset-type-id='MENUS']");
	if (selectedMenu.length > 0){
		return selectedMenu.attr("id");
	}else{
		return false;
	}
};

EditorHelper.isLastElement = function(element){
	var item = EditorHelper.getHolderParent(element);
	var numOfPreviewItems = item.find(".preview-element").not(".background-div").length
	var isImage = element.attr("data-menu-name") == "PREVIEW_IMAGE";
	var noImage = item.find(".preview-element.background-div#no-image").length > 0;
	if (numOfPreviewItems == 0 && isImage){
		return true;
	}else if(numOfPreviewItems == 1 && noImage){
		return true;
	}else{
		return false;
	}
};




EditorHelper.updateAddToMenuBtn = function(){
	var menuId = EditorHelper.checkIfMenuExists();
	if (menuId){
		var numOfLinksToPageInMenu = $("#" +menuId +  " a[data-link-type='EXISTING']").filter("[data-href$='"+EditorHelper.getPageId()+"']").length;
		if (numOfLinksToPageInMenu == 0){
			XPRSHelper.updateParent({"deliver_to":"parent","action":"show-add-to-menu"});
			return;
		}
	}
	XPRSHelper.updateParent({"deliver_to":"parent","action":"hide-add-to-menu"});
};


EditorHelper.showAddPageMenu = function(mode,params){
	$(".floating-plus").removeClass("open").addClass("hidden");
	var isAdmin = false;
	if (typeof params.is_admin != "undefined"){
		isAdmin = params.is_admin;
	}
	EditorHelper.closeDraggableTabbedPanel();
	var newPageBlocker = $(".new-page-blocker");
	if (!params.inline_load){
		newPageBlocker.remove();
		$("html").css("overflow","hidden");
		newPageBlocker = $("<div />")//.addClass("loading");
		newPageBlocker.addClass("new-page-blocker animated-opacity").css({"position":"fixed","top":"0px","left":"0px","width":"100%","height":"100%","background-color":"#333","z-index":"999999999","text-align":"center","opacity":"0"});
		$("body").append(newPageBlocker);
	}else{
		newPageBlocker.empty();
	}
	EditorHelper.showManagePagesLoader();
	
	var closeBtn = $("<div />").addClass("close-new-page-menu-btn clickable t-t").text("CLOSE").css({"position":"fixed","right":"0px","margin-right":"50px","margin-top":"70px","color":"#999","font-family": "Arial"});
	var mainTitle = $("<div />").addClass("new-page-menu-title t-t").text("Add a new Page:").css({"float":"left","margin-top":"50px","margin-left":"100px","font-size":"36px","font-family":"HelveNueThinNormal","color":"white"});
	var subTitle = $("<div />").addClass("new-page-menu-subtitle").text(XPRSTranslator.translateText("Select the page you would like to copy and add to your website")).css({"float":"left","clear": "both","margin-left":"100px","margin-top": "4px","font-size":"16px","text-align": "left","font-family":"Arial","color":"#999"});
	newPageBlocker.append(mainTitle);
	newPageBlocker.append(subTitle);
	newPageBlocker.append(closeBtn);
	closeBtn.unbind("click").bind("click",function(e){
		e.stopPropagation();
		$("html").css("overflow","");
		newPageBlocker.remove();
		$(".floating-plus").removeClass("hidden");
		if (typeof VueEditor != "undefined"){
			VueEditor._router.push("/");
		}
	});
	var pagesListHolder = $("<div />").css({"max-width":"1300px","margin-left":"auto","margin-right":"auto","margin-top":"135px"});
	var pagesList = $("<ul />").css({"text-align":"left"});
	var getPagesParams = {"root_id":EditorHelper.getRootId(),"exclude_posts":true};
	if (mode == "manage-pages"){
		mainTitle.text("Manage Pages:");
		subTitle.html(XPRSTranslator.translateText("Order, duplicate, rename or move your website pages <br> Please note that any changes you make here does not affect your website menu. To manage your menu, "));
		var manageMenuBtn = $("<span />").text(" click here.").addClass("clickable t-t").css("text-decoration","underline").click(function(){
			EditorHelper.showManageMenu(event.data);
		});
		subTitle.append(manageMenuBtn);
	}else if (mode == "select-page"){
		mainTitle.text("Select page to connect:");
		subTitle.text("Select the page you would like to go to when clicking the link");
		getPagesParams["include_template_pages"] = true;
	}else{
		getPagesParams["include_template_pages"] = true;
	}
	if (mode == "posts"){
		mainTitle.text("Blog Posts");
		getPagesParams["only_posts"] = true;
		delete getPagesParams["exclude_posts"];
		delete getPagesParams["include_template_pages"];
		subTitle.html(XPRSTranslator.translateText("Manage your blog posts"));
	}
	XPRSHelper.GET("/get_pages",getPagesParams,function(pages){
		if ("ORDERED_PAGES" in pages){
			var showingTemplatePages = false;
			for(i in pages["ORDERED_PAGES"]){
				var pageId = pages["ORDERED_PAGES"][i];
				if (pageId != null && pageId != "null"){
					var pageLi = $("<li />").attr("id",pageId).addClass("page-block");
					var pageRoot = EditorHelper.getRootId();
					if ("FROM_TEMPLATE" in pages[pageId]){
						if (!showingTemplatePages){
							showingTemplatePages = true;
							var pagesSeperator = $("<li />").addClass("pages-seperator").css({"display":"block","height":"1px","background-color":"#999"});
							pagesList.append(pagesSeperator);
						}
						pageLi.attr("data-original-parent",pages[pageId]["FROM_TEMPLATE"]);
						pageRoot = pages[pageId]["FROM_TEMPLATE"].replace("-PAGES","");
						pageLi.addClass("from-template")
					}else{
						pageLi.attr("data-original-parent",EditorHelper.getRootId() + "-PAGES");
					}
					var pageThumb = $("<img />").css({"width":"200px","height":"200px"}).addClass("clickable page-thumb animated-opacity").attr("id","img-"+pageId);
					var srcUrl = window.location.protocol +"//" + window.location.host + "/viewer/" + pageRoot + "/" + pageId + "?disable_effects=true";
					var apiKey = "8427fb045a2f4098";
					var apiKeyDict = {
							".imxprs.com":"8427fb045a2f4098",
							"imspime.appspot.com":"b3ad70e62b4ab1f4",
							"localhost":"97ebf881e6686e67",
							".imcreator.com":"bfc53b5f3da2c58f"
					};
					for(d in apiKeyDict){
						if (window.location.host.indexOf(d) != -1){
							apiKey = apiKeyDict[d]
						}
					}
					var imgP2ISrc = "/get_page_thumb?root_id=" + pageRoot + "&page_id=" + pageId;
					pageLi.css({"background-image":"url('/images/ui_icons/no_thumb.png')","background-position":"top","background-size":"200px","background-repeat":"no-repeat"});
					pageThumb.css("opacity",0);
					pages[pageId].NAME = (pages[pageId].NAME)? pages[pageId].NAME : "Untitled";
					pageLi.attr("data-page-name",pages[pageId].NAME);
						//request thumbs
					pageThumb.attr("src",imgP2ISrc).attr("data-page-id",pageId).error(function(){
						var erredImage = $(this);
						setTimeout(function(){
							erredImage.attr("src","/get_page_thumb?root_id=" + EditorHelper.getRootId() + "&page_id=" + erredImage.attr("data-page-id"));
						},5000);
					}).load(function(){
						$(this).css("height","");
						$(this).css("opacity",1);
						$(this).parent().css("background-image","");
					});
					//}
					var pageText = $("<div />").text(pages[pageId].NAME).css({"color":"white","font-family":"Arial","margin-top":"10px"});
					if (mode == "manage-pages" || mode == "posts"){
						pageText = $("<input type='text' />").val(pages[pageId].NAME).css({"font-size":"16px","display":"block","background-color":"#333","outline":"none","border":"none","color":"white","font-family":"Arial","margin-top":"10px"});
						pageText.unbind("click").bind("click",function(e){e.stopPropagation();});
						pageText.unbind("change").bind("change",function(e){
							e.stopPropagation();
							var pageNameField = $(this);
							var pageToRename = pageNameField.closest(".page-block");
							XPRSHelper.SAFEPOST("/update_page_name",{"vbid" : pageToRename.attr("id"),"root_id":pageRoot,"new_name":pageNameField.val()},pageRoot + "-PAGES","RENAME-CHILD",function() {
								XPRSHelper.updateParent({"deliver_to":"parent","action":"changed-page-name","vbid":pageToRename.attr("id"),"new_name":pageNameField.val()});
							});
						});
					}
					pageLi.append(pageThumb);
					pageLi.append(pageText);
					
					if (mode == "manage-pages" || mode == "posts"){
						
						pageThumb.unbind("click").bind("click",function(){
							var clickedPageId = $(this).parent().attr("id");
							EditorHelper.showManagePagesLoader();
							
							XPRSHelper.updateParent({"deliver_to":"parent","action":"navigate-viewer","vbid":clickedPageId});
						});
						
						if (pageId != pageRoot){
							var pageControlsHolder = $("<div/>").addClass("page-control-holder");
							var pageControlsMenu = $("<ul/>").addClass("page-control-menu");
							var deletePageBtn = $("<li/>").addClass("page-control-option clickable").append("<img src='/images/ui_icons/sure.png' />");
							deletePageBtn.unbind("click").bind("click", function(e) {
								e.stopPropagation();
								var btnClicked = $(this);
								var message = "This action could not be undone";
								var pageToDelete = btnClicked.closest(".page-block");
								XPRSHelper.xprsAlert(message,{title: "Delete page?", showCancelButton: true,confirmButtonText:"Yes , delete this page",cancelButtonText:"let me think about it..","callbackfunc":function(isConfirm){
									if(isConfirm){
										pageToDelete.remove();
										XPRSHelper.SAFEPOST("/remove_child",{"parent":pageRoot + "-PAGES","child":pageToDelete.attr("id")},pageRoot + "-PAGES",{"action_name":"REMOVE-CHILD","pretty_name":"Remove Page"},function() {
											XPRSHelper.updateParent({"deliver_to":"parent","action":"invalidate-page-list"});
										});
									}
								}});
							});
							var moveUpBtn = $("<li/>").addClass("page-control-option move-up clickable").append("<img src='/images/ui_icons/move_left.png' />");
							moveUpBtn.unbind("click").bind("click",function(e){
								e.stopPropagation();
								var btnClicked = $(this);
								var pageToMove = btnClicked.closest(".page-block");
								pageToMove.prev().before(pageToMove);
								XPRSHelper.SAFEPOST("/move_child",{"parent":pageRoot + "-PAGES" , "vbid": pageToMove.attr("id"),"direction":"up"},pageRoot + "-PAGES","MOVE-CHILD");
							});
							
							var moveDownBtn = $("<li/>").addClass("page-control-option move-down clickable").append("<img src='/images/ui_icons/move_right.png' />");
							moveDownBtn.unbind("click").bind("click",function(e){
								e.stopPropagation();
								var btnClicked = $(this);
								var pageToMove = btnClicked.closest(".page-block");
								pageToMove.next().after(pageToMove);
								XPRSHelper.SAFEPOST("/move_child",{"parent":pageRoot + "-PAGES" , "vbid": pageToMove.attr("id"),"direction":"down"},pageRoot + "-PAGES","MOVE-CHILD");
							});
							
							
							var cloneBtn = $("<li/>").addClass("page-control-option clickable").append("<img src='/images/ui_icons/clone_on.png' />");
							
							cloneBtn.unbind("click").bind("click", function(event) {
								event.stopPropagation();
								var btnClicked = $(this);
								var pageToClone = btnClicked.closest(".page-block");
								var placeHolder = pageToClone.clone(true);
								placeHolder.attr("id","placeholder");
								placeHolder.find("input").attr("disabled","disabled").css("color","#999");
								placeHolder.find(".page-control-holder").addClass("disabled");
								var loadingDiv = $("<div />").addClass("placeholder-loader").css({"position":"absolute","left":"0px","top":"0px","background-color":"rgba(0,0,0,0.5)","width":"100%","height":pageToClone.find(".page-thumb").height()});
								loadingDiv.append("<img src='/images/x_loader.gif' style='width:50px;position:absolute;top: 50%;;left: 50%;margin-left: -27px;margin-top: -29px;' />" );
								placeHolder.append(loadingDiv);
								pageToClone.after(placeHolder);
								
								
								var message = "";
								XPRSHelper.xprsAlert(message,{title: "Name your new page", showCancelButton: true,closeOnConfirm:false,type: "input",inputPlaceholder:EditorHelper.incrementPageName(pageToClone.attr("data-page-name")),confirmButtonText:"Add page",cancelButtonText:"Cancel","callbackfunc":function(pageName){
									if(typeof pageName == "string"){
										if (pageName == ""){
											pageName = pageToClone.attr("data-page-name");
											pageName = EditorHelper.incrementPageName(pageName);
										}
									}else{
										placeHolder.remove();
										return;
									}
									placeHolder.find("input").val(pageName);
									placeHolder.attr("data-page-name",pageName);
									var menuId = EditorHelper.checkIfMenuExists();
									EditorHelper.showManagePagesLoader();
									XPRSHelper.POST("/safe_clone", {
										vbid : pageToClone.attr("id"),
										clone_into : EditorHelper.getRootId() + "-PAGES",
										original_parent_id : pageToClone.attr("data-original-parent"),
										keep_style : true,
										skip_stripe_data: true,
										clone_after_id:pageToClone.attr("id"),
										new_name:pageName,
										child_type:"PAGE",
										get_target_creator:true
									}, function(result) {
											EditorHelper.removeManagePagesLoader();
											if ("limit_reached" in result){
												if (LABEL_CONFIG && "META" in LABEL_CONFIG && LABEL_CONFIG.META.NAME == "aabaco"){
													if (typeof YSBApp != "undefined"){
														YSBApp.send({"action": "restricted-upsell", "appid": "ywebsite"});
													}
												}else{
													XPRSHelper.xprsAlert("Please upgrade your license in order to create more pages",{title: "Page Limit Reached", showCancelButton: false,confirmButtonText:"OK","callbackfunc":function(isConfirm){
													}});
												}
												return;
											}
											var cloneId = result.clone_id;
											placeHolder.attr("id",cloneId);
											EditorHelper.updatePageName({"vbid":cloneId,"new_name":pageName});
											message = XPRSTranslator.translateText("Do you want to add the page as a link to your menu?\n (you can do it later as well)");
											var dialogTitle = XPRSTranslator.translateText("Page") + " '" + pageName + "' " + XPRSTranslator.translateText("was added to your site")
												XPRSHelper.xprsAlert(message,{"do_not_translate":true, title: dialogTitle,closeOnConfirm:menuId, showCancelButton: true,confirmButtonText:"Yes please",cancelButtonText:"Later..","callbackfunc":function(confirm){
													setTimeout(function(){XPRSHelper.updateParent({"deliver_to":"parent","action":"invalidate-page-list"});},1000);
													if (menuId){
														if (EditorHelper.getHolderById(menuId).css("display") == "none"){
															EditorHelper.resetMenuLayout(menuId);
														}
														var pageVbid = cloneId;
														var homePath = "/" + EditorHelper.getRootId();
														//var itemHref = window.location.protocol +"//" + window.location.host + "/viewer" + homePath + "/" + pageVbid;
														var itemHref = homePath + "/" + pageVbid;
														if (confirm){
															//XPRSHelper.POST("/add_existing_page_to_menu",{"root_id":EditorHelper.getRootId(),"label":pageName,"page_vbid":pageVbid},function(res){
																EditorHelper.handleAddLinkToMenu({"vbid":menuId,"link_name":pageName,"link_href":itemHref,"initiated_from_editor":false});
																placeHolder.find("input").removeAttr("disabled").css("color","white")
																placeHolder.find(".page-control-holder").removeClass("disabled");
																placeHolder.find(".placeholder-loader").remove();
																EditorHelper.removeManagePagesLoader();
															//},"json");
														}else{
															placeHolder.find("input").removeAttr("disabled").css("color","white")
															placeHolder.find(".page-control-holder").removeClass("disabled");
															placeHolder.find(".placeholder-loader").remove();
														}
													}else{
														var pageVbid = cloneId;
														var homePath = "/" + EditorHelper.getRootId();
														//var itemHref = window.location.protocol +"//" + window.location.host + "/viewer" + homePath + "/" + pageVbid;
														var itemHref = homePath + "/" + params.page_id;
														var message = "Whould you like us to create one for you?"
														XPRSHelper.xprsAlert(message,{title: "This website does not have a menu", showCancelButton: true,confirmButtonText:"Yes, Thank you",cancelButtonText:"No, never mind...","callbackfunc":function(isConfirm){
															if (confirm){
																EditorHelper.showManagePagesLoader();
																EditorHelper.createNewMenu(function(){
																	//XPRSHelper.POST("/add_existing_page_to_menu",{"root_id":EditorHelper.getRootId(),"label":pageName,"page_vbid":pageVbid},function(res){
																		EditorHelper.handleAddLinkToMenu({"vbid":menuId,"link_name":pageName,"link_href":itemHref,"initiated_from_editor":false});
																		placeHolder.find("input").removeAttr("disabled").css("color","white")
																		placeHolder.find(".page-control-holder").removeClass("disabled");
																		placeHolder.find(".placeholder-loader").remove();
																		EditorHelper.removeManagePagesLoader();
																	//},"json");
																});
															}else{
																placeHolder.find("input").removeAttr("disabled").css("color","white")
																placeHolder.find(".page-control-holder").removeClass("disabled");
																placeHolder.find(".placeholder-loader").remove();
															}
														}});
													}
												}});
												XPRSHelper.trackEvent('Added Page',"General","", 0,true);
										});
								}});
							});
							
							if (mode != "posts"){
								pageControlsMenu.append(moveUpBtn)
								pageControlsMenu.append(cloneBtn)
							}
							pageControlsMenu.append(deletePageBtn);
							if (mode != "posts"){
								pageControlsMenu.append(moveDownBtn);
							}
							pageControlsHolder.append(pageControlsMenu);
							pageLi.append(pageControlsHolder);
						}
					}
					if (mode == "add-page"){
						pageLi.unbind("click").bind("click",function(){
							var currentLink = $(this);
							EditorHelper.clonePageFlow(currentLink.attr("id"),currentLink.attr("data-page-name"),pageLi.attr("data-original-parent"));
						});
					}
					if (mode == "select-page"){
						pageLi.unbind("click").bind("click",function(e){
							e.stopPropagation();
							//do not allow selecting multiple pages
							if (pagesList.find(".chosen-link").length == 0){
								var currentLink = $(this);
								var clickedElement = params.initiating_element;
								if(typeof clickedElement == "undefined"){
									clickedElement = $("#" + params.element_id) ;
								}
								if (currentLink.is(".from-template")){
									var message = "This page is currently not a part of your website, do you want to add it?"
									XPRSHelper.xprsAlert(message,{title: "Add page to website?", closeOnConfirm:false,showCancelButton: true,confirmButtonText:"Yes, Thank you",cancelButtonText:"No, never mind...","callbackfunc":function(isConfirm){
										if (confirm){
											var message = "";
											XPRSHelper.xprsAlert(message,{title: "Name your new page", showCancelButton: true,type: "input",inputPlaceholder:EditorHelper.incrementPageName(currentLink.attr("data-page-name")),confirmButtonText:"Add page",cancelButtonText:"Cancel","callbackfunc":function(pageName){
												if(typeof pageName == "string"){
													if (pageName == ""){
														pageName = currentLink.attr("data-page-name");
														pageName = EditorHelper.incrementPageName(pageName);
													}
												}else{
													return;
												}
												currentLink.find("img , div").addClass("animated-opacity").css("opacity",0);
												currentLink.prepend($("<div class='chosen-link'/>"));
												EditorHelper.showManagePagesLoader();
												XPRSHelper.POST("/safe_clone", {
													vbid : currentLink.attr("id"),
													clone_into : EditorHelper.getRootId() + "-PAGES",
													original_parent_id : currentLink.attr("data-original-parent"),
													keep_style : true,
													skip_stripe_data: true,
													clone_after_id:"last",
													new_name:pageName,
													child_type:"PAGE",
													get_target_creator:true
												}, function(result) {
													if ("limit_reached" in result){
														if (LABEL_CONFIG && "META" in LABEL_CONFIG && LABEL_CONFIG.META.NAME == "aabaco"){
															if (typeof YSBApp != "undefined"){
																YSBApp.send({"action": "restricted-upsell", "appid": "ywebsite"});
															}
														}else{
															XPRSHelper.xprsAlert("Please upgrade your license in order to create more pages",{title: "Page Limit Reached", showCancelButton: false,confirmButtonText:"OK","callbackfunc":function(isConfirm){
															}});
														}
														return;
													}
													//EditorHelper.removeManagePagesLoader();
													var cloneId = result.clone_id;
													//NEED TO UPDATE PAGES NAMES
													//EditorHelper.pagesDetails[cloneId] = {};
													//EditorHelper.pagesDetails[cloneId]["NAME"] = pageName;
													var urlForLink = "/" + EditorHelper.getRootId() + "/" + cloneId;
													EditorHelper.wrapElementWithLink(clickedElement,urlForLink,"EXISTING");
													var newLinkJson = {"TYPE":"EXISTING","URL":urlForLink};
													setTimeout(function(){
														var stripeId = clickedElement.closest(".master.item-box").attr("id");
														XPRSHelper.SAFEPOST("/update_specific_child_key",{"vbid":EditorHelper.getHolderParent(clickedElement).attr("id"),"child_vbid":clickedElement.attr("id"),"updated_key":"LINK","updated_value":JSON.stringify(newLinkJson),"type":"json","stripe_id":stripeId},EditorHelper.getHolderParent(clickedElement).attr("id"),"UPDATE-CHILD",function() {
															//EditorHelper.updateParent({"deliver_to":"editor","action":"invalidate","vbid":EditorHelper.getHolderParent(clickedElement).attr("id")});
															XPRSHelper.updateParent({"deliver_to":"parent","action":"navigate-viewer","vbid":cloneId});
														});
														
														//	$("html").css("overflow","");
														//	newPageBlocker.remove();
													},500);
													XPRSHelper.trackEvent('Added Page',"General","",0,true);
												});
											}});
										}
									}});
								}else{
									currentLink.find("img , div").addClass("animated-opacity").css("opacity",0);
									currentLink.prepend($("<div class='chosen-link'/>"));
									var urlForLink = "/" + EditorHelper.getRootId() + "/" + currentLink.attr("id");
									if (EditorHelper.getRootId() == currentLink.attr("id")){
										 urlForLink = "/" + EditorHelper.getRootId();
									}
									EditorHelper.wrapElementWithLink(clickedElement,urlForLink,"EXISTING");
									var newLinkJson = {"TYPE":"EXISTING","URL":urlForLink};
									var stripeId = clickedElement.closest(".master.item-box").attr("id");
									XPRSHelper.SAFEPOST("/update_specific_child_key",{"vbid":EditorHelper.getHolderParent(clickedElement).attr("id"),"child_vbid":clickedElement.attr("id"),"updated_key":"LINK","updated_value":JSON.stringify(newLinkJson),"type":"json","stripe_id":stripeId},EditorHelper.getHolderParent(clickedElement).attr("id"),"UPDATE-CHILD",function() {
										//EditorHelper.updateParent({"deliver_to":"editor","action":"invalidate","vbid":EditorHelper.getHolderParent(clickedElement).attr("id")});
									});
									setTimeout(function(){
										$("html").css("overflow","");
										newPageBlocker.remove();
										if (typeof VueEditor != "undefined"){
											VueEditor._router.push("/");
										}
									},1500);
								}
							}
						});
					}
					pagesList.append(pageLi);
				}
			}
			
			
			if(isAdmin=="True" && mode == "manage-pages"){
				var shortcodesBtn = $("<li />").attr("id","shortcode-btn").css({"display":"inline-block","margin":"30px 50px"}).addClass("clickable page-block");
				var pageThumb = $("<div />").css({"width":"200px","height":"200px","border":"3px solid #999"}).addClass("clickable page-thumb");
				var pageText = $("<div />").text("SHORTCODES").css({"color":"white","font-family":"Arial","margin-top":"10px"}).addClass("t-t");
				shortcodesBtn.append(pageThumb);
				shortcodesBtn.append(pageText);
				shortcodesBtn.unbind("click").bind("click",function(){
					XPRSHelper.updateParent({"deliver_to":"parent","action":"navigate-viewer","vbid":EditorHelper.shortcodesJson["ID"],"additional_item_class":"shortcodes-page"});
				});
				pagesList.prepend(shortcodesBtn);
			}
		}

		if (mode == "manage-pages" && pages["found_posts"]){
			var postsBtn = $("<li />").attr("id","posts-btn").css({"display":"inline-block","margin":"30px 50px"}).addClass("clickable page-block");
			var pageThumb = $("<div />").css({"width":"200px","height":"200px","border":"3px solid #999","background-image":"url(/images/ui_icons/blog_folder_ico.png)","background-size":"40%","background-repeat":"no-repeat","background-position":"center"}).addClass("clickable page-thumb");
			var pageText = $("<div />").text("Blog Posts").css({"color":"white","font-family":"Arial","margin-top":"10px"}).addClass("t-t");
			postsBtn.append(pageThumb);
			postsBtn.append(pageText);
			postsBtn.unbind("click").bind("click",function(){
				EditorHelper.showAddPageMenu("posts", {"is_admin":isAdmin,"inline_load":true});
			});
			pagesList.prepend(postsBtn);
		}

		if (mode == "posts"){
			var backToPagesBtn = $("<li />").attr("id","backtopages-btn").css({"display":"inline-block","margin":"30px 50px"}).addClass("clickable page-block");
			var pageThumb = $("<div />").css({"width":"200px","height":"200px","border":"3px solid #999","background-image":"url(/images/ui_icons/controlpanel_back.png)","background-size":"40%","background-repeat":"no-repeat","background-position":"center"}).addClass("clickable page-thumb");
			var pageText = $("<div />").text("Back").css({"color":"white","font-family":"Arial","margin-top":"10px"}).addClass("t-t");
			backToPagesBtn.append(pageThumb);
			backToPagesBtn.append(pageText);
			backToPagesBtn.unbind("click").bind("click",function(){
				EditorHelper.showAddPageMenu("manage-pages", {"is_admin":isAdmin,"inline_load":true});
			});
			pagesList.prepend(backToPagesBtn);
		} 

		var newPageBtn = $("<li />").attr("id","add-new").css({"display":"inline-block","margin":"30px 50px"}).addClass("clickable page-block");
		var pageThumb = $("<div />").css({"width":"200px","height":"200px","border":"3px solid #999","background-image":"url(/images/ui_icons/add_site.png)","background-size":"70%","background-repeat":"no-repeat","background-position":"center"}).addClass("clickable page-thumb");;
		var pageText = $("<div />").text(XPRSTranslator.translateText("NEW BLANK PAGE")).css({"color":"white","font-family":"Arial","margin-top":"10px"}).addClass("t-t");
		if(mode == "manage-pages"){
			pageText.text("NEW PAGE")
		}
		newPageBtn.append(pageThumb);
		newPageBtn.append(pageText);
		newPageBtn.unbind("click").bind("click",function(){
			if(mode == "manage-pages"){
				EditorHelper.showAddPageMenu("add-page",{"is_admin":isAdmin})
				return;
			}
			var message = "";
			XPRSHelper.xprsAlert(message,{title: "Name your new page", showCancelButton: true,closeOnConfirm:false,type: "input",inputPlaceholder:"Untitled",confirmButtonText:"Add page",cancelButtonText:"Cancel","callbackfunc":function(pageName){
				//the user chose to add page
				if(typeof pageName == "string"){
					if (pageName == ""){
						pageName = "Untitled";
					}
					var menuId = EditorHelper.checkIfMenuExists();
					message = XPRSTranslator.translateText("Do you want to add the page as a link to your menu?\n (you can do it later as well)");
					EditorHelper.showManagePagesLoader();
					XPRSHelper.POST("/safe_clone", {
						vbid : "MASTER_BLANK_PAGE",
						clone_into : EditorHelper.getRootId() + "-PAGES",
						original_parent_id : "MASTER_TEMPLATE-PAGES",
						keep_style : true,
						skip_stripe_data: true,
						clone_after_id:"last",
						new_name:pageName,
						child_type:"PAGE",
						get_target_creator:true
						}, function(result) {
						EditorHelper.removeManagePagesLoader();
						if ("limit_reached" in result){
							if (LABEL_CONFIG && "META" in LABEL_CONFIG && LABEL_CONFIG.META.NAME == "aabaco"){
								if (typeof YSBApp != "undefined"){
									YSBApp.send({"action": "restricted-upsell", "appid": "ywebsite"});
								}
							}else{
								XPRSHelper.xprsAlert("Please upgrade your license in order to create more pages",{title: "Page Limit Reached", showCancelButton: false,confirmButtonText:"OK","callbackfunc":function(isConfirm){
								}});
							}
							return;
						}
						var cloneId = result.clone_id;
						var dialogTitle = XPRSTranslator.translateText("Page") + " '" + pageName + "' " + XPRSTranslator.translateText("was added to your site")
						XPRSHelper.xprsAlert(message,{"do_not_translate":true, title:dialogTitle,closeOnConfirm:menuId, showCancelButton: true,confirmButtonText:"Yes please",cancelButtonText:"Later..","callbackfunc":function(confirm){
							//if (!(result.error)){
								XPRSHelper.updateParent({"deliver_to":"parent","action":"invalidate-page-list"});
								if (menuId){
									if (EditorHelper.getHolderById(menuId).css("display") == "none"){
										EditorHelper.resetMenuLayout(menuId);
									}
									var pageVbid = cloneId;
									var homePath = "/" + EditorHelper.getRootId();
									var itemHref = window.location.protocol +"//" + window.location.host + "/viewer" + homePath + "/" + pageVbid;
									if (confirm){
										XPRSHelper.POST("/add_existing_page_to_menu",{"root_id":EditorHelper.getRootId(),"label":pageName,"page_vbid":pageVbid},function(){
											XPRSHelper.updateParent({"deliver_to":"parent","action":"preview"});
											XPRSHelper.updateParent({"deliver_to":"parent","action":"viewer-link-click","href":itemHref,"type":"EXISTING"});
										},"json");
									}else{
										XPRSHelper.updateParent({"deliver_to":"parent","action":"preview"});
										XPRSHelper.updateParent({"deliver_to":"parent","action":"viewer-link-click","href":itemHref,"type":"EXISTING"});
									}
								}else{
									var message = "Whould you like us to create one for you?"
									XPRSHelper.xprsAlert(message,{title: "This website does not have a menu", showCancelButton: true,confirmButtonText:"Yes, Thank you",cancelButtonText:"No, never mind...","callbackfunc":function(isConfirm){
										var pageVbid = cloneId;
										var homePath = "/" + EditorHelper.getRootId();
										var itemHref = window.location.protocol +"//" + window.location.host + "/viewer" + homePath + "/" + pageVbid;
										if (confirm){
											EditorHelper.showManagePagesLoader();
											EditorHelper.createNewMenu(function(){
												XPRSHelper.POST("/add_existing_page_to_menu",{"root_id":EditorHelper.getRootId(),"label":pageName,"page_vbid":pageVbid},function(){
													XPRSHelper.updateParent({"deliver_to":"parent","action":"preview"});
													XPRSHelper.updateParent({"deliver_to":"parent","action":"viewer-link-click","href":itemHref,"type":"EXISTING"});
													EditorHelper.removeManagePagesLoader();
												},"json");
											});
										}else{
											XPRSHelper.updateParent({"deliver_to":"parent","action":"preview"});
											XPRSHelper.updateParent({"deliver_to":"parent","action":"viewer-link-click","href":itemHref,"type":"EXISTING"});
										}
									}});
								}
						}});
						XPRSHelper.trackEvent('Added Page',"General","BLANK",0,true);
					});
				}
			 }});
		});
		
		
		if(mode != "select-page" && mode != "posts"){
			pagesList.prepend(newPageBtn);	
		}
		pagesListHolder.append(pagesList)
		newPageBlocker.append(pagesListHolder);
		EditorHelper.removeManagePagesLoader();
	},"json");
	XPRSTranslator.translateDom(newPageBlocker)
	setTimeout(function(){
		newPageBlocker.css("opacity","1")
	},200)
	
	
};


EditorHelper.showManagePagesLoader = function(){
	$(".new-page-blocker").addClass("loading");
	var loaderDiv = $("<div />").addClass("loading-blocker").css({"position":"fixed","top":"0px","left":"0px","width":"100%","height":"100%","background-color":"#333","z-index":"99999999","opacity":"0.6"});
	$(".new-page-blocker").append(loaderDiv);
	$(".xprs-alert button.confirm").addClass("animated-color").css({"background-image":"url('/images/x_loader.gif')","background-repeat":"no-repeat","background-position":"center","background-size":"50px 50px","color":"rgba(0,0,0,0)"});
};

EditorHelper.removeManagePagesLoader = function(){
	$(".new-page-blocker").removeClass("loading");
	$(".new-page-blocker .loading-blocker").remove();
	$(".xprs-alert button.confirm").removeClass("animated-color").css({"background-image":"","background-repeat":"","background-position":"","background-size":"","color":""});
};

EditorHelper.incrementPageName = function(pageName){
	pageName = pageName.replace(/\d+$/, "");
	var maxPageNumber = 0;
	var pageFound = false;
	for (i in EditorHelper.pagesDetails){
		if (typeof EditorHelper.pagesDetails[i] == "object" && "NAME" in EditorHelper.pagesDetails[i] && EditorHelper.pagesDetails[i]["NAME"].startsWith(pageName)){
			pageFound = true;
			var currentName = EditorHelper.pagesDetails[i].NAME;
			var matches = currentName.match(/\d+$/);
			if (matches){
				maxPageNumber = Math.max(matches[0], maxPageNumber);
			}
		}
	}
	if (pageFound){
		maxPageNumber++
		return pageName + maxPageNumber;
	}
	return pageName;
};


EditorHelper.clonePageFlow = function(pageId,currentPageName,pageParent){
	var message = "";
	XPRSHelper.xprsAlert(message,{title: "Name your new page", showCancelButton: true,closeOnConfirm:false,type: "input",inputPlaceholder:EditorHelper.incrementPageName(currentPageName),confirmButtonText:"Add page",cancelButtonText:"Cancel","callbackfunc":function(pageName){
		//the user chose to add page
		if(typeof pageName == "string"){
			if (pageName == ""){
				pageName = currentPageName;
				pageName = EditorHelper.incrementPageName(pageName);
			}
			var menuId = EditorHelper.checkIfMenuExists();
			EditorHelper.showManagePagesLoader();
			XPRSHelper.POST("/safe_clone", {
				vbid : pageId,
				clone_into : EditorHelper.getRootId() + "-PAGES",
				original_parent_id : pageParent,
				keep_style : true,
				skip_stripe_data: true,
				clone_after_id:"last",
				new_name:pageName,
				// use_clone_stack:true,
				child_type:"PAGE",
				get_target_creator:true
			}, function(result) {
				if ("limit_reached" in result){
					EditorHelper.removeManagePagesLoader();
					if (LABEL_CONFIG && "META" in LABEL_CONFIG && LABEL_CONFIG.META.NAME == "aabaco"){
						if (typeof YSBApp != "undefined"){
							YSBApp.send({"action": "restricted-upsell", "appid": "ywebsite"});
						}
					}else{
						XPRSHelper.xprsAlert("Please upgrade your license in order to create more pages",{title: "Page Limit Reached", showCancelButton: false,confirmButtonText:"OK","callbackfunc":function(isConfirm){
						}});
					}
					return;
				}
					EditorHelper.removeManagePagesLoader();
					var cloneId = result.clone_id;	
					message = XPRSTranslator.translateText("Do you want to add the page as a link to your menu?\n (you can do it later as well)");
					var dialogTitle = XPRSTranslator.translateText("Page") + " '" + pageName + "' " + XPRSTranslator.translateText("was added to your site")
					XPRSHelper.xprsAlert(message,{"do_not_translate":true, title: dialogTitle,closeOnConfirm:menuId, showCancelButton: true,confirmButtonText:"Yes please",cancelButtonText:"Later..","callbackfunc":function(confirm){
						setTimeout(function(){XPRSHelper.updateParent({"deliver_to":"parent","action":"invalidate-page-list"});},1000);
						if (menuId){
							if (EditorHelper.getHolderById(menuId).css("display") == "none"){
								EditorHelper.resetMenuLayout(menuId);
							}
							var pageVbid = cloneId;
							var homePath = "/" + EditorHelper.getRootId();
							var itemHref = window.location.protocol +"//" + window.location.host + "/viewer" + homePath + "/" + pageVbid;
							if (confirm){
								XPRSHelper.POST("/add_existing_page_to_menu",{"root_id":EditorHelper.getRootId(),"label":pageName,"page_vbid":pageVbid},function(){
									XPRSHelper.updateParent({"deliver_to":"parent","action":"preview"});
									XPRSHelper.updateParent({"deliver_to":"parent","action":"viewer-link-click","href":itemHref,"type":"EXISTING"});
								},"json");
							}else{
								XPRSHelper.updateParent({"deliver_to":"parent","action":"preview"});
								XPRSHelper.updateParent({"deliver_to":"parent","action":"viewer-link-click","href":itemHref,"type":"EXISTING"});
							}
						}else{
							var pageVbid = cloneId;
							var homePath = "/" + EditorHelper.getRootId();
							var itemHref = window.location.protocol +"//" + window.location.host + "/viewer" + homePath + "/" + pageVbid;
							var message = "Whould you like us to create one for you?"
							XPRSHelper.xprsAlert(message,{title: "This website does not have a menu", showCancelButton: true,confirmButtonText:"Yes, Thank you",cancelButtonText:"No, never mind...","callbackfunc":function(isConfirm){
								if (confirm){
									EditorHelper.showManagePagesLoader();
									EditorHelper.createNewMenu(function(){
										XPRSHelper.POST("/add_existing_page_to_menu",{"root_id":EditorHelper.getRootId(),"label":pageName,"page_vbid":pageVbid},function(){
											XPRSHelper.updateParent({"deliver_to":"parent","action":"preview"});
											XPRSHelper.updateParent({"deliver_to":"parent","action":"viewer-link-click","href":itemHref,"type":"EXISTING"});
											EditorHelper.removeManagePagesLoader();
										},"json");
									});
								}else{
									XPRSHelper.updateParent({"deliver_to":"parent","action":"preview"});
									XPRSHelper.updateParent({"deliver_to":"parent","action":"viewer-link-click","href":itemHref,"type":"EXISTING"});
								}
							}});
						}
					}});
					XPRSHelper.trackEvent('Added Page',"General","",0,true);
				});
		}
	 }});
};

EditorHelper.removePageBlockers = function(){
	$(".new-page-blocker").remove();
};




EditorHelper.populateMenuEditPanel = function(panel,menuId){
	var menuStripe = EditorHelper.getHolderById(menuId);
	var currentMenuLinks = menuStripe.find(".preview-element.Link");
	panel.find(".menu-links-list").empty();
	currentMenuLinks.each(function(){
		var linkEntry = $(this);
		EditorHelper.CreateMenuLinkEntry(panel,linkEntry,menuId);
	});
	
	// setTimeout(function(){
	 	EditorHelper.arrangeManagedLinks();
	// },300);
	
	var addBtn = panel.find(".add-menu-link");
	addBtn.unbind("click").bind("click",function(e){
		e.stopPropagation();
		EditorHelper.draggablePanelAddLinkToMenu(panel);
	});
};


EditorHelper.draggablePanelAddLinkToMenu = function(panel){
	panel.closest(".draggable-tabbed-panel-wrapper").css("display","none").removeClass("shown");
	var message = "Do you want to add a new page to your website or just a new link to the menu?"; 
	XPRSHelper.xprsAlert(message,{title: "Add a page or a link?",closeOnCancel:false, showCancelButton: true,confirmButtonText:"Add Page",cancelButtonText:"Add Link","callbackfunc":function(isConfirm){
		   if(isConfirm){
			   EditorHelper.showAddPageMenu("add-page",{});
		   }else{
			   var message = "";
				XPRSHelper.xprsAlert(message,{title: "Please enter link label", showCancelButton: true,type: "input",inputPlaceholder:"More",confirmButtonText:"Add Link",cancelButtonText:"Cancel","callbackfunc":function(pageName){
					if(typeof pageName == "string"){
						if (pageName == ""){
							pageName = "More";
						}
						EditorHelper.handleAddLinkToMenu({"vbid":EditorHelper.checkIfMenuExists(),"link_name":pageName});
					}
				}});
		   }
	}});
};

EditorHelper.CreateMenuLinkEntry = function(panel,linkEntry,parentId){
	var submenuClass = (linkEntry.is(".submenu-link")) ? "submenu-link" : "";
	var submenuHolderClass = (linkEntry.is(".submenu-title")) ? "submenu-holder" : "";
	var linkDiv = panel.find(".link-div.template").clone().removeClass("template").attr("id",linkEntry.attr("id")).addClass(submenuClass).addClass(submenuHolderClass);
	var linkField = linkDiv.find("input").val(linkEntry.text());
	var linkIcon = linkDiv.find("img.link-icon").attr("src","/images/ui_icons/imos_blog.png");
	var subLinkIcon = linkDiv.find("img.sublink-icon").attr("src","/images/ui_icons/link_on.png");
	var stripeId = linkEntry.closest(".master.item-box").attr("id");
	
	linkDiv.find("input").unbind("keyup").bind("keyup",function(e){
		var currentField = $(this);
		var linkId = currentField.closest(".link-div").attr("id");
		var escapedVal = $('<div/>').text(currentField.val()).html();
		EditorHelper.handleTextChange({"id":linkId,"new_value":escapedVal});
		var timerKey = "PREVIEW_LINK" + linkId;
		EditorHelper.debounceSave(timerKey,function(){
			var stripeId = linkEntry.closest(".master.item-box").attr("id");
			panel.addClass("saving");
			XPRSHelper.SAFEPOST("/update_element_content",{element_id :linkId ,parent_id:parentId,prop_name:"TEXT|LABEL",prop_value:currentField.val() + "|||" + currentField.val(),"stripe_id":stripeId},parentId,"UPDATE-CHILD",function(){
				panel.removeClass("saving");
			});
		});
	});
	
	linkDiv.find(".arrange-arrows").children().unbind("click").bind("click",function(e){
		e.stopPropagation();
		var clickedArrow = $(this);
		if (clickedArrow.is(".inactive")){
			return;
		}
		var currentLinkDiv = clickedArrow.closest(".link-div");
		//currentLinkDiv.add(currentLinkDiv.nextUntil(":not(.submenu-link)"))
		//var parentId = EditorHelper.getHolderParent(clickedElement).attr("id");
		if (clickedArrow.attr("class").indexOf("up") != -1){
			var putAfter = currentLinkDiv.prev();
			if (currentLinkDiv.is(".submenu-link")){
				putAfter.before(currentLinkDiv);
			}else{
				if (putAfter.is(".submenu-link")){
					if (putAfter.prevUntil(":not(.submenu-link)").length == 0){
						putAfter = putAfter.prev();
					}else{
						putAfter = putAfter.prevUntil(":not(.submenu-link)").last().prev();
					}
				}
				putAfter.before(currentLinkDiv.add(currentLinkDiv.nextUntil(":not(.submenu-link)")));
			}
			var prevLink = currentLinkDiv.prevAll(":not(.submenu-link)").first();
			if (currentLinkDiv.is(".submenu-link")){
				prevLink = currentLinkDiv.prev(".submenu-link");
			}
			var linkLi = $("#" + parentId + " #" + currentLinkDiv.attr("id")).closest("li");
			var putAfterLi = $("#" + parentId + " #" + prevLink.attr("id")).closest("li");
			if (putAfterLi.length == 0){
				linkLi.closest("ul").prepend(linkLi)
			}else{
				putAfterLi.after(linkLi);
			}
			panel.addClass("saving");
			XPRSHelper.SAFEPOST("/move_element",{"parent":parentId , "vbid": currentLinkDiv.attr("id"),"direction":"up","stripe_id":stripeId},parentId,"MOVE-ELEMENT",function(){
				panel.removeClass("saving");
			});
		}else{
			var putAfter = currentLinkDiv.next();
			if (currentLinkDiv.is(".submenu-link")){
				putAfter.after(currentLinkDiv);
			}else{
				// This is a submenu, rolling forward
				if (putAfter.is(".submenu-link")){
					putAfter = currentLinkDiv.nextUntil(":not(.submenu-link)").last().next();
				}
				//The next is also a submenu, rolling this menu as well
				if(putAfter.length > 0 && putAfter.next().is(".submenu-link")){
					putAfter = putAfter.nextUntil(":not(.submenu-link)").last();
				}
				putAfter.after(currentLinkDiv.add(currentLinkDiv.nextUntil(":not(.submenu-link)")));
			}
			var prevLink = currentLinkDiv.prevAll(":not(.submenu-link)").first();
			if (currentLinkDiv.is(".submenu-link")){
				prevLink = currentLinkDiv.prev(".submenu-link");
			}
			var linkLi = $("#" + parentId + " #" + currentLinkDiv.attr("id")).closest("li");
			var putAfterLi = $("#" + parentId + " #" + prevLink.attr("id")).closest("li");
			if (putAfterLi.length == 0){
				linkLi.closest("ul").append(linkLi)
			}else{
				putAfterLi.after(linkLi);
			}
			panel.addClass("saving");
			XPRSHelper.SAFEPOST("/move_element",{"parent":parentId , "vbid": currentLinkDiv.attr("id"),"direction":"down","stripe_id":stripeId},parentId,"MOVE-ELEMENT",function(){
				panel.removeClass("saving");
			});
		}
		
		EditorHelper.arrangeManagedLinks();
		
	});

	linkDiv.find(".indent-in").unbind("click").bind("click",function(){
		var currentLinkDiv = $(this).closest(".link-div");
		currentLinkDiv.addClass("submenu-link");
		var addTo = currentLinkDiv.prevAll(".link-div:not('.submenu-link')").first();
		EditorHelper.addToSubMenu(currentLinkDiv, addTo.attr("id"));
		var linksState = EditorHelper.arrangeManagedLinks();
		panel.addClass("saving");
		XPRSHelper.SAFEPOST("/update_submenu",{"parent":parentId ,"stripe_id":stripeId, "links_state":JSON.stringify(linksState)},parentId,"UPDATE-SUBMENU",function(){
			panel.removeClass("saving");
		});
	});

	linkDiv.find(".indent-out").unbind("click").bind("click",function(){
		var currentLinkDiv = $(this).closest(".link-div");
		currentLinkDiv.removeClass("submenu-link");
		var removeFrom = currentLinkDiv.prevAll(".link-div:not('.submenu-link')").first();
		EditorHelper.removeFromSubMenu(currentLinkDiv,removeFrom.attr("id"));
		var linksState = EditorHelper.arrangeManagedLinks();
		panel.addClass("saving");
		XPRSHelper.SAFEPOST("/update_submenu",{"parent":parentId ,"stripe_id":stripeId, "links_state":JSON.stringify(linksState)},parentId,"UPDATE-SUBMENU",function(){
			panel.removeClass("saving");
		});
	});



	linkDiv.find(".delete-btn").unbind("click").bind("click",function(e){
		var currentLinkDiv = $(this).closest(".link-div");
		var linkParent = currentLinkDiv.parent();
		var vbid = currentLinkDiv.attr("id");

		var submenuLinks = currentLinkDiv.nextUntil(":not(.submenu-link)");
		if (currentLinkDiv.is(":not(.submenu-link)") && submenuLinks.length > 0){
			XPRSHelper.xprsAlert("All links in the submenu will be deleted as well!.",{title: "Are you sure you want to remove all links in submenu?",closeOnCancel:true, showCancelButton: true,confirmButtonText:"Remove All",cancelButtonText:"Cancel","callbackfunc":function(isConfirm){
				if(isConfirm) {
					currentLinkDiv.add(submenuLinks).remove();
					EditorHelper.arrangeManagedLinks();
					EditorHelper.handleDelete({"vbid":vbid});
					childrenToRemove = vbid
					submenuLinks.each(function(){
						childrenToRemove += "|" + $(this).attr("id")
					});
					panel.addClass("saving");
					XPRSHelper.SAFEPOST("/remove_child",{"parent":parentId , "child": childrenToRemove,"stripe_id":stripeId},parentId,{"action_name":"REMOVE-SUBMENU-LINK","pretty_name":"Remove link"},function() {
						panel.removeClass("saving");
					});
				}
			}});
		}else{
			var actionName = "REMOVE-CHILD";
			if (currentLinkDiv.is(".submenu-link")){
				actionName = "REMOVE-SUBMENU-LINK";
			}
			currentLinkDiv.remove();
			EditorHelper.handleDelete({"vbid":vbid});
			EditorHelper.arrangeManagedLinks();
			panel.addClass("saving");
			XPRSHelper.SAFEPOST("/remove_child",{"parent":parentId , "child": vbid,"stripe_id":stripeId},parentId,{"action_name":actionName,"pretty_name":"Remove link"},function() {
				panel.removeClass("saving");
			});
		}
	});
	panel.find(".menu-links-list").append(linkDiv);
	linkDiv.show();
};


EditorHelper.arrangeManagedLinks = function(){
	var linksState = {};
	$(".menu-links-list.links-list .link-div").each(function(index){
		var currentLink =  $(this);
		currentLink.find(".fa-caret-up, .fa-caret-down").removeClass("inactive");
		if (currentLink.is(":first-child")){
			currentLink.find(".fa-caret-up").addClass("inactive")
		}
		if (currentLink.is(":last-child")){
			currentLink.find(".fa-caret-down").addClass("inactive")
		}
		
		// currentLink.css("top", 40*index + 5*index);
		currentLink.removeClass("submenu-holder");
		if (currentLink.is(":not(.submenu-link)") && currentLink.next(".submenu-link").length > 0 ){
			currentLink.addClass("submenu-holder");
		}
		var linkLevel = "link";
		if (currentLink.is(".submenu-holder")){
			linkLevel = "MENU";
		}
		if (currentLink.is(".submenu-link")){
			linkLevel = "SUBMENU";
		}

		if (currentLink.is(".submenu-link")){
			if (currentLink.prev(".submenu-holder").length > 0){
				currentLink.find(".fa-caret-up").addClass("inactive")
			}
			if (currentLink.next(":not(.submenu-link)").length > 0){
				currentLink.find(".fa-caret-down").addClass("inactive")
			}
		}

		if (currentLink.is(".submenu-holder")){
			if (currentLink.nextAll().length == currentLink.nextAll(".submenu-link").length){
				currentLink.find(".fa-caret-down").addClass("inactive")
			}
		}

		linksState[currentLink.attr("id")] = linkLevel;
	});
	return linksState;
};


EditorHelper.addToSubMenu = function(linkDiv,parentId){
	var linkId = linkDiv.attr("id");
	var parentToAddTo = $("#" + parentId);
	var parentSubmenu = parentToAddTo.next(".submenu");
	if (parentToAddTo.parent().is("a")){
		parentSubmenu = parentToAddTo.parent().next(".submenu");
	}

	var itemToAdd = $("#" + linkId);
	var itemToAddElement = itemToAdd;
	itemToAdd = itemToAdd.closest("li");

	//create a sub menu if there is none
	if (parentSubmenu.length == 0){
		parentSubmenu = $("<div />").addClass("submenu");
		parentToAddTo.addClass("submenu-title");
		if (parentToAddTo.parent().is("a")){
			parentToAddTo.parent().after(parentSubmenu);
		}else{
			parentToAddTo.after(parentSubmenu);
		}
		
	}
	var nestedLinks = linkDiv.nextUntil(":not(.submenu-link)");
	parentSubmenu.append(itemToAdd);
	if (nestedLinks.length > 0){
		var itemToAddSubMenu = itemToAdd.next(".submenu");
		if (itemToAddSubMenu.parent().is("a")){
			itemToAddSubMenu = itemToAdd.parent().next(".submenu")
		}
		parentSubmenu.append(itemToAddSubMenu.children());
		itemToAddSubMenu.remove();
		itemToAddElement.removeClass("submenu-title");
		itemToAdd.addClass("removable-parent");
		
	}
	itemToAddElement.addClass("submenu-link");
	SpimeEngine.InitHolder(parentToAddTo.closest(".master.item-box"));
};

EditorHelper.removeFromSubMenu = function(linkDiv,parentId){
	var linkId = linkDiv.attr("id");
	var itemToRemove = $("#" + linkId);
	var itemToRemoveElement = itemToRemove;
	itemToRemove = itemToRemove.closest("li");
	if (itemToRemove.is(":last-child")){
		itemToRemoveElement.removeClass("submenu-link");
		var currentSubMenuHolder = itemToRemove.closest(".submenu").prev();
		if (currentSubMenuHolder.is("a")){
			currentSubMenuHolder = currentSubMenuHolder.find(".preview-element");
		}
		var currentSubMenuHolderElement = currentSubMenuHolder;
		currentSubMenuHolder = currentSubMenuHolder.closest("li");
		currentSubMenuHolder.after(itemToRemove);
		var currentSubMenu = currentSubMenuHolder.next(".submenu");
		if (currentSubMenuHolderElement.parent().is("a")){
			currentSubMenu = currentSubMenuHolderElement.parent().next(".submenu");
		}
		if (currentSubMenu.children().length == 0){
			currentSubMenuHolderElement.removeClass("submenu-title");
			currentSubMenuHolder.addClass("removable-parent");
			currentSubMenu.remove();
		}
	}else if(itemToRemove.is(":first-child")){
		var currentSubMenuHolder = itemToRemove.closest(".submenu").prev();
		if (currentSubMenuHolder.is("a")){
			currentSubMenuHolder = currentSubMenuHolder.find(".preview-element");
		}
		var currentSubMenuHolderElement = currentSubMenuHolder;
		currentSubMenuHolder = currentSubMenuHolder.closest("li");
		var currentSubMenu = currentSubMenuHolder.next(".submenu");
		if (currentSubMenuHolderElement.parent().is("a")){
			currentSubMenu = currentSubMenuHolderElement.parent().next(".submenu");
		}
		currentSubMenuHolder.after(itemToRemove);
		itemToRemoveElement.addClass("submenu-title").removeClass("submenu-link");
		if (itemToRemoveElement.is("a")){
			currentSubMenu.before(itemToRemoveElement.parent());
		}else{
			currentSubMenu.before(itemToRemoveElement);
		}
		currentSubMenuHolderElement.removeClass("submenu-title");
		currentSubMenuHolder.addClass("removable-parent");
	}else{
		var nestedLinks = linkDiv.nextUntil(":not(.submenu-link)");
		if (nestedLinks.length > 0){
			var currentSubMenuHolder = itemToRemove.closest(".submenu").prev();
			if (currentSubMenuHolder.is("a")){
				currentSubMenuHolder = currentSubMenuHolder.find(".preview-element");
			}
			currentSubMenuHolder = currentSubMenuHolder.closest("li");
			currentSubMenuHolder.after(itemToRemove);
			itemToRemoveElement.addClass("submenu-title").removeClass("submenu-link");
			var newSubmenu = $("<div />").addClass("submenu");
			if (itemToRemoveElement.parent().is("a")){
				itemToRemoveElement.parent().after(newSubmenu);
			}else{
				itemToRemoveElement.after(newSubmenu);
			}
			
			nestedLinks.each(function(){
				var currentLink = $(this);
				var linkToMove = $("#" + currentLink.attr("id")).closest("li");
				newSubmenu.append(linkToMove);
			})
		}
	}
	SpimeEngine.InitHolder(itemToRemove.closest(".master.item-box"));
};

EditorHelper.populateAccessPanel= function(panel,pageElement){
	var pagePassword = $("body").attr("data-password");
	var pageId = EditorHelper.getPageId();
	if (pagePassword){
		panel.find("[value='password-protected']").prop("checked", true);
		panel.find("input[name='page-password']").val(pagePassword);
	}else{
		panel.find("[value='everyone']").prop("checked", true);
		if (LABEL_CONFIG && "SETTINGS" in LABEL_CONFIG && LABEL_CONFIG.SETTINGS.ALLOW_PAGE_PASSWORD == "allow"){
		}else{
			$(".panel-selector-tab[data-relevant-panel=access-panel]").hide();
			return
		}
	}
	//Fix firefox issue
	if (XPRSHelper.getBrowser().toLowerCase().indexOf("chrome") == -1){
		panel.find("input[name='page-password']").click(function(){$("body").enableSelection();$(this).focus()});
	}

	panel.find("#set-page-pass-btn").unbind("click").bind("click",function(){
		var clickedButton = $(this);
		clickedButton.addClass("loading-state");
		var selectedRadio = panel.find("[name='page-access']:checked");
		if (selectedRadio.val() == "everyone" ){
			XPRSHelper.SAFEPOST("/update_specific_key",{"section": "META","updated_key":"PASSWORD","delete_key":"True"},pageId,"PASSWORD",function() {
   				$("body").removeAttr("data-password");
				clickedButton.removeClass("loading-state");
			}); 
		}else{
			var newPass = panel.find("input[name='page-password']").val();
			XPRSHelper.SAFEPOST("/update_specific_key",{"section": "META","updated_key":"PASSWORD","updated_value":newPass},pageId,"PASSWORD",function() {
   				$("body").attr("data-password",newPass);
				clickedButton.removeClass("loading-state");
			}); 
		}
	});
};

EditorHelper.populateAppsSettings = function(panel,pageElement){

	if ($(".page_ribbon_app").length > 0) {
		panel.find("#ribbon_app.toggle-option").addClass("selected");
	}
	if ($(".page_snow_app").length > 0) {
		panel.find("#snow_app.toggle-option").addClass("selected");
	}
	if ($(".page_cookie_app").length > 0) {
		panel.find("#cookie_app.toggle-option").addClass("selected");
	}
	if ($(".page_feedback_app").length > 0) {
		panel.find("#feedback_app.toggle-option").addClass("selected");
	}
	if ($(".page_chat_app").length > 0) {
		panel.find("#chat_app.toggle-option").addClass("selected");
	}
	if ($(".page_topper_app").length > 0) {
		panel.find("#topper_app.toggle-option").addClass("selected");
	}
	if ($(".page_loader_app").length > 0) {
		panel.find("#loader_app.toggle-option").addClass("selected");
	}
	if ($(".page_share_app").length > 0) {
		panel.find("#share_app.toggle-option").addClass("selected");
	}
	if ($(".page_custom_app").length > 0) {
		panel.find("#custom_app.toggle-option").addClass("selected");
	}
	if ($(".page_signup_app").length > 0) {
		panel.find("#signup_app.toggle-option").addClass("selected");
	}
	if ($(".page_exit_popup_app").length > 0) {
		panel.find("#exit_popup_app.toggle-option").addClass("selected");
	}
	if ($(".page_stripe_popup_app").length > 0) {
		panel.find("#stripe_popup_app.toggle-option").addClass("selected");
	}
	
	panel.find(".remove-app").unbind("click").bind("click",function(e){
		
		e.stopPropagation();

		var currentPageId = EditorHelper.getMasterId();
		var appBtn = $(this).closest('li');
		var appKind = $(this).closest(".toggle-option.app").attr("id");
		
		XPRSHelper.xprsAlert("Any changes you have made to the app's code will be lost.",{title: "Are you sure you want to remove this app?",closeOnCancel:true, showCancelButton: true,confirmButtonText:"Remove",cancelButtonText:"Cancel","callbackfunc":function(isConfirm){
			
			if(isConfirm) {
				EditorHelper.removeApp(currentPageId,appBtn,appKind);
			}
		}});

	});
	
	panel.find(".page-apps-toggle .toggle-option").unbind("click").bind("click",function(e){
		
		var currentPageId = EditorHelper.getMasterId();
		
		if($(this).hasClass("selected")) {
			
			e.stopPropagation();
			var appKind = $(this).closest(".toggle-option.app").attr("id");
			var appName = "page_" + appKind;
			var clickedElement = $("."+appName);
			clickedElement.attr("data-app-name", appName)
			var selectedTab = "raw-parameters";
			if(appKind == "custom_app") selectedTab = "arrange-code";
			EditorHelper.showDraggableTabbedPanel("raw-edit",clickedElement, {"selected-tab":selectedTab,"main-title":"Popup"});
			
			if(appKind == "stripe_popup_app") {
				
				SpimeEngine.initRawHTML(clickedElement.find(".raw-container, .preview-raw-container"),true, function(){
					var DOMContentLoaded_event = document.createEvent("Event");
					DOMContentLoaded_event.initEvent("xprs-app-loaded", true, true);
					window.document.dispatchEvent(DOMContentLoaded_event);
				});
			}
			
			EditorHelper.startElementEditMode(clickedElement);
			

		} else {
			
			var btnHolder = $(this)
			
			$(this).addClass("selected");

			var appKind = $(this).attr('id');
			
			$("#empty-stripe").remove();
			var addedHolder = $("<div />").addClass("master item-box animated-height").attr("id","empty-stripe");
			$("#children").prepend(addedHolder);

			var itemType = "RAW";
			var params = {};
			params['element_type'] = itemType;
			var elementData = {};
			elementData[itemType] = EditorHelper.defaultElementValues[itemType];
			elementData[itemType]["VBID"] = EditorHelper.shortUuid();
			elementData[itemType]["URL"] = "/html_src/" + EditorHelper.shortUuid("static");
			elementData[itemType]["TYPE"]  = "page_" + appKind;
			
			params['element_data'] = JSON.stringify(elementData);
			params['template_src'] = 'xprs/';
			EditorHelper.addElement(addedHolder,"first",params,true,function(){
				
				if(appKind == "stripe_popup_app") {
					
					btnHolder.find('.app-name .remove-app').css('visibility','hidden');
					btnHolder.find('.app-name').css('height', '28px');
					btnHolder.find('.app-name').addClass("loading-state");
					btnHolder.prop('disabled', true);
					
					var currentPageId = EditorHelper.getMasterId();
					
					var originalStripeId = 'vbid-stripe-popup-form-coupon';
					var originalparentVbid ='vbid-stripe-popup-form-site';
					
					$("#empty-stripe").remove();
					var addedHolder = $("<div />").addClass("master item-box animated-height").attr("id","empty-stripe");
					$("#children").append(addedHolder);
					
					EditorHelper.safeCloneStripe(originalStripeId,addedHolder,"FORM",currentPageId,originalparentVbid,"last",true, function(){
						
						var appName = "page_" + appKind;
						var clickedElement = $("."+appName);
						clickedElement.attr("data-app-name", appName)
						var selectedTab = "raw-parameters";
						EditorHelper.showDraggableTabbedPanel("raw-edit",clickedElement, {"selected-tab":selectedTab,"main-title":"Popup"});
						EditorHelper.startElementEditMode(clickedElement);
						
						var DOMContentLoaded_event = document.createEvent("Event");
						DOMContentLoaded_event.initEvent("xprs-app-loaded", true, true);
						window.document.dispatchEvent(DOMContentLoaded_event);
						
						btnHolder.find('.app-name').removeClass("loading-state");
						
						XPRSHelper.updateParent({"deliver_to":"parent","action":"app-dismiss-control-panel"});
						
					}, false);
				}
			});
			
			var customeMsg = " You can customize the code now or later by pressing the edit button on the app's icon.";
			var appDetailesMsg = "";
			
			if(appKind == "ribbon_app") {
				appDetailesMsg = "The widget is adding a corner ribbon to this page.";
			}
			if(appKind == "feedback_app") {
				appDetailesMsg = "This widget is adding a form in whice the site's users can give you feedback.";
			}
			if(appKind == "loader_app") {
				appDetailesMsg = "This widget is adding a thin blue progress bar to the top of this page.";
			}
			if(appKind == "snow_app") {
				appDetailesMsg = "This widget will make it snow!";
			}
			if(appKind == "cookie_app") {
				appDetailesMsg = "This is designed to help you comply with the privacy laws around the world, including the European Union.";
			}
			if(appKind == "share_app") {
				appDetailesMsg = "This widget is adding social networks, share buttons, side bar to the page.";
			}
			if(appKind == "custom_app") {
				appDetailesMsg = "The Custom widget lets you add your own widget to this page.";
			}
			if(appKind == "topper_app") {
				appDetailesMsg = "This widget is adding a button at the bottom of the screen that will take you to the top of the page. It will show only on long pages that have scrolling in them.";
			}
			if(appKind == "chat_app") {
				appDetailesMsg = "Allow users on your site to chat with you online or offline. To start go to http://tawk.to and get your userId.";
			}
			if(appKind == "signup_app") {
				appDetailesMsg = "Adds a popup form to your page.";
			}
			if(appKind == "exit_popup_app") {
				appDetailesMsg = "Adds a popup form to your page that pops when the user is going to leave.";
			}
			if(appKind == "stripe_popup_app") {
				appDetailesMsg = "NO_POP";//"Creates a popup from any stripe in your page.";

			}

			if (appDetailesMsg != "NO_POP") {
				var message = appDetailesMsg + customeMsg;
				var appName = appKind.replace("_", " ");
				XPRSHelper.xprsAlert(message,{title: "You have added the "+ appName +" to this page",closeOnCancel:true, showCancelButton: true,confirmButtonText:"Customize",cancelButtonText:"Later","callbackfunc":function(isConfirm){
					   if(isConfirm){
							var appName = "page_" + appKind;
							var clickedElement = $("."+appName);
							clickedElement.attr("data-app-name", appName)
							var selectedTab = "raw-parameters";
							if(appKind == "custom_app") selectedTab = "arrange-code";
							EditorHelper.showDraggableTabbedPanel("raw-edit",clickedElement, {"selected-tab":selectedTab});
							EditorHelper.startElementEditMode(clickedElement);
					   }else{

					   }
				}});
			} else {

			}
			
		}

	});

}

EditorHelper.removeApp = function(currentPageId,appBtn, appKind) {
	appBtn.removeClass("selected");
	//$(this).find(".edit-app").remove();
	var appName = "page_" + appKind;
	var appElement = $("."+appName).closest(".master.item-box");
	EditorHelper.handleDelete({"vbid":appElement.attr("id")});
	var stripeId = appElement.closest(".master.item-box").attr("id");
	
	if(appKind == "stripe_popup_app") {

		var stripeObj = $("."+appKind+"[data-preset-type-id='FORM'],."+appKind+"_hide[data-preset-type-id='FORM'],."+appKind+"_animate[data-preset-type-id='FORM']");


		if(stripeObj.length > 0) {
			stripeObj.each(function(){
				var stripeFormId = $(this).attr("id");
				EditorHelper.handleDelete({"vbid":stripeFormId});
			
				stripeId = stripeId + "|" + stripeFormId;
			});
		} else {
			console.log('no stripe found');
		}
			
	}

	XPRSHelper.SAFEPOST("/remove_child",{"parent":currentPageId , "child": stripeId,"stripe_id":appElement.attr("id")},currentPageId,"REMOVE-CHILD-NO-UNDO",function() {
		
	});
	
	if(appKind == "ribbon_app") {
		$(".corner-ribbon").remove();
	}
	
	if(appKind == "feedback_app") {
		$(".xprs-feedback-app").remove();
		$(".xprs-feedback-app-feedback-button").remove();
	}
	
	if(appKind == "loader_app") {
		$(".pace").remove();
	}
	
	if(appKind == "snow_app") {
		$("#xprs-snow-app").remove();
	}

	if(appKind == "cookie_app") {
		$("#xprs-cookie-app").remove();
	}
	
	if(appKind == "exit_popup_app") {
		$('#ouibounce-modal').remove();
	}
	
	XPRSHelper.updateParent({"deliver_to":"parent","action":"remove-app-dismiss-control-panel"});
}


EditorHelper.populateGallerySettings = function(panel,holder){
	var styleid = holder.attr("data-preview-styleid");
	var arrangerSettings = holder.find(".arranger-settings");
	currentVal = arrangerSettings.attr("data-arranger_order_type");
	panel.find("#" + currentVal +".toggle-option").addClass("selected");
	var relevantCssSelector = EditorHelper.getCssSelector(styleid, "PREVIEW_INLINE_IMAGE")
	var elementForCss = holder.find(relevantCssSelector)
	if (elementForCss.css(EditorHelper.StyleSettings["PROPERTIES"]["PREVIEW_IMAGE_SIZE"].css_name) == "contain"){
		panel.find("#" + currentVal +".toggle-option").removeClass("selected");
		panel.find("#fit.toggle-option").addClass("selected");
	}
	panel.find(".gallery-type-toggle .toggle-option").unbind("click").bind("click",function(){
		$(this).siblings(".selected").removeClass("selected");
		$(this).addClass("selected");
		var imageSize = "cover";
		if ($(this).attr("id") == "fit"){
			imageSize = "contain";
		}
		newVal = $(this).attr("id");
		arrangerSettings.attr("data-arranger_order_type",newVal);
		
		EditorHelper.UpdateRealTimeStyle(styleid,"PREVIEW_INLINE_IMAGE","PREVIEW_IMAGE_SIZE",imageSize);
		//EditorHelper.updateStyleData({"vbid":holder.attr("id"),"updated_key":$(this).attr("data-prop"),"updated_value":currentVal,"module_name":$(this).attr("data-module"),"style_id":holderStyleId});
		EditorHelper.UpdateServerStyle(styleid,$(this).attr("data-modules"),$(this).attr("data-props"),$(this).attr("data-values"),"",holder.attr("id"));
		SpimeEngine.ArrangeHolder(holder)
	});
	
	
	//EditorHelper.bindAddHeaderBtn(panel,holder);
	
	
};


EditorHelper.bindAddHeaderBtn = function(panel,holder){
	var headerControlBtn = panel.find(".header-control-btn")
	
	headerControlBtn.text("Add Header").attr("data-action","add");
	if (holder.find(".stripe-header-wrapper").length > 0){
		headerControlBtn.text("Remove Header").attr("data-action","remove");
	}
	
	headerControlBtn.unbind("click").bind("click",function(e){
		e.stopPropagation();
		var currentBtn = $(this);
		if (currentBtn.attr("data-action") == "add"){
			var relevantItem = holder.find(".sub.item-box[data-visible='visible']");
			if (relevantItem.length == 0){
				relevantItem = holder.find("#items-holder .sub.item-box").first();
			}
			EditorHelper.addStripeHeader(currentBtn,holder,relevantItem);
		}else{
			relevantItem = holder.find(".sub.item-box.stripe-header");
			var vbid = relevantItem.attr("id");
			var parentId = holder.attr("id");
			EditorHelper.handleDelete({"vbid":vbid});
			currentBtn.addClass("loading-state");
			var stripeId = relevantItem.closest(".master.item-box").attr("id");
			XPRSHelper.SAFEPOST("/remove_child",{"parent":parentId , "child": vbid,"stripe_id":stripeId},parentId,"REMOVE-CHILD-NO-UNDO",function() {
				//EditorHelper.updateParent({"deliver_to":"editor","action":"delete-holder","vbid":vbid,"parent_vbid":parentId});
				currentBtn.text("Add Header").attr("data-action","add");
				holder.find(".stripe-header-wrapper").remove();
				currentBtn.removeClass("loading-state");
			});
		}
	});
};

EditorHelper.populateMenuSettings = function(panel,menuId){
	//var stripeParent = EditorHelper.getStripeParent(clickedElement);
	var stripe = EditorHelper.getHolderById(menuId);
	var settings = stripe.find(".layout-settings");
	var styleId = stripe.attr("data-styleid");
	var module = "PREVIEW_ITEM_STRIPE";
	var menuLayouts = EditorHelper.StyleSettings["MENU_LAYOUTS"];
	var currentMenuLayout = EditorHelper.getMenuLayout(menuId);

	
	var layoutsList = panel.find(".menu-layouts-toggle ul");
	for (var i in menuLayouts){
		//Don't add minified menu with overlay (it is configured in a later menu)
		
			var menuLayoutToggleOp = $("<li />").attr("id",i).addClass("toggle-option half-size-toggle clickable");
			if (i.indexOf("_overlay") == -1 && i.indexOf("_scroll") == -1){
				var menuLayoutIcon = $("<img />").attr("src","/images/ui_icons/"+ i + ".png");
				var menuLayoutText = $("<div />").addClass("t-t").text(menuLayouts[i].NAME);
				menuLayoutToggleOp.append(menuLayoutIcon).append(menuLayoutText);
			}
			if (menuLayouts[i]["ALWAYS_MINIFIED"] != "false"){
				var editLayoutBtn = $("<span />").addClass("edit-menu-layout-btn t-t clickable").text("(edit)");
				editLayoutBtn.unbind("click").bind("click",function(e){
					e.stopPropagation();
					var relevantDraggableTabbedPanel = panel.closest(".draggable-tabbed-panel-wrapper");
					EditorHelper.populateMenuAdvancedSettings(relevantDraggableTabbedPanel.find(".menu-advanced-settings"),menuId)
					EditorHelper.showTab(relevantDraggableTabbedPanel.find(".panel-selector-tab[data-relevant-panel='menu-advanced-settings']"),relevantDraggableTabbedPanel)
				})
				menuLayoutToggleOp.append(editLayoutBtn);
			}
			
			if (i.indexOf("_overlay") == -1 && i.indexOf("_scroll") == -1){
				layoutsList.append(menuLayoutToggleOp);
			}
			
			
			if (i == currentMenuLayout.replace("_overlay","").replace("_scroll","")){
				menuLayoutToggleOp.addClass("selected");
			}
			menuLayoutToggleOp.unbind("click").bind("click",function(e){
				e.stopPropagation();
				var clickedOp = $(this);
				
				//handle the situation of an already open menu
				if (stripe.hasClass("menu-open")){
					stripe.find(".hamburger").click();
					setTimeout(function(e){
						clickedOp.click();
					},1000);
					return false;
				}
				//handle the situation when the menu is scrolled
				if (stripe.hasClass("being-scrolled")){
					var relevantDraggableTabbedPanel = panel.closest(".draggable-tabbed-panel-wrapper");
					relevantDraggableTabbedPanel.addClass("stay-on-scroll");
					relevantDraggableTabbedPanel.attr("data-scroll-pos",0);
					$("body").animate({scrollTop:0},1000,'easeOutQuart',function(){
						clickedOp.click();
						relevantDraggableTabbedPanel.removeClass("stay-on-scroll")
					});
					return false;
				}
				
				clickedOp.siblings(".selected").removeClass("selected");
				clickedOp.addClass("selected");
				var selectedLayout = menuLayouts[clickedOp.attr("id")];
				var props = "";
				var values = "";
				var modules = "";
				for(prop in selectedLayout){
					if (prop != "NAME"){
						settings.attr("data-" + prop.toLowerCase(),selectedLayout[prop]);
						props +=  prop + "|";
						values += selectedLayout[prop] + "|";
						modules += module + "|";
					}
				
				}
				SpimeEngine.ArrangeAll();
				//handle fill height stripes
				EditorHelper.calcFillHeight(selectedLayout)
				EditorHelper.updateMultipleStyleKeys({"styleid":styleId,"props":props.slice(0,-1),"values":values.slice(0,-1),"modules":modules.slice(0,-1)},function(){
					XPRSHelper.updateParent({"deliver_to":"parent","action":"saved"});
				});
				
			});
		}
	
};


EditorHelper.resetMenuLayout = function(menuId){
	var stripe = EditorHelper.getHolderById(menuId);
	var settings = stripe.find(".layout-settings");
	var styleId = stripe.attr("data-styleid");
	var module = "PREVIEW_ITEM_STRIPE";
	var menuLayouts = EditorHelper.StyleSettings["MENU_LAYOUTS"];
	var selectedLayout = menuLayouts["top_menu"];
	var props = "";
	var values = "";
	var modules = "";
	for(prop in selectedLayout){
		if (prop != "NAME"){
			settings.attr("data-" + prop.toLowerCase(),selectedLayout[prop]);
			props +=  prop + "|";
			values += selectedLayout[prop] + "|";
			modules += module + "|";
		}
	
	}
	SpimeEngine.ArrangeAll();
	EditorHelper.updateMultipleStyleKeys({"styleid":styleId,"props":props.slice(0,-1),"values":values.slice(0,-1),"modules":modules.slice(0,-1)},function(){
		XPRSHelper.updateParent({"deliver_to":"parent","action":"saved"});
	});
};

EditorHelper.populateMenuAdvancedSettings = function(panel,menuId){
	var stripe = EditorHelper.getHolderById(menuId);
	var styleId = stripe.attr("data-styleid");
	var settings = stripe.find(".layout-settings");
	
	panel.find(".menu-overlay-btn").removeClass("selected")
	panel.find(".menu-overlay-btn#" + settings.attr("data-menu_overlay")).addClass("selected");
	
	var menuOverlayOptionBtns = panel.find(".menu-overlay-btn");
	menuOverlayOptionBtns.unbind("click").bind("click",function(e){
		e.stopPropagation();
		var clickedOp = $(this);
		if (stripe.hasClass("menu-open")){
			stripe.find(".hamburger").click();
			setTimeout(function(e){
				clickedOp.click();
			},1000);
			return false;
		}
		menuOverlayOptionBtns.removeClass("selected");
		$(this).addClass("selected");
		
		
		var selectedOverlay = clickedOp.attr("id");
		settings.attr("data-menu_overlay",selectedOverlay);

		SpimeEngine.ArrangeAll();
		EditorHelper.updateMultipleStyleKeys({"styleid":styleId,"props":"MENU_OVERLAY","values":selectedOverlay,"modules":"PREVIEW_ITEM_STRIPE"},function(){
			XPRSHelper.updateParent({"deliver_to":"parent","action":"saved"});
		});
		
	});
	
	
	var menuScrollBtn = panel.find("#scroll-with-page");
	
	if (settings.attr("data-always_minified")=="side_screen"){
		menuScrollBtn.hide();
	}else{
		menuScrollBtn.show();
		if (settings.attr("data-menu_scroll") != "false"){
			menuScrollBtn.addClass("selected");
		}
		menuScrollBtn.unbind("click").bind("click",function(e){
			e.stopPropagation();
			var clickedBtn = $(this)
			$('body').animate({scrollTop:0},1000,'easeOutQuart',function(){
				var scrollOption = "true"
				if (!clickedBtn.is(".selected")){
					scrollOption = "false";
				}
				settings.attr("data-menu_scroll",scrollOption);
				SpimeEngine.ArrangeAll();
				EditorHelper.updateMultipleStyleKeys({"styleid":styleId,"props":"MENU_SCROLL","values":scrollOption,"modules":"PREVIEW_ITEM_STRIPE"},function(){
					XPRSHelper.updateParent({"deliver_to":"parent","action":"saved"});
				});
			});
			
			clickedBtn.toggleClass("selected");
		});
	}
	

	
		
	panel.find(".hamburger, .removable-title").remove();
	if (settings.attr("data-always_minified") != "false"){
		var menuHamburger = $(".hamburger.links-menu-btn");
		var selectedClass = "";
		
		for (var i in EditorHelper.StyleSettings["CSS_CLASSES"]["HAMBURGER_CLASS"]){
			var demoBurger = $("<button />").addClass("hamburger for-type").addClass(EditorHelper.StyleSettings["CSS_CLASSES"]["HAMBURGER_CLASS"][i].CLASS).attr("type","button");
			var burgerBox = $("<span />").addClass("hamburger-box");
			var burgerInner = $("<span />").addClass("hamburger-inner");
			if (menuHamburger.length > 0){
				if (menuHamburger.hasClass(EditorHelper.StyleSettings["CSS_CLASSES"]["HAMBURGER_CLASS"][i].CLASS)){
					demoBurger.addClass("selected");
					selectedClass = EditorHelper.StyleSettings["CSS_CLASSES"]["HAMBURGER_CLASS"][i].CLASS 
				}
			}
			demoBurger.attr("data-burger-class", EditorHelper.StyleSettings["CSS_CLASSES"]["HAMBURGER_CLASS"][i].CLASS )
			burgerBox.append(burgerInner);
			demoBurger.append(burgerBox);
			
			demoBurger.hover(function(){$(this).addClass("is-active")},function(){$(this).removeClass("is-active")});
			demoBurger.unbind("click").bind("click",function(e){
				e.stopPropagation();
				panel.find(".hamburger.for-type").removeClass("selected");
				$(this).addClass("selected");
				menuHamburger.removeClass(selectedClass)
				selectedClass = $(this).attr("data-burger-class");
				menuHamburger.addClass(selectedClass);
				XPRSHelper.SAFEPOST("/update_css_class", {"vbid":menuId,"updated_key":"HAMBURGER_CLASS","updated_value":selectedClass,"stripe_id":menuId}, menuId, "CSS_CLASS");
			});
			panel.append(demoBurger)
		}
		
		var selectedSizeClass = "";
		
		var hamburgerSizeMenu = $("<div />").css({"text-align":"left","margin-left":"15px"});
		hamburgerSizeMenu.append($("<span/>").text("Hamburger size").css({"display":"block","margin-top":"20px","margin-left":"10px"})).addClass("removable-title");
		var hamburgerSizes =["very-small","small","medium","large","very-large"];
		for (var i in hamburgerSizes){
			var demoBurger = $("<button />").addClass("hamburger for-size").addClass(hamburgerSizes[i]).attr("type","button").css({"padding":(5*i) + "px"});
			var burgerBox = $("<span />").addClass("hamburger-box");
			var burgerInner = $("<span />").addClass("hamburger-inner");
			if (menuHamburger.length > 0){
				if (menuHamburger.hasClass(hamburgerSizes[i])){
					demoBurger.addClass("selected");
					selectedSizeClass = hamburgerSizes[i];
				}
			}
			demoBurger.attr("data-burger-class", hamburgerSizes[i] )
			burgerBox.append(burgerInner);
			demoBurger.append(burgerBox);
			hamburgerSizeMenu.append(demoBurger);
			demoBurger.unbind("click").bind("click",function(e){
				e.stopPropagation();
				panel.find(".hamburger.for-size").removeClass("selected");
				$(this).addClass("selected");
				menuHamburger.removeClass(selectedSizeClass)
				selectedSizeClass = $(this).attr("data-burger-class");
				menuHamburger.addClass(selectedSizeClass);
				XPRSHelper.SAFEPOST("/update_css_class", {"vbid":menuId,"updated_key":"HAMBURGER_SIZE_CLASS","updated_value":selectedSizeClass,"stripe_id":menuId}, menuId, "CSS_CLASS");
			});
			panel.append(hamburgerSizeMenu);
		}
	}
};


EditorHelper.getMenuLayout = function(menuId){
	var menuLayouts = EditorHelper.StyleSettings["MENU_LAYOUTS"];
	var stripe = EditorHelper.getHolderById(menuId);
	var settings = stripe.find(".layout-settings");
	for (var i in menuLayouts){
		var allPropsMatch = true;
		for (prop in menuLayouts[i]){
			if (prop != "NAME"){
				if (settings.attr("data-" + prop.toLowerCase()) != menuLayouts[i][prop]){
					allPropsMatch = false;
					break;
				}
			}
		}
		if (allPropsMatch){
			return i;
		}
	}
	return "unknown"
};

EditorHelper.populateWebsiteStylePanel = function(panel,clickedElement){
	var masterContainer = $(".master.container");
	
	panel.parent().unbind("click").bind("click",function(e){
		e.stopPropagation();
		$(this).find(".fonts-div").hide();
	});
	var websiteStyleReset = panel.find("#reset-website-style");
	websiteStyleReset.unbind("click").bind("click",function(){
		if (masterContainer.is(".website-style")){
			masterContainer.removeClass("website-style");
			XPRSHelper.SAFEPOST("/update_css_class", {"vbid":EditorHelper.getRootId(),"updated_key":"STYLE_CLASS","delete_key":"True"}, EditorHelper.getRootId(), "CSS_CLASS");
			panel.find(".selected-font").text("None").css("font-family","Arial")
		}
	});
	
	var menuLayouts = EditorHelper.StyleSettings["MENU_LAYOUTS"];
	var menuId = EditorHelper.checkIfMenuExists();
	var menuLayout = EditorHelper.getMenuLayout(menuId);
	if (menuLayout !="unknown"){
		panel.find("#choose-menu-layout-btn .menu-type-span").text(menuLayouts[menuLayout].NAME);
	}else{
		panel.find("#choose-menu-layout-btn .menu-type-span").text("No menu...");
	}
	
	
	panel.find("#choose-menu-layout-btn").unbind("click").bind("click",function(e){
		e.stopPropagation();
		var relevantDraggableTabbedPanel = panel.closest(".draggable-tabbed-panel-wrapper")
		EditorHelper.showTab(relevantDraggableTabbedPanel.find(".panel-selector-tab[data-relevant-panel='menu-type']"),relevantDraggableTabbedPanel)
	});
	
	if (masterContainer.is(".narrow-site")){
		panel.find(".website-width-btn#narrow-site-btn").addClass("selected");
	}else{
		panel.find(".website-width-btn#wide-site-btn").addClass("selected");
	}
	var websiteWidthButtons = panel.find(".website-width-btn");
	websiteWidthButtons.unbind("click").bind("click",function(e){
		e.stopPropagation();
		websiteWidthButtons.removeClass("selected");
		$(this).addClass("selected");
		if ($(this).is("#narrow-site-btn")){
			masterContainer.addClass("narrow-site");
			XPRSHelper.SAFEPOST("/update_css_class", {"vbid":EditorHelper.getRootId(),"updated_key":"SITE_WIDTH","updated_value":"narrow-site"}, EditorHelper.getRootId(), "CSS_CLASS");
		}else{
			masterContainer.removeClass("narrow-site");
			XPRSHelper.SAFEPOST("/update_css_class", {"vbid":EditorHelper.getRootId(),"updated_key":"SITE_WIDTH","delete_key":"True"}, EditorHelper.getRootId(), "CSS_CLASS");
		}
		SpimeEngine.ArrangeAll(true);
		
	});
	
	var currentBodyClass = $("body").attr("class");
	if (currentBodyClass){
		panel.find("#" + currentBodyClass).addClass("selected");
	}
	if ($("body").css("background-image") == "none"){
		panel.find(".bg-type-toggle").hide();
	}
	panel.find(".bg-type-toggle .toggle-option").unbind("click").bind("click",function(e){
		e.stopPropagation();
		$(this).siblings().removeClass("selected");
		$(this).addClass("selected");
		$("body").attr("class",$(this).attr("id"));
		XPRSHelper.SAFEPOST("/update_css_class", {"vbid":EditorHelper.getRootId(),"updated_key":"BACKGROUND_CLASS","updated_value":$(this).attr("id")}, EditorHelper.getRootId(), "CSS_CLASS");
	});
	
	panel.find(".bg-type-toggle").hover(function(){$("#xprs").addClass("animated-opacity").css("opacity",0.6)},function(){$("#xprs").css("opacity",1).removeClass("animated-opacity")})
	

	
	
};

EditorHelper.initFontSelector = function(fontList, currentFont, moduleName, styleid, forWebsiteStyle){
//	var relevantFonts = new Array(100);
	masterContainer = $(".master.container");
	var relevantFonts = EditorHelper.StyleSettings["PROPERTIES"]["FONT"].values;
	fontList.empty();
	var selectedFontOp = $();
	for (i in relevantFonts){
		var font = relevantFonts[i];
		var fontOp = $("<li />").addClass("clickable").css("font-family",font).text(font.replace("'","").replace("'","")).attr("data-font",font.replace("'","").replace("'",""));
		if (font.replace("'","").replace("'","") == currentFont){
			fontOp.addClass("selected");
			selectedFontOp = fontOp;
		}
		fontOp.bind("click",function(e){
			e.stopPropagation();
			EditorHelper.fontOptionClick($(this),$(),moduleName,styleid);
			if (!masterContainer.is(".website-style") && forWebsiteStyle){
				masterContainer.addClass("website-style");
				XPRSHelper.SAFEPOST("/update_css_class", {"vbid":EditorHelper.getRootId(),"updated_key":"STYLE_CLASS","updated_value":"website-style"}, EditorHelper.getRootId(), "CSS_CLASS");
			}
			$(this).closest(".font-selector").find(".selected-font").text($(this).css("font-family").replace("'","").replace("'","")).css("font-family",$(this).css("font-family"));
			$(this).closest(".fonts-div").hide();
		});
		fontList.append(fontOp);
	}
	if (selectedFontOp.length > 0){
		if (selectedFontOp.attr("data-font").toLowerCase() != "none"){
			fontList.prepend(selectedFontOp);
		}
	}else{
		var selectedFontOp = $("<li />").addClass("clickable selected").css("font-family",currentFont).text(currentFont.replace("'","").replace("'",""));
		selectedFontOp.bind("click",function(e){
			e.stopPropagation();
			EditorHelper.fontOptionClick($(this),$(),moduleName,styleid);
			if (!masterContainer.is(".website-style") && forWebsiteStyle){
				masterContainer.addClass("website-style");
				XPRSHelper.SAFEPOST("/update_css_class", {"vbid":EditorHelper.getRootId(),"updated_key":"STYLE_CLASS","updated_value":"website-style"}, EditorHelper.getRootId(), "CSS_CLASS");
			}
			$(this).closest(".fonts-div").hide()
		});
		fontList.prepend(selectedFontOp);
	}
	

	
};


EditorHelper.populateSocialEditPanel = function(panel,clickedElement){
	var currentSocialLinks = clickedElement.children(".link-entry");
	panel.find(".social-icons-list").empty();
	currentSocialLinks.each(function(){
		var linkEntry = $(this);
		EditorHelper.CreateSocialIconEntry(panel,clickedElement,linkEntry.attr("id"),linkEntry.find(".social-link-url").attr("data-href"),linkEntry.attr("data-img-url"));
	});
	setTimeout(function(){
		panel.find(".social-icons-list .link-div").each(function(index){
			$(this).css("top", $(this).height()*index + 5*index);
		});
	},100)
	
	var addBtn = panel.find(".add-social-icon");
	addBtn.find(".new-icon-list").remove();
	addBtn.unbind("click").bind("click",function(){
		if ($(this).find(".new-icon-list").length == 0 ){
			var iconList = $("<ul/>").addClass("new-icon-list");
			for (var i in EditorHelper.StyleSettings["SOCIAL_MEDIA_ICONS"]){
				var currentOption = EditorHelper.StyleSettings["SOCIAL_MEDIA_ICONS"][i];
				if (panel.find("#" + i ).length == 0){
					var linkOption = $("<li/>").addClass("social-link-option clickable");
					linkOption.attr("data-social-id", i);
					linkOption.text(currentOption["NAME"]);
					linkOption.css("background-image","url("+ currentOption["ICON"] +")");
					linkOption.unbind("click").bind("click",function(e){
						e.stopPropagation();
						var clickedIcon = $(this);
						var relevantIconData = EditorHelper.StyleSettings["SOCIAL_MEDIA_ICONS"][clickedIcon.attr("data-social-id")];
						var currentTheme = clickedElement.attr("data-theme")
						var iconUrl = relevantIconData["ICON"];
						if (iconUrl.indexOf(currentTheme) == -1){
							iconUrl = iconUrl.replace("1",currentTheme)
						}
						//Add to menu
						EditorHelper.CreateSocialIconEntry(panel,clickedElement,clickedIcon.attr("data-social-id"),relevantIconData["URL"],relevantIconData["ICON"]);
						
						setTimeout(function(){
							panel.find(".social-icons-list .link-div").each(function(index){
								$(this).css("top", $(this).height()*index + 5*index);
							});
						},100)
						
						EditorHelper.saveSocialLinksChange(panel,clickedElement);
						
						//Add To website
				    	var firstEntry = clickedElement.find(".link-entry").first();
				    	var newLink = firstEntry.clone();
				    	newLink.attr("title",relevantIconData["NAME"]);
				    	newLink.attr("data-title",i);
				    	newLink.attr("data-img-url",relevantIconData["ICON"])
				    	newLink.find(".social-link-url").attr("data-href",relevantIconData["URL"]);
				    	newLink.find(".preview-link-img").attr("src",iconUrl);
				    	newLink.attr("id",clickedIcon.attr("data-social-id"));
				    	clickedElement.append(newLink);
						clickedIcon.closest(".new-icon-list").remove();
					});
					iconList.append(linkOption);
				}
			}
			addBtn.append(iconList)
		}else{
			$(this).find(".new-icon-list").remove();
		}
	});
	panel.append(addBtn);
};

EditorHelper.populateEditVideoPanel = function(panel, clickedElement){
	var saveBtn = panel.find("#update-video");
	var inputText = panel.find("#video-id-field");
	var holderParent = EditorHelper.getHolderParent(clickedElement);
	var oldId = clickedElement.attr("data-spimevideo_id");
	inputText.val(oldId);
	inputText.focus();
	var parentVbid = EditorHelper.getHolderId(holderParent);
	saveBtn.unbind("click").bind("click",function(){
		var videoId = "";
		var fieldValue = inputText.val();
		if (fieldValue.indexOf("v=") == -1){
			if (fieldValue != ""){
				videoId = fieldValue;
			}
		}else{
			videoId = fieldValue.split('v=')[1];
			var ampersandPosition = videoId.indexOf('&');
			if(ampersandPosition != -1) {
				videoId = videoId.substring(0, ampersandPosition);
			}
		}
		clickedElement.attr("data-spimevideo_id",videoId);
		var videoIframe= clickedElement.find("iframe");
		var selectedSource = $(".vid-source-btn.selected").attr("data-source");
		var oldIframeSrc = videoIframe.attr("src");
		var newIframeSrc = oldIframeSrc.replace(oldId,videoId);
		if (videoIframe.is(".vimplayer") && selectedSource == "youtube"){
			newIframeSrc =  "https://www.youtube.com/embed/" + videoId + "?controls=0&html5=1&showinfo=0&modestbranding=1&enablejsapi=1&rel=0&playerapiid=" + clickedElement.attr("id") + "-vidframe";
			videoIframe.removeClass("vimplayer").addClass("ytplayer");
		}else if (videoIframe.is(".ytplayer") && selectedSource == "vimeo"){
			newIframeSrc = "https://player.vimeo.com/video/" + videoId + "?api=1&player_id=" + clickedElement.attr("id") + "-vidframe&autoplay=1";
			videoIframe.removeClass("ytplayer").addClass("vimplayer");
		}
		videoIframe.attr("src",newIframeSrc);
		var stripeId = clickedElement.closest(".master.item-box").attr("id"); 
		XPRSHelper.SAFEPOST("/update_specific_child_key",{"vbid":parentVbid,"child_vbid":clickedElement.attr("id"),"updated_key":"VIDEO_ID","updated_value":videoId,"stripe_id":stripeId},EditorHelper.getHolderParent(clickedElement).attr("id"),"UPDATE-CHILD",function() {
		});
	});
	inputText.unbind("keypress").bind("keypress",function(event) {
		if (event.keyCode == 13) {
			saveBtn.click(); 
		}
	});
	var youTubeBtn = panel.find('[data-source=youtube]');
	var vimeoBtn = panel.find('[data-source=vimeo]');
	vimeoBtn.add(youTubeBtn).unbind("click").bind("click",function(){
		if (!$(this).is(".selected")){
			var newVal = $(this).attr("data-source");
			panel.find(".vid-source-btn").removeClass("selected");
			$(this).addClass("selected");
			var stripeId = clickedElement.closest(".master.item-box").attr("id");
			XPRSHelper.SAFEPOST("/update_specific_child_key",{"vbid":parentVbid,"child_vbid":clickedElement.attr("id"),"updated_key":"SOURCE","updated_value":newVal,"stripe_id":stripeId},EditorHelper.getHolderParent(clickedElement).attr("id"),"UPDATE-CHILD",function() {
				
			});
		}
	});
	if(clickedElement.find("iframe").is(".ytplayer")){
		youTubeBtn.addClass("selected")
	}else{
		vimeoBtn.addClass("selected")
	}

	// var inputHolder = $("<div/>").addClass("part-of-menu");
	// var optionsHolder =  $("<div/>").addClass("vid-toggels");
	var autoPlay = panel.find('[data-toggle=autoplay]');
	var fitBtn = panel.find('[data-toggle=cover]');
	var muteBtn = panel.find('[data-toggle=mute]');
	var loopBtn = panel.find('[data-toggle=loop]');
	if (clickedElement.hasClass("vid-autoplay")){
		autoPlay.addClass("selected");
	}
	if (clickedElement.hasClass("vid-cover")){
		fitBtn.addClass("selected");
	}
	if (clickedElement.hasClass("vid-mute")){
		muteBtn.addClass("selected");
	}
	if (clickedElement.hasClass("vid-loop")){
		loopBtn.addClass("selected");
	}
	EditorHelper.initToggleBtn(autoPlay,clickedElement,"autoplay",parentVbid,"vid");
	EditorHelper.initToggleBtn(fitBtn,clickedElement,"cover",parentVbid,"vid");
	EditorHelper.initToggleBtn(muteBtn,clickedElement,"mute",parentVbid,"vid");
	EditorHelper.initToggleBtn(loopBtn,clickedElement,"loop",parentVbid,"vid");

}


EditorHelper.populateEditMapPanel = function(panel, clickedElement){
	var saveBtn = panel.find("#update-map");
	var inputText = panel.find("#address-field");
	var holderParent = EditorHelper.getHolderParent(clickedElement);
	var oldLocation = clickedElement.attr("data-spimelocation");
	inputText.val(oldLocation);
	inputText.focus();
	var parentVbid = EditorHelper.getHolderId(holderParent);
	saveBtn.unbind("click").bind("click",function(){
		var newLocation = "";
		var fieldValue = inputText.val();
		if (fieldValue != ""){
			newLocation = fieldValue;
		}else{
			EditorHelper.closeLeftClickMenu();
			return;
		}
		clickedElement.attr("data-spimelocation",newLocation);
		SpimeEngine.geoCode(newLocation,function(lat,lng,northeastLat,northeastLng,southwestLat,southwestLng){
			clickedElement.attr("data-spimelat",lat);
			clickedElement.attr("data-spimelng",lng);
			clickedElement.attr("data-spimenortheast-lat",northeastLat);
			clickedElement.attr("data-spimenortheast-lng",northeastLng);
			clickedElement.attr("data-spimesouthwest-lat",southwestLat);
			clickedElement.attr("data-spimesouthwest-lng",southwestLng);
			SpimeEngine.sendMapCommand(clickedElement,"center",{"first_time":true});
			var updatedKeys = "LOCATION|LNG|SOUTHWEST-LNG|NORTHEAST-LNG|LAT|NORTHEAST-LAT|SOUTHWEST-LAT";
			var updatedValues = newLocation + "|" + lng + "|" + southwestLng + "|" + northeastLng + "|" + lat + "|" + northeastLat + "|" + southwestLat
			var stripeId = clickedElement.closest(".master.item-box").attr("id");
			XPRSHelper.SAFEPOST("/update_multiple_child_keys",{"vbid":parentVbid,"child_vbid":clickedElement.attr("id"),"updated_keys":updatedKeys,"updated_values":updatedValues,"stripe_id":stripeId},parentVbid,"UPDATE-CHILD",function() {
			});
			// EditorHelper.closeLeftClickMenu();

		});
	});
	inputText.unbind("keypress").bind("keypress",function(event) {
		if (event.keyCode == 13) {
			saveBtn.click(); 
		}
	});
};

EditorHelper.populateEditImagePanel = function(panel, clickedElement){
	panel.find("#image-crop-btn").click(function(e){
		e.stopPropagation();
		EditorHelper.startCropMode(clickedElement);
		EditorHelper.closeDraggableTabbedPanel();
	});
	EditorHelper.initReplacePicUploader(panel.find("#image-upload"), clickedElement);
	EditorHelper.markOnHover(panel.find("#image-upload"), clickedElement, true); 
	panel.find("#open-media-center").click(function(e){
		e.stopPropagation();
		EditorHelper.showDraggableTabbedPanel("media-center", clickedElement);
	});
	var currentBgClass = clickedElement.attr("class");
	if (currentBgClass.indexOf("parallax-bg") != -1){
		panel.find("#parallax-bg").addClass("selected");
	}else if(currentBgClass.indexOf("fixed-bg") != -1){
		panel.find("#fixed-bg").addClass("selected");
	}else{
		panel.find("#normal-bg").addClass("selected");
	}
	var saveAltBtn = panel.find("#update-alt");
	var imageAlt = panel.find("#alt-text");
	imageAlt.val(clickedElement.attr("title"));
	saveAltBtn.unbind("click").bind("click",function(e){
		saveAltBtn.addClass("loading-state");
		var stripeId = clickedElement.closest(".master.item-box").attr("id"); 
		var parentId = EditorHelper.getHolderParent(clickedElement).attr("id");
		var timerKey = parentId + "_ALT_TEXT"
		EditorHelper.debounceSave(timerKey,function(){
			XPRSHelper.SAFEPOST("/update_specific_child_key",{"vbid":parentId,"child_vbid":clickedElement.attr("id"),"updated_key":"ALT","updated_value":imageAlt.val(),"stripe_id":stripeId},parentId,"UPDATE-CHILD",function() {
				XPRSHelper.updateParent({"deliver_to":"parent","action":"saved"});
				clickedElement.attr("title", imageAlt.val());
				saveAltBtn.removeClass("loading-state");
			});
		});
	});
	panel.find(".bg-class-btn").unbind("click").bind("click",function(e){
		e.stopPropagation();
		var clickedBgOption = $(this);
		clickedBgOption.siblings().removeClass("selected");
		clickedBgOption.addClass("selected");
		var newBgClass = clickedBgOption.attr("id");
		if (newBgClass == "normal-bg"){
			newBgClass = "";
		}
		clickedElement.removeClass("parallax-bg").removeClass("fixed-bg").removeClass("parallax50-bg");
		clickedElement.css("background-position-y","")
		clickedElement.addClass(newBgClass);
		var stripeId = clickedElement.closest(".master.item-box").attr("id"); 
		
		var parentId = EditorHelper.getHolderParent(clickedElement).attr("id");
		var timerKey = parentId + "_BACKGROUND_CLASS"
		EditorHelper.debounceSave(timerKey,function(){
			XPRSHelper.SAFEPOST("/update_specific_child_key",{"vbid":parentId,"child_vbid":clickedElement.attr("id"),"updated_key":"BACKGROUND_CLASS","updated_value":newBgClass,"stripe_id":stripeId},parentId,"UPDATE-CHILD",function() {
				XPRSHelper.updateParent({"deliver_to":"parent","action":"saved"});
			});
		});
	});

	
}

EditorHelper.populateRawPanel = function(panel,clickedElement){
	panel.closest("#xprs-class-selector-holder").css("width",600);
	var url = clickedElement.find(".raw-container, .preview-raw-container").attr("data-raw-content-url");
	panel.unbind("mousedown").bind("mousedown",function(e){
		e.stopPropagation();
		return false;
	});
	var textArea = panel.find("textarea");
	var textAreaId = EditorHelper.shortUuid("ace");
	var editor;
	XPRSHelper.GET(url,{},function(html){
		if (panel.closest(".block-script").length > 0){
			textArea.val(SpimeEngine.unescapeHtml(html));
		}else{
			textArea.val(html);
		}
		textArea.attr("id",textAreaId);
		//textArea.ace({ theme: 'ambiance', lang: 'html'});
		try{
		 editor = ace.edit(textArea.attr("id"));
		 editor.setTheme("ace/theme/ambiance");
		 editor.getSession().setMode("ace/mode/html");
		 editor.getSession().setUseWrapMode(true);
	     editor.getSession().setWrapLimitRange(65, 65);
		}catch(e){

		}
		
	});
	panel.find("#save-html").unbind("click").bind("click",function(){
		var btn = $(this);
		btn.addClass("loading-state");
		var stripe = clickedElement.closest(".master.item-box");
		var contentToSave = editor.getValue();//panel.find("textarea").val();
		var newContentId = EditorHelper.shortUuid("static");
		
		var x = clickedElement.find(".raw-container, .preview-raw-container");
		clickedElement.find(".raw-container, .preview-raw-container").attr("data-raw-content-url","/html_src/" + newContentId);
		var stripeId = stripe.attr("id");
		XPRSHelper.SAFEPOST("/update_multiple_child_keys",{"vbid":EditorHelper.getHolderParent(clickedElement).attr("id"),"child_vbid":clickedElement.attr("id"),"updated_keys":"URL","updated_values":"/html_src/" + newContentId,"stripe_id":stripeId},EditorHelper.getHolderParent(clickedElement).attr("id"),"UPDATE-CHILD",function() {
			
		});
		XPRSHelper.POST("/update_html_src", {content_id:newContentId,content:contentToSave,"element_id":clickedElement.attr("id"), "app":panel.closest(".draggable-tabbed-panel-wrapper").find(".toggle-option.app.selected").attr("id")}, function(){
			setTimeout(function(){
				if($("[data-block-script]").length > 0){
					var escapedScript = clickedElement.find(".escaped-script");
					if (escapedScript.length > 0){
						escapedScript.text(contentToSave.substring(0,Math.min(30,contentToSave.length)) + "...");
					}else{
						escapedScript = "<table style='background-color:white;line-height:normal;margin:auto;font-size:12px;font-family:Arial;text-align:left;border-spacing: 15px;'><tr><td><img style='background-color: grey;' src='https://lh3.googleusercontent.com/EXqfXXM7_vyuUfDKuI7p5OCE4H5EvhLiFzk5ecDENWsg4bDZSVwQUFoO5t8xTHAaaLzQekJmuh4bmvWmyA=s50'/></td><td><b>This section contains script:</b><br/>"
						escapedScript += "<span class='escaped-script' style='color:cornflowerblue;'></span><br/>scripts only run on your published site</td></tr></table>"
						x.html(escapedScript);
						escapedScript = x.find(".escaped-script");
						escapedScript.text(contentToSave.substring(0,Math.min(30,contentToSave.length)) + "...");
					}
				}else{
					SpimeEngine.initRawHTML(clickedElement.find(".raw-container, .preview-raw-container"),true);
				}
				btn.removeClass("loading-state");
			},300);
		});
	});
	
};




EditorHelper.populateSocialIconSettings = function(panel,clickedElement){
	panel.find(".panel-slider").each(function(){
		var currentSlider = $(this);
		if (clickedElement.length > 0){
			EditorHelper.GeneratePanelSlider(currentSlider,clickedElement);
		}
	});
};


EditorHelper.GeneratePanelColorPicker = function(panel,inputField,clickedElement){
	var title = inputField.attr("data-title");
	var moduleName = inputField.attr("data-module");
	//do not show when width is stretched
	if (moduleName == "PREVIEW_ITEM_STRIPE"){
		if (clickedElement.closest(".master.item-box").find(".item-wrapper").first().css("max-width") =="none"){
			inputField.replaceWith($());
			return
		}
	}
	var prop = inputField.attr("data-prop");
	var pickerClass = inputField.attr("data-class");
	var isBlocks = clickedElement.closest(".blocks").length > 0;
	var styleid = clickedElement.closest(".master.item-box").attr("data-styleid");
	if (typeof styleid == "undefined"){
		styleid = clickedElement.closest(".master.item-box").attr("data-preview-styleid");
	}
	if (moduleName == "PAGE"){
		styleid = $(".master.container").attr("data-preview-style");
	}
	if (moduleName == "WEBSITE_PAGE"){
		styleid = $("body").attr("data-root-style-id");
	}
	if (isBlocks && moduleName){
		if ( "BLOCKS_" + moduleName in EditorHelper.StyleSettings["MODULES"]){
			moduleName = "BLOCKS_" + moduleName;
		}
	}
	var titleClass = "slider-title";
	if (pickerClass == "palette-style"){
		titleClass = "panel-title";
	}
	var pickerHolder = $("<div />").addClass("clickable color-picker-holder " + pickerClass).append("<div class='" + titleClass + " t-t'>"+title+"</div>");
	var colorPicker =  $("<div />").addClass("panel-section-control-color");
	var relevantCssSelector = EditorHelper.getCssSelector(styleid,moduleName)

	var elementForCss = clickedElement.closest(".master.container").find(relevantCssSelector);
	if (elementForCss.length == 0){
		elementForCss = clickedElement;
	}

	elementForCss.addClass("animated-color");
	colorPicker.css("background-color",(elementForCss.css(EditorHelper.StyleSettings["PROPERTIES"][prop].css_name)));
	
	
	
	
	if (moduleName.indexOf("_HOVER") != -1 ){
		var testHover = $("<div />").css({"display":"none"}).addClass("hover-tester").addClass(clickedElement.attr("class"));
		if (clickedElement.is("input")){
			testHover.removeClass("placeholder-mode")
			clickedElement.after(testHover);
		}else{
			clickedElement.append(testHover);
		}
		colorPicker.css("background-color",(testHover.css(EditorHelper.StyleSettings["PROPERTIES"][prop].css_name)));
		testHover.remove();
	}
	if (moduleName.indexOf("NOT_PLACEHOLDER") != -1 ){
		testInput = clickedElement.clone();
		testInput.removeClass("placeholder-mode");
		clickedElement.parent().append(testInput);
		colorPicker.css("background-color",testInput.css(EditorHelper.StyleSettings["PROPERTIES"][prop].css_name));
		testInput.remove();
	}
	
	var testEffect = $("<div />").css({"display":"none"});
	if (moduleName == "PREVIEW_INLINE_IMAGE_EFFECT"){
		testEffect.addClass("item-effect-tester");
		clickedElement.closest(".master.item-box").append(testEffect);
		colorPicker.css("background-color",(testEffect.css(EditorHelper.StyleSettings["PROPERTIES"][prop].css_name)));
		testEffect.remove();
	}
	if (moduleName == "PREVIEW_LINK_EFFECT"){
		testEffect.addClass("effect-tester");
		clickedElement.closest(".master.item-box").append(testEffect);
		colorPicker.css("background-color",(testEffect.css(EditorHelper.StyleSettings["PROPERTIES"][prop].css_name)));
		testEffect.remove();
	}
	
	if (pickerClass == "palette-style"){
		var colorsListHolder = $("<div/>").addClass("color-list-holder stay-on");
		var colorsList = $("<ul/>")
		colorsListHolder.append(colorsList);
		colorPicker.append(colorsListHolder);
		EditorHelper.createColorPaletteMenu(colorsList,clickedElement,styleid,moduleName,{"prop":prop,"limit_colors":12});
		if (moduleName != "PAGE"){
			if (moduleName == "WEBSITE_PAGE"){
				EditorHelper.addImageToColorPalette(colorsList,$("body"),"body",true,false);
			}else{
				//We currently does not support menu background
				if (inputField.attr("data-title") != "Menu background"){
					EditorHelper.addImageToColorPalette(colorsList,clickedElement,".stripe-background",true,false);	
				}
				
			}
		}
	}else{
		colorPicker.unbind("click").bind("click",function(e){
			e.stopPropagation();
			var btn = $(this);
			$(".color-picker").spectrum("hide");
			panel.find(".color-list-holder").remove();
			var listLeft = btn.position().left + btn.width();
			var listTop =  btn.position().top + btn.height();
			var colorsListHolder = $("<div/>").addClass("color-list-holder sp-menu always-show").css({"position":"absolute","left":listLeft + "px","top":listTop +"px"});
			if (btn.offset().left + 120 > $(window).width()){
				colorsListHolder.css({"left":"auto","right":0})
			}
			var colorsList = $("<ul/>").addClass("sp-menu");
			colorsListHolder.append(colorsList);
			EditorHelper.createColorPaletteMenu(colorsList,clickedElement,styleid,moduleName,{"prop":prop,"second_target":btn,"close_on_select":true});
			panel.append(colorsListHolder);
			panel.one("click", function(){
				colorsList.remove();
			})
		});
	}
	pickerHolder.append(colorPicker);
	inputField.replaceWith(pickerHolder);
};


EditorHelper.GeneratePanelfilterPalette = function(panel,inputField,clickedElement){
	var title = inputField.attr("data-title");
	var module = inputField.attr("data-module");
	var imageHolderClass = inputField.attr("data-holder-class");
	var styleid = clickedElement.closest(".master.item-box").attr("data-styleid");
	if (typeof styleid == "undefined"){
		styleid = clickedElement.closest(".master.item-box").attr("data-preview-styleid");
	}
	var filterListHolder = $("<div/>").addClass("filter-list-holder stay-on").addClass(inputField.attr("data-class"));
	var filterList = $("<ul/>")
	filterListHolder.append("<div class='filter-list-title t-t'>"+title+"</div>");
	filterListHolder.append(filterList);
	var currentStripeBackgroundDiv = clickedElement.find(imageHolderClass).andSelf().filter(imageHolderClass);
	var demoImage = currentStripeBackgroundDiv.css("background-image");
	var noImage = false;
	if (!demoImage || demoImage == "none" || currentStripeBackgroundDiv.attr("id") == "no-image"){
		demoImage = "url(https://lh6.ggpht.com/n9puTBNktxh5W0nSHbI5SRgfqh2jdZ9VuXVahgg4fcY9_aQFcDsfYGVwnNQk2rUHyjkfMlTqVHLdcwwW5GE=s100)";
		noImage = true;
	}
	
	EditorHelper.addEffectOptions(filterList,styleid,module,demoImage);
	//EditorHelper.addEffectsPalette(filterList,clickedElement,styleid,holderClass,module);
	inputField.replaceWith(filterListHolder);
	if (noImage){
		filterList.closest(".with-image-only").hide();
	}
	
};


EditorHelper.GeneratePanelButton = function(originalBtn,clickedElement){
	createdBtn = $("<div />");
	createdBtn.addClass(originalBtn.attr("data-class"));
	createdBtn.addClass("panel-button clickable t-t");
	createdBtn.text(originalBtn.attr("data-title"));
	if (originalBtn.attr("data-prop") == "CSS_CLASS"){
		EditorHelper.initClassToggleBtn(createdBtn, clickedElement.closest(".master.item-box"),originalBtn.attr("data-class-type"), originalBtn.attr("data-value"));
	}
	originalBtn.replaceWith(createdBtn);
};


EditorHelper.initClassToggleBtn = function(btn, stripe, classType, toggleClass){
	if (stripe.hasClass(toggleClass)){
		btn.addClass("selected")
	}
	btn.unbind("click").bind("click", function(e){
		e.stopPropagation();
		var clickedBtn = $(this);
		if (clickedBtn.is(".selected")){
				clickedBtn.removeClass("selected");
	 			stripe.removeClass(toggleClass);
	 			stripe.css("min-height","");
	 			XPRSHelper.SAFEPOST("/update_css_class", {"vbid":stripe.attr("id"),"updated_key":classType,"delete_key":"True","stripe_id":stripe.attr("id")}, stripe.attr("id"), "CSS_CLASS");
		}else{
			clickedBtn.addClass("selected");
			stripe.addClass(toggleClass);
			if (toggleClass == "fill-height"){
				EditorHelper.calcFillHeight();
					stripe.find(".text-side").css("display", "block");
					setTimeout(function(){stripe.find(".text-side").css("display","");},0)
			}
			relevantDiv = stripe.find(".item-preview , .preview-image-holder:not(.draggable-pic-holder) , .vertical-aligner, .inner-pic:not(.circlize), #items-holder, #items-holder-wrapper");
			relevantDiv.css("min-height","inherit");
			XPRSHelper.SAFEPOST("/update_css_class", {"vbid":stripe.attr("id"),"updated_key":classType,"updated_value":toggleClass,"stripe_id":stripe.attr("id")}, stripe.attr("id"), "CSS_CLASS");
		}
		SpimeEngine.ArrangeHolder(stripe);
	});
}







EditorHelper.GeneratePanelDropdown = function(inputField,clickedElement){
	var title = inputField.attr("data-title");
	var moduleName = inputField.attr("data-module");
	var prop = inputField.attr("data-prop");
	var updateStyle = inputField.attr("data-update-style") == "true";
	var dropdownClass = inputField.attr("data-class");
	var styleid = clickedElement.closest(".master.item-box").attr("data-styleid");
	var dropdownHolder = $("<div />").addClass("clickable dropdown-holder " + dropdownClass).append("<div class='dropdown-title t-t'>"+title+"</div>");
	var dropdownVal = $("<input readonly />").addClass("dropdown-val clickable");
	var dropdownList = $("<ul />").addClass("dropdown-list");
	
	
	
	var currentVal = "SELECT";
	if (EditorHelper.StyleSettings["PROPERTIES"][prop]["onchange"] == "arranger-settings-change"){
		var arrangerSettings = clickedElement.closest(".master.item-box").find(".arranger-settings");
		currentVal = arrangerSettings.attr("data-" + prop.toLowerCase());
	}
	if (EditorHelper.StyleSettings["PROPERTIES"][prop]["onchange"] == "layout-settings-change"){
		var layoutSettings = clickedElement.closest(".master.item-box").find(".layout-settings");
		currentVal = layoutSettings.attr("data-" + prop.toLowerCase());
	}
	
	
	
	for (i in EditorHelper.StyleSettings["PROPERTIES"][prop]["values"]){
		var opValue = EditorHelper.StyleSettings["PROPERTIES"][prop]["values"][i];
		var opText = opValue;
		if (EditorHelper.StyleSettings["PROPERTIES"][prop]["value_names"]){
			opText = EditorHelper.StyleSettings["PROPERTIES"][prop]["value_names"][i];
		}
		opText = opText.toUpperCase();
		
		if (currentVal == opValue){
			dropdownVal.val(opText)
		}
			
		var dropdownOption = $("<li />").addClass("dropdown-option").attr("data-value",opValue).attr("data-text",opText).text(opText);
		dropdownOption.unbind("click").bind("click",function(e){
			e.stopPropagation();
			var stripeToInvalidate = undefined;
			dropdownVal.val($(this).attr("data-text"));
			dropdownHolder.removeClass("show-list");
			if(EditorHelper.StyleSettings["PROPERTIES"][prop]["onchange"] == "arranger-settings-change" || EditorHelper.StyleSettings["PROPERTIES"][prop]["onchange"] == "layout-settings-change" ){
				stripeToInvalidate = clickedElement.closest(".master.item-box").attr("id");
			}
			EditorHelper.UpdateServerStyle(styleid,$(this).closest(".dropdown-holder").attr("data-module"),$(this).closest(".dropdown-holder").attr("data-prop"),$(this).attr("data-value"), "",  stripeToInvalidate);
			
			if (updateStyle){
				var styleChangeParams = {};
				styleChangeParams["target"] = styleid;
				styleChangeParams["css_chunk"] = $(this).closest(".dropdown-holder").attr("data-prop");
				styleChangeParams["class_name"]=EditorHelper.StyleSettings["MODULES"][moduleName].CSS_CLASS;
				styleChangeParams["value"]= $(this).attr("data-text");
				styleChangeParams["module"] = moduleName;
				EditorHelper.handleStyleChange(styleChangeParams);
			}

			if (EditorHelper.StyleSettings["PROPERTIES"][prop]["onchange"] == "arranger-settings-change"){
				var arrangerSettings = clickedElement.closest(".master.item-box").find(".arranger-settings");
				arrangerSettings.attr("data-" + prop.toLowerCase(),$(this).attr("data-value"));
				SpimeEngine.InitHolder(clickedElement.closest(".master.item-box"));
			}
			if (EditorHelper.StyleSettings["PROPERTIES"][prop]["onchange"] == "layout-settings-change"){
				var layoutSettings = clickedElement.closest(".master.item-box").find(".layout-settings");
				layoutSettings.attr("data-" + prop.toLowerCase(),$(this).attr("data-value"));
				SpimeEngine.InitHolder(clickedElement.closest(".master.item-box"));
			}
		});
		dropdownList.append(dropdownOption)
	}
	dropdownHolder.append(dropdownVal).append(dropdownList);
	dropdownHolder.attr("data-module",inputField.attr("data-module"));
	dropdownHolder.attr("data-prop",inputField.attr("data-prop"));
	dropdownVal.unbind("click").bind("click",function(e){
		e.stopPropagation();
		var clickedField = $(this);
		clickedField.closest(".switching-panel").one("click",function(){
			dropdownHolder.removeClass("show-list");
		})
		dropdownHolder.toggleClass("show-list");
	});
	inputField.replaceWith(dropdownHolder);
};


EditorHelper.GeneratePanelSlider = function(inputField,clickedElement){
	var disabledClass = inputField.attr("data-disable-class");
	var title = inputField.attr("data-title");
	var modules = inputField.attr("data-module");
	var props = inputField.attr("data-prop");
	var sliderClass = inputField.attr("data-class");
	var isBlocks = clickedElement.closest(".blocks").length > 0;
	var partOfWebsiteStyle = inputField.is(".part-of-website-style")
	var propsArr = props.split("|");
	var modulesArr = modules.split("|");
	var prop = propsArr[0];
	var moduleName = modulesArr[0];
	var stripe =  clickedElement.closest(".master.item-box")
	var styleid = stripe.attr("data-styleid");
	
	if (partOfWebsiteStyle && $(".master.container").is(".website-style") && inputField.closest(".switching-panel").attr("data-style-class") == "website-style"){
		modules = modules.replace(moduleName,"WEBSITE_"+moduleName)
		moduleName = "WEBSITE_" + moduleName;
		styleid = $("body").attr("data-root-style-id");
	} else if (isBlocks){
		if ( "BLOCKS_" + moduleName in EditorHelper.StyleSettings["MODULES"]){
			modules = modules.replace(moduleName,"BLOCKS_"+moduleName)
			moduleName = "BLOCKS_" + moduleName;
		}
	}
	

	var step = EditorHelper.StyleSettings["PROPERTIES"][prop].step;
	
	//loading settings
	var minValue = EditorHelper.StyleSettings["PROPERTIES"][prop]["min"];
	var maxValue = EditorHelper.StyleSettings["PROPERTIES"][prop]["max"];
	if (!maxValue){
		if (prop == "ARRANGER_COLS"){
			maxValue = clickedElement.closest(".master.item-box").find(".sub.item-box").not(".stripe-header").length ;
		}else{
			maxValue = 9999;
		}
	}
	if(prop == "HEIGHT"){
		minValue = clickedElement.closest(".master.item-box").find(".preview-content-holder").height();
	}
	var diff = maxValue - minValue;
	if (step < 1){
		//diff*=10;
	}
	//20px for the sliding handle
	var trackWidth = 170;
	
	
	//Building the slider dom
	var sliderHolder = $("<div />").addClass("clickable slider-holder " + sliderClass).attr("data-title",title).attr("data-module",modules).attr("data-prop",props).attr("data-class",sliderClass).attr("title", XPRSTranslator.translateText(title)).append("<div class='slider-title t-t'>"+title+"</div>");
	var sliderRail = $("<div />").addClass("slider-rail")
	var sliderHandle = $("<div />").addClass("slider-handle");
	var sliderProgress = $("<div />").addClass("slider-progress");
	sliderRail.append(sliderProgress).append(sliderHandle);
	
	var numericVal = $("<input />").addClass("slider-numeric").attr("data-prop",prop);
	
	
	var sliderArrow = $("<div />").addClass("slider-arrows").append($("<i class='fa fa-caret-up clickable slider-arrow'></i>")).append($("<i class='fa fa-caret-down clickable slider-arrow'></i>"));
	sliderArrow.find(".slider-arrow").unbind("click").bind("click",function(e){
		var calculatedVal;
		if (step < 1){
			calculatedVal = parseFloat(numericVal.val())
		}
		calculatedVal = parseInt(numericVal.val());
		
		if ($(this).attr("class").indexOf("up") != -1){
			if (calculatedVal + step <= maxValue){
				numericVal.val(calculatedVal +  step);
				calculatedVal += step
			}
		}
		if ($(this).attr("class").indexOf("down") != -1){
			if (calculatedVal - step >= minValue){
				numericVal.val(calculatedVal - step);
				calculatedVal -= step
			}
		}
		var calculatedLeft = ((parseFloat(calculatedVal - minValue)/ diff) * trackWidth ) ;
		if (calculatedVal >= minValue && calculatedVal <= maxValue){
			calculatedLeft = Math.round(calculatedLeft);
			sliderHandle.css({"left":calculatedLeft});
			sliderProgress.css("width",calculatedLeft);
			if (sliderClass && sliderClass.indexOf("special-case") != -1){
				EditorHelper.handleSpecialStyleCases(styleid,modules,props,calculatedVal);
				return;
			}
			EditorHelper.UpdateRealTimeStyle(styleid,modules,props,calculatedVal);
			var valType = "-INT";
			if (step < 1){
				valType = "-FLOAT";
			}
			var values = calculatedVal + valType;
			if (propsArr.length > 1){
				for(var p = 0 ;p < propsArr.length-1 ; p++){
					values += "|" + calculatedVal + valType;
				}
			}

			EditorHelper.UpdateServerStyle(styleid,modules,props,values,"",stripe.attr("id"));
		}
	});
	sliderHolder.append(sliderArrow);
	sliderHolder.append(numericVal);
	sliderHolder.append(sliderRail);
	
	//Handle changing the text filed value
	numericVal.unbind("keyup").bind("keyup",function(e){
		var calculatedVal;
		var step = EditorHelper.StyleSettings["PROPERTIES"][prop].step;
		if (step < 1){
			calculatedVal = parseFloat($(this).val())
		}
		calculatedVal = parseInt($(this).val());
		if (e.keyCode == 38){
			if (calculatedVal + step <= maxValue){
				$(this).val(calculatedVal +  step);
				calculatedVal += step
			}
		}
		if (e.keyCode == 40){
			if (calculatedVal - step >= minValue){
				$(this).val(calculatedVal - step);
				calculatedVal -= step
			}
		}
		var calculatedLeft = ((parseFloat(calculatedVal - minValue)/ diff) * trackWidth );
		if (calculatedVal >= minValue && calculatedVal <= maxValue){
			calculatedLeft = Math.round(calculatedLeft);
			sliderHandle.css({"left":calculatedLeft});
			sliderProgress.css("width",calculatedLeft);
			var valType = "-INT";
			if (step < 1){
				valType = "-FLOAT";
			}
			
			if (sliderClass && sliderClass.indexOf("special-case") != -1){
				EditorHelper.handleSpecialStyleCases(styleid,modules,props,calculatedVal);
				return;
			}
			
			var values = calculatedVal + valType;
			if (propsArr.length > 1){
				for(var p = 0 ;p < propsArr.length-1 ; p++){
					values += "|" + calculatedVal + valType;
				}
			}
			if(prop == "HEIGHT"){
				stripe.find(".text-side").css("display", "block");
				setTimeout(function(){stripe.find(".text-side").css("display","");},0)
			}
			EditorHelper.UpdateRealTimeStyle(styleid,modules,props,calculatedVal);
			EditorHelper.UpdateServerStyle(styleid,modules,props,values,"",stripe.attr("id"));
		}
	});
	
	//Handle clicking directly on the rail
	sliderRail.unbind("click").bind("click",function(e){
		e.stopPropagation();
		var currentX = e.pageX - $(this).offset().left;
		sliderProgress.css("width",currentX);// - 10;
		var calculatedVal = ((currentX / trackWidth) * diff) + minValue;
		if (step < 1){
			calculatedVal = calculatedVal.toFixed(1)
		}else{
			calculatedVal = parseInt(calculatedVal);
		}
		
		numericVal.val(calculatedVal);
		EditorHelper.UpdateRealTimeStyle(styleid,modules,props,calculatedVal);
		
		sliderHandle.css("left",currentX);
		var valType = "-INT";
		if (step < 1){
			valType = "-FLOAT";
		}
		var values = calculatedVal + valType;
		if (propsArr.length > 1){
			for(var p = 0 ;p < propsArr.length-1 ; p++){
				values += "|" + calculatedVal + valType;
			}
		}
		EditorHelper.UpdateServerStyle(styleid,modules,props,calculatedVal,"",stripe.attr("id"));
	});
	sliderHandle.draggable({
		axis: "x",
		containment: "parent",
		start: function(event , ui){
			if(prop == "HEIGHT"){
				if (stripe.is(".fill-height")){
					stripe.removeClass("fill-height");
					stripe.attr("data-was-fill-height",true);
					ui.helper.closest(".switching-panel").find(".full-width-btn").removeClass("selected");
				}
			}
		},
		drag: function( event, ui ) {
			var calculatedVal = ((parseFloat(ui.position.left) / trackWidth) * diff) + minValue;
			if (step < 1){
				calculatedVal = calculatedVal.toFixed(1)
			}else{
				calculatedVal = parseInt(calculatedVal);
			}
			numericVal.val(calculatedVal);
			sliderProgress.css("width",ui.position.left);
			EditorHelper.UpdateRealTimeStyle(styleid,modules,props,calculatedVal);
			if(prop == "HEIGHT"){
				stripe.find(".text-side").css("display", "block");
				setTimeout(function(){stripe.find(".text-side").css("display","");},0)
			}
	  },
	  stop: function( event, ui ) {
		  var calculatedVal = ((parseFloat(ui.position.left) / trackWidth) * diff) + minValue;
		  if (step < 1){
			  calculatedVal =  calculatedVal.toFixed(1)
			}else{
				calculatedVal = parseInt(calculatedVal);
			}
		  numericVal.val(calculatedVal);
		  sliderProgress.css("width",ui.position.left);
		  var valType = "-INT";
			if (step < 1){
				valType = "-FLOAT";
			}
			var values = calculatedVal + valType;
			if (propsArr.length > 1){
				for(var p = 0 ;p < propsArr.length-1 ; p++){
					values += "|" + calculatedVal + valType;
				}
			}
		  EditorHelper.UpdateServerStyle(styleid,modules,props,values,"",stripe.attr("id"));

		},
	});
	//panel.append(sliderHolder);
	inputField.replaceWith(sliderHolder);
	
	
	if (stripe.hasClass(disabledClass)){
		sliderHolder.addClass("disabled");
	}
	
	//set the current initial value
	var currentVal;
	if (EditorHelper.StyleSettings["PROPERTIES"][prop].onchange == "style_change"){
		var relevantCssSelector = EditorHelper.getCssSelector(styleid,moduleName);
		var elementForCss = clickedElement.closest(".master.container").find(relevantCssSelector);
		if (elementForCss.length == 0){
			elementForCss = clickedElement;
		}
		
		currentVal = elementForCss.css(EditorHelper.StyleSettings["PROPERTIES"][prop].css_name);
		if (EditorHelper.StyleSettings["PROPERTIES"][prop].units =="px" && currentVal == ""){
			currentVal = 0;
		}
		
			if (EditorHelper.StyleSettings["PROPERTIES"][prop].step < 1){
				if (!isNaN(parseFloat(currentVal))){
					currentVal = parseFloat(currentVal);
				}
			}else if(EditorHelper.StyleSettings["PROPERTIES"][prop].units){
				if (!isNaN(parseInt(currentVal))){
					currentVal = parseInt(currentVal);
				}
			}
			if (EditorHelper.StyleSettings["PROPERTIES"][prop].units == "%"){
				var parentWidth = parseInt(elementForCss.parent().width());
				var percentVal = (currentVal / parentWidth) * 100;
				currentVal = Math.round(percentVal)
			}
			if (currentVal == 0){
				if (propsArr.length > 1){
					var alternateVal = parseInt(elementForCss.filter("[data-menu-name]").css(EditorHelper.StyleSettings["PROPERTIES"][propsArr[1]].css_name));
					if (alternateVal > currentVal){
						currentVal = alternateVal;
					}
				}
			}
		
	}else if (EditorHelper.StyleSettings["PROPERTIES"][prop].onchange == "arranger-settings-change"){
		var arrangerSettings = clickedElement.find(".arranger-settings");
		currentVal = arrangerSettings.attr("data-" + prop.toLowerCase());
		if (prop == "ARRANGER_COLS"){
			currentVal = Math.min(clickedElement.closest(".master.item-box").find(".sub.item-box").not(".stripe-header").length ,currentVal);
		}
		
			if (EditorHelper.StyleSettings["PROPERTIES"][prop].step < 1){
				if (!isNaN(parseFloat(currentVal))){
					currentVal = parseFloat(currentVal);
				}
			}else{
				if (!isNaN(parseInt(currentVal))){
					currentVal = parseInt(currentVal);
				}
			}
	}else if (EditorHelper.StyleSettings["PROPERTIES"][prop].onchange == "stripe-data-change"){
		if (prop == "HEIGHT"){
			$("#" + clickedElement.closest(".master.item-box").attr("id") +" [style*='min-height']").css({"min-height":"","height":""})
			currentVal = parseInt(clickedElement.closest(".master.item-box").css("min-height"));
		}
	}
	
	
	numericVal.val(currentVal);
	var calculatedLeft = ((parseFloat(currentVal - minValue)/ diff) * trackWidth ) ;
	calculatedLeft = Math.round(calculatedLeft);
	sliderProgress.css("width",calculatedLeft);
	sliderHandle.css({"left":calculatedLeft})
};



EditorHelper.handleSpecialStyleCases = function(styleid,modules,props,newValue){
	if (props == "STRIPE_PADDING_LEFT" && modules=="PREVIEW_STRIPE"){
		var params = {}
		//params.modules = "PREVIEW_STRIPE|PREVIEW_STRIPE|PREVIEW_STRIPE";
		//params.props = "STRIPE_PADDING_LEFT|STRIPE_PADDING_RIGHT|STRIPE_WIDTH";
		var newWidth = 100 - parseInt(newValue)*2;
		var opositeValue = newValue * -1;
		var values = newValue + "-INT|" + newValue + "-INT|" + newWidth + "-INT|" + opositeValue + "-INT";
		EditorHelper.UpdateRealTimeStyle(styleid,"STRIPE_BACKGROUND","PERCENT_MARGIN_LEFT",opositeValue);
		EditorHelper.UpdateRealTimeStyle(styleid,"PREVIEW_STRIPE|PREVIEW_STRIPE","STRIPE_PADDING_LEFT|STRIPE_PADDING_RIGHT",newValue);
		EditorHelper.UpdateRealTimeStyle(styleid,"PREVIEW_STRIPE","STRIPE_WIDTH",newWidth);
		EditorHelper.UpdateServerStyle(styleid,"PREVIEW_STRIPE|PREVIEW_STRIPE|PREVIEW_STRIPE|STRIPE_BACKGROUND","STRIPE_PADDING_LEFT|STRIPE_PADDING_RIGHT|STRIPE_WIDTH|PERCENT_MARGIN_LEFT",values)

	}else if (props == "STRIPE_PADDING_LEFT" && modules=="SLIDE_HELPER_DIV"){
		var newWidth = 100 - parseInt(newValue)*2;
		var opositeValue = newValue * -1;
		var values = newValue + "-INT|" + newValue + "-INT|" + newWidth + "-INT|" + opositeValue + "-INT";
		EditorHelper.UpdateRealTimeStyle(styleid,"SLIDE_PIC_SIDE","PERCENT_MARGIN_LEFT",opositeValue);
		EditorHelper.UpdateRealTimeStyle(styleid,"SLIDE_HELPER_DIV|SLIDE_HELPER_DIV","STRIPE_PADDING_LEFT|STRIPE_PADDING_RIGHT",newValue);
		EditorHelper.UpdateRealTimeStyle(styleid,"SLIDE_HELPER_DIV","STRIPE_WIDTH",newWidth);
		var modules = "SLIDE_HELPER_DIV|SLIDE_HELPER_DIV|SLIDE_HELPER_DIV|SLIDE_PIC_SIDE";
		var props = "STRIPE_PADDING_LEFT|STRIPE_PADDING_RIGHT|STRIPE_WIDTH|PERCENT_MARGIN_LEFT";
		EditorHelper.UpdateServerStyle(styleid,modules,props,values)
	}
};


EditorHelper.UpdateRealTimeStyle = function(styleid,modules,props,newValue,vbid){
	
	
	/////// change UI colors ///////
	
	var myId = '.' + styleid;
	/////// end of change UI colors ///////
	
	var propsArr = props.split("|");
	var modulesArr = modules.split("|");
	
	for (i in propsArr){
		var prop = propsArr[i];
		var moduleName = modulesArr[i];
		var holder = $(".master.item-box." + styleid);
		if (EditorHelper.StyleSettings["PROPERTIES"][prop].onchange == "style_change" || EditorHelper.StyleSettings["PROPERTIES"][prop].onchange == "unique_style_change"){
			var params = {};
			params["css_name"] = EditorHelper.StyleSettings["PROPERTIES"][prop].css_name;
			params["class_name"] =  EditorHelper.StyleSettings["MODULES"][moduleName].CSS_CLASS;
			params["top_class"] =  EditorHelper.StyleSettings["MODULES"][moduleName].TOP_CSS_CLASS;
			params["device_class"] =  EditorHelper.StyleSettings["MODULES"][moduleName].DEVICE_CLASS;
			params["value"] = newValue;
			if ("units" in EditorHelper.StyleSettings["PROPERTIES"][prop]){
				params["value"] = newValue + EditorHelper.StyleSettings["PROPERTIES"][prop]["units"];
			}
			params["target"] = styleid;
			params["vbid"] = vbid;
			params["module"] = moduleName;
			EditorHelper.handleStyleChange(params);
		}else if (EditorHelper.StyleSettings["PROPERTIES"][prop].onchange == "arranger-settings-change"){
			var arrangerSettings = holder.find(".arranger-settings");
			arrangerSettings.attr("data-" + prop.toLowerCase(),newValue);
			holder.attr("data-forced-arrange",true);
			SpimeEngine.ArrangeHolder(holder,{},function(){
				var newItemsMinWidth = holder.attr("data-items-min-width");
				if (typeof newItemsMinWidth != "undefined"){
					EditorHelper.UpdateServerStyle(styleid,"GALLERY_PREVIEW",prop,newValue,"",holder.attr("id"));
					setTimeout(function(){
						EditorHelper.UpdateServerStyle(styleid,"GALLERY_PREVIEW","ARRANGER_ITEM_MIN_WIDTH",newItemsMinWidth,"",holder.attr("id"));
					},1000);
				}
			});
		}else if (EditorHelper.StyleSettings["PROPERTIES"][prop].onchange == "stripe-data-change"){
			holder.css({"min-height":newValue});
		}
	}
};

EditorHelper.UpdateServerStyle = function(styleid,modules,props,values,vbids,stripeToInvalidate){
	var timerKey = modules + "_" + props + styleid;
	var callParams = {"styleid":styleid,"props":props,"values":values,"modules":modules};
	if (typeof vbids != "undefined" && vbids != ""){
		timerKey += "_" + vbids;
		callParams["vbid"] = vbids;
	}
	EditorHelper.debounceSave(timerKey,function(){

		if (modules == "STRIPE" && props == "HEIGHT"){
			EditorHelper.updateStripeData({"vbid":stripeToInvalidate,"parent_vbid":EditorHelper.getPageId(),"updated_key":props,"updated_value":values,"module_name":modules});
			if ($("#" + stripeToInvalidate).attr("data-was-fill-height")){
				$("#" + stripeToInvalidate).removeAttr("data-was-fill-height");
				XPRSHelper.SAFEPOST("/update_css_class", {"vbid":stripeToInvalidate,"updated_key":"STRIPE_HEIGHT","delete_key":"True","stripe_id":stripeToInvalidate}, stripeToInvalidate, "CSS_CLASS");
			}
			return
		}

		EditorHelper.updateMultipleStyleKeys(callParams,function(){
			XPRSHelper.updateParent({"deliver_to":"parent","action":"saved"});
		});
		
		if (modules.indexOf("GALLERY_PREVIEW") != -1  || modules.indexOf("ITEM_PREVIEW") != -1  ){
			if (typeof stripeToInvalidate != "undefined"){
				XPRSHelper.POST("/invalidate_stripe_cache", {stripe_id:stripeToInvalidate,"type":"json"}, function(){
				});	
			}
		}
	});
};


EditorHelper.CreateSocialIconEntry = function(panel,clickedElement,socialId,socialUrl,iconSrc){
	var linkDiv = panel.find(".link-div.template").clone().removeClass("template").attr("id",socialId).attr("data-img-url",iconSrc);
	var linkField = linkDiv.find("input").val(socialUrl);
	var currentTheme = clickedElement.attr("data-theme");
	
	if (iconSrc.indexOf(currentTheme) ==-1 ){
		iconSrc = iconSrc.replace("1", currentTheme);
	}
	
	var linkIcon = linkDiv.find("img.social-icon").attr("src",iconSrc);
	
	linkDiv.find("input").unbind("keyup").bind("keyup",function(e){
		EditorHelper.saveSocialLinksChange(panel,clickedElement);
		clickedElement.find("#" + socialId +" .social-link-url").attr("data-href",$(this).val());
	});
	
	linkDiv.find(".arrange-arrows").children().unbind("click").bind("click",function(e){
		var clickedArrow = $(this);
		var currentLinkDiv = clickedArrow.closest(".link-div");
		var relevantLinkEntry = clickedElement.find("#" + currentLinkDiv.attr("id"))
		if (clickedArrow.attr("class").indexOf("up") != -1){
			currentLinkDiv.prev().before(currentLinkDiv);
			relevantLinkEntry.prev().before(relevantLinkEntry);
		}else{
			currentLinkDiv.next().after(currentLinkDiv);
			relevantLinkEntry.next().after(relevantLinkEntry);		
		}
		
		
		currentLinkDiv.parent().find(".link-div").each(function(index){
			$(this).css("top", $(this).height()*index + 5*index)
		});
		
		
		EditorHelper.saveSocialLinksChange(panel,clickedElement);
	});
	linkDiv.find(".delete-btn").unbind("click").bind("click",function(e){
		var currentLinkDiv = $(this).closest(".link-div");
		var relevantLinkEntry = clickedElement.find("#" + currentLinkDiv.attr("id"));
		var linkParent = currentLinkDiv.parent();
		currentLinkDiv.remove();
		relevantLinkEntry.remove();
		linkParent.find(".link-div").each(function(index){
			$(this).css("top", $(this).height()*index + 5*index)
		});
		EditorHelper.saveSocialLinksChange(panel,clickedElement);
	});
	panel.find(".social-icons-list").append(linkDiv);
	linkDiv.show();
};

EditorHelper.saveSocialLinksChange = function(panel,clickedElement){
	var linksJson = [];
	panel.find(".social-icons-list .link-div").each(function(){
		var currentLinkDiv = $(this);
		var linkJson = {};
		linkJson["URL"] = currentLinkDiv.find("input").val();
		linkJson["NAME"] = currentLinkDiv.attr("id")
		linkJson["ICON"] = currentLinkDiv.attr("data-img-url");
		linksJson.push(linkJson);
	});
	
	var timerKey = "SOCIAL_ICON_PANEL_SAVE_" + clickedElement.attr("id");
	EditorHelper.debounceSave(timerKey,function(){
		var stripeId = clickedElement.closest(".master.item-box").attr("id");
		XPRSHelper.SAFEPOST("/update_specific_child_key",{"vbid":EditorHelper.getHolderParent(clickedElement).attr("id"),"child_vbid":clickedElement.attr("id"),"updated_key":"LINKS","updated_value":JSON.stringify(linksJson),"type":"json","stripe_id":stripeId},EditorHelper.getHolderParent(clickedElement).attr("id"),"UPDATE-CHILD",function() {
		});
	});
};


EditorHelper.populateClassChangePanel = function(panel,target,classesType,btnClass,additionalClass,params){
	panel.find(".button-wrapper").remove();
	if (typeof params == "undefined"){
		params = {};
	}
	var classesToRemove = "";
	var foundClass = false;
	for (var i in EditorHelper.StyleSettings["CSS_CLASSES"][classesType]){
		var buttonClass = EditorHelper.StyleSettings["CSS_CLASSES"][classesType][i]
		var buttonDiv = $("<span />").text(buttonClass.NAME).addClass(btnClass).css("outline","none").addClass("t-t");
		var buttonDivWrapper = $("<div/>").addClass("button-wrapper clickable").addClass(buttonClass.CLASS).attr("data-class-to-add",buttonClass.CLASS);
		classesToRemove += " " + buttonClass.CLASS;
		buttonDivWrapper.append(buttonDiv);
		if (target.hasClass(buttonClass.CLASS)){
			buttonDivWrapper.addClass("selected");
			foundClass = true;
		}
		panel.prepend(buttonDivWrapper);
	}
	
	var clearClassBtnWrapper = $("<div/>").addClass("button-wrapper clickable clear-class");
	if (!foundClass){
		clearClassBtnWrapper.addClass("selected");
	}
	var clearClassBtn = $("<span />").text("Clear").addClass(btnClass).css("outline","none").addClass("t-t");
	clearClassBtnWrapper.append(clearClassBtn);
	panel.prepend(clearClassBtnWrapper);
	clearClassBtnWrapper.unbind("click").bind("click",function(e){
		e.stopPropagation();
		var clickedEffect = $(this);
		clickedEffect.siblings().removeClass("selected");
		clickedEffect.addClass("selected");
		target.removeClass(classesToRemove);
		target.removeClass(additionalClass);
		var parentId = target.attr("id");
		var stripeId = target.closest(".master.item-box").attr("id");;
		XPRSHelper.SAFEPOST("/update_css_class", {"vbid":parentId,"updated_key":classesType,"delete_key":"True","stripe_id":stripeId}, parentId, "CSS_CLASS");
	});
	
	panel.find(".button-wrapper").not(".clear-class").unbind("click").bind("click",function(e){
		e.stopPropagation();
		var clickedEffect = $(this);
		clickedEffect.siblings().removeClass("selected");
		clickedEffect.addClass("selected");
		target.removeClass(classesToRemove);
		target.addClass(clickedEffect.attr("data-class-to-add"));
		target.addClass(additionalClass);
		var parentId = target.attr("id");
		var stripeId = target.closest(".master.item-box").attr("id");;
		XPRSHelper.SAFEPOST("/update_css_class", {"vbid":parentId,"updated_key":classesType,"updated_value":$(this).attr("data-class-to-add"),"stripe_id":stripeId}, parentId, "CSS_CLASS");
		if (params.show_enter_effects || params.show_scroll_effects){
			EditorHelper.simulateEffect(target,classesType);
		}
	});
	

};

EditorHelper.simulateEffect = function(target,effectType){
	if (effectType == "ITEM_ENTER_CLASS"){
		target.find(".item-wrapper, .item-details").css({"-moz-transition-property":"none","-webkit-transition-property":"none","-o-transition-property":"none","transition-property":"none"});
		target.removeClass("visible-section").addClass("hidden-section");
		if ($(".master.container").hasClass("scroll-effects")){
			$(".master.container").addClass("removed-scroll-effects").removeClass("scroll-effects");
		} 
		
		setTimeout(function(){
			target.css({"-moz-transition-property":"","-webkit-transition-property":"","-o-transition-property":"","transition-property":""})
			target.find(".item-wrapper, .item-details").css({"-moz-transition-property":"","-webkit-transition-property":"","-o-transition-property":"","transition-property":""})
			target.removeClass("hidden-section").addClass("visible-section");
			if ($(".master.container").hasClass("removed-scroll-effects")){
				$(".master.container").addClass("scroll-effects")
			} 
		},1000);
	}
	if (effectType == "SCROLL_CLASS"){
		$(".master.item-box .item-wrapper").css({"-moz-transition-property":"none","-webkit-transition-property":"none","-o-transition-property":"none","transition-property":"none"});
		$(".master.item-box ").removeClass("visible-section").addClass("hidden-section");
		setTimeout(function(){
			$(".master.item-box .item-wrapper").css({"-moz-transition-property":"","-webkit-transition-property":"","-o-transition-property":"","transition-property":""})
			$(".master.item-box").removeClass("hidden-section").addClass("visible-section");
		},1000);
	}
	
};



EditorHelper.showDraggableTabbedPanel = function(draggablePanelClass,clickedElement,params){
	//clone the panel , init draggable, store position and bind close btn
	var relevantDraggablePanel = EditorHelper.initDraggableTabbedPanel(draggablePanelClass);
	if (clickedElement === undefined){
		clickedElement = $(".page");
	}
	var menuForProduct = clickedElement.find(".product-container").length > 0;
	if (menuForProduct){
		var mainTitle = relevantDraggablePanel.find(".xprs-selector-title");
		mainTitle.text(mainTitle.text().replace("Slideshow", "Product"));
		relevantDraggablePanel.find(".hide-for-product").remove();
		relevantDraggablePanel.addClass("product");
	}
	if (draggablePanelClass == "raw-edit" || draggablePanelClass == "inline-raw-edit"){
		if((clickedElement.hasClass("custom") || clickedElement.hasClass("page_custom_app") || clickedElement.hasClass("stripe_inline_custom_app"))){
			params["selected-tab"] = "raw-other-apps";
			relevantDraggablePanel.addClass("show-code");
		} 
	}
	relevantDraggablePanel.find(".xprs-class-selector-holder").css("width","");
	var switchingPanels = relevantDraggablePanel.find(".panel-selector-tab");
	//init each panel with its relevant init func
	var stripe = clickedElement.closest(".master.item-box");
	
	switchingPanels.each(function(){
		var tabName = $(this).attr("data-relevant-panel");
		var currentSwitchingPanel = relevantDraggablePanel.find("." + tabName);
		switch (tabName) {
			case "section-settings":
				break;
			case "item-settings":
				break;
			case "edit-image":
				EditorHelper.populateEditImagePanel(currentSwitchingPanel, clickedElement);
				break;
			case "edit-map":
				EditorHelper.populateEditMapPanel(currentSwitchingPanel, clickedElement);
				break;
			case "edit-video":
				EditorHelper.populateEditVideoPanel(currentSwitchingPanel, clickedElement);
				break;
			case "arrange-code":
				EditorHelper.populateRawPanel(currentSwitchingPanel,clickedElement);
				break;
   			case "arrange-social":
   				EditorHelper.populateSocialEditPanel(currentSwitchingPanel,clickedElement);
   				break;
   			case "arrange-menu":
   				var menuId = EditorHelper.checkIfMenuExists();
   				EditorHelper.populateMenuEditPanel(currentSwitchingPanel,menuId);
   				break;
   			case "menu-advanced-settings":
   				var menuId = EditorHelper.checkIfMenuExists();
   				EditorHelper.populateMenuAdvancedSettings(currentSwitchingPanel,menuId);
   				break;
   			case "website-style":
   				EditorHelper.populateWebsiteStylePanel(currentSwitchingPanel,clickedElement);
   				break;
   			case "page-settings":
   			case "menu-type":
   				var menuId = EditorHelper.checkIfMenuExists();
   				EditorHelper.populateMenuSettings(currentSwitchingPanel,menuId);
				   break;
   			case "buttons-style":
   				EditorHelper.populateClassChangePanel(currentSwitchingPanel.find(".buttons-hover-effects"),clickedElement.closest(".master.item-box"),"BUTTONS_HOVER_CLASS","preview-element item-link","button-effects",{"add_effect_color":true});
   				if ($(".master.container").is(".website-style") && !clickedElement.closest(".master.item-box").is(".custom") && !clickedElement.is(".custom")){
   					currentSwitchingPanel.find(".style-class-btn#website-style").addClass("selected");
   					currentSwitchingPanel.attr("data-style-class","website-style");
   				}else{
   					currentSwitchingPanel.find(".style-class-btn#custom").addClass("selected");
   					currentSwitchingPanel.attr("data-style-class","custom");
   				}
   				currentSwitchingPanel.find(".style-class-btn").unbind("click").bind("click",function(){
   					var clickedOption = $(this);
   					clickedOption.siblings().removeClass("selected");
   					clickedOption.addClass("selected");
   					var selectedValue = EditorHelper.websiteStyleBtnClick(clickedOption,clickedElement,clickedElement.closest(".master.item-box"));
   					currentSwitchingPanel.attr("data-style-class",selectedValue);
   				});
   				break;
   			case "scroll-effects-panel":
   				EditorHelper.populateClassChangePanel(currentSwitchingPanel.find(".scroll-effects"),clickedElement.closest(".master.container"),"SCROLL_CLASS","preview-element item-link","scroll-effects",{"show_scroll_effects":true});
   				break;
   			case "items-hover-effects":
   				currentSwitchingPanel.find(".effects-tab").each(function(){
   					var currentTab = $(this);
   					currentTab.unbind("click").bind("click",function(){
   						var clickedTab = $(this);
   						if (!clickedTab.is(".selected")){
   							clickedTab.siblings(".effects-tab").removeClass("selected");
   							clickedTab.addClass("selected");
   							if (clickedTab.attr("data-effect") == "items-hover-effect"){
   								EditorHelper.populateClassChangePanel(currentSwitchingPanel.find(".items-hover-effects"),clickedElement.closest(".master.item-box"),"ITEM_HOVER_CLASS","preview-element item-link","items-hover-effects",{"add_effect_color":true});
   							}else{
   								EditorHelper.populateClassChangePanel(currentSwitchingPanel.find(".items-hover-effects"),clickedElement.closest(".master.item-box"),"ITEM_ENTER_CLASS","preview-element item-link","items-enter-effects",{"show_enter_effects":true});
   							}
   						}
   					});
   				});
   				EditorHelper.populateClassChangePanel(currentSwitchingPanel.find(".items-hover-effects"),clickedElement.closest(".master.item-box"),"ITEM_ENTER_CLASS","preview-element item-link","items-enter-effects",{"show_enter_effects":true});
   				break;
   			case "items-enter-effects":
   				EditorHelper.populateClassChangePanel(currentSwitchingPanel,clickedElement.closest(".master.item-box"),"ITEM_ENTER_CLASS","preview-element item-link","items-enter-effects",{"show_enter_effects":true});
   				break;
   			case "gallery-settings":
   				if(clickedElement.attr("data-preset-type-id") == "BLOG"){
   					relevantDraggablePanel.addClass('blog');
   					$(".bg-panel .panel-color").attr( "data-title", "blog background" );
   					
   					relevantDraggablePanel.find(".draggable-tabbed-panel-header").css("background-color","#A5A500");

   					var quickAction = relevantDraggablePanel.find(".quick-action[data-action='add-item']");
   					quickAction.text(quickAction.text().replace("Item", "Post"));
 
   					var mainTitle = relevantDraggablePanel.find(".xprs-selector-title");
   					mainTitle.text(mainTitle.text().replace("Gallery", "Blog"));
   					
   					var toggleText = relevantDraggablePanel.find(".toggle-select-title").first();
   					toggleText.text(toggleText.text().replace("Gallery", "Blog"));

   				}
   				if(clickedElement.attr("data-preset-type-id") == "STORE"){
   					relevantDraggablePanel.addClass("store-mode");
   					relevantDraggablePanel.find(".draggable-tabbed-panel-header").css("background-color","#339966");
   					var mainTitle = relevantDraggablePanel.find(".xprs-selector-title");
   					mainTitle.text(mainTitle.text().replace("Gallery", "Store"));
   					var whitelabelAllowEcommerce = true;
   					if (LABEL_CONFIG && "SETTINGS" in LABEL_CONFIG && LABEL_CONFIG.SETTINGS.ALLOW_ECOMMERCE == "disallow" && SpimeEngine.ecommerceSolution == "DISABLED"){
   						whitelabelAllowEcommerce = false;
   					}
   					if (whitelabelAllowEcommerce){
   						relevantDraggablePanel.find(".quick-action[data-action='ecommerce-dashboard']").show().siblings("hr").first().show();
   					}
   				}
   				EditorHelper.populateGallerySettings(currentSwitchingPanel,clickedElement);
   				break;
   			case "layout-switching":
   				break;
   			case "raw-settings":
   				EditorHelper.initRawSettings(currentSwitchingPanel,clickedElement);
   				break;
   			case "raw-parameters":
   				EditorHelper.initRawParameters(currentSwitchingPanel,clickedElement);
   				break;
   			case "raw-other-apps":
   				EditorHelper.initRawOtherApps(currentSwitchingPanel,clickedElement);
   				break;
   			case "edit-product":
   				EditorHelper.populateEditProduct(currentSwitchingPanel,clickedElement,params);
   				break;
			case "pro-panel":
   				EditorHelper.initSpacingBox(currentSwitchingPanel,clickedElement);
   				if ($("body").is(".admin-edit")){
   					var presetSelector = $("<select>");
   					presetSelector.unbind("change").bind("change",function(e){
   						var selectedPreset = $(this).val()
   						var stripeId = stripe.attr("id");
   						XPRSHelper.SAFEPOST("/update_specific_key",{"vbid":stripe.attr("id") , "section": "META","updated_key":"PRESET_TYPE_ID","updated_value":selectedPreset},stripe.attr("id"),"PRESET_TYPE_ID",function() {
   							stripe.attr("data-preset-type-id",selectedPreset);
   							XPRSHelper.SAFEPOST("/update_specific_child_key",{"vbid":EditorHelper.getPageId(),"child_vbid":stripe.attr("id"),"updated_key":"TYPE","updated_value":selectedPreset,"stripe_id":stripeId},EditorHelper.getPageId(),"UPDATE-CHILD",function() {
   								
   							});
						});   						
   					})
   					for (presetId in XPRSHelper.presetTypes){
   						if (!XPRSHelper.inPresetGroup(presetId,"ELEMENTS") && !XPRSHelper.inPresetGroup(presetId,"UNRESOLVED")){
   							var presetOp = $("<option>").text(presetId).val(presetId);
   							if (stripe.attr("data-preset-type-id") == presetId){
   								presetOp.attr('selected', true);
   							}
   							presetSelector.append(presetOp);
   						}
   					}
   					currentSwitchingPanel.append(presetSelector)
   				}
				EditorHelper.handleImageDownloadSelector(currentSwitchingPanel,clickedElement);
   				EditorHelper.generateResetBtn(currentSwitchingPanel, draggablePanelClass, clickedElement);
   				break;
   			case "promo-settings":
   	   			break;
   			case "media-center":
   				EditorHelper.openMediaCenter(clickedElement);
   				break;
   			case "social-icons-theme":
   				var currentTheme = clickedElement.attr("data-theme");
   				$(".social-theme").removeClass("selected").unbind("click").bind("click",function(e){
   					e.stopPropagation();
   					var clickedTheme = $(this);
   					currentTheme = clickedElement.attr("data-theme");
   					clickedTheme.siblings().removeClass("selected");
   					clickedTheme.addClass("selected")
   					var clickedThemeFolder = clickedTheme.attr("id").replace("theme","");
   					
   					clickedElement.attr("data-theme",clickedThemeFolder)
   					clickedElement.find(".preview-link-img").each(function(){
   						var currentSrc = $(this).attr("src");
						var currentLink = $(this).closest(".link-entry");
   						var newSrc = currentSrc.replace("1",clickedThemeFolder);
   						if (currentTheme != "1"){
							newSrc = currentLink.attr("data-img-url").substring(0,currentLink.attr("data-img-url").indexOf("/socialmedia/") + "/socialmedia/".length) + clickedThemeFolder + currentLink.attr("id").toLowerCase().replace("_","") + ".png";
   						}
   						$(this).attr("src",newSrc);
   					});
   					var stripeId = clickedElement.closest(".master.item-box").attr("id");
   					XPRSHelper.SAFEPOST("/update_specific_child_key",{"vbid":EditorHelper.getHolderParent(clickedElement).attr("id"),"child_vbid":clickedElement.attr("id"),"updated_key":"THEME","updated_value":clickedThemeFolder,"stripe_id":stripeId},EditorHelper.getHolderParent(clickedElement).attr("id"),"UPDATE-CHILD",function() {
					});
   				});
   				$("#" + currentTheme + ".social-theme").addClass("selected")
   				break;
   			case "page-apps-panel":
   				EditorHelper.populateAppsSettings(currentSwitchingPanel,clickedElement.closest(".master.container"));
   				break;
			case "access-panel":
   				EditorHelper.populateAccessPanel(currentSwitchingPanel,clickedElement.closest(".master.container"));
   				break;
		}
		if (currentSwitchingPanel.find(".layout-switcher-placeholder").length > 0 || currentSwitchingPanel.find(".align-switcher-placeholder").length > 0 ){
			EditorHelper.initLayoutSwitcher (currentSwitchingPanel, clickedElement);
		}
		if (currentSwitchingPanel.find(".boxed-streched").length > 0){
			var boxedOption = $("<li />").addClass("layout-option clickable t-t panel-button").attr("id","boxed-section").text("boxed");
			var stretchedOption = $("<li />").addClass("layout-option clickable t-t panel-button").attr("id","stretched-section").text("stretched");
			if (stripe.find(".item-wrapper").first().css("max-width") == EditorHelper.PAGE_WIDTH + "px"){
				boxedOption.addClass("selected");
			}
			if (stripe.find(".item-wrapper").first().css("max-width") == "none"){
				stretchedOption.addClass("selected");
			}

			boxedOption.add(stretchedOption).unbind("click").bind("click", function(e){
				e.stopPropagation();
				boxedOption.add(stretchedOption).removeClass("selected");
				$(this).addClass("selected");
				EditorHelper.widthSwitcherClick($(this),stripe);

			});
			currentSwitchingPanel.find(".boxed-streched").append(boxedOption).append(stretchedOption);
		}
	});
	
	
	if (params && "main-title" in params){
		var mainTitle = relevantDraggablePanel.find(".xprs-selector-title");
		mainTitle.text(params["main-title"]);
	}

	if (typeof VueEditor != "undefined"){
		VueEditor._router.push("/");
	}
	
	//if this is a footer with a middle layout
	if (clickedElement.closest(".master.item-box").attr("data-preset-type-id") == "FOOTERS" && clickedElement.closest(".master.item-box").find(".middle_layout").length > 0 ){
		relevantDraggablePanel.find(".panel-color[data-module=PREVIEW_ITEM_STRIPE]").attr("data-module","ITEM_PREVIEW")
	}
	
	//init sliders
	relevantDraggablePanel.find(".panel-slider").each(function(){
		var currentSlider = $(this);
		EditorHelper.GeneratePanelSlider(currentSlider,clickedElement);
	});

	//init accodions
	relevantDraggablePanel.find(".accordion").not(".always-show").each(function(){
		var accordionTitle = $(this).find(".accordion-title");
		accordionTitle.click(function(){
			$(this).closest(".accordion").toggleClass("shown");
			$(this).closest(".accordion").find(".accordion-content").slideToggle()
		})
	});
	
	//init color pickers
	relevantDraggablePanel.find(".panel-color").each(function(){
		var currentColorPicker = $(this);
		EditorHelper.GeneratePanelColorPicker(relevantDraggablePanel,currentColorPicker,clickedElement);
	});
	
	//init filter palette
	relevantDraggablePanel.find(".panel-effects").each(function(){
		var currentFilterPalette = $(this);
		EditorHelper.GeneratePanelfilterPalette(relevantDraggablePanel,currentFilterPalette,clickedElement);
	});
	
	//init dropdowns
	relevantDraggablePanel.find(".panel-dropdown").each(function(){
		var currentdropdown = $(this);
		EditorHelper.GeneratePanelDropdown(currentdropdown,clickedElement);
	});

	//init buttons
	relevantDraggablePanel.find("input.panel-button").each(function(){
		var currentbtn = $(this);
		EditorHelper.GeneratePanelButton(currentbtn,clickedElement);
	});
	
	//init font selectors
	var masterContainer = $(".master.container");
	relevantDraggablePanel.find(".font-selector").each(function(){
		var currentFont = "None";
		var currentFontSelector = $(this);
		var relevantFontModule = currentFontSelector.attr("data-module");
		var isWebsiteStyle = relevantFontModule.startsWith("WEBSITE");
		var selectedFontDiv = currentFontSelector.find(".selected-font");
		var testClass = currentFontSelector.attr("data-element-class");

		if ( isWebsiteStyle && masterContainer.is(".website-style")){
			var tempItemBox = $("<div/>").addClass("master item-box").hide();
			var tempTitleForFont = $("<div/>").addClass(testClass);
			tempItemBox.append(tempTitleForFont);
			masterContainer.append(tempItemBox);
			currentFont = tempTitleForFont.css("font-family");
			currentFont = currentFont.replace("'","").replace("'","");
			tempItemBox.remove();
		}else{
			currentFont = clickedElement.css(EditorHelper.StyleSettings["PROPERTIES"]["FONT"].css_name).replace("'","").replace("'","");
		}
		selectedFontDiv.text(currentFont)
		if (currentFont=="None"){
			selectedFontDiv.css("font-family","Arial");
		}else{
			selectedFontDiv.css("font-family",currentFont);
		}
		var fontList = currentFontSelector.find(".fonts-div ul");

		
		var relevantStyleForFont = $("body").attr("data-root-style-id");
		if (!isWebsiteStyle){
			var relevantStyleForFont = clickedElement.closest(".master.item-box").attr("data-styleid");
			if (typeof relevantStyleForFont == "undefined"){
				relevantStyleForFont = clickedElement.closest(".master.item-box").attr("data-preview-styleid");
			}
		}
		EditorHelper.initFontSelector(fontList, currentFont, relevantFontModule, relevantStyleForFont, isWebsiteStyle);
		selectedFontDiv.unbind("click").bind("click",function(e){
			e.stopPropagation();
			relevantDraggablePanel.find(".fonts-div").hide();
			var clickedSelectedFont = $(this);
			clickedSelectedFont.closest(".font-selector").find(".fonts-div").toggle();
		});
	});

	//init quick actions
	relevantDraggablePanel.find(".quick-action").each(function(){
		var currentAction = $(this);
		if (currentAction.attr("data-action") == "delete-image"){
			EditorHelper.markOnHover(currentAction, clickedElement, true, "red");
		}
		currentAction.unbind("click").bind("click",function(e){
			e.stopPropagation();
			if (currentAction.attr("data-action") == "arrange"){
				EditorHelper.showTab(relevantDraggablePanel.find(".panel-selector-tab[data-relevant-panel='arrange-menu']"),relevantDraggablePanel)
			}
			if (currentAction.attr("data-action") == "add-link"){
				EditorHelper.draggablePanelAddLinkToMenu(relevantDraggablePanel);
			}
			if (currentAction.attr("data-action") == "add-page"){
				EditorHelper.showAddPageMenu("add-page",{});
			}
			
			if (currentAction.attr("data-action") == "manage-pages"){
				EditorHelper.showAddPageMenu("manage-pages",{});
			}

			if (currentAction.attr("data-action") == "delete-image"){
				if (clickedElement.is("body")){
					clickedElement.css("background-image","none");
					EditorCore.deleteSpecificStyleKey({"styleid":$("body").attr("data-root-style-id"),"module":"WEBSITE_PAGE","prop":"BACKGROUND_IMAGE"});
				}else if (clickedElement.is(".preview-item-links")) {
					clickedElement.css("background-image","none");
					EditorHelper.deleteSpecificStyleKey({"styleid":clickedElement.closest(".master.item-box").attr("data-preview-styleid"),"module":"MENUFIED_PREVIEW_LINKS_HOLDER","prop":"BACKGROUND_IMAGE"});
					EditorHelper.populateEditImagePanel(relevantDraggablePanel, clickedElement);
				}else{
					clickedElement.css("background-image","");
					var parentId = clickedElement.closest(".item-box").attr("id");
					var stripeId = clickedElement.closest(".master.item-box").attr("id");
					XPRSHelper.SAFEPOST("/remove_child",{"parent":parentId , "child": clickedElement.attr("id"),"stripe_id":stripeId},parentId,{"action_name":"REMOVE-CHILD","pretty_name":"Remove background"},function() {
						clickedElement.attr("id","no-image");
						clickedElement.removeAttr("title");
						EditorHelper.populateEditImagePanel(relevantDraggablePanel, clickedElement);
					});
				}
			}

			if (currentAction.attr("data-action") == "delete-map"){
				EditorHelper.handleDelete({"vbid":clickedElement.attr("id")});
				var parentId = clickedElement.closest(".item-box").attr("id");
				var stripeId = clickedElement.closest(".master.item-box").attr("id");
				XPRSHelper.SAFEPOST("/remove_child",{"parent":parentId , "child": clickedElement.attr("id"),"stripe_id":stripeId},stripe.attr("id"),{"action_name":"REMOVE-CHILD","pretty_name":"Remove Map"},function() {
				});
				EditorHelper.closeDraggableTabbedPanel();
			}
			if (currentAction.attr("data-action") == "delete-video"){
				EditorHelper.handleDelete({"vbid":clickedElement.attr("id")});
				var parentId = clickedElement.closest(".item-box").attr("id");
				var stripeId = clickedElement.closest(".master.item-box").attr("id");
				XPRSHelper.SAFEPOST("/remove_child",{"parent":parentId , "child": clickedElement.attr("id"),"stripe_id":stripeId},stripe.attr("id"),{"action_name":"REMOVE-CHILD","pretty_name":"Remove Video"},function() {
				});
				EditorHelper.closeDraggableTabbedPanel();
			}

			
			if (currentAction.attr("data-action") == "ecommerce-dashboard"){
				currentAction.addClass("loading-state");
				if (SpimeEngine.ecommerceSolution == "DISABLED"){
					EditorHelper.updateStoreCategory(clickedElement.closest(".master.item-box"), 0);
					return;
				} 
				
				if (SpimeEngine.ecommerceSolution == "IMOS"){
					var stripeId = clickedElement.closest(".master.item-box").attr("id");
					EditorHelper.openImosDashboard("store","",{"vbid":stripeId});
				}
			}
			
			
			
			if (currentAction.attr("data-action") == "add-item"){
				var relevantItem = clickedElement.find(".sub.item-box[data-visible='visible']");
				if (relevantItem.length == 0){
					relevantItem = clickedElement.find("#items-holder .sub.item-box").first();
				}
				EditorHelper.cloneItemFromManage(relevantItem, true);
			}
			if (currentAction.attr("data-action") == "change-color"){
				EditorHelper.changeMediaCenterIconColor(relevantDraggablePanel, currentAction.attr("data-param"));
			}
		});
	});
	
	
	if (clickedElement.closest(".master.item-box").is(".stripe_popup_app")){
		var popupQuickAction = $("<div />").addClass("quick-action clickable").text("Popup settings");
		popupQuickAction.unbind("click").bind("click",function(e){
			e.stopPropagation();
	    	var stripePopup = $(".page_stripe_popup_app");
	    	if(stripePopup.length > 0) {
		    	EditorHelper.showDraggableTabbedPanel("raw-edit",stripePopup, {"selected-tab":"raw-parameters","main-title":"Popup"});
				SpimeEngine.initRawHTML(stripePopup.find(".raw-container"),true, function(){
					var DOMContentLoaded_event = document.createEvent("Event");
					DOMContentLoaded_event.initEvent("xprs-app-loaded", true, true);
					window.document.dispatchEvent(DOMContentLoaded_event);
				});
	    	}
		});
		// var quickActionsHolder = $("<div />").addClass("quick-actions")
		// quickActionsHolder.append(popupQuickAction);
		relevantDraggablePanel.find(".page-apps-panel").prepend($("<hr/>"));
		relevantDraggablePanel.find(".page-apps-panel").prepend(popupQuickAction);
		
	}
	
	//init add header btn
	
	EditorHelper.bindAddHeaderBtn(relevantDraggablePanel,clickedElement);
	
	
	//init elements visibility toggle
	relevantDraggablePanel.find(".elements-visibility-toggle .toggle-option").each(function(){
		var stripe = clickedElement.closest(".master.item-box");
		var currentToggleOption = $(this);
		var btnElementType = currentToggleOption.attr("id");
		var relevantItem = clickedElement.find(".sub.item-box[data-visible='visible']");
		var relevantElement = stripe.find("[data-menu-name='"+btnElementType+"']").last();
		if (relevantItem.length > 0){
			relevantElement = relevantItem.find("[data-menu-name='"+btnElementType+"']").last();
		}
		if (relevantElement.length > 0 ){
			currentToggleOption.addClass("selected");
		}
		
		currentToggleOption.unbind("click").bind("click",function(){
			var clickedToggle = $(this);
			EditorHelper.toggleElementVisibilityClick(stripe,clickedToggle);
		});
	});	
	XPRSTranslator.translateDom(relevantDraggablePanel);
	
	if (typeof params != "undefined" && "selected-tab" in params) {
		if (clickedElement.hasClass("preview-element") && params["selected-tab"] == "arrange-code"){
			params["selected-tab"] = "raw-other-apps"
		}
		EditorHelper.showTab(relevantDraggablePanel.find(".panel-selector-tab[data-relevant-panel='"+params["selected-tab"]+"']"),relevantDraggablePanel);
	}
	
	relevantDraggablePanel.css("display","block").addClass("shown");
	
	setTimeout(function(){
		relevantDraggablePanel.css("transform", "translateX(0) translateY(0)");
	},0);
	// //Panel should be above the fold completely
	// if (relevantDraggablePanel.height() + relevantDraggablePanel.position().top > $(window).height()){
	// 	relevantDraggablePanel.css({"top":0});
	// }
};


EditorHelper.initImosDashboard = function(){
	XPRSIMOS.rootId = EditorHelper.getRootId();
	
	var cmsBlocker = $(".imos-blocker");
	var cmsWindow = cmsBlocker.find(".imos-window");
	XPRSIMOS.initMenu(cmsWindow);
	cmsWindow.addClass("shadowed")
	var cmsContent = cmsWindow.find(".imos-content");
	cmsContent.addClass("dirty-flag-holder")
	var cmsHeader = cmsWindow.find(".imos-header");
	var closeBtn = $("<div />").addClass("imos-close imos-ok-btn imos-btn clickable").text("OK");
	cmsBlocker.append(closeBtn);
	cmsBlocker.add(closeBtn).unbind("click").bind("click",function(e){
		e.stopPropagation();
		if (cmsContent.is(".dirty")){
			cmsContent.removeClass("dirty");
			closeBtn.addClass("loading-state")
			var allDirtyStripes = cmsContent.attr("data-dirty-stripes");
			if (allDirtyStripes){
				allDirtyStripes = JSON.parse(allDirtyStripes);
			}
			var reloadedOneStripe = false;
			for (stripeId in allDirtyStripes){
				EditorHelper.reloadPart({"vbid":stripeId},function(){
					if (!reloadedOneStripe){
						reloadedOneStripe = true;
						SpimeEngine.enableScroll();
						cmsBlocker.fadeOut(function(){
							closeBtn.removeClass("loading-state");
						});
					}
				});	
			}
		}else{
			closeBtn.removeClass("loading-state");
			SpimeEngine.enableScroll();
			cmsBlocker.fadeOut(function(){
			});
		}
	});
	cmsWindow.unbind("click").bind("click",function(e){
		e.stopPropagation();
	});
};

EditorHelper.generateResetBtn = function(currentSwitchingPanel, draggablePanelClass, clickedElement){
	var hardReset = $("<div class='panel-button clickable' />").text("hard reset").click(function(){
		var stripe = clickedElement.closest(".master.item-box");
		var styleid = stripe.attr("data-preview-styleid");
		$.get("/reset_style",{"sbid":styleid},function(resetArr){
			for (var i in resetArr){
				var prop = resetArr[i]["prop"];
				var moduleName = resetArr[i]["module"];
				var value = resetArr[i]["value"];
				var styleChangeParams = {}
				styleChangeParams["css_name"] = EditorHelper.StyleSettings["PROPERTIES"][prop].css_name;
				styleChangeParams["class_name"] =  EditorHelper.StyleSettings["MODULES"][moduleName].CSS_CLASS;
				styleChangeParams["top_class"] =  EditorHelper.StyleSettings["MODULES"][moduleName].TOP_CSS_CLASS;
				styleChangeParams["parent_class"] =  EditorHelper.StyleSettings["MODULES"][moduleName].PARENT_CSS_CLASS;
				styleChangeParams["value"] = value;
				styleChangeParams["target"] = styleid;
				styleChangeParams["module"] = moduleName;
				EditorHelper.handleStyleChange(styleChangeParams);
			}
			EditorHelper.showDraggableTabbedPanel(draggablePanelClass, clickedElement,{"selected-tab":"pro-panel"});
		},"json");
	});
	currentSwitchingPanel.append(hardReset)
};

EditorHelper.handleImageDownloadSelector = function(currentSwitchingPanel,clickedElement){
	var dropdownVal = currentSwitchingPanel.find("#allow-image-download");
	var stripe = clickedElement.closest(".master.item-box");
	if (stripe.find(".sub.container").attr("data-allow-download") == "true"){
		dropdownVal.val(currentSwitchingPanel.find("[data-value='ALLOW_DOWNLOAD_ALL']").attr("data-text"));
	}
	if (dropdownVal.length) {
		dropdownHolder = dropdownVal.closest(".dropdown-holder")
		dropdownVal.unbind("click").bind("click",function(e){
			e.stopPropagation();
			var clickedField = $(this);
			clickedField.closest(".switching-panel").one("click",function(){
				dropdownHolder.removeClass("show-list");
			})
			dropdownHolder.toggleClass("show-list");
		});
		dropdownHolder.find(".dropdown-option").unbind("click").bind("click",function(e){
			e.stopPropagation();
				var clickedOp = $(this);
				var newValue = clickedOp.attr("data-value");
				
				dropdownHolder.removeClass("show-list");
				if (clickedOp.attr("data-text") != dropdownVal.val()){
					dropdownVal.val(clickedOp.attr("data-text"));
					if (newValue == "ALLOW_DOWNLOAD_ALL"){
						XPRSHelper.SAFEPOST("/update_specific_key",{"vbid":stripe.attr("id") , "section": "META","updated_key":"IMAGE_DOWNLOAD","updated_value":newValue},stripe.attr("id"),"IMAGE_DOWNLOAD",function() {
							stripe.find(".sub.container").attr("data-allow-download","true");
						}); 
					}else{
						XPRSHelper.SAFEPOST("/update_specific_key",{"vbid":stripe.attr("id"), "section": "META","updated_key":"IMAGE_DOWNLOAD","delete_key":"True"},stripe.attr("id"),"IMAGE_DOWNLOAD",function() {
							stripe.find(".sub.container").removeAttr("data-allow-download");
						}); 
					}
					XPRSHelper.POST("/invalidate_stripe_cache", {stripe_id:stripe.attr("id"),"type":"json"}, function(){});
				}
		});
	}
};


EditorHelper.openImosDashboard = function(mode,section,params){
	EditorHelper.closeDraggableTabbedPanel();
	SpimeEngine.disableScroll();
	var cmsBlocker = $(".imos-blocker");
	var cmsWindow = cmsBlocker.find(".imos-window");
	EditorHelper.createImosSiteIfNeeded(function(){
		XPRSIMOS.loadImosDashboardPage(cmsWindow,mode,params);
		cmsBlocker.fadeIn();
	})
	
};


EditorHelper.changeMediaCenterIconColor = function(relevantDraggablePanel,color){
	if (color == "black"){
		relevantDraggablePanel.removeClass("icon-gray");
		relevantDraggablePanel.removeClass("icon-white");
		relevantDraggablePanel.addClass("icon-black");
		relevantDraggablePanel.find("#myDiv").children().first().css("background-color", "white");
	}
	if (color == "white"){
		relevantDraggablePanel.removeClass("icon-gray");
		relevantDraggablePanel.removeClass("icon-black");
		relevantDraggablePanel.addClass("icon-white");
		relevantDraggablePanel.find("#myDiv").children().first().css("background-color", "black");
	}
	if (color == "gray"){
		relevantDraggablePanel.removeClass("icon-white");
		relevantDraggablePanel.removeClass("icon-black");
		relevantDraggablePanel.addClass("icon-gray");
		relevantDraggablePanel.find("#myDiv").children().first().css("background-color", "white");
	}
};


EditorHelper.toggleElementVisibilityClick = function(stripe,clickedToggle){
	var presetType = stripe.attr("data-preset-type-id");
	var btnElementType = clickedToggle.attr("id");
	var selectedType = btnElementType.replace("PREVIEW_","");
	if (clickedToggle.is(".selected")){
		if (SpimeEngine.getHolderType(stripe) == "gallery" && !XPRSHelper.inPresetGroup(presetType,"SLIDESHOWS")){
			var elementsToDelete = stripe.find("[data-menu-name='"+btnElementType+"']");
			var elementsToDeleteIds = {};
			elementsToDelete.each(function(){
				var vbid = $(this).attr("id");
				var itemParent = $(this).closest(".sub.item-box");
				elementsToDeleteIds[itemParent.attr("id")] = {};
				elementsToDeleteIds[itemParent.attr("id")] = vbid;
				EditorHelper.handleDelete({"vbid":vbid});
			});
			var stripeId = stripe.attr("id");
			XPRSHelper.POST("/remove_multiple_elements",{"elemets_ids":JSON.stringify(elementsToDeleteIds),"stripe_id":stripeId},stripe.attr("id"),function() {
			});
		}else{
			var elementToDelete = stripe.find("[data-menu-name='"+btnElementType+"']").last();
			var parentOfElementId = stripe.attr("id");
			if (XPRSHelper.inPresetGroup(presetType,"SLIDESHOWS")){
				var visibleItem = stripe.find(".sub.item-box[data-visible='visible']");
				elementToDelete = visibleItem.find("[data-menu-name='"+btnElementType+"']").last();
				parentOfElementId = visibleItem.attr("id");
			}
			var vbid = elementToDelete.attr("id");
			EditorHelper.handleDelete({"vbid":vbid});
			var stripeId = elementToDelete.closest(".master.item-box").attr("id");
			XPRSHelper.SAFEPOST("/remove_child",{"parent":parentOfElementId , "child": vbid,"stripe_id":stripeId},stripe.attr("id"),{"action_name":"REMOVE-CHILD","pretty_name":"Remove " + selectedType},function() {
			});
			
		}
	}else{
		if (SpimeEngine.getHolderType(stripe) == "gallery" && !XPRSHelper.inPresetGroup(presetType,"SLIDESHOWS")){
			if (selectedType != "PIC"){
				EditorHelper.addElementToMultipleItems(btnElementType.replace("PREVIEW_",""),btnElementType,stripe);
			}else{
				var elementData = {};
				elementData["PREVIEW"] = {};
				elementData["PREVIEW"][selectedType] = EditorHelper.defaultElementValues[selectedType];
				elementData["PREVIEW"][selectedType]["VBID"] = EditorHelper.shortUuid();
				stripe.find("[data-menu-name='PREVIEW_INLINE_IMAGE']").each(function(){
					var imageHolder = $(this);
					if (imageHolder.attr("id") == "no-image"){
						imageHolder.css("background-image","url("+ elementData["PREVIEW"][selectedType]["URL"] +"=s1600)");
						imageHolder.closest("#no-image").attr("id",elementData["PREVIEW"][selectedType]["VBID"]);
					}
				});
				
				
			}
		}else{
			if (XPRSHelper.inPresetGroup(presetType,"SLIDESHOWS")){
				var visibleItem = stripe.find(".sub.item-box[data-visible='visible']");
				var relevantElement = visibleItem.find("[data-menu-name='"+btnElementType+"']");
				if (relevantElement.length == 0){
					EditorHelper.adddEl(btnElementType.replace("PREVIEW_",""),btnElementType,visibleItem,stripe)
				}
			}else{
				EditorHelper.adddEl(btnElementType.replace("PREVIEW_",""),btnElementType,stripe,stripe)
			}
		}
	}
	//arrange after all elements have been added/removed
	setTimeout(function(){
		SpimeEngine.ArrangeHolder(stripe);
	},1500)
	
	clickedToggle.toggleClass("selected");
};


EditorHelper.addElementToMultipleItems = function(selectedType,btnElementType,stripe){
	var elementPositions = {};
	var relevantItems = stripe.find(".sub.item-box").not(".stripe-header");
	relevantItems.each(function(){
		var currentItem = $(this);
		var relevantElement = currentItem.find("[data-menu-name='"+btnElementType+"']").last();
		if (relevantElement.length == 0){
			var elementPlaceHolder = EditorHelper.getElementPlaceholder(selectedType,currentItem);
			var afterId = elementPlaceHolder.attr("data-after-id");
			elementPositions[currentItem.attr("id")] = {};
			elementPositions[currentItem.attr("id")]["after_id"] = afterId;
			elementPositions[currentItem.attr("id")]["element_id"] = EditorHelper.shortUuid();
		}
	});
	var elementData = {};
	elementData["PREVIEW"] = {};
	elementData["PREVIEW"][selectedType] = EditorHelper.defaultElementValues[selectedType];
	elementData["PREVIEW"][selectedType]["VBID"] = "no-id";
	elementData["PREVIEW"][selectedType]["CONTEXT"] = "PREVIEW";
	if (selectedType == "ICON"){
		if (EditorHelper.shortcodesJson){
			for(i in EditorHelper.shortcodesJson["CHILDREN"]){
				var child = Object.getOwnPropertyNames(EditorHelper.shortcodesJson["CHILDREN"][i]);
				if (child == "ICON"){
					elementData["PREVIEW"][selectedType]["URL"] = EditorHelper.shortcodesJson["CHILDREN"][i]["ICON"]["URL"];
				}
			}
		}
	}
	XPRSHelper.POST("/add_multiple_elements",{element_type:btnElementType ,element_data:JSON.stringify(elementData),elements_positions:JSON.stringify(elementPositions),template_src:"xprs/ordered/","stripe_id":stripe.attr("id")} ,function(resp){
		var allAddedElements = $();
		relevantItems.each(function(){
			var itemId = $(this).attr("id");
			if(itemId in elementPositions){
				var currentItem = $(this);
				var dataDiv = $(resp["element_html"]);
				dataDiv.find("#no-id").attr("id",elementPositions[itemId]["element_id"])
				EditorHelper.overrideLinks(dataDiv);
				EditorHelper.addLeftClickMenu(dataDiv);
				dataDiv.hide();
				currentItem.find(".element-placeholder[data-elementtype='"+selectedType+"']").first().replaceWith(dataDiv);
				allAddedElements = allAddedElements.add(dataDiv)
			}
		});
		setTimeout(function(){
			allAddedElements.fadeIn();
			SpimeEngine.ArrangeHolder(stripe);
		},300)
	},"json");
};



EditorHelper.initSpacingBox = function(currentSwitchingPanel,clickedElement){
	spacingWidget = currentSwitchingPanel.find(".spacing-widget");
	
	var dropdownHolder = $("<div />").addClass("clickable dropdown-holder");
	var dropdownVal = $("<input readonly />").addClass("dropdown-val clickable").val(XPRSTranslator.translateText("text box spacing")).attr("value","PREVIEW_CONTENT_HOLDER")
	var dropdownList = $("<ul />").addClass("dropdown-list").css("margin","0px");
	
	var spacingElements = [{"value":"PREVIEW_CONTENT_HOLDER","title":"text box spacing","always_show":true},
	                       {"value":"PREVIEW_TITLE","title":"Title spacing"},
	                       {"value":"PREVIEW_SUBTITLE","title":"subtitle spacing"},
	                       {"value":"PREVIEW_BODY","title":"body spacing"},
	                       {"value":"PREVIEW_LINK","title":"button spacing"},
	                       {"value":"PREVIEW_ICON","title":"icon spacing"},
	                       {"value":"PREVIEW_FIELD","title":"field spacing"}];
	if (clickedElement.closest(".master.item-box").find(".stripe-header-wrapper").length > 0){
		spacingElements.push({"value":"BLOCKS_PREVIEW_CONTENT_HOLDER","title":"header text box spacing","always_show":true});
		spacingElements.push({"value":"BLOCKS_PREVIEW_LINK","title":"header button spacing","always_show":true});
	}
	var styleid = clickedElement.closest(".master.item-box").attr("data-styleid");
	
	for (i in spacingElements){
		var opValue = spacingElements[i].value;
		if (clickedElement.closest(".master.item-box").find("[data-menu-name='"+ opValue +"']").length > 0 ||  spacingElements[i].always_show){
			var opText = spacingElements[i].title
			var dropdownOption = $("<li />").addClass("dropdown-option t-t").attr("data-value",opValue).attr("data-text",opText).text(opText);
			dropdownOption.unbind("click").bind("click",function(e){
				e.stopPropagation();
				var clickedOp = $(this);
				var newModule = clickedOp.attr("data-value");
				var relevantCssSelector = EditorHelper.getCssSelector(styleid, clickedOp.attr("data-value"))
				var elementForCss = clickedElement.closest(".master.item-box").find(relevantCssSelector);
				
				spacingWidget.find(".slider-holder").each(function(){
					var currentSlider = $(this);
					currentSlider.attr("data-module",newModule);
					EditorHelper.GeneratePanelSlider(currentSlider,clickedElement);
				});
				var moudleForReset = ""
				for (var x=0; x < 7 ; x ++ ){
					moudleForReset += newModule + "|"
				}
				moudleForReset += newModule;
				spacingWidget.find(".reset-margin-btn").attr("data-modules",moudleForReset);
				dropdownVal.val(XPRSTranslator.translateText($(this).attr("data-text")));
				dropdownHolder.removeClass("show-list");
			})
			dropdownList.append(dropdownOption);
		}
	}
	dropdownHolder.append(dropdownVal).append(dropdownList);
	dropdownVal.unbind("click").bind("click",function(e){
		e.stopPropagation();
		var clickedField = $(this);
		clickedField.closest(".switching-panel").one("click",function(){
			dropdownHolder.removeClass("show-list");
		})
		dropdownHolder.toggleClass("show-list");
	});
	spacingWidget.before(dropdownHolder)
	currentSwitchingPanel.find(".reset-margin-btn").unbind("click").bind("click",function(){
		var styleid = clickedElement.closest(".master.item-box").attr("data-styleid");
		modules = $(this).attr("data-modules");
		props = $(this).attr("data-props");
		newValue = 0;
		values = "0-INT|0-INT|0-INT|0-INT|0-INT|0-INT|0-INT|0-INT";
		$(this).closest(".spacing-widget").find(".slider-numeric").val(newValue)
		EditorHelper.UpdateRealTimeStyle(styleid,modules,props,newValue);
		EditorHelper.UpdateServerStyle(styleid,modules,props,values);
	})
}
	


EditorHelper.initDraggableTabbedPanel = function(draggablePanelClass){
	EditorHelper.closeDraggableTabbedPanel();
	var relevantDraggablePanel = $(".draggable-tabbed-panel-wrapper.template." + draggablePanelClass).clone();
	relevantDraggablePanel.removeClass("template");
	$(".draggable-tabbed-panel-wrapper.template." + draggablePanelClass).after(relevantDraggablePanel);
	var currentScrollTop = $(window).scrollTop();
	relevantDraggablePanel.attr("data-scroll-pos",currentScrollTop);
	relevantDraggablePanel.find(".color-list-holder").remove();
	relevantDraggablePanel.find(".panel-selector-tab").unbind("click").bind("click",function(e){
		e.stopPropagation();
		var clickedTab = $(this);
		var initialTemplate = XPRSHelper.getXprsCookie("xprs-initial-template");
		var panelToShow = clickedTab.attr("data-relevant-panel");
		if (panelToShow == "pro-panel"){
			XPRSHelper.trackEvent('clicked_pro',"General", initialTemplate);
			EditorHelper.behindPayment(function(){
				EditorHelper.showTab(clickedTab, relevantDraggablePanel);
			});
		}else{
			EditorHelper.showTab(clickedTab, relevantDraggablePanel);
		}
	});
	
	relevantDraggablePanel.find(".close-btn").unbind("click").bind("click",function(e){
		e.stopPropagation();
		EditorHelper.closeDraggableTabbedPanel(relevantDraggablePanel);
	});

	relevantDraggablePanel.find(".move-panel").unbind("click").bind("click",function(e){
		e.stopPropagation();
		$("body").toggleClass("panel-appear-right");
	});
	
	return relevantDraggablePanel;
};


EditorHelper.closeDraggableTabbedPanel = function(relevantDraggablePanel){
	if (typeof relevantDraggablePanel == "undefined"){
		relevantDraggablePanel = $(".draggable-tabbed-panel-wrapper.shown");
	}
	if (relevantDraggablePanel.length > 0){
		$(".color-picker").spectrum("hide");
		if (relevantDraggablePanel.find(".dirty").length > 0){
			var message = "It seems like you changed some product details but did not saved them..."; 
			XPRSHelper.xprsAlert(message,{title: "Save Changes?", showCancelButton: true,confirmButtonText:"Save",cancelButtonText:"Discard Changes","callbackfunc":function(isConfirm){
					relevantDraggablePanel.find(".dirty").removeClass("dirty")
				   if(isConfirm){
					   relevantDraggablePanel.find("form").submit();
				   }else{
					   EditorHelper.closeDraggableTabbedPanel(relevantDraggablePanel)
				   }
			}});
			return;
		}
		relevantDraggablePanel.parent().find(".color-list-holder").remove();
		if (relevantDraggablePanel.is(".media-center")){
			relevantDraggablePanel.css("transform","translateY(100%)");
		}else if ($("body").is(".panel-appear-right")){
			relevantDraggablePanel.css("transform","translateX(-100%)");
		}else{
			relevantDraggablePanel.css("transform","translateX(100%)");
		}
		setTimeout(function(){
			relevantDraggablePanel.remove();
		},500);
		
		if($(".text-sidebar-container").length > 0){
			$(".text-sidebar-container").removeClass("text-sidebar-container")
			$(".text-edit-sidebar").remove();
		}
	}
};


EditorHelper.behindPayment = function(callbackFunc){
	var isBricksite = (LABEL_CONFIG && "META" in LABEL_CONFIG && LABEL_CONFIG.META.NAME == "bricksite"); 
	if ($("body").is(".admin-edit") || Object.keys(EditorHelper.loadedLicense).length > 0 || isBricksite){
		callbackFunc(EditorHelper.loadedLicense);
		return;
	}
		XPRSHelper.GET("/get_site_license",{"vbid":EditorHelper.getRootId()},function(license){
			EditorHelper.loadedLicense = license;
			var initialTemplate = XPRSHelper.getXprsCookie("xprs-initial-template");
			if (typeof license.vbid != "undefined"){//licensed
				callbackFunc(license);
			}else{
				XPRSHelper.xprsAlert(
					"Some of the features we offer require a premium license. To enjoy this feature, unlimited hosting and a domain -  please upgrade",
					{title: XPRSTranslator.translateText("This is a Premium Feature"), showCancelButton: true,confirmButtonText:"Upgrade Now",cancelButtonText:"Later","callbackfunc":function(isConfirm){
					if(isConfirm){
						XPRSHelper.trackEvent('clicked_pro_upgrade', "General", initialTemplate);
						if (typeof VueEditor != "undefined"){
							VueEditor._router.push("/website/publish");
						}else{
							$("#publish-btn").click();
						}
						
					}else{
						XPRSHelper.trackEvent('clicked_pro_later',"General", initialTemplate);
					}
				}, cancelFunc:function(){XPRSHelper.trackEvent('clicked_pro_later',"General", initialTemplate);}});
			}
		},"json");
	
}

EditorHelper.showTab = function(tabBtn,relevantDraggablePanel){
	tabBtn.siblings().removeClass("selected");
	tabBtn.addClass("selected");
	var panelToShow = tabBtn.attr("data-relevant-panel");
	relevantDraggablePanel.find(".switching-panel").removeClass("selected")
	relevantDraggablePanel.find(".switching-panel." + panelToShow).addClass("selected");
	if (tabBtn.attr("data-override-width")){
		relevantDraggablePanel.find("#xprs-class-selector-holder").css("width",600);
	}else{
		relevantDraggablePanel.find("#xprs-class-selector-holder").css("width","");	
	}
};



EditorHelper.populateButtonStylesPanel = function(panelWrapper,clickedElement){
	var panel = panelWrapper.find(".buttons-style");
	var isBlocks = clickedElement.closest(".blocks").length > 0;
	var styleid = clickedElement.closest(".master.item-box").attr("data-styleid");
	if (typeof styleid == "undefined"){
		styleid = clickedElement.closest(".master.item-box").attr("data-preview-styleid");
	}
	panel.find(".panel-section-control-color").each(function(){
		var btn = $(this);
		var prop = btn.attr("data-prop");
		var moduleName = btn.attr("data-module-name");
		if (isBlocks){
			moduleName = "BLOCKS_" + moduleName;
		}
		btn.css("background-color",(clickedElement.css(EditorHelper.StyleSettings["PROPERTIES"][prop].css_name)));
		if (moduleName.indexOf("PREVIEW_LINK_HOVER") != -1){
			var testHover = $("<div />").css({"display":"none"}).addClass("hover-tester");
			clickedElement.after(testHover);
			btn.css("background-color",(testHover.css(EditorHelper.StyleSettings["PROPERTIES"][prop].css_name)));
			testHover.remove();
		} 
		
		btn.unbind("click").bind("click",function(e){
			e.stopPropagation();
			$(".color-picker").spectrum("hide");
			panelWrapper.find(".color-list-holder").remove();
			var listLeft = btn.position().left + btn.width();
			var listTop =  btn.position().top + btn.height();
			var colorsListHolder = $("<div/>").addClass("color-list-holder sp-menu always-show").css({"position":"absolute","left":listLeft + "px","top":listTop +"px"});
			var colorsList = $("<ul/>").addClass("sp-menu");
			colorsListHolder.append(colorsList);
			EditorHelper.createColorPaletteMenu(colorsList,clickedElement,styleid,moduleName,{"prop":prop,"second_target":btn,"close_on_select":true});
			panelWrapper.append(colorsListHolder);
		});
	});

};


EditorHelper.handleScroll = function(event){
	var openDraggableTabbedPanels = $(".draggable-tabbed-panel-wrapper.shown");
	openDraggableTabbedPanels.each(function(){
		if (!openDraggableTabbedPanels.is(".website-style")){
			var olderScrollPos = parseInt($(this).attr("data-scroll-pos"));
			if (Math.abs(olderScrollPos - $(window).scrollTop()) > 500 && !$(this).hasClass("stay-on-scroll")){
				EditorHelper.closeDraggableTabbedPanel($(this))
			}
		}
	});
	var openLayoutMenus = $(".layout-list-holder");
	openLayoutMenus.each(function(){
		var olderScrollPos = parseInt($(this).attr("data-scroll-pos"));
		if (Math.abs(olderScrollPos - $(window).scrollTop()) > 500){
			$(this).css("display","none").removeClass("shown");
		}
	});
	var openLeftClickMenus = $(".left-click-menu-holder");
	openLeftClickMenus.each(function(){
		var olderScrollPos = parseInt($(this).attr("data-scroll-pos"));
		if (Math.abs(olderScrollPos - $(window).scrollTop()) > 500){
			$(".mark-area").removeClass("mark-area");
			$(this).remove();
		}
	});
};


EditorHelper.handleShowAddSection = function(addSectionIndex){
	if ($("#add-menu-wrapper").length > 0){
		if (addSectionIndex === undefined){
			addSectionIndex = 1;
		}
		var menuExists = EditorHelper.checkIfMenuExists();
		var numberOfStripes = $(".control-handle").length;
		//no menu
		if( !menuExists ){
			addSectionIndex = 0;
		}else{
			//footer + all rights reserved
			if (numberOfStripes <= 3 && $(".footer-box").nextAll().length > 1){
				addSectionIndex = 0;
			}
			//only two stripes
			if (numberOfStripes <= 2){
				addSectionIndex = 1;
			}
			if (numberOfStripes <= 1){
				addSectionIndex = 0;
			}
		}
		var res = $(".control-handle:eq(" + addSectionIndex + ") #add-stripe").click();
		//no such index
		if (res.length == 0){
			$(".control-handle:eq(1) #add-stripe").click();
		}
		EditorHelper.scrollToItem({vbid:"empty-stripe","top_padding":30});
	}else{
		setTimeout(function(){
			EditorHelper.handleShowAddSection(addSectionIndex);	
		},500);
	}
}




EditorHelper.removePopupApp = function(){
	var currentPageId = EditorHelper.getMasterId();
	var appKind = 'stripe_popup_app';
	var appBtn = $('li.'+appKind);
	
	XPRSHelper.xprsAlert("Any changes you have made to the app's code will be lost.",{title: "Are you sure you want to remove this app?",closeOnCancel:true, showCancelButton: true,confirmButtonText:"Remove",cancelButtonText:"Cancel","callbackfunc":function(isConfirm){
		if(isConfirm) {
			EditorHelper.removeApp(currentPageId,appBtn,appKind);
			$("#stripe_popup_app.toggle-option").removeClass("selected");
			var relevantDraggablePanel = $('.draggable-tabbed-panel-wrapper.raw-edit.shown'); 
			if(relevantDraggablePanel)EditorHelper.closeDraggableTabbedPanel(relevantDraggablePanel);
		}
	}});
}

EditorHelper.showPopupApp = function(){
	var stripePopup = $(".page_stripe_popup_app");
	    	
	if(stripePopup.length > 0) {
		EditorHelper.showDraggableTabbedPanel("raw-edit",stripePopup, {"selected-tab":"raw-parameters","main-title":"Popup"});
		SpimeEngine.initRawHTML(stripePopup.find(".raw-container"),true, function(){
			var DOMContentLoaded_event = document.createEvent("Event");
			DOMContentLoaded_event.initEvent("xprs-app-loaded", true, true);
			window.document.dispatchEvent(DOMContentLoaded_event);
			
			XPRSHelper.updateParent({"deliver_to":"parent","action":"app-dismiss-control-panel"});
		});
		
	} else {
		
		$("#stripe_popup_app.toggle-option").addClass("selected");
		
		$("#empty-stripe").remove();
		var addedHolder = $("<div />").addClass("master item-box animated-height").attr("id","empty-stripe");
		$("#children").prepend(addedHolder);
		 
		var appKind = "stripe_popup_app";
		var itemType = "RAW";
		var params = {};
		params['element_type'] = itemType;
		var elementData = {};
		elementData[itemType] = EditorHelper.defaultElementValues[itemType];
		elementData[itemType]["VBID"] = EditorHelper.shortUuid();
		elementData[itemType]["URL"] = "/html_src/" + EditorHelper.shortUuid("static");
		elementData[itemType]["TYPE"]  = "page_" + appKind;
		
		params['element_data'] = JSON.stringify(elementData);
		params['template_src'] = 'xprs/';
		EditorHelper.addElement(addedHolder,"first",params,true,function(){

			var currentPageId = EditorHelper.getMasterId();
			
			var originalStripeId = 'vbid-stripe-popup-form-coupon';
			var originalparentVbid ='vbid-stripe-popup-form-site';
			
			$("#empty-stripe").remove();
			var addedHolder = $("<div />").addClass("master item-box animated-height").attr("id","empty-stripe");
			$("#children").append(addedHolder);
			
			EditorHelper.safeCloneStripe(originalStripeId,addedHolder,"FORM",currentPageId,originalparentVbid,"last",false, function(){
				var appName = "page_" + appKind;
				var clickedElement = $("."+appName);
				var selectedTab = "raw-parameters";
				EditorHelper.showDraggableTabbedPanel("raw-edit",clickedElement, {"selected-tab":selectedTab,"main-title":"Popup"});
				EditorHelper.startElementEditMode(clickedElement);
				var DOMContentLoaded_event = document.createEvent("Event");
				DOMContentLoaded_event.initEvent("xprs-app-loaded", true, true);
				window.document.dispatchEvent(DOMContentLoaded_event);
				XPRSHelper.updateParent({"deliver_to":"parent","action":"app-dismiss-control-panel"});
				setTimeout(function(){EditorHelper.askAboutWebsiteStyle(addedHolder, true);
				},2000);
			}, false);
			
		});
	}
}

EditorHelper.calcFillHeight = function(menuLayout){
	var menuHeightShouldBeZero = false;
	var menuStripe = $("[data-preset-type-id='MENUS']");
	if (typeof menuLayout != "undefined"){
		menuHeightShouldBeZero = menuLayout["MENU_OVERLAY"] == "absolute";
		menuHeightShouldBeZero = menuHeightShouldBeZero || menuLayout["MENU_POSITION"] == "none" || menuLayout["MENU_POSITION"] == "left";
	}else{
		menuHeightShouldBeZero = menuStripe.css("display") == "none" || menuStripe.is(".force-transparency");
		menuHeightShouldBeZero = menuHeightShouldBeZero || $(".page").attr("data-menu_position") == "left" || $(".page").attr("data-menu_overlay") == "absolute";
	}
	var menuHeight = 0;
	if (!menuHeightShouldBeZero){
		menuHeight = menuStripe.outerHeight();
	}
	var newHeight = "calc(100vh - " + menuHeight + "px)!important";
	var newEditorHeight = "calc(100vh - " + (menuHeight + 50) + "px)!important";
	var values = newHeight + "|" + newEditorHeight

	var fillHeightStyle = $("#fill-height-style");
	if (fillHeightStyle.length == 0){
		fillHeightStyle = $("<style />").attr("id","fill-height-style");
	}
	var cssSelectorStr = EditorHelper.StyleSettings["MODULES"]["EDITOR_WEBSITE_FIRST_STRIPE"]["PARENT_CSS_CLASS"] + " ";
	var relevantClasses = EditorHelper.StyleSettings["MODULES"]["EDITOR_WEBSITE_FIRST_STRIPE"]["CSS_CLASS"];
	for (c in relevantClasses){
		cssSelectorStr += relevantClasses[c];
		if (c < relevantClasses.length -1 ){cssSelectorStr += ","}
		
	}
	fillHeightStyle.html(cssSelectorStr + "{ min-height:" + newEditorHeight + "}")
	$("head").append(fillHeightStyle);
	var rootStyleId = $("[data-root-style-id]").attr("data-root-style-id")
	EditorHelper.updateMultipleStyleKeys({"styleid":rootStyleId,"props":"MIN_HEIGHT|MIN_HEIGHT","values":values,"modules":"WEBSITE_FIRST_STRIPE|EDITOR_WEBSITE_FIRST_STRIPE"},function(){
		XPRSHelper.updateParent({"deliver_to":"parent","action":"saved"});
	});
};

EditorHelper.receiveMessage = function(event){
	if (window.location.origin != event.origin) {
		return
	}
	switch (event.data.action) {
	    case "device-preview":
	    	EditorHelper.handleDevicePreview(event.data);
	        break;
	    case "preview":
	    	$("#editor-tab").show();
	    	break;
	    case "save-as":
	    	EditorHelper.handleSaveAs(event.data);
	    	break;
	    case "save":
	    	EditorHelper.handleSave(event.data);
	    	break;
	    case "settings":
	    	EditorHelper.handleSettings(event.data);
	    	break;
	    case "changed-page-name":
	    	EditorHelper.updatePageName(event.data);
	    	break;
	    case "show-tooltip":
	    	XPRSHelper.renderTip(event.data.tip);
	    	break;
	    case "remove-tooltips":
	    	$(".tip-highlight").removeClass("tip-highlight");
	    	$(".tooltip-ui" + event.data.tooltip_index).remove();
	    	break;	
	    case "lang-change":
	    	XPRSTranslator.switchToLanguage(event.data.lang,function(){
	    		XPRSTranslator.translateDom($(".draggable-tabbed-panel-wrapper"));
			});
	    	break;
	    case "undo":
	    	if (typeof XPRSUndo != "undefined"){
	    		XPRSUndo.undo();
	    	}
	    	break;
	}
	var contentHeight = event.data.contentHeight;
	if (contentHeight){
		sender = event.data.sender;
	}
};

EditorHelper.updateMultipleStyleKeys = function(params,callbackFunc){
	if (typeof params.vbid == "undefined"){
		delete params.vbid;
	}
	if (params.modules.indexOf("WEBSITE") != -1){
		params.styleid = $("body").attr("data-root-style-id");
	}
	XPRSHelper.SAFEPOST("/update_multiple_style_keys",params,params.styleid,params.props + "-" + params.modules,callbackFunc);
};

EditorHelper.deleteMultipleStyleKeys = function(params,callbackFunc){
	XPRSHelper.SAFEPOST("/delete_multiple_style_keys",params,params.styleid, "DELETE-" + params.modules,callbackFunc);
};

EditorHelper.updateStyleData= function(params,callbackFunc){
	EditorCore.saveStyleChange(params.module_name,{"name":params.updated_key,"initiatorId":params.vbid},params.updated_value,params.style_id);
	if (typeof callbackFunc != "undefined"){
		callbackFunc();
	}
	if ("stripe_id" in params){
		XPRSHelper.POST("/invalidate_stripe_cache", {stripe_id:params.stripe_id,"type":"json"}, function(){
		});
	}
};

EditorHelper.updateStripeData = function(params,callbackFunc){
	var prop = {"name":params.updated_key,"initiatorId":params.vbid};
	if (typeof params.and_reset != "undefined"){
		prop["and_reset"] = params.and_reset;
	}
	EditorCore.saveStyleChange(params.module_name,prop,params.updated_value,params.parent_vbid);
	if (typeof callbackFunc != "undefined"){
		callbackFunc();
	}
};

EditorHelper.shortUuid = function(prefix) {
	if (typeof prefix == "undefined"){
		prefix = "element";
	}
	return prefix + '-xxxxxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
		var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
		return v.toString(16);
	});
};

EditorHelper.isTextSelected = function(){
    var text = "";
    if (typeof window.getSelection != "undefined") {
        text = window.getSelection().toString();
    } else if (typeof document.selection != "undefined" && document.selection.type == "Text") {
        text = document.selection.createRange().text;
    }
    return text.length > 0;
}

EditorHelper.removeAllSelections = function(){
	if (window.getSelection) {
		  if (window.getSelection().empty) {  // Chrome
		    window.getSelection().empty();
		  } else if (window.getSelection().removeAllRanges) {  // Firefox
		    window.getSelection().removeAllRanges();
		  }
	} else if (document.selection) {  // IE?
		  document.selection.empty();
	}
};

EditorHelper.updateWindowTop = function(msg){
	window.top.postMessage(msg, '*');
};

EditorHelper.updateParent = function(msg){
	XPRSHelper.getParentWindow().postMessage(msg, '*');
};

EditorHelper.loadingFinished = function(){
	var overlay = $(".overlay-div");
	if (overlay.length > 0){
		overlay.addClass("zero-opacity").one('transitionend webkitTransitionEnd oTransitionEnd otransitionend MSTransitionEnd',function(event) {
			event.stopPropagation();
			$(this).unbind('transitionend webkitTransitionEnd oTransitionEnd otransitionend MSTransitionEnd');
			$(this).css("z-index",0);
		});
	}
	$(".page-loader").css("opacity",0);
	if ($("#control-panel").find("#tips-btn").attr("data-first-time")){
		$("#control-panel").find("#tips-btn").removeAttr("data-first-time");
		setTimeout(function(){
				XPRSHelper.renderTip(0);
		},2000);
	}
	$("body").removeClass("loading");
};